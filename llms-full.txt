# ä»‹ç»

Vite çš„ä¸»è¦ç›®çš„æ˜¯æ„å»ºå‰ç«¯åº”ç”¨ã€‚å®ƒæä¾›å¿«é€Ÿçš„å¼€å‘æœåŠ¡å™¨ï¼Œå¯ä»¥é€šè¿‡çƒ­æ¨¡å—æ›¿æ¢ï¼ˆHMRï¼‰è½¬æ¢å’ŒæœåŠ¡èµ„æºï¼Œä½†å®ƒä¸åŒ…å«ç”Ÿäº§æœåŠ¡å™¨ã€‚

åˆ›å»º SPA æ—¶ï¼Œä½ å¸¸å¸¸éœ€è¦æ·»åŠ  API è·¯ç”±â€”â€”æ— è®ºæ˜¯ä¸ºäº†ç»•è¿‡ CORSã€ä½¿ç”¨ API ä»¤ç‰Œè°ƒç”¨æœåŠ¡ï¼Œè¿˜æ˜¯å®ç°ä½ è‡ªå·±çš„åç«¯é€»è¾‘ã€‚Nitro å…è®¸ä½ åœ¨é¡¹ç›®çš„ `routes/` ç›®å½•å†…åˆ›å»ºæœåŠ¡å™¨å’Œ API è·¯ç”±ã€‚ä½ ç”šè‡³å¯ä»¥é€šè¿‡åˆ›å»º `server.ts` æ–‡ä»¶ï¼Œå®ç°å¯¹æ•´ä¸ªæœåŠ¡å™¨å…¥å£çš„æ§åˆ¶ã€‚å‡­å€Ÿå…¶é«˜çº§ä¸”è¿è¡Œæ—¶æ— å…³çš„æ–¹æ³•ï¼ŒNitro è®©ä½ å¯ä»¥ä½¿ç”¨ä»»ä½• HTTP åº“ï¼Œæ¯”å¦‚ [Elysia](https://elysia.zhcndoc.com/){rel="&#x22;nofollow&#x22;"}ã€[h3](https://h3.zhcndoc.com){rel="&#x22;nofollow&#x22;"} æˆ– [Hono](https://hono.dev){rel="&#x22;nofollow&#x22;"}ã€‚

è¿™è¿˜ä¸æ˜¯å…¨éƒ¨ï¼šè¿è¡Œ `vite build` ä¼šåŒæ—¶æ„å»ºä½ çš„åç«¯å’Œå‰ç«¯ä»£ç ï¼Œå¹¶è¾“å‡ºåˆ°ä¸€ä¸ªä¼˜åŒ–çš„ `.output/` æ–‡ä»¶å¤¹ã€‚è¯¥è¾“å‡ºä¸ä»…å…¼å®¹ Node.jsã€Bun å’Œ Denoï¼Œè¿˜æ”¯æŒè®¸å¤šæ— éœ€é…ç½®çš„æ‰˜ç®¡å¹³å°ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥å°†å…¨æ ˆ Vite åº”ç”¨éƒ¨ç½²åˆ° Cloudflare Workersã€Netlifyã€Vercel ç­‰å¹³å°ï¼Œä¸”æ— éœ€ä¿®æ”¹ä¸€è¡Œä»£ç ï¼ŒåŒæ—¶è¿˜èƒ½åˆ©ç”¨å¹³å°ç‰¹æ€§ï¼Œå¦‚ ESRã€ISR å’Œ SWRã€‚

Nitro æœåŠ¡å™¨å…·æœ‰æé«˜çš„æ€§èƒ½ã€‚é€šè¿‡ç»“åˆä»£ç æ‹†åˆ†å’Œç¼–è¯‘è·¯ç”±ï¼Œæ¶ˆé™¤äº†è¿è¡Œæ—¶è·¯ç”±å™¨çš„éœ€æ±‚ï¼Œä»…ä¿ç•™æœ€å°çš„ç¼–è¯‘é€»è¾‘ã€‚è¿™ä½¿å…¶éå¸¸é€‚åˆæ— æœåŠ¡å™¨æ‰˜ç®¡ï¼Œå› ä¸ºå¯åŠ¨æ—¶é—´å‡ ä¹ä¸º 0msï¼Œä¸é¡¹ç›®è§„æ¨¡æ— å…³ï¼Œå¹¶ä¸”åªåŠ è½½å’Œæ‰§è¡Œå¤„ç†è¯·æ±‚æ‰€éœ€çš„ä»£ç ã€‚

æ‹¥æœ‰æœåŠ¡å™¨è¿˜è§£é”äº†æœåŠ¡å™¨ç«¯æ¸²æŸ“åŠŸèƒ½ã€‚ä½ å¯ä»¥ä½¿ç”¨ä½ å–œæ¬¢çš„æ¨¡æ¿å¼•æ“æ¸²æŸ“ HTMLï¼Œæˆ–è€…ç›´æ¥åœ¨æœåŠ¡å™¨ä¸Šä½¿ç”¨ Reactã€Vue æˆ– Svelte ç­‰ç»„ä»¶åº“ã€‚ä½ ç”šè‡³å¯ä»¥å®ç°å…¨æ ˆé€šç”¨æ¸²æŸ“ï¼ˆuniversal renderingï¼‰ä¸å®¢æˆ·ç«¯æ°´åˆï¼ˆhydrationï¼‰ã€‚Nitro æä¾›äº†åŸºç¡€å’Œæ¸è¿›çš„æ–¹æ³•ï¼Œå¸®åŠ©ä½ å®ç°ç›®æ ‡ã€‚

æœåŠ¡å™¨æ•°æ®å­˜å‚¨ç»å¸¸æ˜¯å¿…éœ€çš„ï¼ŒNitro å¼€ç®±å³ç”¨åŒ…å«ä¸€ä¸ªè¿è¡Œæ—¶æ— å…³çš„é”®å€¼å­˜å‚¨å±‚ã€‚å®ƒé»˜è®¤ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œä½†ä½ å¯ä»¥è¿æ¥ 20 å¤šç§ä¸åŒé©±åŠ¨ï¼ˆå¦‚æ–‡ä»¶ç³»ç»Ÿã€Redisã€S3 ç­‰ï¼‰ï¼Œå°†å®ƒä»¬ç»‘å®šåˆ°ä¸åŒçš„å‘½åç©ºé—´ï¼Œå¹¶ä¸”æ— éœ€ä¿®æ”¹ä»£ç å³å¯åˆ‡æ¢ã€‚

ç¼“å­˜æ˜¯ä»»ä½• Web æœåŠ¡å™¨çš„å…³é”®éƒ¨åˆ†ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ Nitro æ”¯æŒå¯¹æœåŠ¡å™¨è·¯ç”±å’ŒæœåŠ¡å™¨å‡½æ•°çš„ç¼“å­˜ï¼Œä¸”ç¼“å­˜ç›´æ¥ç”±æœåŠ¡å™¨å­˜å‚¨æ”¯æŒï¼ˆé€šè¿‡ `cache` å‘½åç©ºé—´ï¼‰ã€‚

å½“é”®å€¼å­˜å‚¨ä¸å¤Ÿç”¨æ—¶ï¼ŒNitro è¿˜å†…ç½®äº†ä¸€ä¸ª SQL æ•°æ®åº“ã€‚å®ƒé»˜è®¤ä½¿ç”¨ SQLiteï¼Œä½†ä½ å¯ä»¥é€šè¿‡ç›¸åŒçš„ API è¿æ¥å’ŒæŸ¥è¯¢ 10 å¤šç§æ•°æ®åº“ï¼ˆPostgresã€MySQLã€PGLite ç­‰ï¼‰ã€‚

æœ€åï¼ŒNitro ä¹Ÿå¯ä½œä¸ºæ„å»ºä½ è‡ªå·±å…ƒæ¡†æ¶çš„åŸºç¡€ã€‚åƒ Nuxtã€SolidStart å’Œ TanStack Start è¿™æ ·çš„æµè¡Œæ¡†æ¶ï¼Œå®Œå…¨æˆ–éƒ¨åˆ†åˆ©ç”¨äº† Nitroã€‚

å‡†å¤‡å¥½è¯•è¯•äº†å—ï¼Ÿè·³è½¬åˆ° [å¿«é€Ÿå¼€å§‹](https://nitro.zhcndoc.com/docs/quick-start)ã€‚


# å¿«é€Ÿå¼€å§‹

::warning
Nitro v3 Alpha æ–‡æ¡£ä»åœ¨å¼€å‘ä¸­ â€” è¯·é¢„è®¡ä¼šæœ‰æ›´æ–°ã€å°šæœªæ‰“ç£¨çš„éƒ¨åˆ†ä»¥åŠå¶å°”çš„ä¸å‡†ç¡®ä¹‹å¤„ã€‚
::

## åœ¨çº¿ä½“éªŒ Nitro

åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨æˆ‘ä»¬çš„ playground ä½“éªŒ Nitroã€‚

::card-group
  :::card
  ---
  icon: i-logos-stackblitz-icon
  target: _blank
  title: Nitro+Vite å…¥é—¨
  to: https://stackblitz.com/github/nitrojs/starter/tree/v3-vite?file=index.html,server.ts
  ---
  åœ¨æµè§ˆå™¨ä¸­ä½¿ç”¨ä¸€ä¸ªæç®€çš„ Vite é¡¹ç›®ç©è½¬ Nitroã€‚
  :::
::

## åˆ›å»º Nitro é¡¹ç›®

åˆ›å»º Nitro åº”ç”¨æœ€å¿«æ·çš„æ–¹å¼æ˜¯ä½¿ç”¨ `create-nitro-app`ã€‚

> [!æ³¨æ„]
> è¯·ç¡®ä¿å·²å®‰è£…æœ€æ–°çš„ Node.jsã€Bun æˆ– Deno çš„é•¿æœŸæ”¯æŒç‰ˆæœ¬ï¼ˆLTSï¼‰ã€‚
> [Node.js](https://node.zhcndoc.com/zh-cn){rel="&#x22;nofollow&#x22;"}ã€[Bun](https://bun.zhcndoc.com/){rel="&#x22;nofollow&#x22;"}ã€[Deno](https://deno.zhcndoc.com/){rel="&#x22;nofollow&#x22;"}

:pm-x{command="create-nitro-app"}

::div{style="display:flex;justify-content:center;"}
![é¢„è§ˆ](https://github.com/nitrojs/create-nitro-app/blob/main/.images/preview.png?raw=true){style="max-width:100%;height:auto;display:block;"}
::

æŒ‰ç…§å‘½ä»¤è¡Œç•Œé¢çš„æŒ‡å¼•æ“ä½œï¼Œå³å¯å¼€å§‹å¯åŠ¨å¼€å‘æœåŠ¡å™¨ã€‚

## æ·»åŠ åˆ° Vite é¡¹ç›®

è‹¥è¦å°† Nitro æ·»åŠ åˆ°ç°æœ‰ Vite é¡¹ç›®ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ï¼š

::steps{level="3"}
### å®‰è£… `nitro` åŒ…

:pm-install{name="nitro"}

### æ·»åŠ  Nitro æ’ä»¶

```js [vite.config.mjs] {2,6}
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({
  plugins: [
    nitro()
  ],
  nitro: {
    serverDir: './'
  }
});
```
::

å°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œç°åœ¨ä½ å¯ä»¥å‘ä½ çš„ Vite é¡¹ç›®æ·»åŠ æœåŠ¡å™¨å’Œ API è·¯ç”±äº†ï¼


# Nitro æ¸²æŸ“å™¨

::warning
Nitro v3 Alpha æ–‡æ¡£ä»åœ¨å®Œå–„ä¸­ â€” å¯èƒ½æœ‰æ›´æ–°ã€éƒ¨åˆ†åŠŸèƒ½ä¸å®Œå–„æˆ–å¶æœ‰ä¸å‡†ç¡®ä¹‹å¤„ã€‚
::

æ¸²æŸ“å™¨æ˜¯ Nitro ä¸­çš„ä¸€ä¸ªç‰¹æ®Šå¤„ç†å™¨ï¼Œç”¨äºæ•è·æ‰€æœ‰æœªåŒ¹é…ä»»ä½•ç‰¹å®š API æˆ–è·¯ç”±å¤„ç†å™¨çš„è¯·æ±‚ã€‚å®ƒé€šå¸¸ç”¨äºæœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰ã€æä¾›å•é¡µåº”ç”¨ï¼ˆSPAï¼‰ï¼Œæˆ–åˆ›å»ºè‡ªå®šä¹‰ HTML å“åº”ã€‚

## HTML æ¨¡æ¿

### è‡ªåŠ¨æ£€æµ‹çš„ `index.html`

é»˜è®¤æƒ…å†µä¸‹ï¼ŒNitro ä¼šè‡ªåŠ¨åœ¨é¡¹ç›®çš„ src ç›®å½•ä¸­æŸ¥æ‰¾ `index.html` æ–‡ä»¶ã€‚

å¦‚æœæ‰¾åˆ°ï¼ŒNitro ä¼šå°†å…¶ç”¨ä½œæ¸²æŸ“å™¨æ¨¡æ¿ï¼Œå¹¶ä¸ºæ‰€æœ‰æœªåŒ¹é…çš„è·¯ç”±è¿”å›è¯¥æ–‡ä»¶ã€‚

::code-group
```html [index.html]
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>My Vite + Nitro App</title>
  </head>
  <body>
    <div id="app"></div>
    <script type="module" src="/src/main.ts"></script>
  </body>
</html>
```

```ts [routes/api/hello.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler((event) => {
  return { hello: "API" };
});
```
::

::tip
å½“æ£€æµ‹åˆ° `index.html` æ—¶ï¼ŒNitro ä¼šè‡ªåŠ¨åœ¨ç»ˆç«¯è¾“å‡ºæ—¥å¿—ï¼š`Using index.html as renderer template.`
::

æœ‰äº†ä¸Šè¿°è®¾ç½®ï¼š

- `/api/hello` â†’ ç”±ä½ çš„ API è·¯ç”±å¤„ç†
- `/about`ã€`/contact` ç­‰ â†’ è¿”å› `index.html`

### è‡ªå®šä¹‰ HTML æ–‡ä»¶

ä½ å¯ä»¥åœ¨ Nitro é…ç½®ä¸­ä½¿ç”¨ `renderer.template` é€‰é¡¹æŒ‡å®šè‡ªå®šä¹‰çš„ HTML æ¨¡æ¿æ–‡ä»¶ã€‚

::code-group
```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  renderer: {
    template: './app.html'
  }
})
```

```html [app.html]
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Custom Template</title>
  </head>
  <body>
    <div id="root">Loading...</div>
    <script type="module" src="/src/main.js"></script>
  </body>
</html>
```
::

### è¶…æ–‡æœ¬é¢„å¤„ç†å™¨ï¼ˆå®éªŒæ€§ï¼‰

Nitro ä½¿ç”¨ [rendu](https://github.com/h3js/rendu){rel="&#x22;nofollow&#x22;"} è¶…æ–‡æœ¬é¢„å¤„ç†å™¨ï¼Œæä¾›ä¸€ç§ä½¿ç”¨ JavaScript è¡¨è¾¾å¼åˆ›å»ºåŠ¨æ€ HTML æ¨¡æ¿çš„ç®€å•å¼ºå¤§æ–¹å¼ã€‚

ä½ å¯ä»¥ä½¿ç”¨ç‰¹æ®Šçš„å®šç•Œç¬¦æ³¨å…¥åŠ¨æ€å†…å®¹ï¼š

- `{{ content }}` è¾“å‡º HTML è½¬ä¹‰åçš„å†…å®¹
- `{{{ content }}}` æˆ– `<?= expression ?>` è¾“å‡ºåŸå§‹ï¼ˆæœªè½¬ä¹‰ï¼‰å†…å®¹
- `<? ... ?>` ç”¨äº JavaScript æ§åˆ¶æµ

è¿˜æš´éœ²äº†å…¨å±€å˜é‡ï¼š

- `$REQUEST`ï¼šä¼ å…¥çš„ Request å¯¹è±¡
- `$METHOD`ï¼šHTTP æ–¹æ³•ï¼ˆGETã€POST ç­‰ï¼‰
- `$URL`ï¼šè¯·æ±‚çš„ URL å¯¹è±¡
- `$HEADERS`ï¼šè¯·æ±‚å¤´
- `$RESPONSE`ï¼šå“åº”é…ç½®å¯¹è±¡
- `$COOKIES`ï¼šåªè¯»çš„è¯·æ±‚ Cookie å¯¹è±¡

```html [index.html]
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Dynamic template</title>
  </head>
  <body>
    <h1>Hello {{ $REQUEST.url }}</h1>
  </body>
</html>
```

:read-more{title="Rendu æ–‡æ¡£" to="https://github.com/h3js/rendu"}

## è‡ªå®šä¹‰æ¸²æŸ“å™¨å¤„ç†å™¨

å¯¹äºæ›´å¤æ‚çš„åœºæ™¯ï¼Œä½ å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰çš„æ¸²æŸ“å™¨å¤„ç†å™¨ï¼Œç¨‹åºåŒ–ç”Ÿæˆå“åº”ã€‚

åˆ›å»ºä¸€ä¸ªæ¸²æŸ“å™¨æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ `defineRenderHandler` å®šä¹‰ä½ çš„è‡ªå®šä¹‰æ¸²æŸ“é€»è¾‘ï¼š

```ts [renderer.ts]
import { defineRenderHandler } from "nitro/runtime";

export default defineRenderHandler((event) => {
  return {
    body: `<!DOCTYPE html>
      <html>
        <head>
          <title>Custom Renderer</title>
        </head>
        <body>
          <h1>Hello from custom renderer!</h1>
          <p>å½“å‰è·¯å¾„: ${event.path}</p>
        </body>
      </html>`,
    headers: {
      'content-type': 'text/html; charset=utf-8'
    }
  }
})
```

ç„¶åï¼Œåœ¨ Nitro é…ç½®ä¸­æŒ‡å®šè¯¥æ¸²æŸ“å™¨å…¥å£ï¼š

```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  renderer: {
    handler: './renderer.ts'
  }
})
```

## æ¸²æŸ“å™¨ä¼˜å…ˆçº§

æ¸²æŸ“å™¨å§‹ç»ˆä½œä¸ºä¸€ä¸ªå…œåº•è·¯ç”±ï¼ˆ`/**`ï¼‰å­˜åœ¨ï¼Œæ‹¥æœ‰**æœ€ä½ä¼˜å…ˆçº§**ã€‚è¿™æ„å‘³ç€ï¼š

::steps{level="4"}
#### å…·ä½“çš„ API è·¯ç”±ä¼˜å…ˆåŒ¹é…ï¼ˆå¦‚ `/api/users`ï¼‰

#### å…·ä½“çš„æœåŠ¡å™¨è·¯ç”±å…¶æ¬¡åŒ¹é…ï¼ˆå¦‚ `/about`ï¼‰

#### æ¸²æŸ“å™¨æ•è·æ‰€æœ‰å…¶ä»–è¯·æ±‚
::

```md
api/
  users.ts        â†’ /api/users ï¼ˆä¼˜å…ˆåŒ¹é…ï¼‰
routes/
  about.ts        â†’ /about ï¼ˆæ¬¡ä¼˜å…ˆåŒ¹é…ï¼‰
renderer.ts         â†’ /** ï¼ˆæ•è·æ‰€æœ‰å…¶ä»–è·¯ç”±ï¼‰
```

::warning
å¦‚æœä½ åœ¨è·¯ç”±ä¸­å®šä¹‰äº†ä¸€ä¸ª catch-all è·¯ç”±ï¼ˆ`[...].ts`ï¼‰ï¼ŒNitro ä¼šè­¦å‘Šè¯¥è·¯ç”±å°†è¢«æ¸²æŸ“å™¨è¦†ç›–ã€‚è¯·ä½¿ç”¨æ›´å…·ä½“çš„è·¯ç”±æˆ–ä¸åŒçš„ HTTP æ–¹æ³•ä»¥é¿å…å†²çªã€‚
::

:read-more{title="Lifecycle" to="https://nitro.zhcndoc.com/docs/lifecycle"}

## ä½¿ç”¨åœºæ™¯

### å•é¡µåº”ç”¨ï¼ˆSPAï¼‰

ä¸ºæ‰€æœ‰è·¯ç”±è¿”å› SPA çš„ `index.html`ï¼Œä»¥æ”¯æŒå®¢æˆ·ç«¯è·¯ç”±ï¼š

::tip
è¿™ä¹Ÿæ˜¯ Nitro å’Œ Vite é…åˆä½¿ç”¨æ—¶çš„é»˜è®¤è¡Œä¸ºã€‚
::


# æœåŠ¡å™¨è·¯ç”±

> Nitro æ”¯æŒåŸºäºæ–‡ä»¶çš„ API è·¯ç”±ï¼ˆæ–‡ä»¶ä¼šè‡ªåŠ¨æ˜ å°„åˆ° [h3 è·¯ç”±](https://h3.zhcndoc.com/guide/basics/routing){rel="&#x22;nofollow&#x22;"}ï¼‰ã€‚å®šä¹‰è·¯ç”±å°±åƒåœ¨ `server/api/` æˆ– `server/routes/` ç›®å½•å†…åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ä¸€æ ·ç®€å•ã€‚

æ¯ä¸ªæ–‡ä»¶åªèƒ½å®šä¹‰ä¸€ä¸ªå¤„ç†ç¨‹åºï¼Œæ‚¨å¯ä»¥ [å°† HTTP æ–¹æ³•é™„åŠ ](https://nitro.zhcndoc.com/#specific-request-method) åˆ°æ–‡ä»¶åï¼Œä»¥å®šä¹‰ç‰¹å®šçš„è¯·æ±‚æ–¹æ³•ã€‚

```text
routes/
  api/
    test.ts      <-- /api/test
  hello.get.ts   <-- /hello (ä»…é™ GET)
  hello.post.ts  <-- /hello (ä»…é™ POST)
vite.config.ts
```

æ‚¨å¯ä»¥é€šè¿‡åˆ›å»ºå­ç›®å½•æ¥åµŒå¥—è·¯ç”±ã€‚

```txt
routes/
  api/
    [org]/
      [repo]/
        index.ts   <-- /api/:org/:repo
        issues.ts  <-- /api/:org/:repo/issues
      index.ts     <-- /api/:org
package.json
```

#### è·¯ç”±åˆ†ç»„

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæ‚¨å¯èƒ½å¸Œæœ›å°†ä¸€ç»„è·¯ç”±å½’ä¸ºä¸€ç±»ï¼Œä½†åˆä¸å½±å“åŸºäºæ–‡ä»¶çš„è·¯ç”±ã€‚ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥å°†æ–‡ä»¶æ”¾å…¥ä»¥æ‹¬å· `(` å’Œ `)` åŒ…è£¹çš„æ–‡ä»¶å¤¹ä¸­ã€‚

ä¾‹å¦‚ï¼š

```txt
routes/
  api/
    (admin)/
      users.ts   <-- /api/users
      reports.ts <-- /api/reports
    (public)/
      index.ts   <-- /api
package.json
```

> [!æ³¨æ„] è·¯ç”±åˆ†ç»„ä¸æ˜¯è·¯ç”±å®šä¹‰çš„ä¸€éƒ¨åˆ†ï¼Œåªç”¨äºç»„ç»‡ç›®çš„ã€‚

### ç®€å•è·¯ç”±

é¦–å…ˆï¼Œåœ¨ `server/routes/` æˆ– `server/api/` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶ã€‚æ–‡ä»¶åå°†ä½œä¸ºè·¯ç”±è·¯å¾„ã€‚

ç„¶åï¼Œå¯¼å‡ºä¸€ä¸ªç”¨ `defineEventHandler` åŒ…è£¹çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†åœ¨è·¯ç”±åŒ¹é…æ—¶æ‰§è¡Œã€‚

```ts [routes/api/test.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler(() => {
  return { hello: "API" };
});
```

### å¸¦å‚æ•°çš„è·¯ç”±

#### å•ä¸ªå‚æ•°

è¦å®šä¹‰å¸¦å‚æ•°çš„è·¯ç”±ï¼Œè¯·ä½¿ç”¨ `[<param>]` è¯­æ³•ï¼Œå…¶ä¸­ `<param>` æ˜¯å‚æ•°çš„åç§°ã€‚è¯¥å‚æ•°å°†åœ¨ `event.context.params` å¯¹è±¡ä¸­å¯ç”¨ï¼Œæˆ–ä½¿ç”¨ [`getRouterParam`](https://h3.zhcndoc.com/utils/request#getrouterparamevent-name-opts-decode){rel="&#x22;nofollow&#x22;"} å·¥å…·ã€‚

```ts [routes/hello/[name\\].ts]
import { defineHandler } from "nitro/h3";

export default defineHandler((event) => {
  const { name } = event.context.params;

  return `Hello ${name}!`;
});
```

è°ƒç”¨å¸¦å‚æ•°çš„è·¯ç”± `/hello/nitro`ï¼Œæ‚¨å°†å¾—åˆ°ï¼š

```txt [Response]
Hello nitro!
```

#### å¤šä¸ªå‚æ•°

æ‚¨å¯ä»¥é€šè¿‡ä½¿ç”¨ `[<param1>]/[<param2>]` è¯­æ³•åœ¨è·¯ç”±ä¸­å®šä¹‰å¤šä¸ªå‚æ•°ï¼Œå…¶ä¸­æ¯ä¸ªå‚æ•°éƒ½æ˜¯ä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚æ‚¨ **ä¸èƒ½** åœ¨å•ä¸ªæ–‡ä»¶åçš„æ–‡ä»¶å¤¹ä¸­å®šä¹‰å¤šä¸ªå‚æ•°ã€‚

```ts [routes/hello/[name\\]/[age\\].ts]
import { defineHandler } from "nitro/h3";

export default defineHandler((event) => {
  const { name, age } = event.context.params;

  return `Hello ${name}! You are ${age} years old.`;
});
```

#### æ•è·æ‰€æœ‰å‚æ•°

æ‚¨å¯ä»¥ä½¿ç”¨ `[...<param>]` è¯­æ³•æ•è· URL ä¸­å‰©ä½™çš„æ‰€æœ‰éƒ¨åˆ†ã€‚è¿™å°†åŒ…æ‹¬æ–œæ  `/` åœ¨å‚æ•°ä¸­ã€‚

```ts [routes/hello/[...name\\].ts]
import { defineHandler } from "nitro/h3";

export default defineHandler((event) => {
  const { name } = event.context.params;

  return `Hello ${name}!`;
});
```

è°ƒç”¨å¸¦å‚æ•°çš„è·¯ç”± `/hello/nitro/is/hot`ï¼Œæ‚¨å°†å¾—åˆ°ï¼š

```txt [Response]
Hello nitro/is/hot!
```

### ç‰¹å®šè¯·æ±‚æ–¹æ³•

æ‚¨å¯ä»¥å°† HTTP æ–¹æ³•é™„åŠ åˆ°æ–‡ä»¶åï¼Œä»¥å¼ºåˆ¶è·¯ç”±ä»…åŒ¹é…ç‰¹å®šçš„ HTTP è¯·æ±‚æ–¹æ³•ï¼Œä¾‹å¦‚ `hello.get.ts` å°†ä»…åŒ¹é… `GET` è¯·æ±‚ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•æ‚¨æƒ³è¦çš„ HTTP æ–¹æ³•ã€‚

::code-group
```js [GET]
// routes/users/[id].get.ts
import { defineHandler } from "nitro/h3";

export default defineHandler(async (event) => {
  const { id } = event.context.params;

  // å¯¹ id æ‰§è¡ŒæŸäº›æ“ä½œ

  return `ç”¨æˆ·èµ„æ–™ï¼`
})
```

```js [POST]
// routes/users.post.ts
import { defineHandler, readBody } from "nitro/h3";

export default defineHandler(async (event) => {
  const body = await readBody(event);

  // å¯¹ body æ‰§è¡ŒæŸäº›æ“ä½œï¼Œä¾‹å¦‚å°†å…¶ä¿å­˜åˆ°æ•°æ®åº“

  return { updated: true };
});
```
::

### æ•è·æ‰€æœ‰è·¯ç”±

æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„è·¯ç”±ï¼ŒåŒ¹é…æœªè¢«ä»»ä½•å…¶ä»–è·¯ç”±åŒ¹é…çš„æ‰€æœ‰è·¯ç”±ã€‚è¿™å¯¹äºåˆ›å»ºé»˜è®¤è·¯ç”±éå¸¸æœ‰ç”¨ã€‚

è¦åˆ›å»ºæ•è·æ‰€æœ‰è·¯ç”±ï¼Œè¯·åœ¨ `server/routes/` æˆ– `server/api/` ç›®å½•æˆ–ä»»ä½•å­ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªåä¸º `[...].ts` çš„æ–‡ä»¶ã€‚

```ts [routes/[...\\].ts]
import { defineHandler } from "nitro/h3";

export default defineHandler((event) => {
  return `Hello ${event.url}!`;
});
```

### ç¯å¢ƒç‰¹å®šå¤„ç†ç¨‹åº

æ‚¨å¯ä»¥æŒ‡å®šä»…åœ¨ç‰¹å®šæ„å»ºä¸­åŒ…å«çš„è·¯ç”±ï¼Œé€šè¿‡åœ¨æ–‡ä»¶ååæ·»åŠ  `.dev`ã€`.prod` æˆ– `.prerender` åç¼€ï¼Œä¾‹å¦‚ï¼š`routes/test.get.dev.ts` æˆ– `routes/test.get.prod.ts`ã€‚

> [!æç¤º]
> æ‚¨å¯ä»¥é€šè¿‡ `handlers[]` é…ç½®çš„ç¨‹åºæ³¨å†Œä¸ºç¯å¢ƒæŒ‡å®šå¤šä¸ªç¯å¢ƒæˆ–é¢„è®¾åç§°ä½œä¸ºç¯å¢ƒã€‚

## ä¸­é—´ä»¶

Nitro è·¯ç”±ä¸­é—´ä»¶å¯ä»¥æŒ‚é’©åˆ°è¯·æ±‚ç”Ÿå‘½å‘¨æœŸä¸­ã€‚

::tip
ä¸­é—´ä»¶å¯ä»¥åœ¨è¯·æ±‚å¤„ç†å‰ä¿®æ”¹è¯·æ±‚ï¼Œè€Œä¸æ˜¯ä¹‹åã€‚
::

ä¸­é—´ä»¶åœ¨ `server/middleware/` ç›®å½•ä¸­è‡ªåŠ¨æ³¨å†Œã€‚

```md
middleware/
  auth.ts
  logger.ts
  ...
routes/
  hello.ts
```

### ç®€å•ä¸­é—´ä»¶

ä¸­é—´ä»¶ä¸è·¯ç”±å¤„ç†ç¨‹åºçš„å®šä¹‰æ–¹å¼å®Œå…¨ç›¸åŒï¼Œå”¯ä¸€ä¾‹å¤–æ˜¯å®ƒä»¬ä¸åº”è¿”å›ä»»ä½•å†…å®¹ã€‚
ä»ä¸­é—´ä»¶è¿”å›çš„è¡Œä¸ºç±»ä¼¼äºä»è¯·æ±‚è¿”å› - è¯¥å€¼å°†ä½œä¸ºå“åº”è¿”å›ï¼Œä¸”ä¸ä¼šæ‰§è¡Œåç»­ä»£ç ã€‚

```ts [server/middleware/auth.ts]
export default defineEventHandler((event) => {
  // æ‰©å±•æˆ–ä¿®æ”¹äº‹ä»¶
  event.context.user = { name: 'Nitro' }
})
```

åœ¨ `server/middleware/` ç›®å½•ä¸­çš„ä¸­é—´ä»¶ä¼šè‡ªåŠ¨æ³¨å†Œåˆ°æ‰€æœ‰è·¯ç”±ã€‚å¦‚æœæ‚¨æƒ³ä¸ºç‰¹å®šè·¯ç”±æ³¨å†Œä¸­é—´ä»¶ï¼Œè¯·å‚è§ [å¯¹è±¡è¯­æ³•äº‹ä»¶å¤„ç†ç¨‹åº](https://h3.zhcndoc.com/guide/basics/handler#object-syntax){rel="&#x22;nofollow&#x22;"}ã€‚

::note
ä»ä¸­é—´ä»¶è¿”å›ä»»ä½•å†…å®¹å°†å…³é—­è¯·æ±‚ï¼Œåº”é¿å…ï¼ä»ä¸­é—´ä»¶è¿”å›çš„ä»»ä½•å€¼å°†æ˜¯å“åº”ï¼Œä¸”åç»­ä»£ç å°†ä¸è¢«æ‰§è¡Œï¼Œç„¶è€Œ **è¿™å¹¶ä¸æ¨èè¿™æ ·åšï¼**
::

### è·¯ç”±å…ƒæ•°æ®

æ‚¨å¯ä»¥åœ¨æ„å»ºæ—¶ä½¿ç”¨ `defineRouteMeta` å®åœ¨äº‹ä»¶å¤„ç†ç¨‹åºæ–‡ä»¶ä¸­å®šä¹‰è·¯ç”±å¤„ç†ç¨‹åºçš„å…ƒæ•°æ®ã€‚

> [!é‡è¦]
> ğŸš§ æ­¤åŠŸèƒ½å½“å‰å¤„äºå®éªŒé˜¶æ®µã€‚

```ts [routes/api/test.ts]
import { defineRouteMeta } from "nitro";
import { defineHandler } from "nitro/h3";

defineRouteMeta({
  openAPI: {
    tags: ["test"],
    description: "æµ‹è¯•è·¯ç”±æè¿°",
    parameters: [{ in: "query", name: "test", required: true }],
  },
});

export default defineHandler(() => "OK");
```

::read-more{to="https://swagger.io/specification/v3/"}
æ­¤åŠŸèƒ½ç›®å‰å¯ç”¨äºæŒ‡å®š OpenAPI å…ƒæ•°æ®ã€‚æœ‰å…³å¯ç”¨çš„ OpenAPI é€‰é¡¹ï¼Œè¯·å‚è§ swagger è§„èŒƒã€‚
::

### æ‰§è¡Œé¡ºåº

ä¸­é—´ä»¶æŒ‰ç›®å½•åˆ—è¡¨é¡ºåºæ‰§è¡Œã€‚

```md
server/
  middleware/
    auth.ts <-- ç¬¬ä¸€ä¸ª
    logger.ts <-- ç¬¬äºŒä¸ª
    ... <-- ç¬¬ä¸‰ä¸ª
```

ç”¨æ•°å­—å‰ç¼€ä¸­é—´ä»¶ä»¥æ§åˆ¶å…¶æ‰§è¡Œé¡ºåºã€‚

```md
server/
  middleware/
    1.logger.ts <-- ç¬¬ä¸€ä¸ª
    2.auth.ts <-- ç¬¬äºŒä¸ª
    3.... <-- ç¬¬ä¸‰ä¸ª
```

::note
è¯·è®°ä½ï¼Œæ–‡ä»¶åæŒ‰å­—ç¬¦ä¸²æ’åºï¼Œå› æ­¤ä¾‹å¦‚å¦‚æœæ‚¨æœ‰ 3 ä¸ªæ–‡ä»¶ `1.filename.ts`ã€`2.filename.ts` å’Œ `10.filename.ts`ï¼Œåˆ™ `10.filename.ts` å°†åœ¨ `1.filename.ts` ä¹‹åå‡ºç°ã€‚ä¸ºé¿å…è¿™ç§æƒ…å†µï¼Œå‰ç¼€ `1-9` æ—¶ä½¿ç”¨ `0`ï¼Œå¦‚ `01`ï¼Œå¦‚æœæ‚¨åœ¨åŒä¸€ç›®å½•ä¸­æœ‰è¶…è¿‡ 10 ä¸ªä¸­é—´ä»¶ã€‚
::

### è¯·æ±‚è¿‡æ»¤

ä¸­é—´ä»¶åœ¨æ¯ä¸ªè¯·æ±‚ä¸Šæ‰§è¡Œã€‚

åº”ç”¨è‡ªå®šä¹‰é€»è¾‘ï¼Œå°†å…¶ä½œç”¨åŸŸé™åˆ¶ä¸ºç‰¹å®šæ¡ä»¶ã€‚

ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ URL å°†ä¸­é—´ä»¶åº”ç”¨äºç‰¹å®šè·¯ç”±ï¼š

```ts [server/middleware/auth.ts]
export default defineEventHandler((event) => {
  // ä»…åœ¨ /auth è·¯ç”±æ‰§è¡Œ
  if (getRequestURL(event).pathname.startsWith('/auth')) {
    event.context.user = { name: 'Nitro' }
  }
});
```

## é”™è¯¯å¤„ç†

æ‚¨å¯ä»¥ä½¿ç”¨ [H3 ä¸­æä¾›çš„å·¥å…·](https://h3.zhcndoc.com/guide/basics/error){rel="&#x22;nofollow&#x22;"} æ¥å¤„ç†è·¯ç”±å’Œä¸­é—´ä»¶ä¸­çš„é”™è¯¯ã€‚

é”™è¯¯è¿”å›ç»™å®¢æˆ·ç«¯çš„æ–¹å¼å–å†³äºç¯å¢ƒã€‚åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œå¯¹äº `Accept` å¤´ä¸º `text/html` çš„è¯·æ±‚ï¼ˆå¦‚æµè§ˆå™¨ï¼‰ï¼Œå°†è¿”å› HTML é”™è¯¯é¡µé¢ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé”™è¯¯æ€»æ˜¯ä»¥ JSON å½¢å¼å‘é€ã€‚

è¿™ç§è¡Œä¸ºå¯ä»¥è¢«æŸäº›è¯·æ±‚å±æ€§ï¼ˆä¾‹å¦‚ï¼š`Accept` æˆ– `User-Agent` å¤´ï¼‰è¦†ç›–ã€‚

## ä»£ç åˆ†å‰²

Nitro ä¼šä¸ºæ¯ä¸ªè·¯ç”±å¤„ç†ç¨‹åºåˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ä»£ç å—ã€‚ä»£ç å—åœ¨é¦–æ¬¡è¯·æ±‚æ—¶æŒ‰éœ€åŠ è½½ï¼Œæ‰€ä»¥ `/api/users` ä¸ä¼šåŠ è½½ `/api/posts` çš„ä»£ç ã€‚

æœ‰å…³å…¨éƒ¨æ‰“åŒ…åˆ°å•ä¸ªæ–‡ä»¶çš„é…ç½®ï¼Œè¯·å‚è§ [`inlineDynamicImports`](https://nitro.zhcndoc.com/config#inlinedynamicimports)ã€‚

## è·¯ç”±è§„åˆ™

Nitro å…è®¸æ‚¨åœ¨é…ç½®çš„é¡¶å±‚ä¸ºæ¯ä¸ªè·¯ç”±æ·»åŠ é€»è¾‘ã€‚è¿™å¯ä»¥ç”¨äºé‡å®šå‘ã€ä»£ç†ã€ç¼“å­˜å’Œä¸ºè·¯ç”±æ·»åŠ å¤´ã€‚

å®ƒæ˜¯ä»è·¯ç”±æ¨¡å¼ï¼ˆéµå¾ª [rou3](https://github.com/h3js/rou3){rel="&#x22;nofollow&#x22;"}ï¼‰åˆ°è·¯ç”±é€‰é¡¹çš„æ˜ å°„ã€‚

å½“ `cache` é€‰é¡¹è®¾ç½®æ—¶ï¼ŒåŒ¹é…æ¨¡å¼çš„å¤„ç†ç¨‹åºå°†è‡ªåŠ¨åŒ…è£¹åœ¨ `defineCachedEventHandler` ä¸­ã€‚æœ‰å…³æ­¤åŠŸèƒ½çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ [ç¼“å­˜æŒ‡å—](https://nitro.zhcndoc.com/guide/cache)ã€‚

::note
`swr: true|number` æ˜¯ `cache: { swr: true, maxAge: number }` çš„å¿«æ·æ–¹å¼ã€‚
::

æ‚¨å¯ä»¥åœ¨ `nitro.config.ts` ä¸­ä½¿ç”¨ `routeRules` é€‰é¡¹è®¾ç½®è·¯ç”±è§„åˆ™ã€‚

```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineConfig({
  routeRules: {
    '/blog/**': { swr: true },
    '/blog/**': { swr: 600 },
    '/blog/**': { static: true },
    '/blog/**': { cache: { /* ç¼“å­˜é€‰é¡¹ */ } },
    '/assets/**': { headers: { 'cache-control': 's-maxage=0' } },
    '/api/v1/**': { cors: true, headers: { 'access-control-allow-methods': 'GET' } },
    '/old-page': { redirect: '/new-page' },
    '/old-page/**': { redirect: '/new-page/**' },
    '/proxy/example': { proxy: 'https://example.com' },
    '/proxy/**': { proxy: '/api/**' },
  }
});
```


# èµ„æº

## å…¬å…±èµ„æº

Nitro é€šè¿‡ `public/` ç›®å½•ç®¡ç†èµ„æºã€‚

::warning
Nitro v3 Alpha æ–‡æ¡£ä»åœ¨å¼€å‘ä¸­ â€”â€” å¯èƒ½å­˜åœ¨æ›´æ–°ã€ä¸å®Œå–„ä¹‹å¤„ä»¥åŠå¶å°”çš„é”™è¯¯ã€‚
::

`public/` ç›®å½•ä¸‹çš„æ‰€æœ‰èµ„æºéƒ½ä¼šè¢«è‡ªåŠ¨æä¾›æœåŠ¡ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥ç›´æ¥é€šè¿‡æµè§ˆå™¨è®¿é—®å®ƒä»¬ï¼Œæ— éœ€ä»»ä½•ç‰¹æ®Šé…ç½®ã€‚

```md
public/
  image.png     <-- /image.png
  video.mp4     <-- /video.mp4
  robots.txt    <-- /robots.txt
```

### ç”Ÿäº§ç¯å¢ƒå…¬å…±èµ„æº

æ„å»º Nitro åº”ç”¨æ—¶ï¼Œ`public/` ç›®å½•ä¼šè¢«å¤åˆ¶åˆ° `.output/public/`ï¼ŒåŒæ—¶ä¼šåˆ›å»ºåŒ…å«å…ƒæ•°æ®çš„æ¸…å•å¹¶åµŒå…¥åˆ°æœåŠ¡å™¨åŒ…ä¸­ã€‚

```json
{
  "/image.png": {
    "type": "image/png",
    "etag": "\"4a0c-6utWq0Kbk5OqDmksYCa9XV8irnM\"",
    "mtime": "2023-03-04T21:39:45.086Z",
    "size": 18956
  },
  "/robots.txt": {
    "type": "text/plain; charset=utf-8",
    "etag": "\"8-hMqyDrA8fJ0R904zgEPs3L55Jls\"",
    "mtime": "2023-03-04T21:39:45.086Z",
    "size": 8
  },
  "/video.mp4": {
    "type": "video/mp4",
    "etag": "\"9b943-4UwfQXKUjPCesGPr6J5j7GzNYGU\"",
    "mtime": "2023-03-04T21:39:45.085Z",
    "size": 637251
  }
}
```

è¿™ä½¿å¾— Nitro æ— éœ€æ‰«æç›®å½•ä¹Ÿèƒ½è¯†åˆ«å…¬å…±èµ„æºï¼Œä»è€Œé€šè¿‡ç¼“å­˜å¤´å®ç°é«˜æ€§èƒ½ã€‚

## æœåŠ¡å™¨èµ„æº

`assets/` ç›®å½•ä¸‹çš„æ‰€æœ‰èµ„æºéƒ½ä¼šè¢«æ·»åŠ åˆ°æœåŠ¡å™¨åŒ…ä¸­ã€‚æ„å»ºå®Œæˆåï¼Œä½ å¯ä»¥åœ¨ `.output/server/chunks/raw/` ç›®å½•æ‰¾åˆ°å®ƒä»¬ã€‚è¯·æ³¨æ„èµ„æºçš„å¤§å°ï¼Œå› ä¸ºå®ƒä»¬ä¼šä¸æœåŠ¡å™¨åŒ…ä¸€åŒæ‰“åŒ…ã€‚

::tip
é™¤éä½¿ç”¨ `useStorage()`ï¼Œå¦åˆ™èµ„æºä¸ä¼šåŒ…å«åœ¨æœåŠ¡å™¨åŒ…ä¸­ã€‚
::

è¿™äº›èµ„æºå¯ä»¥é€šè¿‡ä½¿ç”¨ [å­˜å‚¨å±‚](https://nitro.zhcndoc.com/docs/storage) çš„ `assets:server` æŒ‚è½½ç‚¹è®¿é—®ã€‚

ä¾‹å¦‚ï¼Œä½ å¯ä»¥å°†ä¸€ä¸ª json æ–‡ä»¶å­˜æ”¾åœ¨ `assets/data.json`ï¼Œå¹¶åœ¨ä½ çš„å¤„ç†å™¨ä¸­è¿™æ ·è·å–å®ƒï¼š

```js
import { defineHandler } from "nitro/h3";

export default defineHandler(async () => {
  const data = await useStorage("assets:server").get("data.json");

  return data;
});
```

### è‡ªå®šä¹‰æœåŠ¡å™¨èµ„æº

è‹¥è¦æ·»åŠ æ¥è‡ªè‡ªå®šä¹‰ç›®å½•çš„èµ„æºï¼Œä½ éœ€è¦åœ¨ Nitro é…ç½®ä¸­å®šä¹‰è·¯å¾„ã€‚è¿™å…è®¸ä½ æ·»åŠ ä½äº `assets/` ç›®å½•ä¹‹å¤–çš„ç›®å½•ä¸­çš„èµ„æºã€‚

```js [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  serverAssets: [{
    baseName: 'my_directory',
    dir: './my_directory'
  }]
})
```

ä¸¾ä¾‹æ¥è¯´ï¼Œä½ å¯èƒ½æƒ³æ·»åŠ ä¸€ä¸ªåŒ…å« HTML æ¨¡æ¿çš„ç›®å½•ã€‚

```js [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  serverAssets: [{
    baseName: 'templates',
    dir: './templates'
  }]
})
```

ç„¶åä½ å¯ä»¥ä½¿ç”¨ `assets:templates` åŸºç¡€è·¯å¾„æ¥è®¿é—®ä½ çš„èµ„æºã€‚

```ts [handlers/success.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler(async (event) => {
  const html = await useStorage("assets:templates").get("success.html");

  return html;
});
```


# é…ç½®

::warning
Nitro v3 Alpha æ–‡æ¡£ä»åœ¨å®Œå–„ä¸­ â€” é¢„è®¡ä¼šæœ‰æ›´æ–°ã€ä¸å®Œå–„ä¹‹å¤„å’Œå¶å°”çš„ä¸å‡†ç¡®å†…å®¹ã€‚
::

::read-more{to="https://nitro.zhcndoc.com/config"}
è¯·æŸ¥çœ‹ [é…ç½®å‚è€ƒ](https://nitro.zhcndoc.com/config) ä»¥è·å–å¯ç”¨é€‰é¡¹ã€‚
::

æ‚¨å¯ä»¥é€šè¿‡é…ç½®æ–‡ä»¶è‡ªå®šä¹‰æ‚¨çš„ Nitro æ„å»ºå™¨ã€‚

::CodeGroup
```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  // Nitro é€‰é¡¹
})
```

```ts [vite.config.ts]
import { defineConfig } from 'vite'
import { nitro } from 'nitro/vite'

export default defineConfig({
  plugins: [
    nitro()
  ],
  nitro: {
    // Nitro é€‰é¡¹
  }
})
```
::

::important
å¦‚æœæ‚¨ä½¿ç”¨ [Nuxt](https://nuxt.zhcndoc.com){rel=""nofollow""}ï¼Œè¯·åœ¨æ‚¨çš„ Nuxt é…ç½®ä¸­ä½¿ç”¨ `nitro` é€‰é¡¹ã€‚
::

::tip
Nitro ä½¿ç”¨ [c12](https://github.com/unjs/c12){rel=""nofollow""} åŠ è½½é…ç½®ï¼Œæä¾›æ›´å¤šå¯èƒ½æ€§ï¼Œä¾‹å¦‚åœ¨å½“å‰å·¥ä½œç›®å½•æˆ–ç”¨æˆ·ä¸»ç›®å½•ä¸­ä½¿ç”¨ `.nitrorc` æ–‡ä»¶ã€‚
::

## è¿è¡Œæ—¶é…ç½®

Nitro æä¾›äº†ä¸€ä¸ªè¿è¡Œæ—¶é…ç½® APIï¼Œä»¥ä¾¿åœ¨åº”ç”¨ç¨‹åºä¸­å…¬å¼€é…ç½®ï¼Œå¹¶èƒ½å¤Ÿé€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡åœ¨è¿è¡Œæ—¶æ›´æ–°é…ç½®ã€‚å½“æ‚¨å¸Œæœ›ä¸ºä¸åŒçš„ç¯å¢ƒï¼ˆä¾‹å¦‚å¼€å‘ã€é¢„å‘å¸ƒã€ç”Ÿäº§ï¼‰å…¬å¼€ä¸åŒçš„é…ç½®å€¼æ—¶ï¼Œè¿™éå¸¸æœ‰ç”¨ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæ‚¨å¯ä»¥ç”¨å®ƒæ¥ä¸ºä¸åŒçš„ç¯å¢ƒæš´éœ²ä¸åŒçš„ API ç«¯ç‚¹æˆ–ä¸åŒçš„åŠŸèƒ½æ ‡å¿—ã€‚

é¦–å…ˆï¼Œæ‚¨éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰è¿è¡Œæ—¶é…ç½®ã€‚

::CodeGroup
```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  runtimeConfig: {
    apiToken: "dev_token", // `dev_token` æ˜¯é»˜è®¤å€¼
  }
});
```

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  runtimeConfig: {
    apiToken: "dev_token", // `dev_token` æ˜¯é»˜è®¤å€¼
  }
})
```
::

\::

æ‚¨ç°åœ¨å¯ä»¥ä½¿ç”¨ `useRuntimeConfig()` è®¿é—®è¿è¡Œæ—¶é…ç½®ã€‚

```ts [api/example.get.ts]
import { defineHandler } from "nitro/h3";
import { useRuntimeConfig } from "nitro/runtime-config";

export default defineHandler((event) => {
  return useRuntimeConfig().apiToken; // è¿”å› `dev_token`
});
```

è¯·åœ¨äº‹ä»¶å¤„ç†ç¨‹åºå’Œå·¥å…·å†…ä½¿ç”¨ `useRuntimeConfig(event)`ï¼Œå¹¶**é¿å…**åœ¨ç¯å¢ƒå…¨å±€ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨å®ƒã€‚è¿™å¯èƒ½ä¼šå¯¼è‡´æ„å¤–è¡Œä¸ºï¼Œä¾‹å¦‚åœ¨ä¸åŒè¯·æ±‚ä¹‹é—´å…±äº«ç›¸åŒçš„è¿è¡Œæ—¶é…ç½®ã€‚

### æœ¬åœ°å¼€å‘

æœ€åï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ç¯å¢ƒå˜é‡æ›´æ–°è¿è¡Œæ—¶é…ç½®ã€‚æ‚¨å¯ä»¥åœ¨å¼€å‘ä¸­ä½¿ç”¨ `.env` æˆ– `.env.local` æ–‡ä»¶ï¼Œå¹¶åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨å¹³å°å˜é‡ï¼ˆè§ä¸‹æ–‡ï¼‰ã€‚

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `.env` æ–‡ä»¶ï¼š

```bash [.env]
NITRO_API_TOKEN="123"
```

é‡æ–°å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼Œè·å– `/api/example` ç«¯ç‚¹ï¼Œæ‚¨åº”è¯¥çœ‹åˆ° `123` ä½œä¸ºå“åº”ï¼Œè€Œä¸æ˜¯ `dev_token`ã€‚

åˆ«å¿˜äº†ï¼Œæ‚¨ä»ç„¶å¯ä»¥é€šè¿‡ `import.meta.env` æˆ– `process.env` é€šç”¨è®¿é—®ç¯å¢ƒå˜é‡ï¼Œä½†é¿å…åœ¨ç¯å¢ƒå…¨å±€ä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨å®ƒä»¬ï¼Œä»¥é˜²æ­¢æ„å¤–è¡Œä¸ºã€‚

### ç”Ÿäº§ç¯å¢ƒ

æ‚¨å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å®šä¹‰å˜é‡ä»¥æ›´æ–°è¿è¡Œæ—¶é…ç½®ã€‚æ‰€æœ‰å˜é‡å¿…é¡»ä»¥ `NITRO_` ä¸ºå‰ç¼€ï¼Œä»¥ä¾¿åº”ç”¨åˆ°è¿è¡Œæ—¶é…ç½®ã€‚å®ƒä»¬å°†è¦†ç›–æ‚¨åœ¨ `nitro.config.ts` æ–‡ä»¶ä¸­å®šä¹‰çš„è¿è¡Œæ—¶é…ç½®å˜é‡ã€‚

::warning
æ‰€æœ‰å˜é‡å¿…é¡»ä»¥ `NITRO_` ä¸ºå‰ç¼€æ‰èƒ½åº”ç”¨äºè¿è¡Œæ—¶é…ç½®ã€‚å®ƒä»¬å°†è¦†ç›–æ‚¨åœ¨ `nitro.config.ts` æ–‡ä»¶ä¸­å®šä¹‰çš„è¿è¡Œæ—¶é…ç½®å˜é‡ã€‚
::

::CodeGroup
```bash [.env]
NITRO_API_TOKEN="123"
```

```bash [.env (nuxt)]
NUXT_API_TOKEN="123"
```
::

\::

åœ¨è¿è¡Œæ—¶é…ç½®ä¸­ï¼Œä½¿ç”¨ camelCase å®šä¹‰é”®ã€‚åœ¨ç¯å¢ƒå˜é‡ä¸­ï¼Œä½¿ç”¨ snake\_case å’Œå¤§å†™å­—æ¯å®šä¹‰é”®ã€‚

```ts
{
  helloWorld: "foo"
}
```

```bash
NITRO_HELLO_WORLD="foo"
```


# SQL æ•°æ®åº“

> Nitro æä¾›äº†ä¸€ä¸ªå†…ç½®çš„è½»é‡çº§ SQL æ•°æ®åº“å±‚ã€‚

:warning

Nitro v3 Alpha æ–‡æ¡£ä»åœ¨å¼€å‘ä¸­ â€” å¯èƒ½ä¼šæœ‰æ›´æ–°ã€ä¸å®Œå–„ä¹‹å¤„å’Œå¶å°”çš„ä¸å‡†ç¡®ã€‚
:

é»˜è®¤çš„æ•°æ®åº“è¿æ¥å·²**é¢„é…ç½®**ä¸º [SQLite](https://db0.unjs.io/connectors/sqlite){rel="&#x22;nofollow&#x22;"}ï¼Œå¹¶ä¸”å¯ä»¥åœ¨å¼€å‘æ¨¡å¼å’Œä»»ä½•å…¼å®¹ Node.js çš„ç”Ÿäº§éƒ¨ç½²ä¸­å¼€ç®±å³ç”¨ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ•°æ®å°†å­˜å‚¨åœ¨ `.data/db.sqlite` ä¸­ã€‚

::important
æ•°æ®åº“æ”¯æŒç›®å‰å¤„äºå®éªŒé˜¶æ®µã€‚
è¯·å‚é˜… [db0 é—®é¢˜](https://github.com/unjs/db0/issues){rel=""nofollow""} ä»¥è·å–çŠ¶æ€ä¿¡æ¯å’ŒæŠ¥å‘Šé”™è¯¯ã€‚
::

ä¸ºäº†å¯ç”¨æ•°æ®åº“å±‚ï¼Œä½ éœ€è¦å¯ç”¨å®éªŒç‰¹æ€§æ ‡å¿—ã€‚

```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  experimental: {
    database: true
  }
})
```

::tip
ä½ å¯ä»¥æ›´æ”¹é»˜è®¤è¿æ¥ï¼Œæˆ–è€…ä¸ºä»»ä½• [æ”¯æŒçš„æ•°æ®åº“](https://db0.unjs.io/connectors/sqlite){rel=""nofollow""} å®šä¹‰æ›´å¤šè¿æ¥ã€‚
::

::tip
ä½ å¯ä»¥å°†æ•°æ®åº“å®ä¾‹é›†æˆåˆ°ä»»ä½• [æ”¯æŒçš„ ORM](https://db0.unjs.io/integrations){rel=""nofollow""} ä¸­ã€‚
::

:read-more{title="DB0 æ–‡æ¡£" to="https://db0.unjs.io"}

## ç”¨æ³•

```ts [server.ts]
import { defineHandler } from "nitro/h3";
import { useDatabase } from "nitro/database";

export default defineHandler(async () => {
  const db = useDatabase();

  // Create users table
  await db.sql`DROP TABLE IF EXISTS users`;
  await db.sql`CREATE TABLE IF NOT EXISTS users ("id" TEXT PRIMARY KEY, "firstName" TEXT, "lastName" TEXT, "email" TEXT)`;

  // Add a new user
  const userId = String(Math.round(Math.random() * 10_000));
  await db.sql`INSERT INTO users VALUES (${userId}, 'John', 'Doe', '')`;

  // Query for users
  const { rows } = await db.sql`SELECT * FROM users WHERE id = ${userId}`;

  return {
    rows,
  };
});
```

## é…ç½®

ä½ å¯ä»¥ä½¿ç”¨ `database` é…ç½®æ¥é…ç½®æ•°æ®åº“è¿æ¥ï¼š

```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  database: {
    default: {
      connector: "sqlite",
      options: { name: "db" }
    },
    users: {
      connector: "postgresql",
      options: {
        url: "postgresql://username:password@hostname:port/database_name"
      },
    },
  },
});
```

::tip
ä½ å¯ä»¥ä½¿ç”¨ `devDatabase` é…ç½®ä»…åœ¨å¼€å‘æ¨¡å¼ä¸‹è¦†ç›–æ•°æ®åº“é…ç½®ã€‚
::


# ç”Ÿå‘½å‘¨æœŸ

::warning
Nitro v3 Alpha æ–‡æ¡£ä»åœ¨å¼€å‘ä¸­ â€” æœŸå¾…æ›´æ–°ã€ä¸å®Œå–„ä¹‹å¤„åŠå¶å°”çš„ä¸å‡†ç¡®ã€‚
::

è¯·æ±‚å¯ä»¥ä»ä»¥ä¸‹ä»»ä¸€å±‚è¢«æ‹¦æˆªå¹¶ç»ˆæ­¢ï¼ˆå¯å¸¦å“åº”ï¼Œä¹Ÿå¯ä¸å¸¦å“åº”ï¼‰ï¼Œé¡ºåºå¦‚ä¸‹ï¼š

::steps
### è·¯ç”±è§„åˆ™

Nitro é…ç½®ä¸­å®šä¹‰çš„åŒ¹é…è·¯ç”±è§„åˆ™å°†è¢«æ‰§è¡Œã€‚è¯·æ³¨æ„ï¼Œå¤§å¤šæ•°è·¯ç”±è§„åˆ™å¯ä»¥ä¿®æ”¹å“åº”è€Œä¸ç»ˆæ­¢ï¼ˆä¾‹å¦‚ï¼Œæ·»åŠ ä¸€ä¸ªå“åº”å¤´ï¼‰ã€‚

```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  routeRules: {
    '/**': { headers: { 'x-nitro': 'first' } }
  }
})
```

:read-more{title="è·¯ç”± > è·¯ç”±è§„åˆ™" to="https://nitro.zhcndoc.com/docs/routing#route-rules"}

### å…¨å±€ä¸­é—´ä»¶

å®šä¹‰åœ¨ `middleware/` ç›®å½•ä¸‹çš„ä»»ä½•å…¨å±€ä¸­é—´ä»¶éƒ½ä¼šè¿è¡Œï¼š

```ts [middleware/info.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler((event) => {
  event.context.info = { name: "Nitro" };
});
```

  :::warning
  ä¸­é—´ä»¶ä¸­è¿”å›å“åº”å°†å…³é—­è¯¥è¯·æ±‚ï¼Œåº”å°½é‡é¿å…ã€‚
  :::

  :::read-more{to="https://nitro.zhcndoc.com/docs/middleware"}
  äº†è§£æ›´å¤šå…³äº Nitro ä¸­é—´ä»¶ã€‚
  :::

### è·¯ç”±

æ­¤é˜¶æ®µï¼ŒNitro ä¼šæ£€æŸ¥ `routes/` æ–‡ä»¶å¤¹ä¸­å®šä¹‰çš„è·¯ç”±ä»¥åŒ¹é…ä¼ å…¥è¯·æ±‚ã€‚

```ts [routes/api/hello.ts]
export default (event) => ({ world: true })
```

  :::read-more{to="https://nitro.zhcndoc.com/docs/routing#filesystem-routing"}
  äº†è§£æ›´å¤šå…³äº Nitro æ–‡ä»¶ç³»ç»Ÿè·¯ç”±ã€‚
  :::

### æœåŠ¡å™¨å…¥å£

å¦‚æœå®šä¹‰äº†æœåŠ¡å™¨å…¥å£å¤„ç†å™¨ï¼Œåˆ™å°†è¿è¡Œï¼š

```ts [server.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler((event) => {
  if (event.path === "/") {
    return "ä¸»é¡µ";
  }
});
```

  :::tip
  å¯å°†æœåŠ¡å™¨å…¥å£è§†ä¸ºæœ€åè¿è¡Œçš„å…¨å±€ä¸­é—´ä»¶ã€‚
  :::

  :::read-more{to="https://nitro.zhcndoc.com/docs/server-entry"}
  äº†è§£æ›´å¤šå…³äº Nitro æœåŠ¡å™¨å…¥å£ã€‚
  :::

### æ¸²æŸ“å™¨

å¦‚æœæ²¡æœ‰åŒ¹é…è·¯ç”±ï¼ŒNitro ä¼šå¯»æ‰¾æ¸²æŸ“å™¨å¤„ç†å™¨ï¼ˆå·²å®šä¹‰æˆ–è‡ªåŠ¨æ£€æµ‹ï¼‰æ¥å¤„ç†è¯·æ±‚ã€‚

  :::read-more{to="https://nitro.zhcndoc.com/docs/renderer"}
  äº†è§£æ›´å¤šå…³äº Nitro æ¸²æŸ“å™¨ã€‚
  :::
::


# æ’ä»¶

::warning
Nitro v3 Alpha æ–‡æ¡£ä»åœ¨å¼€å‘ä¸­ â€” é¢„è®¡ä¼šæœ‰æ›´æ–°ã€ä¸å®Œå–„ä¹‹å¤„ä»¥åŠå¶å°”çš„ä¸å‡†ç¡®ã€‚
::

Nitro æ’ä»¶å°†åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶**æ‰§è¡Œä¸€æ¬¡**ï¼Œä»¥å…è®¸æ‰©å±• Nitro çš„è¿è¡Œæ—¶è¡Œä¸ºã€‚ :br
å®ƒä»¬æ¥æ”¶ `nitroApp` ä¸Šä¸‹æ–‡ï¼Œå¯ç”¨äºæŒ‚è½½ Nitro ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚

æ’ä»¶ä¼šä» `plugins/` ç›®å½•è‡ªåŠ¨æ³¨å†Œï¼Œå¹¶åœ¨ç¬¬ä¸€æ¬¡ Nitro åˆå§‹åŒ–æ—¶åŒæ­¥è¿è¡Œï¼ˆæŒ‰æ–‡ä»¶åé¡ºåºï¼‰ã€‚

**ç¤ºä¾‹ï¼š**

```ts [plugins/test.ts]
import { definePlugin } from "nitro";

export default definePlugin((nitroApp) => {
  console.log('Nitro æ’ä»¶', nitroApp)
})
```

å¦‚æœä½ çš„æ’ä»¶åœ¨å…¶ä»–ç›®å½•ï¼Œå¯ä»¥ä½¿ç”¨ `plugins` é€‰é¡¹ï¼š

```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  plugins: ['my-plugins/hello.ts']
})
```

## Nitro è¿è¡Œæ—¶é’©å­

ä½ å¯ä»¥ä½¿ç”¨ Nitro çš„ [hooks](https://github.com/unjs/hookable){rel="&#x22;nofollow&#x22;"} æ¥é€šè¿‡æ’ä»¶æ³¨å†Œè‡ªå®šä¹‰ï¼ˆå¼‚æ­¥æˆ–åŒæ­¥ï¼‰å‡½æ•°ï¼Œä»¥æ‰©å±• Nitro çš„é»˜è®¤è¿è¡Œæ—¶è¡Œä¸ºã€‚

**ç¤ºä¾‹ï¼š**

```ts
import { definePlugin } from "nitro";

export default definePlugin((nitro) => {
  nitro.hooks.hook("close", async () => {
    // å½“ nitro æ­£åœ¨å…³é—­æ—¶æ‰§è¡Œ
  });
})
```

### å¯ç”¨çš„é’©å­

- `"close", () => {}`
- `"request", (event) => {}`
- `"error", (error, { event? }) => {}`
- `"response", (res, event) => {}`

## ç¤ºä¾‹

### æ•è·é”™è¯¯

ä½ å¯ä»¥ä½¿ç”¨æ’ä»¶æ•è·æ‰€æœ‰åº”ç”¨é”™è¯¯ã€‚

```ts
import { definePlugin } from "nitro";

export default definePlugin((nitro) => {
  nitro.hooks.hook("error", async (error, { event }) => {
    console.error(`${event.path} åº”ç”¨é”™è¯¯:`, error)
  });
})
```

### ä¼˜é›…å…³é—­

æœåŠ¡å™¨å°†ä¼˜é›…å…³é—­ï¼Œå¹¶ç­‰å¾…ç”± event.waitUntil å‘èµ·çš„ä»»ä½•åå°æŒ‚èµ·ä»»åŠ¡å®Œæˆã€‚

### è¯·æ±‚å’Œå“åº”ç”Ÿå‘½å‘¨æœŸ

ä½ å¯ä»¥ä½¿ç”¨æ’ä»¶æ³¨å†Œé’©å­ï¼Œåœ¨è¯·æ±‚ç”Ÿå‘½å‘¨æœŸä¸­è¿è¡Œï¼š

```ts
import { definePlugin } from "nitro";

export default definePlugin((nitroApp) => {
  nitroApp.hooks.hook("request", (req) => {
    console.log("on request", req.url);
  });
});
```


# ä»»åŠ¡

::warning
Nitro v3 Alpha æ–‡æ¡£ä»åœ¨å¼€å‘ä¸­ â€” é¢„è®¡ä¼šæœ‰æ›´æ–°ã€ä¸å®Œå–„ä¹‹å¤„åŠå¶å°”çš„é”™è¯¯ã€‚
::

## é€‰æ‹©å®éªŒæ€§åŠŸèƒ½

::important
ä»»åŠ¡æ”¯æŒç›®å‰æ˜¯å®éªŒæ€§çš„ã€‚
è¯·æŸ¥çœ‹ [nitrojs/nitro#1974](https://github.com/nitrojs/nitro/issues/1974){rel=""nofollow""} ä»¥è·å–ç›¸å…³è®¨è®ºã€‚
::

ä¸ºäº†ä½¿ç”¨ä»»åŠ¡ APIï¼Œæ‚¨éœ€è¦å¯ç”¨å®éªŒæ€§åŠŸèƒ½æ ‡å¿—ã€‚

::CodeGroup
```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  experimental: {
    tasks: true
  }
})
```

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  nitro: {
    experimental: {
      tasks: true
    }
  }
})
```
::

\::

## å®šä¹‰ä»»åŠ¡

ä»»åŠ¡å¯ä»¥åœ¨ `server/tasks/[name].ts` æ–‡ä»¶ä¸­å®šä¹‰ã€‚

æ”¯æŒåµŒå¥—ç›®å½•ã€‚ä»»åŠ¡åç§°å°†é€šè¿‡ `:` è¿æ¥ã€‚ï¼ˆä¾‹ï¼š`server/tasks/db/migrate.ts` ä»»åŠ¡åç§°å°†ä¸º `db:migrate`ï¼‰

**ç¤ºä¾‹ï¼š**

```ts [tasks/db/migrate.ts]
export default defineTask({
  meta: {
    name: "db:migrate",
    description: "è¿è¡Œæ•°æ®åº“è¿ç§»",
  },
  run({ payload, context }) {
    console.log("æ­£åœ¨è¿è¡Œæ•°æ®åº“è¿ç§»ä»»åŠ¡...");
    return { result: "æˆåŠŸ" };
  },
});
```

## å®šæ—¶ä»»åŠ¡

æ‚¨å¯ä»¥ä½¿ç”¨ Nitro é…ç½®å®šä¹‰å®šæ—¶ä»»åŠ¡ï¼Œä»¥ä¾¿åœ¨æ¯æ®µæ—¶é—´åè‡ªåŠ¨è¿è¡Œã€‚

::CodeGroup
```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  scheduledTasks: {
    // æ¯åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ `cms:update` ä»»åŠ¡
    '* * * * *': ['cms:update']
  }
})
```

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  nitro: {
    scheduledTasks: {
      // æ¯åˆ†é’Ÿè¿è¡Œä¸€æ¬¡ `cms:update` ä»»åŠ¡
      '* * * * *': ['cms:update']
    }
  }
})
```
::

::tip
æ‚¨å¯ä»¥ä½¿ç”¨ [crontab.guru](https://crontab.guru/){rel=""nofollow""} æ¥è½»æ¾ç”Ÿæˆå’Œç†è§£ cron è¡¨è¾¾å¼æ¨¡å¼ã€‚
::

## `waitUntil`

åœ¨è¿è¡Œåå°ä»»åŠ¡æ—¶ï¼Œæ‚¨å¯èƒ½å¸Œæœ›ç¡®ä¿æœåŠ¡å™¨æˆ–å·¥ä½œçº¿ç¨‹ç­‰å¾…ä»»åŠ¡å®Œæˆã€‚

å¯é€‰çš„ `context.waitUntil` å‡½æ•° *å¯èƒ½* å¯ç”¨ï¼Œè¿™å–å†³äºè¿è¡Œæ—¶ç¯å¢ƒã€‚

```ts
export default defineTask({
  run({ context }) {
    const promise = fetch(...)
    context.waitUntil?.(promise);
    await promise;
    return { result: "Success" };
  },
});
```

### å¹³å°æ”¯æŒ

- `dev`ã€`node-server`ã€`bun` å’Œ `deno-server` é¢„è®¾æ”¯æŒ [croner](https://croner.56k.guru/){rel="&#x22;nofollow&#x22;"} å¼•æ“ã€‚
- `cloudflare_module` é¢„è®¾ä¸ [Cron Triggers](https://developers.cloudflare.com/workers/configuration/cron-triggers/){rel="&#x22;nofollow&#x22;"} å…·æœ‰åŸç”Ÿé›†æˆã€‚ç¡®ä¿é…ç½® wrangler ä½¿ç”¨ä¸æ‚¨åœ¨ `scheduledTasks` ä¸­å®šä¹‰çš„å®Œå…¨ç›¸åŒçš„æ¨¡å¼ä»¥è¿›è¡ŒåŒ¹é…ã€‚
- `vercel` é¢„è®¾ä¸ [Vercel Cron Jobs](https://vercel.com/docs/cron-jobs){rel="&#x22;nofollow&#x22;"} å…·æœ‰åŸç”Ÿé›†æˆã€‚Nitro ä¼šåœ¨æ„å»ºæ—¶è‡ªåŠ¨ç”Ÿæˆ cron ä»»åŠ¡é…ç½® â€” æ— éœ€æ‰‹åŠ¨è®¾ç½® `vercel.json`ã€‚
- è®¡åˆ’æ”¯æŒæ›´å¤šé¢„è®¾ï¼ˆå…·æœ‰åŸç”ŸåŸè¯­æ”¯æŒï¼‰ï¼

## ç¨‹åºåŒ–è¿è¡Œä»»åŠ¡

è¦æ‰‹åŠ¨è¿è¡Œä»»åŠ¡ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `runTask(name, { payload? })` å·¥å…·ã€‚

**ç¤ºä¾‹ï¼š**

```ts [api/migrate.ts]
export default eventHandler(async (event) => {
  // é‡è¦ï¼šèº«ä»½éªŒè¯ç”¨æˆ·å’ŒéªŒè¯è´Ÿè½½ï¼
  const payload = { ...getQuery(event) };
  const { result } = await runTask("db:migrate", { payload });

  return { result };
});
```

## ä½¿ç”¨å¼€å‘æœåŠ¡å™¨è¿è¡Œä»»åŠ¡

Nitro å†…ç½®çš„å¼€å‘æœåŠ¡å™¨ä½¿ä»»åŠ¡å¯ä»¥è½»æ¾æ‰§è¡Œï¼Œè€Œæ— éœ€ç¼–ç¨‹ä½¿ç”¨ã€‚

### ä½¿ç”¨ API è·¯ç”±

#### `/_nitro/tasks`

æ­¤ç«¯ç‚¹è¿”å›å¯ç”¨çš„ä»»åŠ¡åç§°åŠå…¶å…ƒæ•°æ®çš„åˆ—è¡¨ã€‚

```json
// [GET] /_nitro/tasks
{
  "tasks": {
    "db:migrate": {
      "description": "è¿è¡Œæ•°æ®åº“è¿ç§»"
    },
    "cms:update": {
      "description": "æ›´æ–° CMS å†…å®¹"
    }
  },
  "scheduledTasks": [
    {
      "cron": "* * * * *",
      "tasks": [
        "cms:update"
      ]
    }
  ]
}
```

#### `/_nitro/tasks/:name`

æ­¤ç«¯ç‚¹æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ã€‚æ‚¨å¯ä»¥ä½¿ç”¨æŸ¥è¯¢å‚æ•°å’Œä¸»ä½“ JSON è´Ÿè½½æä¾›è´Ÿè½½ã€‚å‘é€çš„ JSON ä¸»ä½“è´Ÿè½½å¿…é¡»ä½äº `"payload"` å±æ€§ä¸‹ã€‚

::code-group
```ts [tasks/echo/payload.ts]
export default defineTask({
  meta: {
    name: "echo:payload",
    description: "è¿”å›æä¾›çš„è´Ÿè½½",
  },
  run({ payload, context }) {
    console.log("æ­£åœ¨è¿è¡Œå›å£°ä»»åŠ¡...");
    return { result: payload };
  },
});
```

```json [GET]
// [GET] /_nitro/tasks/echo:payload?field=value&array=1&array=2
{
  "field": "value",
  "array": ["1", "2"]
}
```

```json [POST]
/**
 * [POST] /_nitro/tasks/echo:payload?field=value
 * body: {
 *   "payload": {
 *     "answer": 42,
 *     "nested": {
 *       "value": true
 *     }
 *   }
 * }
 */
{
  "field": "value",
  "answer": 42,
  "nested": {
    "value": true
  }
}
```
::

::note
åŒ…å«åœ¨æ­£æ–‡ä¸­çš„ JSON è´Ÿè½½å°†è¦†ç›–æŸ¥è¯¢å‚æ•°ä¸­å­˜åœ¨çš„é”®ã€‚
::

### ä½¿ç”¨ CLI

::important
åªèƒ½åœ¨ **å¼€å‘æœåŠ¡å™¨è¿è¡Œ** æ—¶è¿è¡Œè¿™äº›å‘½ä»¤ã€‚æ‚¨åº”è¯¥åœ¨ç¬¬äºŒä¸ªç»ˆç«¯ä¸­è¿è¡Œå®ƒä»¬ã€‚
::

#### åˆ—å‡ºä»»åŠ¡

```sh
nitro task list
```

#### è¿è¡Œä»»åŠ¡

```sh
nitro task run db:migrate --payload "{}"
```

## æ³¨æ„äº‹é¡¹

### å¹¶å‘

æ¯ä¸ªä»»åŠ¡åªèƒ½æœ‰ **ä¸€ä¸ªè¿è¡Œå®ä¾‹**ã€‚åœ¨å¹¶è¡Œè°ƒç”¨åŒä¸€ä¸ªåç§°çš„ä»»åŠ¡å¤šæ¬¡æ—¶ï¼Œå®é™…ä¸Šåªè°ƒç”¨ä¸€æ¬¡ï¼Œæ‰€æœ‰è°ƒç”¨è€…å°†è·å¾—ç›¸åŒçš„è¿”å›å€¼ã€‚

::note
Nitro ä»»åŠ¡å¯ä»¥å¤šæ¬¡åŒæ—¶è¿è¡Œã€‚
::


# Nitro æœåŠ¡å™¨å…¥å£

::warning
Nitro v3 Alpha æ–‡æ¡£ä»åœ¨å¼€å‘ä¸­ â€” æœŸå¾…æ›´æ–°ã€ä¸å®Œå–„ä¹‹å¤„ä»¥åŠå¶å°”çš„é”™è¯¯ã€‚
::

æœåŠ¡å™¨å…¥å£æ˜¯ Nitro ä¸­çš„ä¸€ä¸ªç‰¹æ®Šå¤„ç†å™¨ï¼Œä½œä¸ºå…¨å±€ä¸­é—´ä»¶ï¼Œä¸ºæ‰€æœ‰ä¼ å…¥è¯·æ±‚è¿è¡Œï¼Œä¸”åœ¨è·¯ç”±åŒ¹é…ä¹‹å‰æ‰§è¡Œï¼ˆå‚è§ [è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ](https://nitro.zhcndoc.com/docs/architecture#request-lifecycle)ï¼‰ã€‚å®ƒé€šå¸¸ç”¨äºè·¨æ¨¡å—å…³æ³¨ç‚¹ï¼Œå¦‚è®¤è¯ã€æ—¥å¿—è®°å½•ã€è¯·æ±‚é¢„å¤„ç†æˆ–åˆ›å»ºè‡ªå®šä¹‰è·¯ç”±é€»è¾‘ã€‚

## è‡ªåŠ¨æ£€æµ‹çš„ `server.ts`

é»˜è®¤æƒ…å†µä¸‹ï¼ŒNitro ä¼šè‡ªåŠ¨åœ¨é¡¹ç›®æ ¹ç›®å½•æˆ–æ‰«æç›®å½•ä¸­æŸ¥æ‰¾ `server.ts`ï¼ˆæˆ– `.js`ã€`.mjs`ã€`.tsx` ç­‰ï¼‰æ–‡ä»¶ã€‚

å¦‚æœæ‰¾åˆ°ï¼ŒNitro ä¼šå°†å…¶ä½œä¸ºæœåŠ¡å™¨å…¥å£ï¼Œå¹¶å¯¹æ‰€æœ‰ä¼ å…¥è¯·æ±‚è¿è¡Œã€‚

::code-group
```ts [server.ts]
export default {
  async fetch(req: Request) {
    const url = new URL(req.url);

    // å¤„ç†ç‰¹å®šè·¯ç”±
    if (url.pathname === "/health") {
      return new Response("OK", {
        status: 200,
        headers: { "content-type": "text/plain" }
      });
    }

    // ç»™æ‰€æœ‰è¯·æ±‚æ·»åŠ è‡ªå®šä¹‰å¤´
    // è¿”å›ç©º(undefined)ä»¥ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªå¤„ç†å™¨
  }
}
```

```ts [routes/api/hello.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler((event) => {
  return { hello: "API" };
});
```
::

::tip
æ£€æµ‹åˆ° `server.ts` åï¼ŒNitro ä¼šåœ¨ç»ˆç«¯è‡ªåŠ¨æ‰“å°ï¼š`Using \`server.ts\` as server entry.\`
::

åœ¨æ­¤è®¾ç½®ä¸‹ï¼š

- `/health` â†’ ç”±æœåŠ¡å™¨å…¥å£å¤„ç†
- `/api/hello` â†’ æœåŠ¡å™¨å…¥å£å…ˆè¿è¡Œï¼Œç„¶åæ‰§è¡Œ API è·¯ç”±
- `/about` ç­‰ â†’ æœåŠ¡å™¨å…¥å£å…ˆè¿è¡Œï¼Œéšåç»§ç»­è·¯ç”±æˆ–æ¸²æŸ“å™¨å¤„ç†

## æ¡†æ¶å…¼å®¹æ€§

æœåŠ¡å™¨å…¥å£æ˜¯é›†æˆå…¶ä»–æ¡†æ¶ï¼ˆå¦‚ [Elysia](https://elysia.zhcndoc.com/){rel="&#x22;nofollow&#x22;"}ã€[Hono](https://hono.dev/){rel="&#x22;nofollow&#x22;"} æˆ– [H3](https://h3.zhcndoc.com/){rel="&#x22;nofollow&#x22;"}ï¼‰çš„ç»ä½³æ–¹å¼ã€‚

::tabs
  :::tabs-item{icon="i-undocs-h3" label="H3"}
  ```ts [server.ts]
  import { H3 } from "h3";

  const app = new H3()

  app.get("/", () => "âš¡ï¸ Hello from H3!");

  export default app;
  ```
  :::

  :::tabs-item{icon="i-undocs-hono" label="Hono"}
  ```ts [server.ts]
  import { Hono } from "hono";

  const app = new Hono();

  app.get("/", (c) => c.text("ğŸ”¥ Hello from Hono!"));

  export default app;
  ```
  :::

  :::tabs-item{icon="i-undocs-elysia" label="Elysia"}
  ```ts [server.ts]
  import { Elysia } from "elysia";

  const app = new Elysia();

  app.get("/", (c) => "ğŸ¦Š Hello from Elysia!");

  export default app;
  ```
  :::
::

## è‡ªå®šä¹‰æœåŠ¡å™¨å…¥å£æ–‡ä»¶

ä½ å¯ä»¥é€šè¿‡ Nitro é…ç½®ä¸­çš„ `serverEntry` é€‰é¡¹æŒ‡å®šè‡ªå®šä¹‰æœåŠ¡å™¨å…¥å£æ–‡ä»¶ã€‚

```ts [nitro.config.ts]
import { defineNitroConfig } from 'nitro/config'

export default defineNitroConfig({
  serverEntry: './nitro.server.ts'
})
```

## ä½¿ç”¨äº‹ä»¶å¤„ç†å™¨

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ `defineHandler` å¯¼å‡ºäº‹ä»¶å¤„ç†å™¨ï¼Œä»¥è·å¾—æ›´å¥½çš„ç±»å‹æ¨æ–­å’Œè®¿é—® h3 äº‹ä»¶å¯¹è±¡ï¼š

```ts [server.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler((event) => {
  // æ·»åŠ è‡ªå®šä¹‰ä¸Šä¸‹æ–‡
  event.context.requestId = crypto.randomUUID();
  event.context.timestamp = Date.now();

  // è®°å½•è¯·æ±‚æ—¥å¿—
  console.log(`[${event.context.requestId}] ${event.method} ${event.path}`);

  // ç»§ç»­æ‰§è¡Œä¸‹ä¸€ä¸ªå¤„ç†å™¨ï¼ˆä¸è¿”å›ä»»ä½•å†…å®¹ï¼‰
});
```

::important
å¦‚æœä½ çš„æœåŠ¡å™¨å…¥å£è¿”å› `undefined` æˆ–ä¸è¿”å›ä»»ä½•å†…å®¹ï¼Œè¯·æ±‚å°†ç»§ç»­ç”±è·¯ç”±å’Œæ¸²æŸ“å™¨å¤„ç†ï¼›å¦‚æœè¿”å›å“åº”ï¼Œåˆ™è¯·æ±‚ç”Ÿå‘½å‘¨æœŸåœ¨æ­¤ç»ˆæ­¢ã€‚
::

## è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ

æœåŠ¡å™¨å…¥å£ä½œä¸ºå…¨å±€ä¸­é—´ä»¶æ ˆçš„ä¸€éƒ¨åˆ†è¢«è°ƒç”¨ï¼Œä½ç½®åœ¨è·¯ç”±è§„åˆ™ä¹‹åã€è·¯ç”±å¤„ç†å™¨ä¹‹å‰ï¼š

```md
1. æœåŠ¡å™¨é’©å­ï¼š`request`
2. è·¯ç”±è§„åˆ™ï¼ˆå¤´ä¿¡æ¯ã€é‡å®šå‘ç­‰ï¼‰
3. å…¨å±€ä¸­é—´ä»¶ï¼ˆmiddleware/ï¼‰
4. æœåŠ¡å™¨å…¥å£ â† ä½ ç°åœ¨æ‰€åœ¨çš„ä½ç½®
5. è·¯ç”±ï¼ˆroutes/ï¼‰
6. æ¸²æŸ“å™¨ï¼ˆrenderer.ts æˆ– index.htmlï¼‰
```

å¯å°†æœåŠ¡å™¨å…¥å£è§†ä¸ºè·¯ç”±åŒ¹é…å‰è¿è¡Œçš„**æœ€åä¸€ä¸ªå…¨å±€ä¸­é—´ä»¶**ã€‚

:read-more{title="æ¶æ„ > è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ" to="https://nitro.zhcndoc.com/docs/architecture#request-lifecycle"}

## æœ€ä½³å®è·µ

- ä½¿ç”¨æœåŠ¡å™¨å…¥å£å¤„ç†å½±å“**æ‰€æœ‰è·¯ç”±**çš„è·¨æ¨¡å—å…³æ³¨ç‚¹
- è¿”å› `undefined` ä»¥ç»§ç»­å¤„ç†ï¼Œè¿”å›å“åº”åˆ™ç»ˆæ­¢æµç¨‹
- ä¿æŒæœåŠ¡å™¨å…¥å£é€»è¾‘ç²¾ç®€ä»¥è·å¾—æ›´å¥½æ€§èƒ½
- ä½¿ç”¨å…¨å±€ä¸­é—´ä»¶å¤„ç†æ¨¡å—åŒ–å…³æ³¨ç‚¹ï¼Œè€Œéå•ä¸€åºå¤§æœåŠ¡å™¨å…¥å£
- å¯è€ƒè™‘ä½¿ç”¨ [Nitro æ’ä»¶](https://nitro.zhcndoc.com/docs/plugins) è¿›è¡Œåˆå§‹åŒ–é€»è¾‘
- é¿å…åœ¨æœåŠ¡å™¨å…¥å£ä¸­è¿›è¡Œé‡é‡çº§è®¡ç®—ï¼ˆå®ƒä¼šä¸ºæ¯ä¸ªè¯·æ±‚è¿è¡Œï¼‰
- ä¸è¦åœ¨æœåŠ¡å™¨å…¥å£å¤„ç†ç‰¹å®šè·¯ç”±é€»è¾‘ï¼ˆæ›´é«˜æ•ˆçš„æ–¹å¼æ˜¯ä½¿ç”¨è·¯ç”±å¤„ç†å™¨ï¼‰


# ç¼“å­˜

::warning
Nitro v3 Alpha æ–‡æ¡£ä»åœ¨å¼€å‘ä¸­ â€” å¯èƒ½ä¼šæœ‰æ›´æ–°ã€ä¸å®Œå–„ä¹‹å¤„å’Œå¶å‘çš„ä¸å‡†ç¡®ã€‚
::

## ç¼“å­˜çš„äº‹ä»¶å¤„ç†å™¨

è¦ç¼“å­˜äº‹ä»¶å¤„ç†å™¨ï¼Œæ‚¨åªéœ€ä½¿ç”¨ `defineCachedHandler` æ–¹æ³•ã€‚

å®ƒçš„ç”¨æ³•ç±»ä¼¼äº `defineHandler`ï¼Œä½†å¢åŠ äº†ç¬¬äºŒä¸ª [options](https://nitro.zhcndoc.com/#options) å‚æ•°ç”¨äºç¼“å­˜é…ç½®ã€‚

```ts [routes/cached.ts]
import { defineCachedHandler } from "nitro/cache";

export default defineCachedHandler((event) => {
  return "æˆ‘è¢«ç¼“å­˜ä¸€å°æ—¶";
}, { maxAge: 60 * 60 });
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå“åº”å°†åœ¨ 1 å°æ—¶å†…è¢«ç¼“å­˜ï¼ŒåŒæ—¶åœ¨åå°æ›´æ–°ç¼“å­˜æ—¶ï¼Œå°†å‘é€ä¸€ä¸ªè¿‡æœŸå€¼åˆ°å®¢æˆ·ç«¯ã€‚å¦‚æœæ‚¨å¸Œæœ›ç«‹å³è¿”å›æ›´æ–°åçš„å“åº”ï¼Œè¯·è®¾ç½® `swr: false`ã€‚

::important
**å¤„ç†ç¼“å­˜å“åº”æ—¶ï¼Œæ‰€æœ‰ä¼ å…¥çš„è¯·æ±‚å¤´éƒ½ä¼šè¢«ä¸¢å¼ƒã€‚** å¦‚æœæ‚¨å®šä¹‰äº† [`varies` é€‰é¡¹](https://nitro.zhcndoc.com/#options)ï¼Œåˆ™åªæœ‰æŒ‡å®šçš„è¯·æ±‚å¤´ä¼šåœ¨ç¼“å­˜å’Œæä¾›å“åº”æ—¶è¢«è€ƒè™‘ã€‚
::

æœ‰å…³å¯ç”¨é€‰é¡¹çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… [options](https://nitro.zhcndoc.com/#options) éƒ¨åˆ†ã€‚

::note
æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨ `cachedEventHandler` æ–¹æ³•ä½œä¸º `defineCachedHandler` çš„åˆ«åã€‚
::

## ç¼“å­˜çš„å‡½æ•°

æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ `defineCachedFunction` å‡½æ•°ç¼“å­˜ä¸€ä¸ªæ™®é€šå‡½æ•°ã€‚å¯¹äºç¼“å­˜å¹¶å¤ç”¨å¤šä¸ªå¤„ç†å™¨ä¸­è°ƒç”¨çš„éäº‹ä»¶å¤„ç†å™¨å‡½æ•°è¿”å›å€¼éå¸¸æœ‰ç”¨ã€‚

ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½æƒ³è¦ç¼“å­˜ä¸€ä¸ª API è°ƒç”¨çš„ç»“æœï¼Œç¼“å­˜æ—¶é—´ä¸º 1 å°æ—¶ï¼š

```ts [routes/api/stars/[...repo\\].ts]
import { defineHandler, type H3Event } from "nitro/h3";
import { defineHandler, defineCachedFunction } from "nitro/cache";

export default defineHandler(async (event) => {
  const { repo } = event.context.params;
  const stars = await cachedGHStars(repo).catch(() => 0)

  return { repo, stars }
});

const cachedGHStars = defineCachedFunction(async (repo: string) => {
  const data = await fetch(`https://api.github.com/repos/${repo}`).then(res => res.json());

  return data.stargazers_count;
}, {
  maxAge: 60 * 60,
  name: "ghStars",
  getKey: (repo: string) => repo
});
```

åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œæ˜Ÿæ˜Ÿæ•°é‡å°†è¢«ç¼“å­˜åˆ° `.nitro/cache/functions/ghStars/<owner>/<repo>.json` ä¸­ï¼Œ`value` æ˜¯æ˜Ÿæ˜Ÿçš„æ•°é‡ï¼š

```json
{"expires":1677851092249,"value":43991,"mtime":1677847492540,"integrity":"ZUHcsxCWEH"}
```

::important
ç”±äºç¼“å­˜æ•°æ®è¢«åºåˆ—åŒ–ä¸º JSONï¼Œå› æ­¤éå¸¸é‡è¦çš„æ˜¯ï¼Œç¼“å­˜çš„å‡½æ•°ä¸èƒ½è¿”å›ä»»ä½•æ— æ³•åºåˆ—åŒ–çš„å†…å®¹ï¼Œå¦‚ Symbolsã€Mapsã€Sets ç­‰ã€‚
::

::callout
å¦‚æœæ‚¨ä½¿ç”¨è¾¹ç¼˜å·¥ä½œè€…ï¼ˆEdge Workersï¼‰æ¥æ‰˜ç®¡æ‚¨çš„åº”ç”¨ï¼Œåº”è¯¥éµå¾ªä»¥ä¸‹è¯´æ˜ã€‚

  :::collapsible{name="è¾¹ç¼˜å·¥ä½œè€…è¯´æ˜"}
  åœ¨è¾¹ç¼˜å·¥ä½œè€…ä¸­ï¼Œå®ä¾‹ä¼šåœ¨æ¯ä¸ªè¯·æ±‚åè¢«é”€æ¯ã€‚Nitro ä¼šè‡ªåŠ¨ä½¿ç”¨ `event.waitUntil` æ¥åœ¨ç¼“å­˜æ›´æ–°æ—¶ä¿æŒå®ä¾‹å­˜æ´»ï¼ŒåŒæ—¶å°†å“åº”å‘é€ç»™å®¢æˆ·ç«¯ã€‚

  ä¸ºäº†ç¡®ä¿æ‚¨çš„ç¼“å­˜å‡½æ•°åœ¨è¾¹ç¼˜å·¥ä½œè€…ä¸­æ­£å¸¸å·¥ä½œï¼Œ**æ‚¨åº”è¯¥å§‹ç»ˆå°† `event` ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç»™ä½¿ç”¨ `defineCachedFunction` å®šä¹‰çš„å‡½æ•°ã€‚**

  ```ts [routes/api/stars/[...repo\\].ts] {5,10,17}
  import { defineCachedFunction } from "nitro/cache";


  export default defineHandler(async (event) => {
    const { repo } = event.context.params;
    const stars = await cachedGHStars(event, repo).catch(() => 0)

    return { repo, stars }
  });

  const cachedGHStars = defineCachedFunction(async (event: H3Event, repo: string) => {
    const data = await fetch(`https://api.github.com/repos/${repo}`).then(res => res.json());

    return data.stargazers_count;
  }, {
    maxAge: 60 * 60,
    name: "ghStars",
    getKey: (event: H3Event, repo: string) => repo
  });
  ```

  è¿™æ ·ï¼Œå‡½æ•°åœ¨åå°æ›´æ–°ç¼“å­˜æ—¶èƒ½å¤Ÿä¿æŒå®ä¾‹å­˜æ´»ï¼Œè€Œä¸ä¼šå½±å“å®¢æˆ·ç«¯çš„å“åº”é€Ÿåº¦ã€‚
  :::
::

### è¾¹ç¼˜å·¥ä½œè€…

å¦‚æœæ‚¨ä½¿ç”¨è¾¹ç¼˜å·¥ä½œè€…éƒ¨ç½²åº”ç”¨ï¼Œæ¯ä¸ªè¯·æ±‚åå®ä¾‹éƒ½ä¼šè¢«é”€æ¯ã€‚Nitro ä¼šè‡ªåŠ¨ä½¿ç”¨ `event.waitUntil` æ¥åœ¨ç¼“å­˜æ›´æ–°æ—¶ä¿æŒå®ä¾‹å­˜æ´»ï¼ŒåŒæ—¶å°†å“åº”å‘é€ç»™å®¢æˆ·ç«¯ã€‚

ä¸ºäº†ç¡®ä¿æ‚¨çš„ç¼“å­˜å‡½æ•°åœ¨è¾¹ç¼˜å·¥ä½œè€…ä¸­å¦‚é¢„æœŸå·¥ä½œï¼Œ&#x2A;*åº”è¯¥å§‹ç»ˆå°† `event` ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç»™ç”¨ `defineCachedFunction` å®šä¹‰çš„å‡½æ•°ã€‚**

```ts [routes/api/stars/[...repo\\].ts] {5,10,17}
import { defineHandler, defineCachedFunction, type H3Event } from "nitro/runtime";

export default defineHandler(async (event) => {
  const { repo } = event.context.params;
  const stars = await cachedGHStars(event, repo).catch(() => 0)

  return { repo, stars }
});

const cachedGHStars = defineCachedFunction(async (event: H3Event, repo: string) => {
  const data = await fetch(`https://api.github.com/repos/${repo}`).then(res => res.json());

  return data.stargazers_count;
}, {
  maxAge: 60 * 60,
  name: "ghStars",
  getKey: (event: H3Event, repo: string) => repo
});
```

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå‡½æ•°å°†åœ¨æ›´æ–°ç¼“å­˜æ—¶èƒ½å¤Ÿä¿æŒå®ä¾‹å­˜æ´»è€Œä¸ä¼šå‡æ…¢å®¢æˆ·ç«¯çš„å“åº”é€Ÿåº¦ã€‚

## ç¼“å­˜è·¯ç”±è§„åˆ™

æ­¤åŠŸèƒ½ä½¿æ‚¨èƒ½å¤Ÿåœ¨ä¸»é…ç½®æ–‡ä»¶ä¸­ç›´æ¥æ·»åŠ åŸºäºé€šé…ç¬¦æ¨¡å¼çš„ç¼“å­˜è·¯ç”±ã€‚è¿™å¯¹äºä¸ºåº”ç”¨ç¨‹åºçš„ä¸€éƒ¨åˆ†æä¾›å…¨å±€ç¼“å­˜ç­–ç•¥ç‰¹åˆ«æœ‰ç”¨ã€‚

ä½¿ç”¨ `stale-while-revalidate` è¡Œä¸ºç¼“å­˜æ‰€æœ‰åšå®¢è·¯ç”± 1 å°æ—¶ï¼š

```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  routeRules: {
    "/blog/**": { cache: { maxAge: 60 * 60 } },
  },
});
```

å¦‚æœæƒ³ä½¿ç”¨ä¸€ä¸ª [è‡ªå®šä¹‰ç¼“å­˜å­˜å‚¨](https://nitro.zhcndoc.com/#cache-storage) æŒ‚è½½ç‚¹ï¼Œå¯ä»¥ä½¿ç”¨ `base` é€‰é¡¹ï¼š

```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  storage: {
    redis: {
      driver: "redis",
      url: "redis://localhost:6379",
    },
  },
  routeRules: {
    "/blog/**": { cache: { maxAge: 60 * 60, base: "redis" } },
  },
});
```

## è‡ªå®šä¹‰ç¼“å­˜å­˜å‚¨

Nitro å°†ç¼“å­˜æ•°æ®å­˜å‚¨åœ¨ `cache` å­˜å‚¨æŒ‚è½½ç‚¹ä¸­ã€‚

- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé»˜è®¤ä½¿ç”¨ [memory driver](https://unstorage.unjs.io/drivers/memory){rel="&#x22;nofollow&#x22;"}ã€‚
- åœ¨å¼€å‘ç¯å¢ƒä¸­ï¼Œä½¿ç”¨ [filesystem driver](https://unstorage.unjs.io/drivers/fs){rel="&#x22;nofollow&#x22;"}ï¼Œå†™å…¥ä¸´æ—¶ç›®å½•ï¼ˆ`.nitro/cache`ï¼‰ã€‚

è¦è¦†ç›–ç”Ÿäº§å­˜å‚¨ï¼Œè¯·ä½¿ç”¨ `storage` é€‰é¡¹è®¾ç½® `cache` æŒ‚è½½ç‚¹ï¼š

```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  storage: {
    cache: {
      driver: 'redis',
      /* Redis è¿æ¥å™¨é€‰é¡¹ */
    }
  }
})
```

åœ¨å¼€å‘ç¯å¢ƒï¼Œæ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ `devStorage` é€‰é¡¹è¦†ç›–ç¼“å­˜æŒ‚è½½ç‚¹ï¼š

```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  storage: {
    cache: {
      // ç”Ÿäº§ç¯å¢ƒç¼“å­˜å­˜å‚¨
    },
  },
  devStorage: {
    cache: {
      driver: 'redis',
      /* Redis è¿æ¥å™¨é€‰é¡¹ */
    }
  }
})
```

## é€‰é¡¹

`defineCachedHandler` å’Œ `defineCachedFunction` å‡½æ•°æ¥å—ä»¥ä¸‹é€‰é¡¹ï¼š

::field-group
  :::field{name="base" type="string"}
  ç”¨äºç¼“å­˜çš„å­˜å‚¨æŒ‚è½½ç‚¹åç§°ã€‚ :br
  é»˜è®¤å€¼ä¸º `cache`ã€‚
  :::

  :::field{name="name" type="string"}
  ç¼“å­˜åç§°ï¼Œè‹¥æœªæä¾›åˆ™ä»å‡½æ•°åæ¨æ–­ï¼Œé»˜è®¤å€¼ä¸º `'_'`ã€‚
  :::

  :::field{name="group" type="string"}
  ç¼“å­˜åˆ†ç»„ã€‚äº‹ä»¶å¤„ç†å™¨é»˜è®¤ä¸º `'nitro/handlers'`ï¼Œå‡½æ•°é»˜è®¤ä¸º `'nitro/functions'`ã€‚
  :::

  :::field{name="getKey()" type="(...args) => string"}
  æ¥æ”¶ä¸åŸå§‹å‡½æ•°ç›¸åŒå‚æ•°å¹¶è¿”å›ç¼“å­˜é”®ï¼ˆ`string`ï¼‰çš„å‡½æ•°ã€‚ :br
  è‹¥ä¸æä¾›ï¼Œå°†ä½¿ç”¨å†…ç½®å“ˆå¸Œå‡½æ•°æ ¹æ®å‚æ•°ç”Ÿæˆé”®ã€‚
  :::

  :::field{name="integrity" type="string"}
  ç”¨äºä½¿ç¼“å­˜å¤±æ•ˆçš„å€¼ï¼ˆå˜åŠ¨æ—¶å¤±æ•ˆï¼‰ã€‚ :br
  é»˜è®¤åŸºäºå‡½æ•°ä»£ç è®¡ç®—ï¼Œåœ¨å¼€å‘ç¯å¢ƒç”¨äºå‡½æ•°ä»£ç å˜æ›´æ—¶å¤±æ•ˆç¼“å­˜ã€‚
  :::

  :::field{name="maxAge" type="number"}
  ç¼“å­˜æœ€å¤§æœ‰æ•ˆæ—¶é—´ï¼ˆç§’ï¼‰ã€‚ :br
  é»˜è®¤ `1`ï¼ˆç§’ï¼‰ã€‚
  :::

  :::field{name="staleMaxAge" type="number"}
  è¿‡æœŸç¼“å­˜æœ€å¤§æœ‰æ•ˆæ—¶é—´ï¼ˆç§’ï¼‰ã€‚è®¾ç½®ä¸º `-1` æ—¶å¯ç”¨åå°æ›´æ–°åŒæ—¶è¿”å›è¿‡æœŸç¼“å­˜ï¼ˆSWRï¼‰ã€‚ :br
  é»˜è®¤ `0`ï¼ˆç¦ç”¨ï¼‰ã€‚
  :::

  :::field{name="swr" type="boolean"}
  æ˜¯å¦å¯ç”¨ stale-while-revalidate è¡Œä¸ºï¼Œåœ¨å¼‚æ­¥åå°æ›´æ–°æ—¶æä¾›è¿‡æœŸå“åº”ã€‚ :br
  é»˜è®¤ `true`ã€‚
  :::

  :::field{name="shouldInvalidateCache()" type="(...args) => boolean"}
  è¿”å› `boolean`ï¼Œå†³å®šæ˜¯å¦ä½¿å½“å‰ç¼“å­˜å¤±æ•ˆå¹¶åˆ›å»ºæ–°ç¼“å­˜ã€‚
  :::

  :::field{name="shouldBypassCache()" type="(...args) => boolean"}
  è¿”å› `boolean`ï¼Œå†³å®šæ˜¯å¦ç»•è¿‡å½“å‰ç¼“å­˜ä½†ä¸å¤±æ•ˆç°æœ‰ç¼“å­˜æ¡ç›®ã€‚
  :::

  :::field{name="varies" type="string[]"}
  ç”¨äºç¼“å­˜çš„è¯·æ±‚å¤´æ•°ç»„ï¼Œ[äº†è§£æ›´å¤š](https://github.com/nitrojs/nitro/issues/1031){rel=""nofollow""}ã€‚å¤šç§Ÿæˆ·ç¯å¢ƒä¸­å¯ä¼ é€’ `['host', 'x-forwarded-host']`ï¼Œä»¥ç¡®ä¿è¿™äº›è¯·æ±‚å¤´è¢«è€ƒè™‘ä¸”ç¼“å­˜é’ˆå¯¹æ¯ä¸ªç§Ÿæˆ·å”¯ä¸€ã€‚
  :::
::

## ç¼“å­˜é”®å’Œå¤±æ•ˆ

`defineCachedFunction` æˆ– `defineCachedHandler` ç”Ÿæˆç¼“å­˜é”®çš„æ¨¡å¼å¦‚ä¸‹ï¼š

```ts
`${options.group}:${options.name}:${options.getKey(...args)}.json`
```

ä¾‹å¦‚ï¼Œä»¥ä¸‹ç¼“å­˜å‡½æ•°ï¼š

```ts
import { defineCachedFunction } from "nitro/cache";

const getAccessToken = defineCachedFunction(() => {
  return String(Date.now())
}, {
  maxAge: 10,
  name: "getAccessToken",
  getKey: () => "default"
});
```

å…¶ç¼“å­˜é”®å°†ä¸ºï¼š

```ts
nitro:functions:getAccessToken:default.json
```

æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç ä½¿ç¼“å­˜å‡½æ•°çš„æ¡ç›®å¤±æ•ˆï¼š

```ts
import { useStorage } from "nitro/storage";

await useStorage('cache').removeItem('nitro:functions:getAccessToken:default.json')
```

::read-more{to="https://nitro.zhcndoc.com/docs/storage"}
æ›´å¤šå…³äº Nitro å­˜å‚¨çš„å†…å®¹ã€‚
::


# KV å­˜å‚¨

::warning
Nitro v3 Alpha æ–‡æ¡£ä»åœ¨å®Œå–„ä¸­ â€” å¯èƒ½ä¼šæœ‰æ›´æ–°ã€ä¸å®Œå–„ä¹‹å¤„å’Œå¶å°”çš„ä¸å‡†ç¡®ã€‚
::

Nitro å†…ç½®é›†æˆäº† [unstorage](https://unstorage.unjs.io){rel="&#x22;nofollow&#x22;"}ï¼Œä»¥æä¾›ä¸è¿è¡Œæ—¶æ— å…³çš„æŒä¹…å±‚ã€‚

## ç”¨æ³•

è¦ä½¿ç”¨å­˜å‚¨å±‚ï¼Œå¯ä»¥ä½¿ç”¨ `useStorage()` å¹¶è°ƒç”¨ `get(key)` æ¥æ£€ç´¢é¡¹ï¼Œå¹¶ä½¿ç”¨ `set(key, value)` æ¥è®¾ç½®é¡¹ã€‚

```ts
import { useStorage } from "nitro/storage";

// é»˜è®¤å­˜å‚¨åœ¨å†…å­˜ä¸­
await useStorage().set("test:foo", { hello: "world" })
await useStorage().get("test:foo")

// ä½ å¯ä»¥ä½¿ç”¨æ•°æ®å­˜å‚¨å°†æ•°æ®å†™å…¥é»˜è®¤çš„ .data/kv ç›®å½•
const dataStorage = useStorage("data")
await dataStorage.set("test", "works")
await dataStorage.get("data:test") // å€¼æŒä¹…åŒ–

// ä½ ä¹Ÿå¯ä»¥åœ¨ useStorage(base) ä¸­æŒ‡å®šåŸºæ•°
await useStorage("test").set("foo", { hello: "world" })

// ä½ å¯ä»¥ä½¿ç”¨æ³›å‹æ¥å®šä¹‰ç±»å‹
await useStorage<{ hello: string }>("test").get("foo")
await useStorage("test").get<{ hello: string }>("foo")
```

:read-more{to="https://unstorage.unjs.io"}

## é…ç½®

ä½ å¯ä»¥ä½¿ç”¨ `storage` é…ç½®æŒ‚è½½ä¸€ä¸ªæˆ–å¤šä¸ªè‡ªå®šä¹‰å­˜å‚¨é©±åŠ¨ç¨‹åºã€‚ :br
é”®æ˜¯æŒ‚è½½ç‚¹åç§°ï¼Œå€¼æ˜¯é©±åŠ¨ç¨‹åºåç§°å’Œé…ç½®ã€‚

```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  storage: {
    redis: {
      driver: "redis",
      /* redis è¿æ¥å™¨é€‰é¡¹ */
    }
  }
})
```

ç„¶åï¼Œä½ å¯ä»¥ä½¿ç”¨ `useStorage("redis")` å‡½æ•°è®¿é—® redis å­˜å‚¨ã€‚

ä½ å¯ä»¥åœ¨ [unstorage æ–‡æ¡£](https://unstorage.unjs.io/){rel="&#x22;nofollow&#x22;"} ä¸­æ‰¾åˆ°é©±åŠ¨ç¨‹åºåˆ—è¡¨åŠå…¶é…ç½®ã€‚

## ä»…é™å¼€å‘çš„æŒ‚è½½ç‚¹

é»˜è®¤æƒ…å†µä¸‹ï¼ŒNitro å°†åœ¨å¼€å‘æ—¶ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ç¨‹åºæŒ‚è½½é¡¹ç›®ç›®å½•å’Œä¸€äº›å…¶ä»–ç›®å½•ã€‚

```js
// è®¿é—®é¡¹ç›®æ ¹ç›®å½•
const rootStorage = useStorage('root')

// è®¿é—®é¡¹ç›® src ç›®å½•ï¼ˆé»˜è®¤ä¸æ ¹ç›®å½•ç›¸åŒï¼‰
const srcStorage = useStorage('src')

// è®¿é—®æœåŠ¡å™¨ç¼“å­˜ç›®å½•
const cacheStorage = useStorage('cache')

// è®¿é—®ä¸´æ—¶æ„å»ºç›®å½•
const buildStorage = useStorage('build')
```

::tip
ä½ è¿˜å¯ä»¥ä½¿ç”¨ `devStorage` é”®åœ¨å¼€å‘æœŸé—´è¦†ç›–å­˜å‚¨é…ç½®ã€‚å½“ä½ åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨æ•°æ®åº“å¹¶å¸Œæœ›åœ¨å¼€å‘ä¸­ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿæ—¶ï¼Œè¿™éå¸¸æœ‰ç”¨ã€‚
::

ä¸ºäº†ä½¿ç”¨ `devStorage` é”®ï¼Œä½ éœ€è¦ä½¿ç”¨ `nitro dev` å‘½ä»¤ï¼Œå¹¶ä¸” `storage` é€‰é¡¹ä¸­çš„é”®å¿…é¡»ä¸ç”Ÿäº§çš„ç›¸åŒã€‚

::CodeGroup
```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  // ç”Ÿäº§
  storage: {
    default: {
      driver: 'redis',
      /* redis è¿æ¥å™¨é€‰é¡¹ */
    }
  },
  // å¼€å‘
  devStorage: {
    default: {
      driver: 'fs',
      base: './data/kv'
    }
  }
})
```

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  nitro: {
    // ç”Ÿäº§
    storage: {
      db: {
        driver: 'redis',
        /* redis è¿æ¥å™¨é€‰é¡¹ */
      }
    },
    // å¼€å‘
    devStorage: {
      db: {
        driver: 'fs',
        base: './data/db'
      }
    }
  }
})
```
::

## è¿è¡Œæ—¶é…ç½®

åœ¨æŒ‚è½½ç‚¹é…ç½®åœ¨è¿è¡Œæ—¶ä¸ç¡®å®šçš„åœºæ™¯ä¸‹ï¼ŒNitro å¯ä»¥åœ¨å¯åŠ¨æ—¶åŠ¨æ€æ·»åŠ æŒ‚è½½ç‚¹ï¼Œä½¿ç”¨ [æ’ä»¶](https://nitro.zhcndoc.com/docs/plugins)ã€‚

```ts [plugins/storage.ts]
import { useStorage } from "nitro/storage";
import { definePlugin } from "nitro";
import redisDriver from "unstorage/drivers/redis";

export default definePlugin(() => {
  const storage = useStorage()

  // åŠ¨æ€ä¼ å…¥è¿è¡Œæ—¶é…ç½®æˆ–å…¶ä»–æ¥æºçš„å‡­è¯
  const driver = redisDriver({
    base: "redis",
    host: process.env.REDIS_HOST,
    port: process.env.REDIS_PORT,
    /* å…¶ä»– redis è¿æ¥å™¨é€‰é¡¹ */
  })

  // æŒ‚è½½é©±åŠ¨ç¨‹åº
  storage.mount("redis", driver)
})
```

::warning
è¿™æ˜¯ä¸€ä¸ªä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼Œæœªæ¥ä¼šæœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆï¼è¯·å…³æ³¨ GitHub é—®é¢˜ [è¿™é‡Œ](https://github.com/nitrojs/nitro/issues/1161#issuecomment-1511444675){rel=""nofollow""}ã€‚
::


# è¿ç§»æŒ‡å—

::note
è¿™æ˜¯ä¸€ä¸ªå…³äºä» Nitro 2 è¿ç§»åˆ° 3 çš„æ´»æ–‡æ¡£ã€‚åœ¨ä½¿ç”¨æµ‹è¯•ç‰ˆæ—¶è¯·å®šæœŸæ£€æŸ¥ã€‚
::

Nitro v3 å¼•å…¥äº†æ•…æ„çš„ä¸å‘åå…¼å®¹çš„æ›´æ”¹ã€‚æœ¬æŒ‡å—å¸®åŠ©æ‚¨ä» Nitro v2 è¿ç§»ã€‚

## `nitropack` é‡å‘½åä¸º `nitro`

NPM åŒ… [nitropack](https://www.npmjs.com/package/nitropack){rel="&#x22;nofollow&#x22;"}ï¼ˆv2ï¼‰å·²æ›´åä¸º [nitro](https://www.npmjs.com/package/nitro){rel="&#x22;nofollow&#x22;"}ï¼ˆv3ï¼‰ã€‚

**è¿ç§»ï¼š** åœ¨ `package.json` ä¸­æ›´æ–° `nitropack` ä¾èµ–ä¸º `nitro`ï¼š

::note
ç›®å‰åªæä¾›å¤œé—´ç‰ˆæœ¬ã€‚
::

```diff [nightly channel]
{
  "dependencies": {
--    "nitropack": "latest"
++    "nitro": "npm:nitro-nightly"
  }
}
```

**è¿ç§»ï¼š** åœ¨æ‚¨çš„ä»£ç åº“ä¸­æœç´¢å¹¶å°†æ‰€æœ‰ `nitropack` å®ä¾‹é‡å‘½åä¸º `nitro`ï¼š

```diff
-- import { defineNitroConfig } from "nitropack/config"
++ import { defineNitroConfig } from "nitro/config"
```

## nitro/runtime

è¿è¡Œæ—¶å·¥å…·å·²è¢«ç§»è‡³å„è‡ªçš„ `nitro/*` å­è·¯å¾„å¯¼å‡ºã€‚è¯·å‚è€ƒæ–‡æ¡£ä»¥äº†è§£ç”¨æ³•ã€‚

```diff
-- import { useStorage } from "nitropack/runtime/storage"
++ import { useStorage } from "nitro/storage"
```

## æœ€ä½æ”¯æŒçš„ Node.js ç‰ˆæœ¬ï¼š20

Nitro ç°åœ¨è¦æ±‚æœ€ä½ Node.js ç‰ˆæœ¬ä¸º 20ï¼Œå› ä¸º Node.js 18 å°†åœ¨ [2025 å¹´ 4 æœˆ](https://node.zhcndoc.com/zh-cn/about/previous-releases){rel="&#x22;nofollow&#x22;"} è¾¾åˆ°ç”Ÿå‘½å‘¨æœŸç»“æŸã€‚

è¯·å‡çº§åˆ° [æœ€æ–°çš„ LTS](https://node.zhcndoc.com/zh-cn/download){rel="&#x22;nofollow&#x22;"} ç‰ˆæœ¬ï¼ˆ>= 20ï¼‰ã€‚

**è¿ç§»ï¼š**

- ä½¿ç”¨ `node --version` æ£€æŸ¥æ‚¨çš„æœ¬åœ° Node.js ç‰ˆæœ¬ï¼Œå¦‚æœ‰å¿…è¦è¯·æ›´æ–°ã€‚
- å¦‚æœæ‚¨ä½¿ç”¨ CI/CD ç³»ç»Ÿè¿›è¡Œéƒ¨ç½²ï¼Œè¯·ç¡®ä¿æ‚¨çš„ç®¡é“æ­£åœ¨è¿è¡Œ Node.js 20 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚
- å¦‚æœæ‚¨çš„æ‰˜ç®¡æä¾›å•†ç®¡ç† Node.js è¿è¡Œæ—¶ï¼Œè¯·ç¡®ä¿å®ƒè®¾ç½®ä¸ºç‰ˆæœ¬ 20ã€22 æˆ–æ›´é«˜ã€‚

## ç±»å‹å¯¼å…¥

Nitro ç±»å‹ç°åœ¨ä»…ä» `nitro/types` å¯¼å‡ºã€‚

**è¿ç§»ï¼š** ä» `nitro/types` å¯¼å…¥ç±»å‹ï¼Œè€Œä¸æ˜¯ä» `nitro`ï¼š

```diff
-- import { NitroRuntimeConfig } from "nitropack"
++ import { NitroRuntimeConfig } from "nitro/types"
```

## åº”ç”¨é…ç½®æ”¯æŒå·²ç§»é™¤

Nitro v2 æ”¯æŒä¸€ä¸ªæ†ç»‘çš„åº”ç”¨é…ç½®ï¼Œå¯ä»¥åœ¨ `app.config.ts` ä¸­å®šä¹‰é…ç½®ï¼Œå¹¶é€šè¿‡ `useAppConfig()` åœ¨è¿è¡Œæ—¶è®¿é—®å®ƒä»¬ã€‚

æ­¤åŠŸèƒ½å·²è¢«ç§»é™¤ã€‚

**è¿ç§»ï¼š**

åœ¨æ‚¨çš„æœåŠ¡å™¨ç›®å½•ä¸­ä½¿ç”¨å¸¸è§„çš„ `.ts` æ–‡ä»¶å¹¶ç›´æ¥å¯¼å…¥ã€‚

## é¢„è®¾æ›´æ–°

Nitro é¢„è®¾å·²æ›´æ–°ä»¥ç¡®ä¿ä¸æœ€æ–°ç‰ˆæœ¬å…¼å®¹ã€‚

ä¸€äº›ï¼ˆé—ç•™ï¼‰é¢„è®¾å·²è¢«ç§»é™¤æˆ–é‡å‘½åã€‚

| æ—§é¢„è®¾                                                           | æ–°é¢„è®¾                                   |
| ------------------------------------------------------------- | ------------------------------------- |
| `node`                                                        | `node-middleware`ï¼ˆå¯¼å‡ºæ›´æ”¹ä¸º `middleware`ï¼‰ |
| `cloudflare`, `cloudflare_worker`, `cloudflare_module_legacy` | `cloudflare_module`                   |
| `deno-server-legacy`                                          | `deno_server`ï¼Œä½¿ç”¨ Deno v2              |
| `netlify-builder`                                             | `netlify_functions` æˆ– `netlify_edge`  |
| `vercel-edge`                                                 | `vercel`ï¼Œå¯ç”¨ Fluid è®¡ç®—                  |
| `azure`, `azure_functions`                                    | `azure_swa`                           |
| `firebase`                                                    | `firebase-functions`                  |
| `iis`                                                         | `iis-handler`                         |
| `deno`                                                        | `deno-deploy`                         |
| `edgio`                                                       | å·²åœäº§                                   |
| `cli`                                                         | å› ä½¿ç”¨ä¸è¶³è€Œç§»é™¤                              |
| `service_worker`                                              | å› ä¸ç¨³å®šæ€§è€Œç§»é™¤                              |
| `firebase`                                                    | ä½¿ç”¨æ–°çš„ Firebase åº”ç”¨æ‰˜ç®¡                    |

## ç§»é™¤çš„å­è·¯å¾„å¯¼å‡º

Nitro v2 å¼•å…¥äº†å¤šä¸ªå­è·¯å¾„å¯¼å‡ºï¼Œå…¶ä¸­ä¸€äº›å·²è¢«ç§»é™¤æˆ–æ›´æ–°ï¼š

- `nitro/rollup`ã€`nitropack/core`ï¼ˆè¯·ä½¿ç”¨ `nitro/builder`ï¼‰
- `nitropack/runtime/*`ï¼ˆè¯·ä½¿ç”¨ `nitro/*`ï¼‰
- `nitropack/kit`ï¼ˆå·²ç§»é™¤ï¼‰
- `nitropack/presets`ï¼ˆå·²ç§»é™¤ï¼‰

æ›¾ç»å¼•å…¥äº†ä¸€ä¸ªå®éªŒæ€§çš„ `nitropack/kit`ï¼Œä½†ç°åœ¨å·²ç»è¢«ç§»é™¤ã€‚æœªæ¥å¯èƒ½ä¼šæ¨å‡ºä¸€ä¸ªç‹¬ç«‹çš„ Nitro Kit åŒ…ï¼Œå¹¶ä¸”ç›®æ ‡ä¼šæ›´åŠ æ˜ç¡®ã€‚

**Migration:**

- ä½¿ç”¨æ¥è‡ª `nitro/types` çš„ `NitroModule`ï¼Œè€Œä¸æ˜¯æ¥è‡ª kit çš„ `defineNitroModule`ã€‚
- ä¼˜å…ˆä½¿ç”¨å†…ç½®çš„ Nitro é¢„è®¾ï¼ˆå¤–éƒ¨é¢„è®¾ä»…ä¾›è¯„ä¼°ä½¿ç”¨ï¼‰ã€‚

## å¯é€‰é’©å­

å¦‚æœæ‚¨ä¹‹å‰åœ¨ Nitro æ’ä»¶å¤–éƒ¨ä½¿ç”¨è¿‡ `useNitroApp().hooks`ï¼Œå®ƒå¯èƒ½ä¸º undefinedã€‚è¯·ä½¿ç”¨æ–°çš„ `useNitroHooks()` æ¥ä¿è¯è·å¾—å®ä¾‹ã€‚


# å¤œé—´é€šé“

æ‚¨å¯ä»¥é€šè¿‡æ›´æ–° `package.json` æ¥é€‰æ‹©åŠ å…¥å¤œé—´å‘å¸ƒé€šé“ï¼š

```json
{
  "devDependencies": {
    "nitro": "npm:nitro-nightly@latest"
  }
}
```

```diff [Nuxt]
{
  "devDependencies": {
-    "nuxt": "^3.0.0"
+    "nuxt": "npm:nuxt-nightly@latest"
  }
}
```

\::

::note
å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨ Nuxtï¼Œ[è¯·ä½¿ç”¨ Nuxt å¤œé—´é€šé“](https://nuxt.zhcndoc.com/docs/guide/going-further/nightly-release-channel#opting-in){rel=""nofollow""}ï¼Œå› ä¸ºå®ƒå·²ç»åŒ…å« `nitropack-nightly`ã€‚
::

åˆ é™¤é”æ–‡ä»¶ï¼ˆ`package-lock.json`ã€`yarn.lock`ã€`pnpm-lock.yaml`ã€`bun.lock` æˆ– `bun.lockb`ï¼‰å¹¶é‡æ–°å®‰è£…ä¾èµ–é¡¹ã€‚

::important
åœ¨å•ä»“åº“ä¸­ä½¿ç”¨ **Bun ä½œä¸ºåŒ…ç®¡ç†å™¨** æ—¶ï¼Œéœ€è¦ç¡®ä¿ nitro åŒ…è¢«æ­£ç¡®æå‡ã€‚

:br

```toml [bunfig.toml]
[install]
publicHoistPattern = ["nitro*"]
```
::

::important
é¿å…ä½¿ç”¨ `<npm|pnpm|yarn|bun|deno> install nitro-nightly`ï¼›è¿™æ ·å®‰è£…ä¸æ­£ç¡®ã€‚
å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·åˆ é™¤ `node_modules` å’Œé”æ–‡ä»¶ï¼Œç„¶åæŒ‰ç…§ä»¥ä¸Šæ­¥éª¤æ“ä½œã€‚
::


# æ¦‚è¿°

Nitro å¯ä»¥ä»ç›¸åŒçš„ä»£ç åº“ç”Ÿæˆé€‚åˆä¸åŒæ‰˜ç®¡æä¾›è€…çš„ä¸åŒè¾“å‡ºæ ¼å¼ã€‚é€šè¿‡ä½¿ç”¨å†…ç½®çš„é¢„è®¾ï¼Œæ‚¨å¯ä»¥è½»æ¾é…ç½® Nitro ä»¥å‡ ä¹ä¸éœ€è¦é¢å¤–ä»£ç æˆ–é…ç½®åœ°è°ƒæ•´å…¶è¾“å‡ºæ ¼å¼ï¼

## é»˜è®¤è¾“å‡º

é»˜è®¤çš„ç”Ÿäº§è¾“å‡ºé¢„è®¾æ˜¯ [Node.js server](https://nitro.zhcndoc.com/deploy/node)ã€‚

åœ¨å¼€å‘æ¨¡å¼ä¸‹è¿è¡Œ Nitro æ—¶ï¼ŒNitro æ€»æ˜¯ä¼šä½¿ç”¨åä¸º `nitro-dev` çš„ç‰¹æ®Šé¢„è®¾ï¼Œè¯¥é¢„è®¾ä½¿ç”¨ Node.js ä»¥ ESM çš„å½¢å¼åœ¨éš”ç¦»çš„ Worker ç¯å¢ƒä¸­è¿è¡Œï¼Œå°½å¯èƒ½æ¥è¿‘ç”Ÿäº§ç¯å¢ƒçš„è¡Œä¸ºã€‚

## é›¶é…ç½®æä¾›è€…

åœ¨ä½¿ç”¨ CI/CD éƒ¨ç½²ç”Ÿäº§ç¯å¢ƒæ—¶ï¼ŒNitro ä¼šå°è¯•è‡ªåŠ¨æ£€æµ‹æä¾›è€…ç¯å¢ƒå¹¶ç›¸åº”åœ°è®¾ç½®æ­£ç¡®çš„é…ç½®ï¼Œæ— éœ€ä»»ä½•é¢å¤–é…ç½®ã€‚ç›®å‰ï¼Œä»¥ä¸‹æä¾›è€…å¯ä»¥é€šè¿‡é›¶é…ç½®è‡ªåŠ¨æ£€æµ‹ã€‚

- [aws amplify](https://nitro.zhcndoc.com/deploy/providers/aws-amplify)
- [azure](https://nitro.zhcndoc.com/deploy/providers/azure)
- [cloudflare](https://nitro.zhcndoc.com/deploy/providers/cloudflare)
- [firebase app hosting](https://nitro.zhcndoc.com/deploy/providers/firebase#firebase-app-hosting)
- [netlify](https://nitro.zhcndoc.com/deploy/providers/netlify)
- [stormkit](https://nitro.zhcndoc.com/deploy/providers/stormkit)
- [vercel](https://nitro.zhcndoc.com/deploy/providers/vercel)
- [zeabur](https://nitro.zhcndoc.com/deploy/providers/zeabur)

::warning
å¯¹äº Turborepo ç”¨æˆ·ï¼Œé›¶é…ç½®æ£€æµ‹å°†å—åˆ°å…¶ä¸¥æ ¼ç¯å¢ƒæ¨¡å¼çš„å¹²æ‰°ã€‚æ‚¨å¯èƒ½éœ€è¦æ˜¾å¼åœ°å…è®¸å˜é‡ï¼Œæˆ–ä½¿ç”¨å…¶å®½æ¾ç¯å¢ƒæ¨¡å¼ï¼ˆä½¿ç”¨ `--env-mode=loose` æ ‡å¿—ï¼‰ã€‚
::

## æ›´æ”¹éƒ¨ç½²é¢„è®¾

å¦‚æœæ‚¨éœ€è¦é’ˆå¯¹ç‰¹å®šæä¾›è€…æ„å»º Nitroï¼Œæ‚¨å¯ä»¥é€šè¿‡å®šä¹‰åä¸º `NITRO_PRESET` æˆ– `SERVER_PRESET` çš„ç¯å¢ƒå˜é‡ï¼Œæˆ–è€…é€šè¿‡æ›´æ–°æ‚¨çš„ Nitro [é…ç½®](https://nitro.zhcndoc.com/docs/configuration)ï¼Œæˆ–ä½¿ç”¨ `--preset` å‚æ•°æ¥æŒ‡å®šç›®æ ‡ã€‚

å»ºè®®åœ¨ä¾èµ–äº CI/CD çš„éƒ¨ç½²ä¸­ä½¿ç”¨ç¯å¢ƒå˜é‡çš„æ–¹æ³•ã€‚

**ç¤ºä¾‹ï¼š** å®šä¹‰ `NITRO_PRESET` ç¯å¢ƒå˜é‡

```bash
nitro build --preset cloudflare_pages
```

**ç¤ºä¾‹ï¼š** æ›´æ–° `nitro.config.ts` æ–‡ä»¶

```ts
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  preset: 'cloudflare_pages'
})
```

## å…¼å®¹æ€§æ—¥æœŸ

éƒ¨ç½²æä¾›è€…å®šæœŸæ›´æ–°ä»–ä»¬çš„è¿è¡Œæ—¶è¡Œä¸ºã€‚Nitro é¢„è®¾ä¼šæ›´æ–°ä»¥æ”¯æŒè¿™äº›æ–°åŠŸèƒ½ã€‚

ä¸ºäº†é˜²æ­¢ç ´åç°æœ‰éƒ¨ç½²ï¼ŒNitro ä½¿ç”¨å…¼å®¹æ€§æ—¥æœŸã€‚è¯¥æ—¥æœŸå…è®¸æ‚¨åœ¨é¡¹ç›®åˆ›å»ºæ—¶é”å®šè¡Œä¸ºã€‚æ‚¨è¿˜å¯ä»¥é€‰æ‹©åœ¨å‡†å¤‡å¥½æ—¶é€‰æ‹©æœªæ¥çš„æ›´æ–°ã€‚

å½“æ‚¨åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®æ—¶ï¼Œ`compatibilityDate` è¢«è®¾ç½®ä¸ºå½“å‰æ—¥æœŸã€‚æ­¤è®¾ç½®ä¼šä¿å­˜åœ¨æ‚¨çš„é¡¹ç›®é…ç½®ä¸­ã€‚

æ‚¨åº”è¯¥å®šæœŸæ›´æ–°å…¼å®¹æ€§æ—¥æœŸã€‚æ›´æ–°åï¼Œè¯·å§‹ç»ˆå½»åº•æµ‹è¯•æ‚¨çš„éƒ¨ç½²ã€‚ä»¥ä¸‹æ˜¯å…³é”®æ—¥æœŸåŠå…¶å½±å“çš„åˆ—è¡¨ã€‚


# Node.js

**é¢„è®¾:** `node_server`

Node.js æ˜¯ç”Ÿäº§æ„å»ºçš„é»˜è®¤ Nitro è¾“å‡ºé¢„è®¾ï¼Œå¹¶ä¸” Nitro åŸç”Ÿæ”¯æŒ Node.js è¿è¡Œæ—¶ã€‚

ä½¿ç”¨ nitro CLI æ„å»ºé¡¹ç›®ï¼š

```bash
nitro build
```

å½“ä½¿ç”¨ Node æœåŠ¡å™¨é¢„è®¾è¿è¡Œ `nitro build` æ—¶ï¼Œç»“æœå°†æ˜¯ä¸€ä¸ªå¯åŠ¨å‡†å¤‡å°±ç»ªçš„ Node æœåŠ¡å™¨çš„å…¥å£ç‚¹ã€‚è¦å°è¯•è¾“å‡ºï¼š

```bash
$ node .output/server/index.mjs
æ­£åœ¨ç›‘å¬ http://localhost:3000
```

æ‚¨ç°åœ¨å¯ä»¥å°†å®Œå…¨ç‹¬ç«‹çš„ `.output` ç›®å½•éƒ¨ç½²åˆ°æ‚¨é€‰æ‹©çš„æ‰˜ç®¡æœåŠ¡ã€‚

### ç¯å¢ƒå˜é‡

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ç¯å¢ƒå˜é‡è‡ªå®šä¹‰æœåŠ¡å™¨è¡Œä¸ºï¼š

- `NITRO_PORT` æˆ– `PORT`ï¼ˆé»˜è®¤ä¸º `3000`ï¼‰
- `NITRO_HOST` æˆ– `HOST`
- `NITRO_UNIX_SOCKET` - å¦‚æœæä¾›ï¼ˆä¸€ä¸ªæŒ‡å‘æ‰€éœ€å¥—æ¥å­—æ–‡ä»¶çš„è·¯å¾„ï¼‰ï¼Œåˆ™æœåŠ¡å°†é€šè¿‡æä¾›çš„ UNIX å¥—æ¥å­—æä¾›æœåŠ¡ã€‚
- `NITRO_SSL_CERT` å’Œ `NITRO_SSL_KEY` - å¦‚æœä¸¤è€…éƒ½å­˜åœ¨ï¼Œåˆ™æœåŠ¡å™¨å°†åœ¨ HTTPS æ¨¡å¼ä¸‹å¯åŠ¨ã€‚åœ¨ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œè¿™ä¸åº”åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ï¼ŒNitro æœåŠ¡å™¨åº”ä½äºåå‘ä»£ç†åï¼Œä¾‹å¦‚ nginx æˆ– Cloudflareï¼Œè¯¥ä»£ç†ç»ˆæ­¢ SSLã€‚
- `NITRO_SHUTDOWN_DISABLED` - å½“è®¾ç½®ä¸º `'true'` æ—¶ï¼Œç¦ç”¨ä¼˜é›…å…³é—­åŠŸèƒ½ã€‚å¦‚æœè®¾ç½®ä¸º `'true'`ï¼Œåˆ™å°†è·³è¿‡ä¼˜é›…å…³é—­ä»¥åŠ é€Ÿå¼€å‘è¿‡ç¨‹ã€‚é»˜è®¤ä¸º `'false'`ã€‚
- `NITRO_SHUTDOWN_SIGNALS` - å…è®¸æ‚¨æŒ‡å®šåº”å¤„ç†å“ªäº›ä¿¡å·ã€‚æ¯ä¸ªä¿¡å·åº”ä»¥ç©ºæ ¼åˆ†éš”ã€‚é»˜è®¤ä¸º `'SIGINT SIGTERM'`ã€‚
- `NITRO_SHUTDOWN_TIMEOUT` - è®¾ç½®å¼ºåˆ¶å…³é—­å‘ç”Ÿå‰çš„æ—¶é—´ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ã€‚é»˜è®¤ä¸º `'30000'` æ¯«ç§’ã€‚
- `NITRO_SHUTDOWN_FORCE` - å½“è®¾ç½®ä¸º true æ—¶ï¼Œåœ¨å…³é—­è¿‡ç¨‹ç»“æŸæ—¶è§¦å‘ `process.exit()`ã€‚å¦‚æœè®¾ç½®ä¸º `'false'`ï¼Œè¿›ç¨‹å°†ç®€å•åœ°è®©äº‹ä»¶å¾ªç¯æ¸…ç†ã€‚é»˜è®¤ä¸º `'true'`ã€‚

## é›†ç¾¤æ¨¡å¼

**é¢„è®¾:** `node_cluster`

ä¸ºäº†æ›´é«˜çš„æ€§èƒ½å¹¶åˆ©ç”¨å¤šæ ¸å¤„ç†ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨é›†ç¾¤é¢„è®¾ã€‚

### ç¯å¢ƒå˜é‡

é™¤äº†æ¥è‡ª `node_server` é¢„è®¾çš„ç¯å¢ƒå˜é‡ï¼Œæ‚¨è¿˜å¯ä»¥è‡ªå®šä¹‰è¡Œä¸ºï¼š

- `NITRO_CLUSTER_WORKERS`: é›†ç¾¤å·¥ä½œè¿›ç¨‹çš„æ•°é‡ï¼ˆé»˜è®¤ä¸ºå¯ç”¨ CPU å†…æ ¸æ•°é‡ï¼‰

## å¤„ç†ç¨‹åºï¼ˆé«˜çº§ï¼‰

**é¢„è®¾:** `node`

Nitro è¿˜æœ‰ä¸€ä¸ªæ›´ä½çº§çš„é¢„è®¾ï¼Œç›´æ¥å¯¼å‡ºä¸€ä¸ªå…·æœ‰ `(req, res) => {}` ç­¾åçš„å‡½æ•°ï¼Œå¯ç”¨äºä¸­é—´ä»¶å’Œè‡ªå®šä¹‰æœåŠ¡å™¨ã€‚

å½“ä½¿ç”¨ Node é¢„è®¾è¿è¡Œ `nitro build` æ—¶ï¼Œç»“æœå°†æ˜¯ä¸€ä¸ªå¯¼å‡ºå…·æœ‰ `(req, res) => {}` ç­¾åçš„å‡½æ•°çš„å…¥å£ç‚¹ã€‚

**ç¤ºä¾‹ï¼š**

```js
import { createServer } from 'node:http'
import { listener } from './.output/server'

const server = createServer(listener)
server.listen(8080)
```


# Bun

**é¢„è®¾:** `bun`

Nitro è¾“å‡ºä¸ Bun è¿è¡Œæ—¶å…¼å®¹ã€‚åœ¨ä½¿ç”¨é»˜è®¤çš„ [Node.js](https://nitro.zhcndoc.com/deploy/runtimes/node) çš„åŒæ—¶ï¼Œæ‚¨ä¹Ÿå¯ä»¥åœ¨ bun ä¸­è¿è¡Œè¾“å‡ºï¼Œä½¿ç”¨ `bun` é¢„è®¾çš„ä¼˜åŠ¿åœ¨äºæ›´å¥½çš„ä¼˜åŒ–ã€‚

ä½¿ç”¨ bun é¢„è®¾æ„å»ºåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤åœ¨ç”Ÿäº§ä¸­è¿è¡ŒæœåŠ¡å™¨ï¼š

```bash
bun run ./.output/server/index.mjs
```

:read-more{to="https://bun.zhcndoc.com"}


# Deno

**é¢„è®¾:** `deno_server`

æ‚¨å¯ä»¥ä½¿ç”¨ Node.js æ„å»º Nitro æœåŠ¡å™¨ï¼Œä»¥ä¾¿åœ¨è‡ªå®šä¹‰æœåŠ¡å™¨ä¸­è¿è¡Œäº [Deno Runtime](https://deno.zhcndoc.com/runtime){rel="&#x22;nofollow&#x22;"}ã€‚

```bash
# ä½¿ç”¨ deno NITRO é¢„è®¾æ„å»º
NITRO_PRESET=deno_server npm run build

# å¯åŠ¨ç”Ÿäº§æœåŠ¡å™¨
deno run --unstable --allow-net --allow-read --allow-env .output/server/index.ts
```

## Deno Deploy

:read-more{to="https://nitro.zhcndoc.com/deploy/providers/deno-deploy"}


# Alwaysdata

**é¢„è®¾:** `alwaysdata`

:read-more{to="https://alwaysdata.com"}

## è®¾ç½®åº”ç”¨ç¨‹åº

### å‰ææ¡ä»¶

::steps{level="4"}
#### å¦‚æœæ‚¨è¿˜æ²¡æœ‰ï¼Œ [åœ¨ alwaysdata å¹³å°ä¸Šæ³¨å†Œä¸€ä¸ªæ–°è´¦æˆ·](https://www.alwaysdata.com/en/register/){rel=""nofollow""}ã€‚

#### è·å–ä¸€ä¸ªå…è´¹çš„ 100Mb è®¡åˆ’æ¥æ‰˜ç®¡æ‚¨çš„åº”ç”¨ã€‚
::

::note
è¯·è®°ä½ï¼Œæ‚¨çš„ *è´¦æˆ·å* å°†ç”¨äºä¸ºæ‚¨æä¾›ä¸€ä¸ªé»˜è®¤ URLï¼Œå…¶å½¢å¼ä¸º `account_name.alwaysdata.net`ï¼Œå› æ­¤è¯·æ˜æ™ºåœ°é€‰æ‹©ã€‚æ‚¨ä¹Ÿå¯ä»¥ç¨åå°†æ‚¨ç°æœ‰çš„åŸŸåä¸æ‚¨çš„è´¦æˆ·é“¾æ¥ï¼Œæˆ–è€…æ ¹æ®éœ€è¦åœ¨æ‚¨çš„ä¸ªäººèµ„æ–™ä¸‹æ³¨å†Œå¤šä¸ªè´¦æˆ·ã€‚
::

### æœ¬åœ°éƒ¨ç½²

::steps{level="4"}
#### ä½¿ç”¨ `npm run build -- preset alwaysdata` åœ¨æœ¬åœ°æ„å»ºæ‚¨çš„é¡¹ç›®ã€‚

#### [å°†æ‚¨çš„åº”ç”¨ä¸Šä¼ ](https://help.alwaysdata.com/en/remote-access/){rel=""nofollow""}åˆ°æ‚¨çš„è´¦æˆ·çš„ç‹¬ç«‹ç›®å½•ä¸­ï¼ˆä¾‹å¦‚ `$HOME/www/my-app`ï¼‰ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•æ‚¨åå¥½çš„åè®®ï¼ˆSSH/FTP/WebDAV ç­‰ï¼‰æ¥åšåˆ°è¿™ä¸€ç‚¹ã€‚

#### åœ¨æ‚¨çš„ç®¡ç†é¢æ¿ä¸Šï¼Œä¸ºæ‚¨çš„åº”ç”¨ [åˆ›å»ºä¸€ä¸ªæ–°ç«™ç‚¹](https://admin.alwaysdata.com/site/add/){rel=""nofollow""} ï¼Œå¹¶è®¾ç½®ä»¥ä¸‹ç‰¹æ€§:* *åœ°å€*: `[account_name].alwaysdata.net`
* *ç±»å‹*: Node.js
* *å‘½ä»¤*: `node ./output/server/index.mjs`
* *å·¥ä½œç›®å½•*: `www/my-app` ï¼ˆè¯·æ ¹æ®æ‚¨çš„éƒ¨ç½²è·¯å¾„è¿›è¡Œè°ƒæ•´ï¼‰
* *ç¯å¢ƒ*:
  ```ini
  NITRO_PRESET=alwaysdata
  ```
* *Node.js ç‰ˆæœ¬*: `é»˜è®¤ç‰ˆæœ¬` å³å¯ï¼›é€‰æ‹©ä¸ä½äº `20.0.0`ï¼ˆæ‚¨ä¹Ÿå¯ä»¥[å…¨å±€è®¾ç½®æ‚¨çš„ Node.js ç‰ˆæœ¬](https://help.alwaysdata.com/en/languages/nodejs/configuration/#supported-versions){rel=""nofollow""}ï¼‰
* *çƒ­é‡å¯*: `SIGHUP`:read-more{title="è·å–æœ‰å…³ alwaysdata Node.js ç«™ç‚¹ç±»å‹çš„æ›´å¤šä¿¡æ¯" to="https://help.alwaysdata.com/en/languages/nodejs"}

#### æ‚¨çš„åº”ç”¨ç°åœ¨å·²ä¸Šçº¿ï¼Œåœ°å€ä¸º `http(s)://[account_name].alwaysdata.net`ã€‚
::


# AWS Lambda

**é¢„è®¾:** `aws_lambda`

:read-more{title="AWS Lambda" to="https://aws.amazon.com/lambda/"}

Nitro æä¾›äº†ä¸€ä¸ªå†…ç½®é¢„è®¾ï¼Œç”¨äºç”Ÿæˆä¸ [AWS Lambda](https://aws.amazon.com/lambda/){rel="&#x22;nofollow&#x22;"} å…¼å®¹çš„è¾“å‡ºæ ¼å¼ã€‚`.output/server/index.mjs` ä¸­çš„è¾“å‡ºå…¥å£ç‚¹ä¸ [AWS Lambda æ ¼å¼](https://docs.aws.amazon.com/lex/latest/dg/lambda-input-response-format.html){rel="&#x22;nofollow&#x22;"} å…¼å®¹ã€‚

å®ƒå¯ä»¥è¢«ç¨‹åºåŒ–ä½¿ç”¨æˆ–ä½œä¸ºéƒ¨ç½²çš„ä¸€éƒ¨åˆ†ã€‚

```ts
import { handler } from './.output/server'

// ç¨‹åºåŒ–ä½¿ç”¨
const { statusCode, headers, body } = handler({ rawPath: '/' })
```

## å†…è”å—

Nitro çš„è¾“å‡ºé»˜è®¤ä½¿ç”¨åŠ¨æ€å—ï¼Œä»…åœ¨éœ€è¦æ—¶æ‡’åŠ è½½ä»£ç ã€‚ç„¶è€Œè¿™æœ‰æ—¶å¹¶ä¸æ˜¯æ€§èƒ½çš„æœ€ä½³é€‰æ‹©ã€‚(å‚è§ [nitrojs/nitro#650](https://github.com/nitrojs/nitro/pull/650){rel="&#x22;nofollow&#x22;"} ä¸­çš„è®¨è®º)ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ [`inlineDynamicImports`](https://nitro.zhcndoc.com/config#inlinedynamicimports) é…ç½®å¯ç”¨å—å†…è”è¡Œä¸ºã€‚

::CodeGroup
```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  inlineDynamicImports: true
});
```

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  nitro: {
    inlineDynamicImports: true
  }
})
```
::

\::

## å“åº”æµ

:read-more{title="ä»‹ç» AWS Lambda å“åº”æµ" to="https://aws.amazon.com/blogs/compute/introducing-aws-lambda-response-streaming/"}

ä¸ºäº†å¯ç”¨å“åº”æµï¼Œå¯ç”¨ `awsLambda.streaming` æ ‡å¿—ï¼š

```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  awsLambda: {
    streaming: true
  }
});
```


# AWS Amplify

**é¢„è®¾:** `aws_amplify`

:read-more{title="AWS Amplify Hosting" to="https://aws.amazon.com/amplify"}

## éƒ¨ç½²åˆ° AWS Amplify Hosting

::tip
ä¸è¯¥æä¾›å•†çš„é›†æˆå¯ä»¥é€šè¿‡ [é›¶é…ç½®](https://nitro.zhcndoc.com/deploy/#zero-config-providers) å®ç°ã€‚
::

::steps{level="4"}
#### ç™»å½•åˆ° [AWS Amplify Hosting æ§åˆ¶å°](https://console.aws.amazon.com/amplify/){rel=""nofollow""}

#### ç‚¹å‡» "å¼€å§‹ä½¿ç”¨" > Amplify Hosting (æ‰˜ç®¡ä½ çš„ web åº”ç”¨)

#### é€‰æ‹©å¹¶æˆæƒè®¿é—®ä½ çš„ Git ä»“åº“æä¾›å•†ï¼Œå¹¶é€‰æ‹©ä¸»åˆ†æ”¯

#### ä¸ºä½ çš„åº”ç”¨ç¨‹åºé€‰æ‹©ä¸€ä¸ªåç§°ï¼Œç¡®ä¿æ„å»ºè®¾ç½®è¢«è‡ªåŠ¨æ£€æµ‹ï¼Œå¹¶åœ¨é«˜çº§éƒ¨åˆ†å¯é€‰åœ°è®¾ç½®ç¯å¢ƒå˜é‡

#### å¯é€‰åœ°é€‰æ‹©å¯ç”¨ SSR æ—¥å¿—è®°å½•ï¼Œä»¥ä¾¿å°†æœåŠ¡å™¨ç«¯æ—¥å¿—è®°å½•åˆ°ä½ çš„ Amazon CloudWatch å¸æˆ·

#### ç¡®è®¤é…ç½®å¹¶ç‚¹å‡» "ä¿å­˜å¹¶éƒ¨ç½²"
::

## é«˜çº§é…ç½®

ä½ å¯ä»¥ä½¿ç”¨ `awsAmplify` é€‰é¡¹é…ç½®è¯¥é¢„è®¾çš„é«˜çº§é€‰é¡¹ã€‚

```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  awsAmplify: {
      // catchAllStaticFallback: true,
      // imageOptimization: { path: "/_image", cacheControl: "public, max-age=3600, immutable" },
      // imageSettings: { ... },
      // runtime: "nodejs18.x", // default: "nodejs18.x" | "nodejs16.x" | "nodejs20.x"
  }
})
```

### `amplify.yml`

ä½ å¯èƒ½éœ€è¦ä¸€ä¸ªè‡ªå®šä¹‰çš„ `amplify.yml` æ–‡ä»¶ç”¨äºé«˜çº§é…ç½®ã€‚ä»¥ä¸‹æ˜¯ä¸¤ä¸ªæ¨¡æ¿ç¤ºä¾‹ï¼š

::code-group
```yml [amplify.yml]
version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm use 18 && node --version
        - corepack enable && npx --yes nypm install
    build:
      commands:
        - pnpm build
  artifacts:
    baseDirectory: .amplify-hosting
    files:
      - "**/*"
```

```yml [amplify.yml (å•ä½“ä»“åº“)]
version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
          - nvm use 18 && node --version
          - corepack enable && npx --yes nypm install
        build:
          commands:
            - pnpm --filter website1 build
      artifacts:
        baseDirectory: apps/website1/.amplify-hosting
        files:
          - '**/*'
      buildPath: /
    appRoot: apps/website1
```
::


# Azure

## Azure é™æ€ Web åº”ç”¨

**é¢„è®¾:** `azure-swa`

:read-more{title="Azure é™æ€ Web åº”ç”¨" to="https://azure.microsoft.com/en-us/products/app-service/static"}

::note
ä¸æ­¤æä¾›ç¨‹åºçš„é›†æˆå¯ä»¥é€šè¿‡ [é›¶é…ç½®](https://nitro.zhcndoc.com/deploy/#zero-config-providers) å®ç°ã€‚
::

[Azure é™æ€ Web åº”ç”¨](https://azure.microsoft.com/en-us/products/app-service/static){rel="&#x22;nofollow&#x22;"} æ—¨åœ¨åœ¨ [GitHub Actions å·¥ä½œæµ](https://docs.microsoft.com/en-us/azure/static-web-apps/github-actions-workflow){rel="&#x22;nofollow&#x22;"} ä¸­è¿›è¡ŒæŒç»­éƒ¨ç½²ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒNitro å°†æ£€æµ‹æ­¤éƒ¨ç½²ç¯å¢ƒå¹¶å¯ç”¨ `azure` é¢„è®¾ã€‚

### æœ¬åœ°é¢„è§ˆ

å¦‚æœæ‚¨æƒ³è¦è¿›è¡Œæœ¬åœ°æµ‹è¯•ï¼Œè¯·å®‰è£… [Azure Functions Core Tools](https://docs.microsoft.com/en-us/azure/azure-functions/functions-run-local){rel="&#x22;nofollow&#x22;"}ã€‚

æ‚¨å¯ä»¥è°ƒç”¨å¼€å‘ç¯å¢ƒä»¥åœ¨éƒ¨ç½²ä¹‹å‰è¿›è¡Œé¢„è§ˆã€‚

```bash
NITRO_PRESET=azure npx nypm@latest build
npx @azure/static-web-apps-cli start .output/public --api-location .output/server
```

### é…ç½®

Azure é™æ€ Web åº”ç”¨ä½¿ç”¨ `staticwebapp.config.json` æ–‡ä»¶è¿›è¡Œ [é…ç½®](https://learn.microsoft.com/en-us/azure/static-web-apps/configuration){rel="&#x22;nofollow&#x22;"}ã€‚

Nitro æ¯å½“ä½¿ç”¨ `azure` é¢„è®¾æ„å»ºåº”ç”¨æ—¶ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆæ­¤é…ç½®æ–‡ä»¶ã€‚

Nitro å°†æ ¹æ®ä»¥ä¸‹æ ‡å‡†è‡ªåŠ¨æ·»åŠ ä»¥ä¸‹å±æ€§ï¼š

| å±æ€§                                                                                                                                                  | æ ‡å‡†                                                                                                   | é»˜è®¤å€¼           |
| --------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- | ------------- |
| **[platform.apiRuntime](https://learn.microsoft.com/en-us/azure/static-web-apps/configuration#platform){rel="&#x22;nofollow&#x22;"}**               | å°†æ ¹æ®æ‚¨çš„åŒ…é…ç½®è‡ªåŠ¨è®¾ç½®ä¸º `node:16` æˆ– `node:14`ã€‚                                                                 | `node:16`     |
| **[navigationFallback.rewrite](https://learn.microsoft.com/en-us/azure/static-web-apps/configuration#fallback-routes){rel="&#x22;nofollow&#x22;"}** | å§‹ç»ˆä¸º `/api/server`                                                                                    | `/api/server` |
| **[routes](https://learn.microsoft.com/en-us/azure/static-web-apps/configuration#routes){rel="&#x22;nofollow&#x22;"}**                              | æ‰€æœ‰é¢„æ¸²æŸ“è·¯ç”±å°†è¢«æ·»åŠ ã€‚æ­¤å¤–ï¼Œå¦‚æœæ‚¨æ²¡æœ‰ `index.html` æ–‡ä»¶ï¼Œå°†ä¸ºå…¼å®¹æ€§ç›®çš„åˆ›å»ºä¸€ä¸ªç©ºçš„ï¼Œå¹¶ä¸”å¯¹ `/index.html` çš„è¯·æ±‚å°†é‡å®šå‘åˆ°æ ¹ç›®å½•ï¼Œç”± `/api/server` å¤„ç†ã€‚ | `[]`          |

### è‡ªå®šä¹‰é…ç½®

æ‚¨å¯ä»¥ä½¿ç”¨ `azure.config` é€‰é¡¹ä¿®æ”¹ Nitro ç”Ÿæˆçš„é…ç½®ã€‚

è‡ªå®šä¹‰è·¯ç”±å°†é¦–å…ˆè¢«æ·»åŠ å’ŒåŒ¹é…ã€‚åœ¨å‘ç”Ÿå†²çªçš„æƒ…å†µä¸‹ï¼ˆå¦‚æœå¯¹è±¡å…·æœ‰ç›¸åŒçš„è·¯ç”±å±æ€§ï¼‰ï¼Œè‡ªå®šä¹‰è·¯ç”±å°†è¦†ç›–ç”Ÿæˆçš„è·¯ç”±ã€‚

### é€šè¿‡ GitHub actions ä» CI/CD éƒ¨ç½²

å½“æ‚¨å°† GitHub ä»“åº“é“¾æ¥åˆ° Azure é™æ€ Web åº”ç”¨æ—¶ï¼Œå°†å‘ä»“åº“æ·»åŠ ä¸€ä¸ªå·¥ä½œæµæ–‡ä»¶ã€‚

å½“ç³»ç»Ÿè¦æ±‚æ‚¨é€‰æ‹©æ¡†æ¶æ—¶ï¼Œé€‰æ‹©è‡ªå®šä¹‰å¹¶æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

| è¾“å…¥                   | å€¼                |
| -------------------- | ---------------- |
| **app\_location**    | '/'              |
| **api\_location**    | '.output/server' |
| **output\_location** | '.output/public' |

å¦‚æœæ‚¨é”™è¿‡äº†æ­¤æ­¥éª¤ï¼Œæ‚¨å¯ä»¥éšæ—¶åœ¨å·¥ä½œæµä¸­æ‰¾åˆ°æ„å»ºé…ç½®éƒ¨åˆ†å¹¶æ›´æ–°æ„å»ºé…ç½®ï¼š

```yaml [.github/workflows/azure-static-web-apps-<RANDOM_NAME>.yml]
###### ä»“åº“/æ„å»ºé…ç½® ######
app_location: '/'
api_location: '.output/server'
output_location: '.output/public'
###### ä»“åº“/æ„å»ºé…ç½®ç»“æŸ ######
```

å°±æ˜¯è¿™æ ·ï¼ç°åœ¨ï¼ŒAzure é™æ€ Web åº”ç”¨å°†åœ¨æ¨é€æ—¶è‡ªåŠ¨éƒ¨ç½²æ‚¨çš„ Nitro é©±åŠ¨åº”ç”¨ã€‚

å¦‚æœæ‚¨ä½¿ç”¨ runtimeConfigï¼Œæ‚¨å¯èƒ½å¸Œæœ›åœ¨ Azure ä¸Šé…ç½®ç›¸åº”çš„ [ç¯å¢ƒå˜é‡](https://docs.microsoft.com/en-us/azure/static-web-apps/application-settings){rel="&#x22;nofollow&#x22;"}ã€‚


# Cleavr

**é¢„è®¾:** `cleavr`

:read-more{title="cleavr.io" to="https://cleavr.io"}

::note
ä¸æ­¤æä¾›å•†çš„é›†æˆå¯ä»¥é€šè¿‡ [é›¶é…ç½®](https://nitro.zhcndoc.com/deploy/#zero-config-providers) å®ç°ã€‚
::

## è®¾ç½®æ‚¨çš„ç½‘é¡µåº”ç”¨

åœ¨æ‚¨çš„é¡¹ç›®ä¸­ï¼Œå°† Nitro é¢„è®¾è®¾ç½®ä¸º `cleavr`ã€‚

```js
export default {
  nitro: {
    preset: 'cleavr'
  }
}
```

å°†æ›´æ”¹æ¨é€åˆ°æ‚¨çš„ä»£ç åº“ã€‚

**åœ¨æ‚¨çš„ Cleavr é¢æ¿ä¸­:**

::steps{level="4"}
#### provision ä¸€å°æ–°æœåŠ¡å™¨

#### æ·»åŠ ä¸€ä¸ªç½‘ç«™ï¼Œé€‰æ‹© **Nuxt 3** ä½œä¸ºåº”ç”¨ç±»å‹

#### åœ¨ç½‘é¡µåº”ç”¨ > è®¾ç½® > ä»£ç ä»“åº“ï¼ŒæŒ‡å‘æ‚¨é¡¹ç›®çš„ä»£ç ä»“åº“
::

æ‚¨ç°åœ¨å·²å‡†å¤‡å¥½éƒ¨ç½²æ‚¨çš„é¡¹ç›®ï¼


# Cloudflare

## Cloudflare Workers

**é¢„è®¾:** `cloudflare_module`

:read-more{title="Cloudflare Workers" to="https://developers.cloudflare.com/workers/"}

::note
ä¸æ­¤æä¾›è€…çš„é›†æˆå¯ä»¥é€šè¿‡ [é›¶é…ç½®](https://nitro.zhcndoc.com/deploy#zero-config-providers) å®ç°ï¼Œæ”¯æŒ [workers builds (beta)](https://developers.cloudflare.com/workers/ci-cd/builds/){rel=""nofollow""}ã€‚
::

::important
è¦å°† Workers ä¸é™æ€èµ„äº§ä¸€èµ·ä½¿ç”¨ï¼Œæ‚¨éœ€è¦è®¾ç½® Nitro å…¼å®¹æ—¥æœŸä¸º `2024-09-19` æˆ–æ›´é«˜ã€‚
::

ä»¥ä¸‹æ˜¯å°† Nitro åº”ç”¨éƒ¨ç½²åˆ° Cloudflare Workers çš„ç¤ºä¾‹ `nitro.config.ts` æ–‡ä»¶ã€‚

::CodeGroup
```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
    compatibilityDate: "2024-09-19",
    preset: "cloudflare_module",
    cloudflare: {
      deployConfig: true,
      nodeCompat: true
    }
})
```

```ts [nuxt.config.ts]
export default defineNuxtConfig({
    compatibilityDate: "2024-09-19",
    nitro: {
      preset: "cloudflare_module",
      cloudflare: {
        deployConfig: true,
        nodeCompat: true
      }
    }
})
```
::

\::

é€šè¿‡è®¾ç½® `deployConfig: true`ï¼ŒNitro å°†è‡ªåŠ¨ä¸ºæ‚¨ç”Ÿæˆä¸€ä¸ªæ­£ç¡®é…ç½®çš„ `wrangler.json`ã€‚
å¦‚æœæ‚¨éœ€è¦æ·»åŠ  [Cloudflare Workers é…ç½®](https://developers.cloudflare.com/workers/wrangler/configuration/){rel="&#x22;nofollow&#x22;"}ï¼Œä¾‹å¦‚ [bindings](https://developers.cloudflare.com/workers/runtime-apis/bindings/){rel="&#x22;nofollow&#x22;"}ï¼Œæ‚¨å¯ä»¥ï¼š

- åœ¨æ‚¨çš„ Nitro é…ç½®ä¸­è®¾ç½® `cloudflare: { wrangler : {} }`ã€‚è¿™ä¸ `wrangler.json` çš„ç±»å‹ç›¸åŒã€‚
- æä¾›æ‚¨è‡ªå·±çš„ `wrangler.json`ã€‚Nitro å°†ä¸é€‚å½“çš„è®¾ç½®åˆå¹¶æ‚¨çš„é…ç½®ï¼ŒåŒ…æ‹¬æŒ‡å‘æ„å»ºè¾“å‡ºã€‚

### æœ¬åœ°é¢„è§ˆ

æ‚¨å¯ä»¥ä½¿ç”¨ [Wrangler](https://github.com/cloudflare/workers-sdk/tree/main/packages/wrangler){rel="&#x22;nofollow&#x22;"} åœ¨æœ¬åœ°é¢„è§ˆæ‚¨çš„åº”ç”¨ï¼š

:pm-run{script="build"}

:pm-x{command="wrangler dev"}

### æ‰‹åŠ¨éƒ¨ç½²

æ„å»ºåº”ç”¨ç¨‹åºåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Wrangler æ‰‹åŠ¨éƒ¨ç½²å®ƒã€‚

é¦–å…ˆç¡®ä¿æ‚¨å·²ç™»å½•åˆ° Cloudflare è´¦æˆ·ï¼š

:pm-x{command="wrangler login"}

ç„¶åæ‚¨å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤éƒ¨ç½²åº”ç”¨ç¨‹åºï¼š

:pm-x{command="wrangler deploy"}

### è¿è¡Œæ—¶é’©å­

æ‚¨å¯ä»¥ä½¿ç”¨ä»¥ä¸‹ [è¿è¡Œæ—¶é’©å­](https://nitro.zhcndoc.com/guide/plugins#nitro-runtime-hooks) æ¥æ‰©å±• [Worker å¤„ç†ç¨‹åº](https://developers.cloudflare.com/workers/runtime-apis/handlers/){rel="&#x22;nofollow&#x22;"}ã€‚

:read-more{to="https://nitro.zhcndoc.com/guide/plugins#nitro-runtime-hooks"}

- [`cloudflare:scheduled`](https://developers.cloudflare.com/workers/runtime-apis/handlers/scheduled/){rel="&#x22;nofollow&#x22;"}
- [`cloudflare:email`](https://developers.cloudflare.com/email-routing/email-workers/runtime-api/){rel="&#x22;nofollow&#x22;"}
- [`cloudflare:queue`](https://developers.cloudflare.com/queues/configuration/javascript-apis/#consumer){rel="&#x22;nofollow&#x22;"}
- [`cloudflare:tail`](https://developers.cloudflare.com/workers/runtime-apis/handlers/tail/){rel="&#x22;nofollow&#x22;"}
- `cloudflare:trace`

### é¢å¤–å¯¼å‡º

ä½ å¯ä»¥åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ª `exports.cloudflare.ts` æ–‡ä»¶ï¼Œä»¥å‘ Cloudflare Worker å…¥å£ç‚¹å¯¼å‡ºé¢å¤–çš„å¤„ç†ç¨‹åºæˆ–å±æ€§ã€‚

```ts [exports.cloudflare.ts]
export class MyWorkflow extends WorkflowEntrypoint {
  async run(event: WorkflowEvent, step: WorkflowStep) {
    // ...
  }
}
```

Nitro å°†è‡ªåŠ¨æ£€æµ‹æ­¤æ–‡ä»¶ï¼Œå¹¶åœ¨æœ€ç»ˆæ„å»ºä¸­åŒ…å«å…¶å¯¼å‡ºå†…å®¹ã€‚

::warning
`exports.cloudflare.ts` æ–‡ä»¶ä¸èƒ½æœ‰é»˜è®¤å¯¼å‡ºã€‚
::

æ‚¨è¿˜å¯ä»¥åœ¨ `nitro.config.ts` ä¸­ä½¿ç”¨ `cloudflare.exports` é€‰é¡¹è‡ªå®šä¹‰å…¥å£æ–‡ä»¶çš„ä½ç½®ï¼š

```ts [nitro.config.ts]
export default defineConfig({
  cloudflare: {
    exports: "custom-exports-entry.ts"
  }
})
```

## Cloudflare Pages

**é¢„è®¾:** `cloudflare_pages`

:read-more{title="Cloudflare Pages" to="https://pages.cloudflare.com/"}

::note
ä¸æ­¤æä¾›è€…çš„é›†æˆå¯ä»¥é€šè¿‡ [é›¶é…ç½®](https://nitro.zhcndoc.com/deploy#zero-config-providers) å®ç°ã€‚
::

::warning
Cloudflare [Workers Module](https://nitro.zhcndoc.com/#cloudflare-workers) æ˜¯æ¨èç”¨äºéƒ¨ç½²çš„æ–°é¢„è®¾ã€‚å¦‚æœæ‚¨åªéœ€ç‰¹å®šåŠŸèƒ½ï¼Œè¯·è€ƒè™‘ä½¿ç”¨ Pagesã€‚
::

ä»¥ä¸‹æ˜¯å°† Nitro åº”ç”¨éƒ¨ç½²åˆ° Cloudflare Pages çš„ç¤ºä¾‹ `nitro.config.ts` æ–‡ä»¶ã€‚

::CodeGroup
```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
    preset: "cloudflare_pages",
    cloudflare: {
      deployConfig: true,
      nodeCompat:true
    }
})
```

```ts [nuxt.config.ts]
export default defineNuxtConfig({
    nitro: {
      preset: "cloudflare_pages",
      cloudflare: {
        deployConfig: true,
        nodeCompat:true
      }
    }
})
```
::

\::

Nitro å°†è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª `_routes.json` æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶æ§åˆ¶æ¥è‡ªæ–‡ä»¶çš„è·¯ç”±å’Œæ¥è‡ª Worker è„šæœ¬çš„è·¯ç”±ã€‚é€šè¿‡é…ç½®é€‰é¡¹ `cloudflare.pages.routes` å¯ä»¥è¦†ç›–è‡ªåŠ¨ç”Ÿæˆçš„è·¯ç”±æ–‡ä»¶ ([äº†è§£æ›´å¤š](https://developers.cloudflare.com/pages/platform/functions/routing/#functions-invocation-routes){rel="&#x22;nofollow&#x22;"})ã€‚

### æœ¬åœ°é¢„è§ˆ

æ‚¨å¯ä»¥ä½¿ç”¨ [Wrangler](https://github.com/cloudflare/workers-sdk/tree/main/packages/wrangler){rel="&#x22;nofollow&#x22;"} åœ¨æœ¬åœ°é¢„è§ˆæ‚¨çš„åº”ç”¨ï¼š

:pm-run{script="build"}

:pm-x{command="wrangler pages dev"}

### æ‰‹åŠ¨éƒ¨ç½²

æ„å»ºåº”ç”¨ç¨‹åºåï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ Wrangler æ‰‹åŠ¨éƒ¨ç½²å®ƒï¼Œé¦–å…ˆç¡®ä¿æ‚¨å·²ç™»å½•åˆ° Cloudflare è´¦æˆ·ï¼š

:pm-x{command="wrangler login"}

ç„¶åæ‚¨å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤éƒ¨ç½²åº”ç”¨ç¨‹åºï¼š

:pm-x{command="wrangler pages deploy"}

## ä½¿ç”¨ GitHub Actions åœ¨ CI/CD ä¸­éƒ¨ç½²

æ— è®ºæ‚¨æ˜¯ä½¿ç”¨ Cloudflare Pages è¿˜æ˜¯ Cloudflare Workersï¼Œæ‚¨éƒ½å¯ä»¥ä½¿ç”¨ [Wrangler GitHub actions](https://github.com/marketplace/actions/deploy-to-cloudflare-workers-with-wrangler){rel="&#x22;nofollow&#x22;"} æ¥éƒ¨ç½²æ‚¨çš„åº”ç”¨ã€‚

::note
**æ³¨æ„ï¼š** è¯·è®°å¾— [æŒ‡ç¤º Nitro ä½¿ç”¨æ­£ç¡®çš„é¢„è®¾](https://nitro.zhcndoc.com/deploy#changing-the-deployment-preset)ï¼ˆè¯·æ³¨æ„ï¼Œè¿™åœ¨æ‰€æœ‰é¢„è®¾ä¸­éƒ½æ˜¯å¿…è¦çš„ï¼ŒåŒ…æ‹¬ `cloudflare_pages`ï¼‰ã€‚
::

## ç¯å¢ƒå˜é‡

Nitro å…è®¸æ‚¨é€šè¿‡ `process.env` æˆ– `import.meta.env` æˆ–è¿è¡Œæ—¶é…ç½®é€šç”¨è®¿é—®ç¯å¢ƒå˜é‡ã€‚

::note
ç¡®ä¿ä»…åœ¨ **äº‹ä»¶ç”Ÿå‘½å‘¨æœŸå†…** è®¿é—®ç¯å¢ƒå˜é‡ï¼Œè€Œä¸æ˜¯åœ¨å…¨å±€ä¸Šä¸‹æ–‡ä¸­ï¼Œå› ä¸º Cloudflare ä»…åœ¨è¯·æ±‚ç”Ÿå‘½å‘¨æœŸæœŸé—´æä¾›å®ƒä»¬ï¼Œè€Œä¸æ˜¯åœ¨æ­¤ä¹‹å‰ã€‚
::

**ç¤ºä¾‹ï¼š** å¦‚æœæ‚¨è®¾ç½®äº† `SECRET` å’Œ `NITRO_HELLO_THERE` ç¯å¢ƒå˜é‡ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®å®ƒä»¬ï¼š

```ts
import { defineHandler } from "nitro/h3";
import { useRuntimeConfig } from "nitro/runtime-config";

console.log(process.env.SECRET) // è¯·æ³¨æ„ï¼Œè¿™æ˜¯åœ¨å…¨å±€èŒƒå›´å†…ï¼å› æ­¤å®é™…ä¸Šå®ƒä¸èµ·ä½œç”¨ï¼Œå˜é‡æ˜¯æœªå®šä¹‰çš„ï¼

export default defineHandler((event) => {
  // è¯·æ³¨æ„ï¼Œæ‰€æœ‰ä»¥ä¸‹æ–¹å¼éƒ½æ˜¯è®¿é—®ä¸Šè¿°å˜é‡çš„æœ‰æ•ˆæ–¹æ³•
  useRuntimeConfig().helloThere
  useRuntimeConfig().secret
  process.env.NITRO_HELLO_THERE
  import.meta.env.SECRET
});
```

### åœ¨å¼€å‘æ¨¡å¼ä¸­æŒ‡å®šå˜é‡

åœ¨å¼€å‘æ—¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ `.env` æˆ– `.env.local` æ–‡ä»¶æŒ‡å®šç¯å¢ƒå˜é‡ï¼š

```ini
NITRO_HELLO_THERE="captain"
SECRET="top-secret"
```

::note
**æ³¨æ„ï¼š** è¯·ç¡®ä¿å°† `.env` å’Œ `.env.local` æ·»åŠ åˆ° `.gitignore` æ–‡ä»¶ä¸­ï¼Œä»¥å…æ‚¨æäº¤å®ƒï¼Œå› ä¸ºå®ƒå¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ã€‚
::

### ä¸ºæœ¬åœ°é¢„è§ˆæŒ‡å®šå˜é‡

æ„å»ºåï¼Œå½“æ‚¨å°è¯•åœ¨æœ¬åœ°ä½¿ç”¨ `wrangler dev` æˆ– `wrangler pages dev` æµ‹è¯•é¡¹ç›®æ—¶ï¼Œä¸ºäº†è®¿é—®ç¯å¢ƒå˜é‡ï¼Œæ‚¨éœ€è¦åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸­æŒ‡å®šåœ¨ `.dev.vars` æ–‡ä»¶ä¸­ï¼ˆå¦‚ [Pages](https://developers.cloudflare.com/pages/functions/bindings/#interact-with-your-environment-variables-locally){rel="&#x22;nofollow&#x22;"} å’Œ [Workers](https://developers.cloudflare.com/workers/configuration/environment-variables/#interact-with-environment-variables-locally){rel="&#x22;nofollow&#x22;"} æ–‡æ¡£ä¸­æ‰€ç¤ºï¼‰ã€‚

å¦‚æœæ‚¨åœ¨å¼€å‘æ—¶ä½¿ç”¨äº† `.env` æˆ– `.env.local` æ–‡ä»¶ï¼Œåˆ™æ‚¨çš„ `.dev.vars` åº”ä¸ä¹‹ç›¸åŒã€‚

::note
**æ³¨æ„ï¼š** è¯·ç¡®ä¿å°† `.dev.vars` æ·»åŠ åˆ° `.gitignore` æ–‡ä»¶ä¸­ï¼Œä»¥å…æ‚¨æäº¤å®ƒï¼Œå› ä¸ºå®ƒå¯èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯ã€‚
::

### ä¸ºç”Ÿäº§ç¯å¢ƒæŒ‡å®šå˜é‡

å¯¹äºç”Ÿäº§ç¯å¢ƒï¼Œè¯·ä½¿ç”¨ Cloudflare æ§åˆ¶å°æˆ– [`wrangler secret`](https://developers.cloudflare.com/workers/wrangler/commands/#secret){rel="&#x22;nofollow&#x22;"} å‘½ä»¤è®¾ç½®ç¯å¢ƒå˜é‡å’Œæœºå¯†ã€‚

### ä½¿ç”¨ `wrangler.toml`/`wrangler.json` æŒ‡å®šå˜é‡

æ‚¨å¯ä»¥æŒ‡å®šè‡ªå®šä¹‰çš„ `wrangler.toml`/`wrangler.json` æ–‡ä»¶ï¼Œå¹¶åœ¨å…¶ä¸­å®šä¹‰å˜é‡ã€‚

::warning
è¯·æ³¨æ„ï¼Œè¿™ä¸æ¨èç”¨äºæ•æ„Ÿæ•°æ®ï¼Œä¾‹å¦‚æœºå¯†ã€‚
::

**ç¤ºä¾‹ï¼š**

::code-group
```ini [wrangler.toml]
# å…±äº«
[vars]
NITRO_HELLO_THERE="general"
SECRET="secret"

# ä¸º `--env production` ç”¨æ³•è¦†ç›–å€¼
[env.production.vars]
NITRO_HELLO_THERE="captain"
SECRET="top-secret"
```

```json [wrangler.json]
{
  "vars": {
    "NITRO_HELLO_THERE": "general",
    "SECRET": "secret"
  },
  "env": {
    "production": {
      "vars": {
        "NITRO_HELLO_THERE": "captain",
        "SECRET": "top-secret"
      }
    }
  }
}

```
::

## ç›´æ¥è®¿é—® Cloudflare ç»‘å®š

ç»‘å®šå…è®¸æ‚¨ä¸ Cloudflare å¹³å°ä¸Šçš„èµ„æºäº¤äº’ï¼Œè¿™äº›èµ„æºçš„ç¤ºä¾‹åŒ…æ‹¬é”®å€¼æ•°æ®å­˜å‚¨ ([KVs](https://developers.cloudflare.com/kv/){rel="&#x22;nofollow&#x22;"}) å’Œæ— æœåŠ¡å™¨ SQL æ•°æ®åº“ ([D1s](https://developers.cloudflare.com/d1/){rel="&#x22;nofollow&#x22;"})ã€‚

::read-more
æœ‰å…³ç»‘å®šçš„æ›´å¤šè¯¦ç»†ä¿¡æ¯åŠå…¶ç”¨æ³•ï¼Œè¯·å‚é˜… Cloudflare çš„ [Pages](https://developers.cloudflare.com/pages/functions/bindings/){rel=""nofollow""} å’Œ [Workers](https://developers.cloudflare.com/workers/configuration/bindings/#bindings){rel=""nofollow""} æ–‡æ¡£ã€‚
::

::tip
Nitro æä¾›äº†é«˜çº§ APIï¼Œä»¥ä¾¿ä¸ [KV å­˜å‚¨](https://nitro.zhcndoc.com/guide/storage) å’Œ [æ•°æ®åº“](https://nitro.zhcndoc.com/guide/database) äº¤äº’ï¼Œå¼ºçƒˆå»ºè®®æ‚¨ä¼˜å…ˆä½¿ç”¨å®ƒä»¬ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¾èµ–ä½çº§ API ä»¥ç¡®ä¿ä½¿ç”¨ç¨³å®šæ€§ã€‚
::

:read-more{title="æ•°æ®åº“å±‚" to="https://nitro.zhcndoc.com/guide/database"}

:read-more{title="KV å­˜å‚¨" to="https://nitro.zhcndoc.com/guide/storage"}

åœ¨è¿è¡Œæ—¶ï¼Œæ‚¨å¯ä»¥é€šè¿‡è®¿é—®è¯·æ±‚äº‹ä»¶çš„ `context.cloudflare.env` å­—æ®µæ¥è®¿é—®ç»‘å®šï¼Œä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥è¿™æ ·è®¿é—® D1 ç»‘å®šï¼š

```ts
import { defineHandler } from "nitro/h3";

defineHandler(async (event) => {
  const { cloudflare } = event.context
  const stmt = await cloudflare.env.MY_D1.prepare('SELECT id FROM table')
  const { results } = await stmt.all()
})
```

### åœ¨æœ¬åœ°å¼€å‘ä¸­è®¿é—®ç»‘å®š

è¦åœ¨å¼€å‘æ¨¡å¼ä¸‹è®¿é—®ç»‘å®šï¼Œé¦–å…ˆéœ€è¦å®šä¹‰å®ƒä»¬ã€‚ä½ å¯ä»¥åœ¨ `wrangler.jsonc`ã€`wrangler.json` æˆ– `wrangler.toml` æ–‡ä»¶ä¸­è¿›è¡Œå®šä¹‰ã€‚

ä¾‹å¦‚ï¼Œåœ¨ `wrangler.toml` ä¸­å®šä¹‰ä¸€ä¸ªå˜é‡å’Œä¸€ä¸ª KV å‘½åç©ºé—´ï¼š

::code-group
```ini [wrangler.toml]
[vars]
MY_VARIABLE="my-value"

[[kv_namespaces]]
binding = "MY_KV"
id = "xxx"
```

```json [wrangler.json]
{
  "vars": {
    "MY_VARIABLE": "my-value"
  },
  "kv_namespaces": [
    {
      "binding": "MY_KV",
      "id": "xxx"
    }
  ]
}
```
::

æ¥ä¸‹æ¥æˆ‘ä»¬å®‰è£…æ‰€éœ€çš„ `wrangler` åŒ…ï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰ï¼š

:pm-install{name="wrangler -D"}

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  modules: ['nitro-cloudflare-dev']
})
```

\::

ä»æ­¤æ—¶èµ·ï¼Œå½“è¿è¡Œ

:pm-run{script="dev"}

æ‚¨å°†èƒ½å¤Ÿåƒä¸Šé¢æ‰€ç¤ºä¸€æ ·ï¼Œä»è¯·æ±‚äº‹ä»¶ä¸­è®¿é—® `MY_VARIABLE` å’Œ `MY_KV`ã€‚

#### Wrangler ç¯å¢ƒ

å¦‚æœæ‚¨æœ‰å¤šä¸ª Wrangler ç¯å¢ƒï¼Œå¯ä»¥åœ¨ Cloudflare å¼€å‘ä»¿çœŸæœŸé—´æŒ‡å®šè¦ä½¿ç”¨çš„ Wrangler ç¯å¢ƒï¼š

```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  preset: 'cloudflare-module',
  cloudflare: {
    dev: {
      environment: 'preview'
    }
  }
})
```


# Deno Deploy

**é¢„è®¾ï¼š** `deno_deploy`

:read-more{title="Deno Deploy" to="https://deno.zhcndoc.com/deploy"}

## ä½¿ç”¨ CLI éƒ¨ç½²

æ‚¨å¯ä»¥ä½¿ç”¨ [deployctl](https://deno.zhcndoc.com/deploy/docs/deployctl){rel="&#x22;nofollow&#x22;"} æ¥éƒ¨ç½²æ‚¨çš„åº”ç”¨ã€‚

ç™»å½•åˆ° [Deno Deploy](https://dash.deno.com/account#access-tokens){rel="&#x22;nofollow&#x22;"} è·å– `DENO_DEPLOY_TOKEN` è®¿é—®ä»¤ç‰Œï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ã€‚

```bash
# ä½¿ç”¨ deno_deploy NITRO é¢„è®¾æ„å»º
NITRO_PRESET=deno_deploy npm run build

# ç¡®ä¿ä»è¾“å‡ºç›®å½•è¿è¡Œ deployctl å‘½ä»¤
cd .output
deployctl deploy --project=my-project server/index.ts
```

## é€šè¿‡ CI/CD ä½¿ç”¨ GitHub Actions éƒ¨ç½²

æ‚¨åªéœ€å°† deployctl GitHub Action ä½œä¸ºå·¥ä½œæµä¸­çš„ä¸€ä¸ªæ­¥éª¤åŒ…æ‹¬å³å¯ã€‚

æ‚¨ä¸éœ€è¦ä¸ºæ­¤è®¾ç½®ä»»ä½•å¯†é’¥ã€‚æ‚¨éœ€è¦å°†æ‚¨çš„ GitHub ä»“åº“é“¾æ¥åˆ°æ‚¨çš„ Deno Deploy é¡¹ç›®ï¼Œå¹¶é€‰æ‹© "GitHub Actions" éƒ¨ç½²æ¨¡å¼ã€‚æ‚¨å¯ä»¥åœ¨ [Deno Deploy](https://dash.deno.com){rel="&#x22;nofollow&#x22;"} çš„é¡¹ç›®è®¾ç½®ä¸­å®Œæˆæ­¤æ“ä½œã€‚

åœ¨æ‚¨çš„ `.github/workflows` ç›®å½•ä¸­åˆ›å»ºå¦‚ä¸‹å·¥ä½œæµæ–‡ä»¶ï¼š

```yaml [.github/workflows/deno_deploy.yml]
name: deno-deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  deploy:
    steps:
      - uses: actions/checkout@v5
      - run: corepack enable
      - uses: actions/setup-node@v6
        with:
          node-version: 18
          cache: pnpm
      - run: pnpm install
      - run: pnpm build
        env:
          NITRO_PRESET: deno_deploy
      - name: éƒ¨ç½²åˆ° Deno Deploy
        uses: denoland/deployctl@v1
        with:
          project: my-project
          entrypoint: server/index.ts
          root: .output
```

## Deno è¿è¡Œæ—¶

:read-more{to="https://nitro.zhcndoc.com/deploy/runtimes/deno"}


# DigitalOcean

**é¢„è®¾:** `digital_ocean`

:read-more{title="Digital Ocean åº”ç”¨å¹³å°" to="https://docs.digitalocean.com/products/app-platform/"}

## è®¾ç½®åº”ç”¨ç¨‹åº

::steps{level="4"}
#### æŒ‰ç…§[æŒ‡å—](https://docs.digitalocean.com/products/app-platform/how-to/create-apps/){rel=""nofollow""}åˆ›å»ºä¸€ä¸ªæ–°çš„ Digital Ocean åº”ç”¨ã€‚

#### æ¥ä¸‹æ¥ï¼Œæ‚¨éœ€è¦é…ç½®ç¯å¢ƒå˜é‡ã€‚åœ¨æ‚¨çš„åº”ç”¨è®¾ç½®ä¸­ï¼Œè¯·ç¡®ä¿è®¾ç½®ä»¥ä¸‹åº”ç”¨çº§ç¯å¢ƒå˜é‡ï¼š```bash
NITRO_PRESET=digital_ocean
```:br[æ›´å¤šä¿¡æ¯](https://docs.digitalocean.com/products/app-platform/how-to/use-environment-variables/){rel=""nofollow""}ã€‚

#### æ‚¨éœ€è¦ç¡®ä¿åœ¨åº”ç”¨çš„ `package.json` ä¸­è®¾ç½® `engines.node` å­—æ®µï¼Œä»¥ç¡®ä¿ Digital Ocean ä½¿ç”¨æ”¯æŒçš„ Node.js ç‰ˆæœ¬ï¼š```json
{
   "engines": {
      "node": "16.x"
   }
}
```:br[æŸ¥çœ‹æ›´å¤šä¿¡æ¯](https://docs.digitalocean.com/products/app-platform/languages-frameworks/nodejs/#node-version){rel=""nofollow""}ã€‚

#### æ‚¨è¿˜éœ€è¦æ·»åŠ ä¸€ä¸ªè¿è¡Œå‘½ä»¤ï¼Œä»¥ä¾¿ Digital Ocean çŸ¥é“åœ¨æ„å»ºåè¦è¿è¡Œå“ªä¸ªå‘½ä»¤ã€‚æ‚¨å¯ä»¥é€šè¿‡åœ¨ `package.json` ä¸­æ·»åŠ ä¸€ä¸ªå¯åŠ¨è„šæœ¬æ¥åšåˆ°è¿™ä¸€ç‚¹ï¼š```json
{
   "scripts": {
      "start": "node .output/server/index.mjs"
   }
}
```

#### æœ€åï¼Œæ‚¨éœ€è¦å°†æ­¤å¯åŠ¨è„šæœ¬æ·»åŠ åˆ° Digital Ocean åº”ç”¨çš„è¿è¡Œå‘½ä»¤ä¸­ã€‚è½¬åˆ° `Components > Settings > Commands`ï¼Œç‚¹å‡»â€œç¼–è¾‘â€ï¼Œç„¶åæ·»åŠ  `npm run start`
::

æ‚¨çš„åº”ç”¨åº”è¯¥åœ¨ Digital Ocean ç”Ÿæˆçš„ URL ä¸Šå®æ—¶å¯ç”¨ï¼Œæ‚¨ç°åœ¨å¯ä»¥æŒ‰ç…§[å…¶ä½™ Digital Ocean éƒ¨ç½²æŒ‡å—](https://docs.digitalocean.com/products/app-platform/how-to/manage-deployments/){rel="&#x22;nofollow&#x22;"}è¿›è¡Œæ“ä½œã€‚


# Firebase

::note
æ‚¨éœ€è¦è®¢é˜… [**Blaze è®¡åˆ’**](https://firebase.google.com/pricing){rel=""nofollow""}ï¼ˆæŒ‰éœ€ä»˜è´¹ï¼‰æ‰èƒ½å¼€å§‹ã€‚
::

## Firebase åº”ç”¨æ‰˜ç®¡

é¢„è®¾: `firebase_app_hosting`

:read-more{title="Firebase åº”ç”¨æ‰˜ç®¡" to="https://firebase.google.com/docs/app-hosting"}

::tip
æ‚¨å¯ä»¥ä½¿ç”¨ [é›¶é…ç½®](https://nitro.zhcndoc.com/deploy/#zero-config-providers) ä¸æ­¤æä¾›è€…é›†æˆã€‚
::

### é¡¹ç›®è®¾ç½®

::steps{level="4"}
#### å‰å¾€ Firebase [æ§åˆ¶å°](https://console.firebase.google.com/){rel=""nofollow""} å¹¶è®¾ç½®ä¸€ä¸ªæ–°é¡¹ç›®ã€‚

#### ä»ä¾§è¾¹æ é€‰æ‹© **æ„å»º > åº”ç”¨æ‰˜ç®¡**ã€‚
* åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨å¯èƒ½éœ€è¦å‡çº§æ‚¨çš„è´¦å•è®¡åˆ’ã€‚

#### ç‚¹å‡» **å¼€å§‹ä½¿ç”¨**ã€‚
* é€‰æ‹©ä¸€ä¸ªåŒºåŸŸã€‚
* å¯¼å…¥ä¸€ä¸ª GitHub ä»“åº“ï¼ˆæ‚¨éœ€è¦é“¾æ¥æ‚¨çš„ GitHub è´¦æˆ·ï¼‰ã€‚
* é…ç½®éƒ¨ç½²è®¾ç½®ï¼ˆé¡¹ç›®æ ¹ç›®å½•å’Œåˆ†æ”¯ï¼‰ï¼Œå¹¶å¯ç”¨è‡ªåŠ¨å‘å¸ƒã€‚
* ä¸ºæ‚¨çš„åç«¯é€‰æ‹©ä¸€ä¸ªå”¯ä¸€çš„ IDã€‚

#### ç‚¹å‡»å®Œæˆå¹¶éƒ¨ç½²ä»¥åˆ›å»ºæ‚¨çš„é¦–æ¬¡å‘å¸ƒã€‚
::

å½“æ‚¨ä½¿ç”¨ Firebase åº”ç”¨æ‰˜ç®¡è¿›è¡Œéƒ¨ç½²æ—¶ï¼Œåº”ç”¨æ‰˜ç®¡é¢„è®¾å°†åœ¨æ„å»ºæ—¶è‡ªåŠ¨è¿è¡Œã€‚


# Flightcontrol

**é¢„è®¾:** `flightcontrol`

:read-more{title="flightcontrol.dev" to="https://flightcontrol.dev?ref=nitro"}

::note
Flightcontrol å¯¹ [Nuxt](https://nuxt.zhcndoc.com/){rel=""nofollow""} é¡¹ç›®æä¾›é›¶é…ç½®æ”¯æŒã€‚
::

## è®¾ç½®ä½ çš„ Flightcontrol è´¦æˆ·

æ€»ä½“æ¥è¯´ï¼Œä½ ç¬¬ä¸€æ¬¡éƒ¨ç½²é¡¹ç›®éœ€è¦éµå¾ªçš„æ­¥éª¤å¦‚ä¸‹ï¼š

::steps{level="4"}
#### åœ¨ [Flightcontrol](https://app.flightcontrol.dev/signup?ref=nitro){rel=""nofollow""} åˆ›å»ºä¸€ä¸ªè´¦æˆ·

#### åœ¨ [AWS](https://portal.aws.amazon.com/billing/signup){rel=""nofollow""} åˆ›å»ºä¸€ä¸ªè´¦æˆ·ï¼ˆå¦‚æœä½ è¿˜æ²¡æœ‰çš„è¯ï¼‰

#### å°†ä½ çš„ AWS è´¦æˆ·é“¾æ¥åˆ° Flightcontrol

#### æˆæƒ Flightcontrol GitHub åº”ç”¨è®¿é—®ä½ é€‰æ‹©çš„å…¬å…±æˆ–ç§æœ‰ä»“åº“ã€‚

#### é€šè¿‡ä»ªè¡¨æ¿æˆ– `flightcontrol.json` é…ç½®åˆ›å»ºä¸€ä¸ª Flightcontrol é¡¹ç›®ã€‚
::

### é€šè¿‡ä»ªè¡¨æ¿åˆ›å»ºå¸¦é…ç½®çš„é¡¹ç›®

::steps{level="4"}
#### ä»ä»ªè¡¨æ¿åˆ›å»ºä¸€ä¸ª Flightcontrol é¡¹ç›®ã€‚é€‰æ‹©ä¸€ä¸ªä½œä¸ºæºçš„ä»“åº“ã€‚

#### é€‰æ‹© `GUI` é…ç½®ç±»å‹ã€‚

#### é€‰æ‹© Nuxt é¢„è®¾ã€‚æ­¤é¢„è®¾åŒæ ·é€‚ç”¨äºä»»ä½•åŸºäº Nitro çš„åº”ç”¨ç¨‹åºã€‚

#### é€‰æ‹©ä½ åå¥½çš„ AWS æœåŠ¡å™¨å¤§å°ã€‚

#### æäº¤æ–°é¡¹ç›®è¡¨å•ã€‚
::

### é€šè¿‡ `flightcontrol.json` åˆ›å»ºå¸¦é…ç½®çš„é¡¹ç›®

::steps{level="4"}
#### ä»ä½ çš„ä»ªè¡¨æ¿åˆ›å»ºä¸€ä¸ª Flightcontrol é¡¹ç›®ã€‚é€‰æ‹©ä¸€ä¸ªä½œä¸ºæºçš„ä»“åº“ã€‚

#### é€‰æ‹© `flightcontrol.json` é…ç½®ç±»å‹ã€‚

#### åœ¨ä½ çš„ä»“åº“æ ¹ç›®å½•æ·»åŠ ä¸€ä¸ªåä¸º `flightcontrol.json` çš„æ–°æ–‡ä»¶ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹é…ç½®ï¼Œå®ƒä¸ºä½ çš„åº”ç”¨åˆ›å»ºä¸€ä¸ª AWS fargate æœåŠ¡ï¼š
::

```json [flightcontrol.json]
{
  "$schema": "https://app.flightcontrol.dev/schema.json",
  "environments": [
    {
      "id": "production",
      "name": "ç”Ÿäº§ç¯å¢ƒ",
      "region": "us-west-2",
      "source": {
        "branch": "main"
      },
      "services": [
        {
          "id": "nitro",
          "buildType": "nixpacks",
          "name": "æˆ‘çš„ Nitro ç½‘ç«™",
          "type": "fargate",
          "domain": "www.yourdomain.com",
          "outputDirectory": ".output",
          "startCommand": "node .output/server/index.mjs",
          "cpu": 0.25,
          "memory": 0.5
        }
      ]
    }
  ]
}
```

4. æäº¤æ–°é¡¹ç›®è¡¨å•ã€‚

::read-more{to="https://www.flightcontrol.dev/docs?ref=nitro"}
äº†è§£æ›´å¤šå…³äº Flightcontrol çš„ [é…ç½®](https://www.flightcontrol.dev/docs?ref=nitro){rel=""nofollow""} ä¿¡æ¯ã€‚
::


# Genezio

**é¢„è®¾:** `genezio`

:read-more{title="Genezio" to="https://genezio.com"}

::important
ğŸš§ æ­¤é¢„è®¾ç›®å‰ä¸ºå®éªŒæ€§ã€‚
::

## 1. é¡¹ç›®è®¾ç½®

åˆ›å»º `genezio.yaml` æ–‡ä»¶ï¼š

```yaml
# é¡¹ç›®çš„åç§°ã€‚
name: nitro-app
# è¦è§£æçš„ Genezio YAML é…ç½®çš„ç‰ˆæœ¬ã€‚
yamlVersion: 2
backend:
  # åç«¯çš„æ ¹ç›®å½•ã€‚
  path: .output/
  # æœ‰å…³åç«¯ç¼–ç¨‹è¯­è¨€çš„ä¿¡æ¯ã€‚
  language:
      # ç¼–ç¨‹è¯­è¨€çš„åç§°ã€‚
      name: js
      # åç«¯ä½¿ç”¨çš„åŒ…ç®¡ç†å™¨ã€‚
      packageManager: npm
  # æœ‰å…³åç«¯å‡½æ•°çš„ä¿¡æ¯ã€‚
  functions:
      # å‡½æ•°çš„åç§°ï¼ˆæ ‡ç­¾ï¼‰ã€‚
      - name: nitroServer
      # å‡½æ•°ä»£ç çš„è·¯å¾„ã€‚
        path: server/
        # å‡½æ•°å¤„ç†å™¨çš„åç§°ã€‚
        handler: handler
        # å‡½æ•°çš„å…¥å£ç‚¹ã€‚
        entry: index.mjs
```

::read-more
---
to: https://genezio.com/docs/project-structure/genezio-configuration-file/
---
è¦è¿›ä¸€æ­¥æ ¹æ®æ‚¨çš„éœ€æ±‚å®šåˆ¶è¯¥æ–‡ä»¶ï¼Œå¯ä»¥æŸ¥é˜…
[å®˜æ–¹æ–‡æ¡£](https://genezio.com/docs/project-structure/genezio-configuration-file/){rel=""nofollow""}ã€‚
::

## 2. éƒ¨ç½²æ‚¨çš„é¡¹ç›®

ä½¿ç”¨ genezio nitro é¢„è®¾æ„å»ºï¼š

```bash
NITRO_PRESET=genezio npm run build
```

ä½¿ç”¨ [`genezio`](https://npmjs.com/package/genezio){rel="&#x22;nofollow&#x22;"} cli éƒ¨ç½²ï¼š

:pm-x{command="genezio deploy"}

::read-more
---
title: åç«¯ç¯å¢ƒå˜é‡
to: https://genezio.com/docs/project-structure/backend-environment-variables
---
è¦è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œè¯·æŸ¥çœ‹ [Genezio - ç¯å¢ƒå˜é‡](https://genezio.com/docs/project-structure/backend-environment-variables){rel=""nofollow""}ã€‚
::

## 3. ç›‘æ§æ‚¨çš„é¡¹ç›®

æ‚¨å¯ä»¥é€šè¿‡ [Genezio åº”ç”¨ä»ªè¡¨æ¿](https://app.genez.io/dashboard){rel="&#x22;nofollow&#x22;"} ç›‘æ§å’Œç®¡ç†æ‚¨çš„åº”ç”¨ç¨‹åºã€‚éƒ¨ç½²åæä¾›çš„ä»ªè¡¨æ¿ URL å…è®¸æ‚¨è®¿é—®é¡¹ç›®çŠ¶æ€å’Œæ—¥å¿—çš„ç»¼åˆè§†å›¾ã€‚


# GitHub Pages

**é¢„è®¾:** `github_pages`

:read-more{title="GitHub Pages" to="https://pages.github.com/"}

## è®¾ç½®

æŒ‰ç…§æ­¥éª¤ [åˆ›å»ºä¸€ä¸ª GitHub Pages ç½‘ç«™](https://docs.github.com/en/pages/getting-started-with-github-pages/creating-a-github-pages-site){rel="&#x22;nofollow&#x22;"}ã€‚

## éƒ¨ç½²

ä»¥ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ GitHub Actions å·¥ä½œæµï¼Œç”¨äºä½¿ç”¨ `github_pages` é¢„è®¾å°†æ‚¨çš„ç½‘ç«™éƒ¨ç½²åˆ° GitHub Pagesï¼š

```yaml [.github/workflows/deploy.yml]
# https://github.com/actions/deploy-pages#usage
name: éƒ¨ç½²åˆ° GitHub Pages

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - run: corepack enable
      - uses: actions/setup-node@v6
        with:
          node-version: "18"

      - run: npx nypm install
      - run: npm run build
        env:
          NITRO_PRESET: github_pages

      - name: ä¸Šä¼ å·¥ä»¶
        uses: actions/upload-pages-artifact@v1
        with:
          path: ./.output/public

  # éƒ¨ç½²ä½œä¸š
  deploy:
    # æ·»åŠ å¯¹æ„å»ºä½œä¸šçš„ä¾èµ–
    needs: build

    # æˆäºˆ GITHUB_TOKEN è¿›è¡Œé¡µé¢éƒ¨ç½²æ‰€éœ€çš„æƒé™
    permissions:
      pages: write      # ä»¥ä¾¿éƒ¨ç½²åˆ° Pages
      id-token: write   # ä»¥éªŒè¯éƒ¨ç½²æºè‡ªåˆé€‚æ¥æº

    # éƒ¨ç½²åˆ° github_pages ç¯å¢ƒ
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    # æŒ‡å®šè¿è¡Œå™¨ + éƒ¨ç½²æ­¥éª¤
    runs-on: ubuntu-latest
    steps:
      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v1
```


# GitLab Pages

**é¢„è®¾:** `gitlab_pages`

:read-more{title="GitLab Pages" to="https://pages.github.com/"}

## è®¾ç½®

æŒ‰ç…§æ­¥éª¤ [åˆ›å»ºä¸€ä¸ª GitLab Pages ç½‘ç«™](https://docs.gitlab.com/ee/user/project/pages/#getting-started){rel="&#x22;nofollow&#x22;"}ã€‚

## éƒ¨ç½²

1. è¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ GitLab Pages å·¥ä½œæµï¼Œå°†æ‚¨çš„ç½‘ç«™éƒ¨ç½²åˆ° GitLab Pagesï¼š

```yaml [.gitlab-ci.yml]
image: node:lts
before_script:
  - npx nypm install
pages:
  cache:
    paths:
      - node_modules/
  variables:
    NITRO_PRESET: gitlab_pages
  script:
    - npm run build
  artifacts:
    paths:
      - .output/public
  publish: .output/public
  rules:
    # è¿™ç¡®ä¿åªæœ‰å¯¹é»˜è®¤åˆ†æ”¯çš„æ¨é€
    # æ‰ä¼šè§¦å‘é¡µé¢éƒ¨ç½²
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
```


# Heroku

**é¢„è®¾:** `heroku`

:read-more{title="heroku.com" to="https://heroku.com/"}

## ä½¿ç”¨ heroku CLI

::steps{level="4"}
#### åˆ›å»ºä¸€ä¸ªæ–°çš„ Heroku åº”ç”¨ã€‚```bash
heroku create myapp
```

#### é…ç½® Heroku ä½¿ç”¨ nodejs æ„å»ºåŒ…ã€‚```bash
heroku buildpacks:set heroku/nodejs
```

#### é…ç½®ä½ çš„åº”ç”¨ã€‚```bash
heroku config:set NITRO_PRESET=heroku
```

#### ç¡®ä¿åœ¨ä½ çš„ `package.json` æ–‡ä»¶ä¸­æœ‰ `start` å’Œ `build` å‘½ä»¤ã€‚```json5
"scripts": {
  "build": "nitro build", // å¦‚æœä½¿ç”¨ nuxt åˆ™ä¸º `nuxt build`
  "start": "node .output/server/index.mjs"
}
```
::

## ä½¿ç”¨ nginx

::steps{level="4"}
#### åœ¨[è¿™é‡Œ](https://github.com/heroku/heroku-buildpack-nginx.git){rel=""nofollow""}æ·»åŠ  heroku Nginx æ„å»ºåŒ…ã€‚

#### åœ¨ä½ çš„ `nitro.config` ä¸­æ›´æ”¹ä¸º 'node' é¢„è®¾ã€‚```json5
"nitro": {
   "preset":"node",
}
```

#### ä»æ„å»ºåŒ…æ–‡æ¡£çš„ **ç°æœ‰åº”ç”¨** éƒ¨åˆ†ï¼Œéœ€è¦ä¸¤ä¸ªå…³é”®æ­¥éª¤ä»¥ä½¿å…¶è¿è¡Œã€‚ :br æ­¥éª¤ 1: åœ¨ 'tmp/nginx.socket' ä¸Šç›‘å¬ä¸€ä¸ªå¥—æ¥å­— :br
æ­¥éª¤ 2: å½“ä½ çš„åº”ç”¨å‡†å¤‡å¥½æ¥å—è¿æ¥æ—¶åˆ›å»ºæ–‡ä»¶ '/tmp/app-initialized'

#### åˆ›å»ºè‡ªå®šä¹‰åº”ç”¨è¿è¡Œå™¨ï¼Œä¾‹å¦‚ï¼šåœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º apprunner.mjsï¼ˆæˆ–ä»»ä½•å…¶ä»–é¦–é€‰ä½ç½®ï¼‰ï¼Œåœ¨æ­¤æ–‡ä»¶ä¸­ï¼Œåˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨ï¼Œä½¿ç”¨ node é¢„è®¾ç”Ÿæˆçš„ç›‘å¬å™¨ï¼Œç„¶åæŒ‰ç…§æ„å»ºåŒ…æ–‡æ¡£çš„è¯¦ç»†è¯´æ˜åœ¨å¥—æ¥å­—ä¸Šç›‘å¬ã€‚```ts
import { createServer } from 'node:http'
import { listener } from './.output/server/index.mjs'

const server = createServer(listener)

server.listen('/tmp/nginx.socket') // éµå¾ªæ„å»ºåŒ…æ–‡æ¡£
```

#### è‹¥è¦åˆ›å»º 'tmp/app-initialized' æ–‡ä»¶ï¼Œä½¿ç”¨ä¸€ä¸ª nitro æ’ä»¶ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºæ–‡ä»¶ 'initServer.ts'ï¼ˆæˆ–ä»»ä½•å…¶ä»–é¦–é€‰ä½ç½®ï¼‰ã€‚```ts
import fs from "fs"

export default definePlugin((nitroApp) => {
   if((process.env.NODE_ENV || 'development') != 'development') {
      fs.openSync('/tmp/app-initialized', 'w')
   }
})
```

#### æœ€åï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»ºæ–‡ä»¶ 'Procfile'ï¼Œé€šè¿‡ Procfileï¼Œå‘Šè¯‰ heroku å¯åŠ¨ nginx å¹¶ä½¿ç”¨è‡ªå®šä¹‰çš„ apprunner.mjs å¯åŠ¨æœåŠ¡å™¨ã€‚```procfile
web: bin/start-nginx node apprunner.mjs
```

#### é™„åŠ ï¼šåˆ›å»ºæ–‡ä»¶ 'config/nginx.conf.erb' æ¥è‡ªå®šä¹‰ä½ çš„ nginx é…ç½®ã€‚ä½¿ç”¨ node é¢„è®¾æ—¶ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œé™æ€æ–‡ä»¶å¤„ç†ç¨‹åºä¸ä¼šç”Ÿæˆï¼Œä½ å¯ä»¥ä½¿ç”¨ nginx æ¥æœåŠ¡é™æ€æ–‡ä»¶ï¼Œåªéœ€åœ¨æœåŠ¡å™¨å—ä¸­æ·»åŠ æ­£ç¡®çš„ä½ç½®è§„åˆ™ï¼Œæˆ–è€…ï¼Œé€šè¿‡å°† serveStatic è®¾ç½®ä¸º true å¼ºåˆ¶ node é¢„è®¾ç”Ÿæˆé™æ€æ–‡ä»¶çš„å¤„ç†ç¨‹åºã€‚
::


# IIS

## ä½¿ç”¨ [IISnode](https://github.com/Azure/iisnode){rel="&#x22;nofollow&#x22;"}

**é¢„è®¾:** `iis_node`

::steps{level="4"}
#### åœ¨æ‚¨çš„ Windows æœåŠ¡å™¨ä¸Šå®‰è£…æœ€æ–°çš„ LTS ç‰ˆæœ¬çš„ [Node.js](https://node.zhcndoc.com/zh-cn/){rel=""nofollow""}ã€‚

#### å®‰è£… [IISnode](https://github.com/azure/iisnode/releases){rel=""nofollow""}

#### å®‰è£… [IIS `URLRewrite` æ¨¡å—](https://www.iis.net/downloads/microsoft/url-rewrite){rel=""nofollow""}ã€‚

#### åœ¨ IIS ä¸­ï¼Œå°† `.mjs` æ·»åŠ ä¸ºæ–°çš„ MIME ç±»å‹ï¼Œå¹¶å°†å…¶å†…å®¹ç±»å‹è®¾ç½®ä¸º `application/javascript`ã€‚

#### å°†æ‚¨çš„ `.output` æ–‡ä»¶å¤¹çš„å†…å®¹éƒ¨ç½²åˆ° IIS ä¸­çš„ç½‘ç«™ã€‚
::

## ä½¿ç”¨ IIS å¤„ç†ç¨‹åº

**é¢„è®¾:** `iis_handler`

æ‚¨å¯ä»¥ç›´æ¥ä½¿ç”¨ IIS HTTP å¤„ç†ç¨‹åºã€‚

::steps{level="4"}
#### åœ¨æ‚¨çš„ Windows æœåŠ¡å™¨ä¸Šå®‰è£…æœ€æ–°çš„ LTS ç‰ˆæœ¬çš„ [Node.js](https://node.zhcndoc.com/zh-cn/){rel=""nofollow""}ã€‚

#### å®‰è£… [IIS `HttpPlatformHandler` æ¨¡å—](https://www.iis.net/downloads/microsoft/httpplatformhandler){rel=""nofollow""}

#### å°†æ‚¨çš„ `.output` ç›®å½•å¤åˆ¶åˆ° Windows æœåŠ¡å™¨ï¼Œå¹¶åœ¨ IIS ä¸Šåˆ›å»ºä¸€ä¸ªæŒ‡å‘è¯¥ç›®å½•çš„ç½‘ç«™ã€‚
::

## IIS é…ç½®é€‰é¡¹

::CodeGroup
```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  // IIS é€‰é¡¹é»˜è®¤
  iis: {
    // å°†ç°æœ‰çš„ web.config æ–‡ä»¶åˆå¹¶åˆ° nitro é»˜è®¤æ–‡ä»¶ä¸­
    mergeConfig: true,
    // å®Œå…¨è¦†ç›–é»˜è®¤çš„ nitro web.config æ–‡ä»¶
    overrideConfig: false,
  },
});
```

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  nitro: {
    // IIS é€‰é¡¹é»˜è®¤
    iis: {
      // å°†ç°æœ‰çš„ web.config æ–‡ä»¶åˆå¹¶åˆ° nitro é»˜è®¤æ–‡ä»¶ä¸­
      mergeConfig: true,
      // å®Œå…¨è¦†ç›–é»˜è®¤çš„ nitro web.config æ–‡ä»¶
      overrideConfig: false,
    },
  },
});
```
::


# Koyeb

**é¢„è®¾:** `koyeb`

:read-more{to="https://www.koyeb.com"}

## ä½¿ç”¨æ§åˆ¶é¢æ¿

::steps{level="4"}
#### åœ¨ [Koyeb æ§åˆ¶é¢æ¿](https://app.koyeb.com/){rel=""nofollow""} ä¸­ï¼Œç‚¹å‡» **åˆ›å»ºåº”ç”¨**ã€‚

#### é€‰æ‹© **GitHub** ä½œä¸ºæ‚¨çš„éƒ¨ç½²æ–¹æ³•ã€‚

#### é€‰æ‹©åŒ…å«åº”ç”¨ç¨‹åºä»£ç çš„ GitHub **ä»“åº“** å’Œ **åˆ†æ”¯**ã€‚

#### ä¸ºæ‚¨çš„æœåŠ¡å‘½åã€‚

#### å¦‚æœæ‚¨æ²¡æœ‰åœ¨ `package.json` æ–‡ä»¶ä¸­æ·»åŠ  `start` å‘½ä»¤ï¼Œè¯·åœ¨ **æ„å»ºå’Œéƒ¨ç½²è®¾ç½®** ä¸‹ï¼Œåˆ‡æ¢ä¸è¿è¡Œå‘½ä»¤å­—æ®µç›¸å…³çš„è¦†ç›–å¼€å…³ã€‚åœ¨ **è¿è¡Œå‘½ä»¤** å­—æ®µä¸­è¾“å…¥ï¼š```bash
node .output/server/index.mjs
```

#### åœ¨ **é«˜çº§** éƒ¨åˆ†ï¼Œç‚¹å‡» **æ·»åŠ å˜é‡** å¹¶æ·»åŠ ä¸€ä¸ª `NITRO_PRESET` å˜é‡ï¼Œå€¼è®¾ç½®ä¸º `koyeb`ã€‚

#### å‘½ååº”ç”¨ã€‚

#### ç‚¹å‡» **éƒ¨ç½²** æŒ‰é’®ã€‚
::

## ä½¿ç”¨ Koyeb CLI

::steps{level="4"}
#### æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿï¼Œéµå¾ªè¯´æ˜ä»¥ [å®‰è£… Koyeb CLI å®¢æˆ·ç«¯](https://www.koyeb.com/docs/cli/installation){rel=""nofollow""}ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®‰è£…ç¨‹åºã€‚æˆ–è€…ï¼Œè®¿é—® [GitHub ä¸Šçš„å‘å¸ƒé¡µé¢](https://github.com/koyeb/koyeb-cli/releases){rel=""nofollow""} ç›´æ¥ä¸‹è½½æ‰€éœ€æ–‡ä»¶ã€‚

#### é€šè¿‡è®¿é—® Koyeb æ§åˆ¶é¢æ¿ä¸­çš„ [æ‚¨ç»„ç»‡çš„ API è®¾ç½®](https://app.koyeb.com/settings/api){rel=""nofollow""} åˆ›å»ºä¸€ä¸ª Koyeb API è®¿é—®ä»¤ç‰Œã€‚

#### ä½¿ç”¨ Koyeb CLI ç™»å½•åˆ°æ‚¨çš„è´¦æˆ·ï¼Œè¾“å…¥ï¼š```bash
koyeb login
```:br å½“æç¤ºæ—¶ç²˜è´´æ‚¨çš„ API å‡­è¯ã€‚

#### ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä» GitHub ä»“åº“éƒ¨ç½²æ‚¨çš„ Nitro åº”ç”¨ç¨‹åºã€‚åŠ¡å¿…å°† `<APPLICATION_NAME>`ã€`<YOUR_GITHUB_USERNAME>` å’Œ `<YOUR_REPOSITORY_NAME>` æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„å€¼ï¼š```bash
koyeb app init <APPLICATION_NAME> \
   --git github.com/<YOUR_GITHUB_USERNAME>/<YOUR_REPOSITORY_NAME> \
   --git-branch main \
   --git-run-command "node .output/server/index.mjs" \
   --ports 3000:http \
   --routes /:3000 \
   --env PORT=3000 \
   --env NITRO_PRESET=koyeb
```
::

## ä½¿ç”¨ Docker å®¹å™¨

::steps{level="4"}
#### åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ª `.dockerignore` æ–‡ä»¶ï¼Œå¹¶æ·»åŠ ä»¥ä¸‹è¡Œï¼š```text
Dockerfile
.dockerignore
node_modules
npm-debug.log
.nitro
.output
.git
dist
README.md
```

#### åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸­æ·»åŠ ä¸€ä¸ª `Dockerfile`ï¼š```text
FROM node:18-alpine AS base

FROM base AS deps
RUN apk add --no-cache libc6-compat
WORKDIR /app
COPY package.json package-lock.json ./
RUN npm ci

FROM base AS builder
WORKDIR /app
COPY --from=deps /app/node_modules ./node_modules
COPY . .
RUN npm run build && npm cache clean --force

FROM base AS runner
WORKDIR /app
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nitro
COPY --from=builder /app .
USER nitro
EXPOSE 3000
ENV PORT 3000
CMD ["npm", "run", "start"]
```
::

ä¸Šé¢çš„ Dockerfile æä¾›äº†è¿è¡Œ Nitro åº”ç”¨ç¨‹åºçš„æœ€ä½è¦æ±‚ã€‚æ‚¨å¯ä»¥æ ¹æ®æ‚¨çš„éœ€æ±‚è½»æ¾æ‰©å±•å®ƒã€‚
ç„¶åï¼Œæ‚¨éœ€è¦å°† Docker é•œåƒæ¨é€åˆ°ä¸€ä¸ªæ³¨å†Œè¡¨ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ [Docker Hub](https://hub.docker.com/){rel="&#x22;nofollow&#x22;"} æˆ– [GitHub Container Registry](https://docs.github.com/en/packages/guides/about-github-container-registry){rel="&#x22;nofollow&#x22;"} ç­‰ã€‚
åœ¨ Koyeb æ§åˆ¶é¢æ¿ä¸­ï¼Œä½¿ç”¨é•œåƒå’Œæ ‡ç­¾å­—æ®µæŒ‡å®šæ‚¨è¦éƒ¨ç½²çš„é•œåƒã€‚
æ‚¨è¿˜å¯ä»¥ä½¿ç”¨ [Koyeb CLI](https://www.koyeb.com/docs/build-and-deploy/cli/installation){rel="&#x22;nofollow&#x22;"}ã€‚
æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è€ƒ Koyeb [Docker æ–‡æ¡£](https://www.koyeb.com/docs/build-and-deploy/prebuilt-docker-images){rel="&#x22;nofollow&#x22;"}ã€‚


# Netlify

**é¢„è®¾:** `netlify`

:read-more{title="Netlify å‡½æ•°" to="https://www.netlify.com/platform/core/functions/"}

::note
ä¸è¯¥æä¾›å•†çš„é›†æˆå¯ä»¥é€šè¿‡ [é›¶é…ç½®](https://nitro.zhcndoc.com/deploy/#zero-config-providers) å®ç°ã€‚
::

é€šå¸¸ï¼Œéƒ¨ç½²åˆ° Netlify ä¸éœ€è¦ä»»ä½•é…ç½®ã€‚
Nitro ä¼šè‡ªåŠ¨æ£€æµ‹æ‚¨å¤„äº [Netlify](https://www.netlify.com){rel="&#x22;nofollow&#x22;"} æ„å»ºç¯å¢ƒå¹¶æ„å»ºæ­£ç¡®ç‰ˆæœ¬çš„æœåŠ¡å™¨ã€‚

å¯¹äºæ–°ç«™ç‚¹ï¼ŒNetlify ä¼šæ£€æµ‹åˆ°æ‚¨æ­£åœ¨ä½¿ç”¨ Nitroï¼Œå¹¶å°†å‘å¸ƒç›®å½•è®¾ç½®ä¸º `dist`ï¼Œæ„å»ºå‘½ä»¤è®¾ç½®ä¸º `npm run build`ã€‚

å¦‚æœæ‚¨æ­£åœ¨å‡çº§ç°æœ‰ç«™ç‚¹ï¼Œè¯·æ£€æŸ¥è¿™äº›è®¾ç½®å¹¶æ ¹æ®éœ€è¦è¿›è¡Œæ›´æ–°ã€‚

å¦‚æœæ‚¨æƒ³æ·»åŠ è‡ªå®šä¹‰é‡å®šå‘ï¼Œå¯ä»¥ä½¿ç”¨ [`routeRules`](https://nitro.zhcndoc.com/config#routerules) æˆ–é€šè¿‡å°† [`_redirects`](https://docs.netlify.com/routing/redirects/#syntax-for-the-redirects-file){rel="&#x22;nofollow&#x22;"} æ–‡ä»¶æ·»åŠ åˆ°æ‚¨çš„ `public` ç›®å½•æ¥å®ç°ã€‚

å¯¹äºéƒ¨ç½²ï¼Œåªéœ€åƒå¾€å¸¸ä¸€æ ·å°†ä»£ç æ¨é€åˆ°æ‚¨çš„ git å­˜å‚¨åº“ [ä»¥è¿›è¡Œ Netlify éƒ¨ç½²](https://docs.netlify.com/configure-builds/get-started/){rel="&#x22;nofollow&#x22;"}ã€‚

::note{type="note"}
åœ¨åˆ›å»ºæ–°é¡¹ç›®æ—¶ï¼Œè¯·ç¡®ä¿å‘å¸ƒç›®å½•è®¾ç½®ä¸º `dist`ã€‚
::

## Netlify è¾¹ç¼˜å‡½æ•°

**é¢„è®¾:** `netlify_edge`

Netlify è¾¹ç¼˜å‡½æ•°ä½¿ç”¨ Deno å’Œå¼ºå¤§çš„ V8 JavaScript è¿è¡Œæ—¶ï¼Œè®©æ‚¨ä¸ºå®ç°æœ€å¿«çš„å“åº”æ—¶é—´è¿è¡Œå…¨çƒåˆ†å¸ƒçš„å‡½æ•°ã€‚

:read-more{title="Netlify è¾¹ç¼˜å‡½æ•°" to="https://docs.netlify.com/edge-functions/overview/"}

Nitro è¾“å‡ºå¯ä»¥ç›´æ¥åœ¨è¾¹ç¼˜è¿è¡ŒæœåŠ¡å™¨ï¼Œæ›´é è¿‘æ‚¨çš„ç”¨æˆ·ã€‚

::note{type="note"}
åœ¨åˆ›å»ºæ–°é¡¹ç›®æ—¶ï¼Œè¯·ç¡®ä¿å‘å¸ƒç›®å½•è®¾ç½®ä¸º `dist`ã€‚
::

## è‡ªå®šä¹‰éƒ¨ç½²é…ç½®

æ‚¨å¯ä»¥é€šè¿‡åœ¨ `nitro.config` ä¸­ä½¿ç”¨ `netlify` é”®æ¥æä¾›é¢å¤–çš„éƒ¨ç½²é…ç½®ã€‚å®ƒå°†ä¸å†…ç½®è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®åˆå¹¶ã€‚å½“å‰å”¯ä¸€æ”¯æŒçš„å€¼æ˜¯ `images.remote_images`ï¼Œç”¨äº [é…ç½® Netlify å›¾åƒ CDN](https://docs.netlify.com/image-cdn/create-integration/){rel="&#x22;nofollow&#x22;"}ã€‚


# Platform.sh

**é¢„è®¾:** `platform_sh`

:read-more{to="https://platform.sh"}

## è®¾ç½®

é¦–å…ˆï¼Œåœ¨ platform.sh ä¸Šåˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼Œå¹¶å°†å…¶é“¾æ¥åˆ°ä½ æƒ³è¦è‡ªåŠ¨éƒ¨ç½²çš„ä»“åº“ã€‚

ç„¶ååœ¨ä»“åº“ä¸­åˆ›å»º `.platform.app.yaml` æ–‡ä»¶ï¼š

```yaml [.platform.app.yaml]
name: nitro-app
type: 'nodejs:18'
disk: 128
web:
  commands:
    start: "node .output/server/index.mjs"
build:
  flavor: none
hooks:
  build: |
    corepack enable
    npx nypm install
    NITR_PRESET=platform_sh npm run build
mounts:
    '.data':
        source: local
        source_path: .data
```

:read-more{title="æ‰€æœ‰å¯ç”¨å±æ€§çš„å®Œæ•´åˆ—è¡¨" to="https://docs.platform.sh/create-apps/app-reference.html"}

:read-more{title="æ‰€æœ‰å¯ç”¨å±æ€§çš„å®Œæ•´åˆ—è¡¨" to="https://unjs.io/blog/2023-08-25-nitro-2.6#default-persistent-data-storage"}


# Render.com

**é¢„è®¾:** `render_com`

:read-more{title="render.com" to="https://render.com"}

## è®¾ç½®åº”ç”¨

::steps{level="4"}
#### [åˆ›å»ºä¸€ä¸ªæ–°çš„ Web æœåŠ¡](https://dashboard.render.com/select-repo?type=web){rel=""nofollow""}å¹¶é€‰æ‹©åŒ…å«æ‚¨ä»£ç çš„å­˜å‚¨åº“ã€‚

#### ç¡®ä¿é€‰æ‹©äº† 'Node' ç¯å¢ƒã€‚

#### å°†å¯åŠ¨å‘½ä»¤æ›´æ–°ä¸º `node .output/server/index.mjs`

#### ç‚¹å‡» 'é«˜çº§' å¹¶æ·»åŠ ä¸€ä¸ªç¯å¢ƒå˜é‡ï¼Œ`NITRO_PRESET` è®¾ç½®ä¸º `render_com`ã€‚æ‚¨å¯èƒ½è¿˜éœ€è¦æ·»åŠ ä¸€ä¸ª `NODE_VERSION` ç¯å¢ƒå˜é‡ï¼Œè®¾ç½®ä¸º `18` ä»¥ç¡®ä¿æ„å»ºæˆåŠŸï¼ˆ[æ–‡æ¡£](https://render.com/docs/node-version){rel=""nofollow""}ï¼‰ã€‚

#### ç‚¹å‡» 'åˆ›å»º Web æœåŠ¡'ã€‚
::

## åŸºç¡€è®¾æ–½å³ä»£ç  (IaC)

1. åœ¨æ‚¨å­˜å‚¨åº“çš„æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ªåä¸º `render.yaml` çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ã€‚

> æ­¤æ–‡ä»¶éµå¾ª Render ä¸Šçš„ [åŸºç¡€è®¾æ–½å³ä»£ç ](https://render.com/docs/infrastructure-as-code){rel="&#x22;nofollow&#x22;"} è§„èŒƒ

```yaml
services:
  - type: web
    name: <PROJECTNAME>
    env: node
    branch: main
    startCommand: node .output/server/index.mjs
    buildCommand: npx nypm install && npm run build
    envVars:
    - key: NITRO_PRESET
      value: render_com
```

1. [åˆ›å»ºä¸€ä¸ªæ–°çš„ Blueprint å®ä¾‹](https://dashboard.render.com/select-repo?type=blueprint){rel="&#x22;nofollow&#x22;"}å¹¶é€‰æ‹©åŒ…å«æ‚¨çš„ `render.yaml` æ–‡ä»¶çš„å­˜å‚¨åº“ã€‚

æ‚¨å·²ç»å‡†å¤‡å¥½å¼€å§‹äº†ï¼


# StormKit

**é¢„è®¾:** `stormkit`

:read-more{title="Stormkit" to="https://www.stormkit.io"}

::note
å¯ä»¥é€šè¿‡ [é›¶é…ç½®](https://nitro.zhcndoc.com/deploy#zero-config-providers) é›†æˆ [Stormkit](https://www.stormkit.io/){rel=""nofollow""}ã€‚
::

## è®¾ç½®

æŒ‰ç…§æ­¥éª¤åœ¨ Stormkit ä¸Š [åˆ›å»ºä¸€ä¸ªæ–°åº”ç”¨](https://app.stormkit.io/apps/new){rel="&#x22;nofollow&#x22;"}ã€‚

![åœ¨ Stormkit ä¸Šåˆ›å»ºä¸€ä¸ªæ–°åº”ç”¨](https://nitro.zhcndoc.com/images/stormkit-new-app.png)

## éƒ¨ç½²

é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“æ‚¨å°†æ›´æ”¹æ¨é€åˆ°ä¸»åˆ†æ”¯æ—¶ï¼ŒStormkit ä¼šè‡ªåŠ¨éƒ¨ç½²æ‚¨çš„åº”ç”¨ã€‚ä½†è‹¥è¦è§¦å‘æ‰‹åŠ¨éƒ¨ç½²ï¼ˆä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½ä¼šåœ¨ç¬¬ä¸€æ¬¡éƒ¨ç½²æ—¶è¿™æ ·åšï¼‰ï¼Œæ‚¨å¯ä»¥ç‚¹å‡» `ç«‹å³éƒ¨ç½²`ã€‚

![é€šè¿‡ç«‹å³éƒ¨ç½²è§¦å‘æ‰‹åŠ¨éƒ¨ç½²](https://nitro.zhcndoc.com/images/stormkit-deploy.png)


# Vercel

**é¢„è®¾:** `vercel`

:read-more{title="Vercel æ¡†æ¶æ”¯æŒ" to="https://vercel.com/docs/frameworks"}

::note
å¯ä»¥é€šè¿‡ [é›¶é…ç½®](https://nitro.zhcndoc.com/deploy/#zero-config-providers) é›†æˆæ­¤æä¾›ç¨‹åºã€‚
::

## å…¥é—¨æŒ‡å—

éƒ¨ç½²åˆ° Vercel å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- [é¢„è§ˆéƒ¨ç½²](https://vercel.com/docs/deployments/environments){rel="&#x22;nofollow&#x22;"}
- [æµä½“è®¡ç®—](https://vercel.com/docs/fluid-compute){rel="&#x22;nofollow&#x22;"}
- [å¯è§‚å¯Ÿæ€§](https://vercel.com/docs/observability){rel="&#x22;nofollow&#x22;"}
- [Vercel é˜²ç«å¢™](https://vercel.com/docs/vercel-firewall){rel="&#x22;nofollow&#x22;"}

ä»¥åŠæ›´å¤šåŠŸèƒ½ã€‚äº†è§£æ›´å¤šä¿¡æ¯è¯·å‚é˜… [Vercel æ–‡æ¡£](https://vercel.com/docs){rel="&#x22;nofollow&#x22;"}ã€‚

### ä½¿ç”¨ Git éƒ¨ç½²

Vercel æ”¯æŒ Nitro çš„é›¶é…ç½®éƒ¨ç½²ã€‚[ç«‹å³å°† Nitro éƒ¨ç½²åˆ° Vercel](https://vercel.com/new/clone?repository-url=https%3A%2F%2Fgithub.com%2Fvercel%2Fvercel%2Ftree%2Fmain%2Fexamples%2Fnitro){rel="&#x22;nofollow&#x22;"}ã€‚

## API è·¯ç”±

Nitro çš„ `/api` ç›®å½•ä¸ Vercel ä¸å…¼å®¹ã€‚ç›¸åï¼Œæ‚¨åº”ä½¿ç”¨ï¼š

- `routes/api/`ï¼Œç”¨äºç‹¬ç«‹ä½¿ç”¨

## Bun è¿è¡Œæ—¶

:read-more{title="Vercel" to="https://vercel.com/docs/functions/runtimes/bun"}

æ‚¨å¯ä»¥é€šè¿‡åœ¨ `nitro.config` å†…ä½¿ç”¨ `vercel.functions` é”®æŒ‡å®šè¿è¡Œæ—¶ï¼Œæ¥ä½¿ç”¨ [Bun](https://bun.zhcndoc.com){rel="&#x22;nofollow&#x22;"} æ›¿ä»£ Node.jsï¼š

```ts [nitro.config.ts]
export default defineNitroConfig({
  vercel: {
    functions: {
      runtime: "bun1.x"
    }
  }
})
```

æˆ–è€…ï¼Œå¦‚æœæ‚¨åœ¨ `vercel.json` ä¸­æŒ‡å®šäº† `bunVersion` å±æ€§ï¼ŒNitro ä¹Ÿä¼šè‡ªåŠ¨æ£€æµ‹ Bunï¼š

```json [vercel.json]
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "bunVersion": "1.x"
}
```

## ä»£ç†è·¯ç”±è§„åˆ™

Nitro åœ¨ Vercel ä¸Šé€šè¿‡æ„å»ºæ—¶ç”Ÿæˆ [CDN çº§åˆ«çš„é‡å†™](https://vercel.com/docs/rewrites){rel="&#x22;nofollow&#x22;"} è‡ªåŠ¨ä¼˜åŒ– `proxy` è·¯ç”±è§„åˆ™ã€‚è¿™æ„å‘³ç€åŒ¹é…çš„è¯·æ±‚ä¼šåœ¨è¾¹ç¼˜èŠ‚ç‚¹è¢«ä»£ç†ï¼Œè€Œæ— éœ€è°ƒç”¨æ— æœåŠ¡å™¨å‡½æ•°ï¼Œä»è€Œå‡å°‘å»¶è¿Ÿå’Œæˆæœ¬ã€‚

```ts [nitro.config.ts]
export default defineNitroConfig({
  routeRules: {
    // CDN çº§åˆ«ä»£ç† â€” æ— å‡½æ•°è°ƒç”¨
    "/api/**": {
      proxy: "https://api.example.com/**",
    },
  },
});
```

### CDN é‡å†™ç”Ÿæ•ˆçš„æ¡ä»¶

å½“æ»¡è¶³ **ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶** æ—¶ï¼Œä»£ç†è§„åˆ™ä¼šè¢«å¸è½½åˆ° Vercel CDN é‡å†™ï¼š

- ç›®æ ‡æ˜¯ä¸€ä¸ª **å¤–éƒ¨ URL**ï¼ˆä»¥ `http://` æˆ– `https://` å¼€å¤´ï¼‰ã€‚
- è§„åˆ™ä¸Šæ²¡æœ‰è®¾ç½®é«˜çº§çš„ `ProxyOptions`ã€‚

### å›é€€åˆ°è¿è¡Œæ—¶ä»£ç†

å½“ä»£ç†è§„åˆ™ä½¿ç”¨äº†ä»¥ä¸‹ä»»ä½•ä¸€ä¸ª `ProxyOptions`ï¼ŒNitro ä¼šå°†å…¶ä¿ç•™ä¸ºç”±æ— æœåŠ¡å™¨å‡½æ•°å¤„ç†çš„è¿è¡Œæ—¶ä»£ç†ï¼š

- `headers` â€” å‘é€ç»™ä¸Šæ¸¸è¯·æ±‚çš„è‡ªå®šä¹‰å¤´
- `forwardHeaders` / `filterHeaders` â€” å¤´è¿‡æ»¤
- `fetchOptions` â€” è‡ªå®šä¹‰ fetch é€‰é¡¹
- `cookieDomainRewrite` / `cookiePathRewrite` â€” cookie æ“ä½œ
- `onResponse` â€” å“åº”å›è°ƒ

::note
é€šè¿‡è·¯ç”±è§„åˆ™ `headers` é€‰é¡¹å®šä¹‰çš„å“åº”å¤´ä»ç„¶ä¼šåº”ç”¨äº CDN çº§åˆ«é‡å†™ã€‚åªæœ‰è¯·æ±‚çº§åˆ«çš„ `ProxyOptions.headers`ï¼ˆå‘é€åˆ°ä¸Šæ¸¸ï¼‰éœ€è¦è¿è¡Œæ—¶ä»£ç†ã€‚
::

## è®¡åˆ’ä»»åŠ¡ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰

:read-more{title="Vercel Cron Jobs" to="https://vercel.com/docs/cron-jobs"}

Nitro ä¼šåœ¨æ„å»ºæ—¶è‡ªåŠ¨å°†æ‚¨çš„ [`scheduledTasks`](https://nitro.zhcndoc.com/docs/tasks#scheduled-tasks) é…ç½®è½¬æ¢ä¸º [Vercel å®šæ—¶ä»»åŠ¡](https://vercel.com/docs/cron-jobs){rel="&#x22;nofollow&#x22;"}ã€‚åªéœ€åœ¨ Nitro é…ç½®ä¸­å®šä¹‰è®¡åˆ’ï¼Œç„¶åéƒ¨ç½²å³å¯ï¼Œæ— éœ€æ‰‹åŠ¨é…ç½® `vercel.json` ä¸­çš„å®šæ—¶ä»»åŠ¡ã€‚

```ts [nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  experimental: {
    tasks: true
  },
  scheduledTasks: {
    // æ¯å°æ—¶è¿è¡Œ `cms:update`
    '0 * * * *': ['cms:update'],
    // æ¯å¤©å‡Œæ™¨è¿è¡Œ `db:cleanup`
    '0 0 * * *': ['db:cleanup']
  }
})
```

### ä¿æŠ¤å®šæ—¶ä»»åŠ¡ç«¯ç‚¹

:read-more{title="Securing cron jobs" to="https://vercel.com/docs/cron-jobs/manage-cron-jobs#securing-cron-jobs"}

ä¸ºäº†é˜²æ­¢æœªç»æˆæƒè®¿é—®å®šæ—¶ä»»åŠ¡å¤„ç†å™¨ï¼Œè¯·åœ¨æ‚¨çš„ Vercel é¡¹ç›®è®¾ç½®ä¸­è®¾ç½® `CRON_SECRET` ç¯å¢ƒå˜é‡ã€‚å½“è®¾ç½®äº† `CRON_SECRET` æ—¶ï¼ŒNitro ä¼šåœ¨æ¯æ¬¡å®šæ—¶ä»»åŠ¡è°ƒç”¨æ—¶éªŒè¯ `Authorization` å¤´ã€‚

## è‡ªå®šä¹‰æ„å»ºè¾“å‡ºé…ç½®

æ‚¨å¯ä»¥é€šè¿‡åœ¨ `nitro.config` ä¸­ä½¿ç”¨ `vercel.config` é”®æ¥æä¾›é¢å¤–çš„ [æ„å»ºè¾“å‡ºé…ç½®](https://vercel.com/docs/build-output-api/v3){rel="&#x22;nofollow&#x22;"}ï¼Œè¯¥é…ç½®å°†ä¸å†…ç½®è‡ªåŠ¨ç”Ÿæˆçš„é…ç½®åˆå¹¶ã€‚

## æŒ‰éœ€å¢é‡é™æ€å†ç”Ÿ (ISR)

æŒ‰éœ€é‡æ–°éªŒè¯å…è®¸ä½ åœ¨ä»»æ„æ—¶é—´æ¸…é™¤ ISR è·¯ç”±ç¼“å­˜ï¼Œæ— éœ€ç­‰å¾…åå°é‡æ–°éªŒè¯çš„æ—¶é—´é—´éš”ã€‚

è¦æŒ‰éœ€é‡æ–°éªŒè¯é¡µé¢ï¼š

::steps{level="4"}
#### åˆ›å»ºä¸€ä¸ªç¯å¢ƒå˜é‡ä»¥å­˜å‚¨é‡æ–°éªŒè¯å¯†é’¥* æ‚¨å¯ä»¥ä½¿ç”¨å‘½ä»¤ `openssl rand -base64 32` æˆ–é€šè¿‡ [ç”Ÿæˆä¸€ä¸ªå¯†é’¥](https://generate-secret.vercel.app/32){rel=""nofollow""} æ¥ç”Ÿæˆä¸€ä¸ªéšæœºå€¼ã€‚

#### æ›´æ–°æ‚¨çš„é…ç½®ï¼š```ts \[nitro.config.ts]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  vercel: {
    config: {
      bypassToken: process.env.VERCEL_BYPASS_TOKEN
    }
  }
})
```

#### è¦è§¦å‘â€œæŒ‰éœ€å¢é‡é™æ€å†ç”Ÿï¼ˆISRï¼‰â€å¹¶é‡æ–°éªŒè¯åˆ°é¢„æ¸²æŸ“å‡½æ•°çš„è·¯å¾„ï¼Œè¯·ä½¿ç”¨å¸¦æœ‰ x-prerender-revalidate: `bypassToken` å¤´çš„ GET æˆ– HEAD è¯·æ±‚è®¿é—®è¯¥è·¯å¾„ã€‚å½“ä½¿ç”¨æ­¤è¯·æ±‚å¤´è®¿é—®è¯¥é¢„æ¸²æŸ“å‡½æ•°ç«¯ç‚¹æ—¶ï¼Œç¼“å­˜å°†è¢«é‡æ–°éªŒè¯ã€‚ä¸‹ä¸€æ¬¡å¯¹è¯¥å‡½æ•°çš„è¯·æ±‚åº”è¯¥è¿”å›æœ€æ–°çš„å“åº”ã€‚
::

### é€šè¿‡è·¯ç”±è§„åˆ™è¿›è¡Œç»†ç²’åº¦ ISR é…ç½®

é»˜è®¤æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢å‚æ•°ä¼šå½±å“ç¼“å­˜é”®ï¼Œä½†ä¸ä¼šä¼ é€’ç»™è·¯ç”±å¤„ç†å™¨ï¼Œé™¤éå¦æœ‰æŒ‡å®šã€‚

æ‚¨å¯ä»¥å‘ `isr` è·¯ç”±è§„åˆ™ä¼ é€’ä¸€ä¸ªé€‰é¡¹å¯¹è±¡æ¥é…ç½®ç¼“å­˜è¡Œä¸ºã€‚

- `expiration`ï¼šç¼“å­˜èµ„äº§åœ¨é€šè¿‡è°ƒç”¨æ— æœåŠ¡å™¨å‡½æ•°é‡æ–°ç”Ÿæˆä¹‹å‰çš„è¿‡æœŸæ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰ã€‚å°†å…¶è®¾ç½®ä¸º `false`ï¼ˆæˆ–è·¯ç”±è§„åˆ™å†™ä¸º `isr: true`ï¼‰è¡¨ç¤ºç¼“å­˜æ°¸ä¸è¿‡æœŸã€‚
- `group`ï¼šèµ„äº§çš„ç»„ç¼–å·ã€‚å…·æœ‰ç›¸åŒç»„ç¼–å·çš„é¢„æ¸²æŸ“èµ„äº§å°†ä¼šåŒæ—¶é‡æ–°éªŒè¯ã€‚
- `allowQuery`ï¼šå…è®¸ç‹¬ç«‹ç¼“å­˜çš„æŸ¥è¯¢å‚æ•°åç§°åˆ—è¡¨ã€‚
  - å¦‚æœæ˜¯ç©ºæ•°ç»„ï¼Œåˆ™æŸ¥è¯¢å‚æ•°å€¼ä¸ä¼šå½±å“ç¼“å­˜ã€‚
  - å¦‚æœæ˜¯ `undefined`ï¼Œåˆ™æ¯ä¸ªä¸åŒçš„æŸ¥è¯¢å‚æ•°å€¼ä¼šè¢«ç‹¬ç«‹ç¼“å­˜ã€‚
  - å¯¹äºé€šé…ç¬¦è·¯ç”± `/**`ï¼Œ`url` å‚æ•°å§‹ç»ˆè¢«æ·»åŠ ã€‚
- `passQuery`ï¼šå½“è®¾ç½®ä¸º `true`ï¼ŒæŸ¥è¯¢å­—ç¬¦ä¸²å°†åŒ…å«åœ¨ä¼ é€’ç»™è°ƒç”¨å‡½æ•°çš„ `request` å‚æ•°ä¸­ã€‚`allowQuery` è¿‡æ»¤ä¾ç„¶ç”Ÿæ•ˆã€‚
- `exposeErrBody`ï¼šå½“è®¾ç½®ä¸º `true` æ—¶ï¼Œå“åº”ä½“æ— è®ºçŠ¶æ€ç å¦‚ä½•ï¼ˆåŒ…æ‹¬é”™è¯¯çŠ¶æ€ç ï¼‰éƒ½ä¼šè¢«æš´éœ²ã€‚ï¼ˆé»˜è®¤å€¼ä¸º `false`ï¼‰

```ts
export default defineNitroConfig({
  routeRules: {
    "/products/**": {
      isr: {
        allowQuery: ["q"],
        passQuery: true,
        exposeErrBody: true
      },
    },
  },
});
```


# Zeabur

**é¢„è®¾:** `zeabur`

:read-more{title="Zeabur" to="https://zeabur.com"}

::note
ä¸æ­¤æä¾›å•†çš„é›†æˆå¯ä»¥é€šè¿‡ [é›¶é…ç½®](https://nitro.zhcndoc.com/deploy/#zero-config-providers) å®ç°ã€‚
::

## ä½¿ç”¨ git éƒ¨ç½²

::steps{level="4"}
#### å°†æ‚¨çš„ä»£ç æ¨é€åˆ° git ä»“åº“ï¼ˆå½“å‰ä»…æ”¯æŒ GitHubï¼‰ã€‚

#### [å°†æ‚¨çš„é¡¹ç›®å¯¼å…¥](https://zeabur.com/docs/get-started){rel=""nofollow""} åˆ° Zeaburã€‚

#### Zeabur å°†æ£€æµ‹æ‚¨æ­£åœ¨ä½¿ç”¨ Nitroï¼Œå¹¶ä¸ºæ‚¨çš„éƒ¨ç½²å¯ç”¨æ­£ç¡®çš„è®¾ç½®ã€‚

#### æ‚¨çš„åº”ç”¨ç¨‹åºå·²æˆåŠŸéƒ¨ç½²ï¼
::


# Zerops

**é¢„è®¾:** `zerops`

:read-more{title="zerops.io" to="https://zerops.io"}

::important
ğŸš§ æ­¤é¢„è®¾ç›®å‰ä¸ºå®éªŒæ€§ã€‚
::

Zerops æ”¯æŒé€šè¿‡é¡¹ç›®æ ¹ç›®å½•ä¸­çš„ç®€å•é…ç½®æ–‡ä»¶éƒ¨ç½²é™æ€å’ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“çš„åº”ç”¨ã€‚

## å¯åŠ¨æ¨¡æ¿

å¦‚æœæ‚¨å¸Œæœ›å¿«é€Ÿå¼€å§‹ä½¿ç”¨ zerops å’Œ nitroï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»“åº“ [`zeropsio/recipe-nitro-nodejs`](https://github.com/zeropsio/recipe-nitro-nodejs){rel="&#x22;nofollow&#x22;"} å’Œ [`zeropsio/recipe-nitro-static`](https://github.com/zeropsio/recipe-nitro-static){rel="&#x22;nofollow&#x22;"} å¯åŠ¨æ¨¡æ¿ã€‚

## é¡¹ç›®è®¾ç½®

é¡¹ç›®å’ŒæœåŠ¡å¯ä»¥é€šè¿‡ [é¡¹ç›®æ·»åŠ å‘å¯¼](https://app.zerops.io/dashboard/project-add){rel="&#x22;nofollow&#x22;"} æ·»åŠ ï¼Œæˆ–ä½¿ç”¨ `zerops-project-import.yml` å¯¼å…¥ã€‚

::code-group
```yml [zerops-project-import.yml (node.js)]
project:
  name: nitro-app

services:
  - hostname: app
    type: nodejs@20
```

```yml [zerops-project-import.yml (static)]
project:
  name: nitro-app

services:
  - hostname: app
    type: static
```
::

ç„¶ååœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `zerops.yml` é…ç½®ï¼š

::code-group
```yml [zerops.yml (node.js)]
zerops:
  - setup: app
    build:
      base: nodejs@20
      envVariables:
        SERVER_PRESET: zerops
      buildCommands:
        - pnpm i
        - pnpm run build
      deployFiles:
        - .output
        - package.json
        - node_modules
    run:
      base: nodejs@20
      ports:
        - port: 3000
          httpSupport: true
      start: node .output/server/index.mjs
```

```yml [zerops.yml (static)]
zerops:
  - setup: app
    build:
      base: nodejs@20
      envVariables:
        SERVER_PRESET: zerops-static
      buildCommands:
        - pnpm i
        - pnpm build
      deployFiles:
        - .zerops/output/static/~
    run:
      base: static
```
::

ç°åœ¨æ‚¨å¯ä»¥ä½¿ç”¨ Zerops CLI è§¦å‘ [æ„å»ºå’Œéƒ¨ç½²ç®¡é“](https://nitro.zhcndoc.com/#building-deploying-your-app)ï¼Œæˆ–é€šè¿‡åœ¨æœåŠ¡è¯¦ç»†ä¿¡æ¯ä¸­è¿æ¥åº”ç”¨æœåŠ¡ä¸æ‚¨çš„ [GitHub](https://docs.zerops.io/references/github-integration/){rel="&#x22;nofollow&#x22;"} / [GitLab](https://docs.zerops.io/references/gitlab-integration){rel="&#x22;nofollow&#x22;"} ä»“åº“æ¥å®ç°ã€‚

## æ„å»ºå’Œéƒ¨ç½²

åœ¨ Zerops åº”ç”¨ä¸­æ‰“å¼€ [è®¾ç½® > è®¿é—®ä»¤ç‰Œç®¡ç†](https://app.zerops.io/settings/token-management){rel="&#x22;nofollow&#x22;"}ï¼Œç”Ÿæˆæ–°çš„è®¿é—®ä»¤ç‰Œã€‚

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç™»å½•æ‚¨çš„è®¿é—®ä»¤ç‰Œï¼š

:pm-x{command="@zerops/zcli login <token>"}

å¯¼èˆªåˆ°æ‚¨çš„åº”ç”¨æ ¹ç›®å½•ï¼ˆ`zerops.yml` æ‰€åœ¨ä½ç½®ï¼‰ï¼Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥è§¦å‘éƒ¨ç½²ï¼š

:pm-x{command="@zerops/zcli push"}

é€šè¿‡å°†æœåŠ¡ä¸æ‚¨çš„ [GitHub](https://docs.zerops.io/references/gitlab-integration){rel="&#x22;nofollow&#x22;"} / [GitLab](https://docs.zerops.io/references/gitlab-integration){rel="&#x22;nofollow&#x22;"} ä»“åº“è¿æ¥ï¼Œæ‚¨çš„ä»£ç å¯ä»¥åœ¨æ¯æ¬¡æäº¤æˆ–æ–°æ ‡ç­¾æ—¶è‡ªåŠ¨éƒ¨ç½²ã€‚å¯ä»¥åœ¨æœåŠ¡è¯¦ç»†ä¿¡æ¯ä¸­è®¾ç½®æ­¤è¿æ¥ã€‚

:read-more{title="Zerops æ–‡æ¡£" to="https://docs.zerops.io/"}


# é…ç½®

:read-more{to="https://nitro.zhcndoc.com/guide/configuration"}

::warning
Nitro v3 Alpha æ–‡æ¡£ä»åœ¨ç¼–å†™ä¸­ â€” é¢„è®¡ä¼šæœ‰æ›´æ–°ã€ç²—ç³™ä¹‹å¤„å’Œå¶å°”çš„ä¸å‡†ç¡®ä¹‹å¤„ã€‚
::

## ä¸€èˆ¬è®¾ç½®

### `preset`

ä½¿ç”¨ `preset` é€‰é¡¹ `NITRO_PRESET` ç¯å¢ƒå˜é‡æ¥è®¾ç½®è‡ªå®šä¹‰çš„ **ç”Ÿäº§** é¢„è®¾ã€‚

å¼€å‘æ¨¡å¼ä¸‹çš„é¢„è®¾å§‹ç»ˆä¸º `nitro_dev`ï¼Œè€Œç”Ÿäº§æ¨¡å¼ä¸‹çš„é»˜è®¤é¢„è®¾ä¸º `node_server`ï¼Œç”¨äºæ„å»ºç‹¬ç«‹çš„ Node.js æœåŠ¡å™¨ã€‚

å½“æœªè®¾ç½® `preset` é€‰é¡¹å¹¶åœ¨å·²çŸ¥ç¯å¢ƒä¸­è¿è¡Œæ—¶ï¼Œé¢„è®¾å°†è‡ªåŠ¨è¢«æ£€æµ‹ã€‚

### `logLevel`

- é»˜è®¤: `3`{.shiki,shiki-themes,github-light,github-dark,github-dark lang="ts"} (`1`{.shiki,shiki-themes,github-light,github-dark,github-dark lang="ts"} å½“æ£€æµ‹åˆ°æµ‹è¯•ç¯å¢ƒæ—¶)

æ—¥å¿—è¯¦ç»†çº§åˆ«ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ [consola](https://github.com/unjs/consola?tab=readme-ov-file#log-level){rel="&#x22;nofollow&#x22;"}ã€‚

### `runtimeConfig`

- é»˜è®¤: `{ nitro: { ... }, ...yourOptions }`{.shiki,shiki-themes,github-light,github-dark,github-dark lang="ts"}

æœåŠ¡å™¨è¿è¡Œæ—¶é…ç½®ã€‚

**æ³¨æ„:** `nitro` å‘½åç©ºé—´æ˜¯ä¿ç•™çš„ã€‚

### `compatibilityDate`

éƒ¨ç½²æä¾›å•†å¼•å…¥äº† Nitro é¢„è®¾å¯ä»¥åˆ©ç”¨çš„æ–°åŠŸèƒ½ï¼Œä½†å…¶ä¸­ä¸€äº›éœ€è¦æ˜ç¡®é€‰æ‹©ã€‚

å°†å…¶è®¾ç½®ä¸ºæœ€æ–°çš„æµ‹è¯•æ—¥æœŸï¼Œæ ¼å¼ä¸º `YY-MM-DD`ï¼Œä»¥åˆ©ç”¨æœ€æ–°çš„é¢„è®¾åŠŸèƒ½ã€‚

å¦‚æœæœªæä¾›æ­¤é…ç½®ï¼ŒNitro å°†ç»§ç»­ä½¿ç”¨å½“å‰ (v2.9) çš„é¢„è®¾è¡Œä¸ºå¹¶æ˜¾ç¤ºè­¦å‘Šã€‚

## ç‰¹æ€§

### `experimental`

- é»˜è®¤: `{}`

å¯ç”¨å®éªŒæ€§åŠŸèƒ½ã€‚

#### `openAPI`

å¯ç”¨ `/_scalar`ã€`/_swagger` å’Œ `/_openapi.json` ç«¯ç‚¹ã€‚

- é»˜è®¤: `false`

è¦åœ¨è·¯ç”±ä¸Šå®šä¹‰ OpenAPI è§„èŒƒï¼Œè¯·æŸ¥çœ‹ [defineRouteMeta](https://nitro.zhcndoc.com/guide/routing#route-meta)ã€‚

æ‚¨å¯ä»¥åœ¨æ ¹çº§åˆ«ä¼ é€’ä¸€ä¸ªå¯¹è±¡æ¥ä¿®æ”¹æ‚¨çš„ OpenAPI è§„èŒƒï¼š

```js
openAPI: {
  meta: {
    title: 'æˆ‘çš„ç²¾å½©é¡¹ç›®',
    description: 'è¿™å¯èƒ½ä¼šæˆä¸ºä¸‹ä¸€ä¸ªå¤§çƒ­é—¨ã€‚',
    version: '1.0'
  }
}
```

è¿™äº›è·¯ç”±åœ¨ç”Ÿäº§ä¸­é»˜è®¤ä¸ºç¦ç”¨ã€‚è¦å¯ç”¨å®ƒä»¬ï¼Œè¯·ä½¿ç”¨ `production` é”®ã€‚
`"runtime"` å…è®¸ä½¿ç”¨ä¸­é—´ä»¶ï¼Œè€Œ `"prerender"` æ˜¯æœ€æœ‰æ•ˆçš„ï¼Œå› ä¸º JSON å“åº”æ˜¯å¸¸é‡ã€‚

```js
openAPI: {
    // é‡è¦: ç¡®ä¿åœ¨å¿…è¦æ—¶ä¿æŠ¤ OpenAPI è·¯ç”±ï¼
    production: "runtime", // æˆ– "prerender"
}
```

å¦‚æœæ‚¨å¸Œæœ›è‡ªå®šä¹‰ Scalar é›†æˆï¼Œæ‚¨å¯ä»¥åƒè¿™æ · [ä¼ é€’é…ç½®å¯¹è±¡](https://github.com/scalar/scalar){rel="&#x22;nofollow&#x22;"}ï¼š

```js
openAPI: {
  ui: {
    scalar: {
      theme: 'purple'
    }
  }
}
```

æˆ–è€…ï¼Œå¦‚æœæ‚¨æƒ³è¦è‡ªå®šä¹‰ç«¯ç‚¹ï¼š

```js
openAPI: {
  route: "/_docs/openapi.json",
  ui: {
    scalar: {
      route: "/_docs/scalar"
    },
    swagger: {
      route: "/_docs/swagger"
    }
  }
}
```

#### `wasm`

å¯ç”¨ WASM æ”¯æŒã€‚

#### `legacyExternals`

å¯ç”¨åï¼Œå°†ä½¿ç”¨é—ç•™ï¼ˆä¸ç¨³å®šï¼‰å®éªŒæ€§ rollup externals ç®—æ³•ã€‚

### `future`

- é»˜è®¤: `{}`

å¾…é‡å¤§ç‰ˆæœ¬æ¨å‡ºçš„æ–°ç‰¹æ€§ï¼Œä»¥é¿å…ç ´åæ€§æ›´æ”¹ã€‚

#### `nativeSWR`

ä¸º Netlify å’Œ Vercel é¢„è®¾ä½¿ç”¨å†…ç½®çš„ SWR åŠŸèƒ½ï¼ˆä½¿ç”¨ç¼“å­˜å±‚å’Œå­˜å‚¨ï¼‰ï¼Œè€Œä¸æ˜¯å›é€€åˆ° ISR è¡Œä¸ºã€‚

### `storage`

- é»˜è®¤: `{}`

å­˜å‚¨é…ç½®ï¼Œè¯¦ç»†ä¿¡æ¯è¯·å‚è§ [å­˜å‚¨å±‚](https://nitro.zhcndoc.com/guide/storage) éƒ¨åˆ†ã€‚

### `renderer`

ä¸»è¦æ¸²æŸ“è·¯å¾„ï¼ˆæ–‡ä»¶åº”ä½œä¸ºé»˜è®¤å¯¼å‡ºäº‹ä»¶å¤„ç†ç¨‹åºï¼‰ã€‚

### `serveStatic`

- ç±»å‹: `boolean` | `'node'`{.shiki,shiki-themes,github-light,github-dark,github-dark lang="ts"} | `'deno'`{.shiki,shiki-themes,github-light,github-dark,github-dark lang="ts"}
- é»˜è®¤: å–å†³äºä½¿ç”¨çš„éƒ¨ç½²é¢„è®¾ã€‚

åœ¨ç”Ÿäº§ä¸­æä¾› `public/` èµ„äº§ã€‚

**æ³¨æ„:** å¼ºçƒˆå»ºè®®æ‚¨çš„è¾¹ç¼˜ CDNï¼ˆNginxã€Apacheã€Cloudï¼‰æä¾› `.output/public/` ç›®å½•ï¼Œè€Œä¸æ˜¯å¯ç”¨å‹ç¼©å’Œæ›´é«˜å±‚æ¬¡çš„ç¼“å­˜ã€‚

### `noPublicDir`

- é»˜è®¤: `false`{.shiki,shiki-themes,github-light,github-dark,github-dark lang="ts"}

å¦‚æœå¯ç”¨ï¼Œå°†ç¦ç”¨ `.output/public` ç›®å½•çš„åˆ›å»ºã€‚è·³è¿‡å¤åˆ¶ `public/` ç›®å½•ï¼Œå¹¶ç¦ç”¨é¢„æ¸²æŸ“ã€‚

### `publicAssets`

åœ¨å¼€å‘ä¸­æä¾›å’Œåœ¨ç”Ÿäº§ä¸­æ‰“åŒ…çš„å…¬å…±èµ„äº§ç›®å½•ã€‚

å¦‚æœæ£€æµ‹åˆ° `public/` ç›®å½•ï¼Œå®ƒå°†é»˜è®¤æ·»åŠ ï¼Œä½†æ‚¨ä¹Ÿå¯ä»¥è‡ªå·±æ·»åŠ æ›´å¤šï¼

å¯ä»¥ä½¿ç”¨ `maxAge` é€‰é¡¹ä¸ºèµ„äº§è®¾ç½® Cache-Control å¤´ï¼š

```ts
  publicAssets: [
    {
      baseURL: "images",
      dir: "public/images",
      maxAge: 60 * 60 * 24 * 7, // 7 å¤©
    },
  ],
```

ä¸Šè¿°é…ç½®åœ¨ `public/images/` æ–‡ä»¶å¤¹ä¸‹çš„èµ„äº§ä¸­ç”Ÿæˆä»¥ä¸‹å¤´éƒ¨ï¼š

`cache-control: public, max-age=604800, immutable`

`dir` é€‰é¡¹æ˜¯æ‚¨çš„æ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä½ç½®ï¼›`baseURL` é€‰é¡¹æ˜¯å®ƒä»¬åœ¨æä¾›/æ‰“åŒ…æ—¶å¯ä»¥ä»ä¸­è®¿é—®çš„æ–‡ä»¶å¤¹ã€‚

### `compressPublicAssets`

- é»˜è®¤: `{ gzip: false, brotli: false, zstd: false }`{.shiki,shiki-themes,github-light,github-dark,github-dark lang="ts"}

å¦‚æœå¯ç”¨ï¼ŒNitro å°†ä¸ºå…¬å…±èµ„äº§å’Œå¤§äº 1024 å­—èŠ‚çš„æ”¯æŒç±»å‹çš„é¢„æ¸²æŸ“è·¯ç”±ç”Ÿæˆé¢„å‹ç¼©ï¼ˆgzipã€brotli å’Œ/æˆ– zstdï¼‰ç‰ˆæœ¬ï¼Œè¾“å‡ºåˆ° public ç›®å½•ã€‚ä½¿ç”¨é»˜è®¤å‹ç¼©çº§åˆ«ã€‚ä½¿ç”¨æ­¤é€‰é¡¹ï¼Œæ‚¨å¯ä»¥æ”¯æŒé›¶å¼€é”€èµ„äº§å‹ç¼©ï¼Œæ— éœ€ä½¿ç”¨ CDNã€‚

å¯å‹ç¼© MIME ç±»å‹åˆ—è¡¨ï¼š

- `application/dash+xml`
- `application/eot`
- `application/font`
- `application/font-sfnt`
- `application/javascript`
- `application/json`
- `application/opentype`
- `application/otf`
- `application/pdf`
- `application/pkcs7-mime`
- `application/protobuf`
- `application/rss+xml`
- `application/truetype`
- `application/ttf`
- `application/vnd.apple.mpegurl`
- `application/vnd.mapbox-vector-tile`
- `application/vnd.ms-fontobject`
- `application/wasm`
- `application/xhtml+xml`
- `application/xml`
- `application/x-font-opentype`
- `application/x-font-truetype`
- `application/x-font-ttf`
- `application/x-httpd-cgi`
- `application/x-javascript`
- `application/x-mpegurl`
- `application/x-opentype`
- `application/x-otf`
- `application/x-perl`
- `application/x-ttf`
- `font/eot`
- `font/opentype`
- `font/otf`
- `font/ttf`
- `image/svg+xml`
- `text/css`
- `text/csv`
- `text/html`
- `text/javascript`
- `text/js`
- `text/plain`
- `text/richtext`
- `text/tab-separated-values`
- `text/xml`
- `text/x-component`
- `text/x-java-source`
- `text/x-script`
- `vnd.apple.mpegurl`

### `serverAssets`

èµ„äº§å¯ä»¥åœ¨æœåŠ¡å™¨é€»è¾‘ä¸­è®¿é—®å¹¶åœ¨ç”Ÿäº§ä¸­æ‰“åŒ…ã€‚ [é˜…è¯»æ›´å¤š](https://nitro.zhcndoc.com/guide/assets#server-assets)ã€‚

### `devServer`

- é»˜è®¤: `{ watch: [] }`{.shiki,shiki-themes,github-light,github-dark,github-dark lang="ts"}

å¼€å‘æœåŠ¡å™¨é€‰é¡¹ã€‚æ‚¨å¯ä»¥ä½¿ç”¨ `watch` é€‰é¡¹ä½¿å¼€å‘æœåŠ¡å™¨åœ¨æŒ‡å®šè·¯å¾„ä¸­çš„ä»»ä½•æ–‡ä»¶å˜åŒ–æ—¶é‡æ–°åŠ è½½ã€‚

### `watchOptions`

å¼€å‘æ¨¡å¼çš„ç›‘è§†é€‰é¡¹ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ [chokidar](https://github.com/paulmillr/chokidar){rel="&#x22;nofollow&#x22;"}ã€‚

### `imports`

è‡ªåŠ¨å¯¼å…¥é€‰é¡¹ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ [unimport](https://github.com/unjs/unimport){rel="&#x22;nofollow&#x22;"}ã€‚

### `plugins`

- é»˜è®¤: `[]`

ä¸€ä¸ª nitro æ’ä»¶è·¯å¾„æ•°ç»„ã€‚å®ƒä»¬å°†åœ¨é¦–æ¬¡åˆå§‹åŒ–æ—¶æŒ‰é¡ºåºæ‰§è¡Œã€‚

è¯·æ³¨æ„ï¼ŒNitro ä¼šè‡ªåŠ¨æ³¨å†Œ `plugins/` ç›®å½•ä¸­çš„æ’ä»¶ï¼Œ[äº†è§£æ›´å¤š](https://nitro.zhcndoc.com/guide/plugins)ã€‚

### `virtual`

- é»˜è®¤: `{}`

ä»åŠ¨æ€è™šæ‹Ÿå¯¼å…¥åç§°æ˜ å°„åˆ°å…¶å†…å®¹æˆ–è¿”å›è¯¥å†…å®¹çš„ï¼ˆå¼‚æ­¥ï¼‰å‡½æ•°ã€‚

## è·¯ç”±

### `baseURL`

é»˜è®¤: `/`{.shiki,shiki-themes,github-light,github-dark,github-dark lang="ts"}ï¼ˆå¦‚æœæä¾›ï¼Œåˆ™ä¸º `NITRO_APP_BASE_URL` ç¯å¢ƒå˜é‡ï¼‰

æœåŠ¡å™¨çš„ä¸»åŸºæœ¬ URLã€‚

### `apiBaseURL`

- é»˜è®¤: `/api`

æ›´æ”¹é»˜è®¤ API åŸºæœ¬ URL å‰ç¼€ã€‚

### `handlers`

æœåŠ¡å™¨å¤„ç†ç¨‹åºå’Œè·¯ç”±ã€‚

å¦‚æœå­˜åœ¨ `server/routes/`ã€`server/api/` æˆ– `server/middleware/` ç›®å½•ï¼Œå®ƒä»¬å°†è‡ªåŠ¨æ·»åŠ åˆ°å¤„ç†ç¨‹åºæ•°ç»„ä¸­ã€‚

### `devHandlers`

å¸¸è§„å¤„ç†ç¨‹åºæŒ‡çš„æ˜¯è¦å¯¼å…¥å’Œé€šè¿‡ rollup è½¬æ¢çš„å¤„ç†ç¨‹åºè·¯å¾„ã€‚

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›ç›´æ¥æä¾›å…·æœ‰ç¼–ç¨‹ç”¨é€”çš„å¤„ç†ç¨‹åºå®ä¾‹ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `devHandlers`ï¼Œä½†è¯·æ³¨æ„ï¼Œå®ƒä»¬ **ä»…åœ¨å¼€å‘æ¨¡å¼ä¸‹å¯ç”¨**ï¼Œå¹¶ **ä¸åœ¨ç”Ÿäº§æ„å»ºä¸­å¯ç”¨**ã€‚

ä¾‹å¦‚ï¼š

```ts
import { defineNitroConfig } from "nitro/config";
import { defineHandler } from "nitro/h3";

export default defineNitroConfig({
  devHandlers: [
    {
      route: '/',
      handler: defineHandler((event) => {
        console.log(event);
      }),
    },
  ],
});
```

### `devProxy`

å¼€å‘æœåŠ¡å™¨çš„ä»£ç†é…ç½®ã€‚

æ‚¨å¯ä»¥ä½¿ç”¨æ­¤é€‰é¡¹è¦†ç›–å¼€å‘æœåŠ¡å™¨è·¯ç”±å¹¶ä»£ç†è¯·æ±‚ã€‚

```js
{
  devProxy: {
    '/proxy/test': 'http://localhost:3001',
    '/proxy/example': { target: 'https://example.com', changeOrigin: true }
  }
}
```

è¯·å‚è§ [httpxy](https://github.com/unjs/httpxy){rel="&#x22;nofollow&#x22;"} ä»¥è·å–æ‰€æœ‰å¯ç”¨ç›®æ ‡é€‰é¡¹ã€‚

### `errorHandler`

è‡ªå®šä¹‰è¿è¡Œæ—¶é”™è¯¯å¤„ç†ç¨‹åºçš„è·¯å¾„ã€‚æ›¿æ¢ nitro çš„å†…ç½®é”™è¯¯é¡µé¢ã€‚
é”™è¯¯å¤„ç†ç¨‹åºå°†è·å¾—ä¸€ä¸ª `H3Error` å’Œ `H3Event`ã€‚å¦‚æœå¤„ç†ç¨‹åºè¿”å›ä¸€ä¸ª promiseï¼Œå°†è¿›è¡Œç­‰å¾…ã€‚
å¤„ç†ç¨‹åºéœ€è¦å‘é€è‡ªå·±çš„å“åº”ã€‚
ä»¥ä¸‹æ˜¯ä¸€ä¸ªä½¿ç”¨ h3 çš„å‡½æ•°è¿”å›çº¯æ–‡æœ¬å“åº”çš„ç¤ºä¾‹ã€‚

**ç¤ºä¾‹ï¼š**

::CodeGroup
```js [nitro.config]
import { defineNitroConfig } from "nitro/config";

export default defineNitroConfig({
  errorHandler: "~/error",
});
```

```js [error.ts]
export default defineNitroErrorHandler((error, event) => {
  setResponseHeader(event, 'Content-Type', 'text/plain')
  return send(event, '[è‡ªå®šä¹‰é”™è¯¯å¤„ç†ç¨‹åº] ' + error.stack)
});
```
::

### `routeRules`

**ğŸ§ª å®éªŒæ€§ï¼**

è·¯ç”±é€‰é¡¹ã€‚å®ƒæ˜¯ä»è·¯ç”±æ¨¡å¼ï¼ˆéµå¾ª [rou3](https://github.com/h3js/rou3){rel="&#x22;nofollow&#x22;"}ï¼‰åˆ°è·¯ç”±é€‰é¡¹çš„æ˜ å°„ã€‚

å½“è®¾ç½® `cache` é€‰é¡¹æ—¶ï¼ŒåŒ¹é…æ¨¡å¼çš„å¤„ç†ç¨‹åºå°†è‡ªåŠ¨ç”¨ `defineCachedEventHandler` åŒ…è£…ã€‚

æœ‰å…³æ‰€æœ‰å¯ç”¨ç¼“å­˜é€‰é¡¹ï¼Œè¯·å‚è§ [ç¼“å­˜ API](https://nitro.zhcndoc.com/guide/cache)ã€‚

::note
`swr: true|number` æ˜¯ `cache: { swr: true, maxAge: number }` çš„å¿«æ·æ–¹å¼ã€‚
::

**ç¤ºä¾‹ï¼š**

```js
routeRules: {
  '/blog/**': { swr: true },
  '/blog/**': { swr: 600 },
  '/blog/**': { static: true },
  '/blog/**': { cache: { /* ç¼“å­˜é€‰é¡¹*/ } },
  '/assets/**': { headers: { 'cache-control': 's-maxage=0' } },
  '/api/v1/**': { cors: true, headers: { 'access-control-allow-methods': 'GET' } },
  '/old-page': { redirect: '/new-page' }, // ä½¿ç”¨çŠ¶æ€ç  307 (ä¸´æ—¶é‡å®šå‘)
  '/old-page2': { redirect: { to:'/new-page2', statusCode: 301 } },
  '/old-page/**': { redirect: '/new-page/**' },
  '/proxy/example': { proxy: 'https://example.com' },
  '/proxy/**': { proxy: '/api/**' },
}
```

### `prerender`

é»˜è®¤ï¼š

```ts
{
  autoSubfolderIndex: true,
  concurrency: 1,
  interval: 0,
  failOnError: false,
  crawlLinks: false,
  ignore: [],
  routes: [],
  retry: 3,
  retryDelay: 500
}
```

é¢„æ¸²æŸ“é€‰é¡¹ã€‚ä»»ä½•æŒ‡å®šçš„è·¯ç”±å°†åœ¨æ„å»ºæœŸé—´è·å–å¹¶å¤åˆ¶åˆ° `.output/public` ç›®å½•ä½œä¸ºé™æ€èµ„äº§ã€‚

ä»¥ `ignore` ä¸­åˆ—å‡ºçš„å‰ç¼€å¼€å¤´çš„ä»»ä½•è·¯ç”±ï¼ˆå­—ç¬¦ä¸²ï¼‰æˆ–åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼æˆ–å‡½æ•°çš„è·¯ç”±å°†è¢«å¿½ç•¥ã€‚

å¦‚æœå°† `crawlLinks` é€‰é¡¹è®¾ç½®ä¸º `true`ï¼ŒNitro é»˜è®¤ä¼šä» `/` å¼€å§‹ï¼ˆæˆ–æ‰€æœ‰åœ¨ `routes` æ•°ç»„ä¸­çš„è·¯ç”±ï¼‰ï¼Œå¹¶ä¸º HTML é¡µé¢æå– `<a>` æ ‡ç­¾å¹¶è¿›è¡Œé¢„æ¸²æŸ“ã€‚

æ‚¨å¯ä»¥å°† `failOnError` é€‰é¡¹è®¾ç½®ä¸º `true`ï¼Œä»¥åœ¨ Nitro æ— æ³•é¢„æ¸²æŸ“è·¯ç”±æ—¶åœæ­¢ CIã€‚

`interval` å’Œ `concurrency` é€‰é¡¹å…è®¸æ‚¨æ§åˆ¶é¢„æ¸²æŸ“çš„é€Ÿåº¦ï¼Œå¯ä»¥æœ‰åŠ©äºé¿å…åœ¨è°ƒç”¨å¤–éƒ¨ API æ—¶ hitting ä¸€äº›é€Ÿç‡é™åˆ¶ã€‚

è®¾ç½® `autoSubfolderIndex` å¯ä»¥è®©æ‚¨æ§åˆ¶å¦‚ä½•åœ¨ `.output/public` ç›®å½•ä¸­ç”Ÿæˆæ–‡ä»¶ï¼š

```bash
# autoSubfolderIndex: true (é»˜è®¤)
å…³äº -> .output/public/about/index.html
# autoSubfolderIndex: false
å…³äº -> .output/public/about.html
```

å½“æ‚¨çš„æ‰˜ç®¡æä¾›å•†ä¸æä¾›æœ‰å…³å°¾éšæ–œæ çš„é€‰é¡¹æ—¶ï¼Œæ­¤é€‰é¡¹æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚

é¢„æ¸²æŸ“å™¨å°†å°è¯•æ¸²æŸ“é¡µé¢ 3 æ¬¡ï¼Œé—´éš” 500 æ¯«ç§’ã€‚ä½¿ç”¨ `retry` å’Œ `retryDelay` æ¥æ›´æ”¹æ­¤è¡Œä¸ºã€‚

## ç›®å½•

### `workspaceDir`

é¡¹ç›®å·¥ä½œåŒºæ ¹ç›®å½•ã€‚

å½“æœªè®¾ç½® `workspaceDir` é€‰é¡¹æ—¶ï¼Œå·¥ä½œåŒºï¼ˆä¾‹å¦‚ pnpm å·¥ä½œåŒºï¼‰ç›®å½•ä¼šè¢«è‡ªåŠ¨æ£€æµ‹ã€‚

### `rootDir`

é¡¹ç›®ä¸»ç›®å½•.

### `srcDir`

- é»˜è®¤: ï¼ˆä¸ `rootDir` ç›¸åŒï¼‰

é¡¹ç›®æºç›®å½•ã€‚é™¤éæŒ‡å®šï¼Œå¦åˆ™ä¸ `rootDir` ç›¸åŒã€‚
`api`ã€`routes`ã€`plugins`ã€`utils`ã€`public`ã€`middleware`ã€`assets` å’Œ `tasks` æ–‡ä»¶å¤¹çš„æ ¹ç›®å½•ã€‚

### `scanDirs`

- é»˜è®¤: ï¼ˆæºç›®å½•ä¸ºç©ºæ•°ç»„æ—¶ï¼‰

è¦æ‰«æå’Œè‡ªåŠ¨æ³¨å†Œæ–‡ä»¶çš„ç›®å½•åˆ—è¡¨ï¼Œä¾‹å¦‚ API è·¯ç”±ã€‚

### `apiDir`

- é»˜è®¤: `api`

å®šä¹‰ä¸€ä¸ªä¸åŒçš„ç›®å½•æ¥æ‰«æ API è·¯ç”±å¤„ç†ç¨‹åºã€‚

### `routesDir`

- é»˜è®¤: `routes`

å®šä¹‰ä¸€ä¸ªä¸åŒçš„ç›®å½•æ¥æ‰«æè·¯ç”±å¤„ç†ç¨‹åºã€‚

### `buildDir`

- é»˜è®¤: `.nitro`

nitro ç”¨äºç”Ÿæˆæ„å»ºç›¸å…³æ–‡ä»¶çš„ä¸´æ—¶å·¥ä½œç›®å½•ã€‚

### `output`

- é»˜è®¤: `{ dir: '.output', serverDir: '.output/server', publicDir: '.output/public' }`

ç”Ÿäº§åŒ…çš„è¾“å‡ºç›®å½•ã€‚

## é«˜çº§

### `dev`

- é»˜è®¤: `true`ï¼ˆå¼€å‘ï¼‰å’Œ `false`ï¼ˆç”Ÿäº§ï¼‰ã€‚

**âš ï¸ æ³¨æ„ï¼è¿™æ˜¯ä¸€ä¸ªé«˜çº§é…ç½®ã€‚å¦‚æœé…ç½®é”™è¯¯ï¼Œå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚**

### `typescript`

é»˜è®¤: `{ generateTsConfig: true }`

### `nodeModulesDirs`

**âš ï¸ æ³¨æ„ï¼è¿™æ˜¯ä¸€ä¸ªé«˜çº§é…ç½®ã€‚å¦‚æœé…ç½®é”™è¯¯ï¼Œå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚**

ç”¨äºè§£ææ¨¡å—æ—¶è¦æœç´¢çš„é¢å¤– `node_modules`ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šæ·»åŠ ç”¨æˆ·ç›®å½•ã€‚

### `hooks`

**âš ï¸ æ³¨æ„ï¼è¿™æ˜¯ä¸€ä¸ªé«˜çº§é…ç½®ã€‚å¦‚æœé…ç½®é”™è¯¯ï¼Œå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚**

nitro é’©å­ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ [hookable](https://github.com/unjs/hookable){rel="&#x22;nofollow&#x22;"}ã€‚

### `commands`

**âš ï¸ æ³¨æ„ï¼è¿™æ˜¯ä¸€ä¸ªé«˜çº§é…ç½®ã€‚å¦‚æœé…ç½®é”™è¯¯ï¼Œå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚**

é¢„è§ˆå’Œéƒ¨ç½²å‘½ä»¤æç¤ºé€šå¸¸ç”±éƒ¨ç½²é¢„è®¾å¡«å……ã€‚

### `devErrorHandler`

**âš ï¸ æ³¨æ„ï¼è¿™æ˜¯ä¸€ä¸ªé«˜çº§é…ç½®ã€‚å¦‚æœé…ç½®é”™è¯¯ï¼Œå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ã€‚**

ç”¨äºå¼€å‘é”™è¯¯çš„è‡ªå®šä¹‰é”™è¯¯å¤„ç†ç¨‹åºå‡½æ•°ã€‚

## Rollup

### `rollupConfig`

é¢å¤–çš„ rollup é…ç½®ã€‚

### `entry`

Rollup å…¥å£ã€‚

### `unenv`

[unenv](https://github.com/unjs/unenv/){rel="&#x22;nofollow&#x22;"} é¢„è®¾çš„é€‰é¡¹ã€‚

### `alias`

Rollup åˆ«åé€‰é¡¹ã€‚

### `minify`

- é»˜è®¤: `false`

å‹ç¼©åŒ…ã€‚

### `inlineDynamicImports`

- é»˜è®¤: `false`

å°†æ‰€æœ‰ä»£ç æ†ç»‘æˆå•ä¸ªæ–‡ä»¶ï¼Œè€Œä¸æ˜¯ä¸ºæ¯ä¸ªè·¯ç”±åˆ›å»ºå•ç‹¬çš„å—ã€‚

å½“ä¸º `false` æ—¶ï¼Œæ¯ä¸ªè·¯ç”±å¤„ç†ç¨‹åºå˜æˆå•ç‹¬çš„å—æŒ‰éœ€åŠ è½½ã€‚å½“ä¸º `true` æ—¶ï¼Œæ‰€æœ‰å†…å®¹æ‰“åŒ…åœ¨ä¸€èµ·ã€‚ä¸€äº›é¢„è®¾é»˜è®¤å¯ç”¨æ­¤åŠŸèƒ½ã€‚

### `sourceMap`

å¯ç”¨æºæ˜ å°„ç”Ÿæˆã€‚è¯·å‚è§ [é€‰é¡¹](https://rollupjs.org/configuration-options/#output-sourcemap){rel="&#x22;nofollow&#x22;"}

- é»˜è®¤: `true`

### `node`

æŒ‡å®šæ„å»ºæ˜¯å¦ç”¨äº Node.jsã€‚å¦‚æœè®¾ç½®ä¸º `false`ï¼ŒNitro ä¼šå°è¯•ä½¿ç”¨ [unenv](https://github.com/unjs/unenv){rel="&#x22;nofollow&#x22;"} æ¨¡æ‹Ÿ Node.js ä¾èµ–ï¼Œå¹¶è°ƒæ•´å…¶è¡Œä¸ºã€‚

### `moduleSideEffects`

é»˜è®¤: `['unenv/polyfill/']`

Rollup ç‰¹å®šé€‰é¡¹ã€‚æŒ‡å®šå…·æœ‰å‰¯ä½œç”¨çš„æ¨¡å—å¯¼å…¥ã€‚

### `replace`

Rollup ç‰¹å®šé€‰é¡¹ã€‚

### `commonJS`

Rollup ç‰¹å®šé€‰é¡¹ã€‚ä¸º rollup CommonJS æ’ä»¶æŒ‡å®šé¢å¤–é…ç½®ã€‚

## é¢„è®¾é€‰é¡¹

### `firebase`

Firebase å‡½æ•°é¢„è®¾çš„é€‰é¡¹ã€‚è¯·å‚è§ [é¢„è®¾æ–‡æ¡£](https://nitro.zhcndoc.com/deploy/providers/firebase#options)

### `vercel`

Vercel é¢„è®¾çš„é€‰é¡¹ã€‚è¯·å‚è§ [é¢„è®¾æ–‡æ¡£](https://nitro.zhcndoc.com/deploy/providers/vercel)

### `cloudflare`

Cloudflare é¢„è®¾çš„é€‰é¡¹ã€‚è¯·å‚è§ [é¢„è®¾æ–‡æ¡£](https://nitro.zhcndoc.com/deploy/providers/cloudflare)


# ç¤ºä¾‹



# Nitro ä¸­æ–‡æ–‡æ¡£ - å‘å¸ƒå…¨æ ˆ Vite åº”ç”¨

::u-page-hero
---
orientation: horizontal
---
  :::code-group
    ::::prose-pre{filename="vite.config.ts"}
    ```ts
    import { defineConfig } from 'vite'
    import { nitro } from 'nitro/vite'

    export default defineConfig({
      plugins: [
        nitro()
      ],
      nitro: {
        preset: 'standard'
      }
    })
    ```
    ::::
  :::

:hero-background

#title
å‘å¸ƒ [å…¨æ ˆ]{.text-primary} Vite åº”ç”¨

#description
Nitro ä¸ºæ‚¨çš„ Vite åº”ç”¨æ‰©å±•äº†ä¸€ä¸ªç”Ÿäº§å°±ç»ªçš„æœåŠ¡å™¨ï¼Œå…¼å®¹ä»»ä½•è¿è¡Œæ—¶ã€‚å‘åº”ç”¨æ·»åŠ æœåŠ¡å™¨è·¯ç”±ï¼Œå¹¶ä»¥é›¶é…ç½®ä½“éªŒéƒ¨ç½²åˆ°å¤šç§æ‰˜ç®¡å¹³å°ã€‚

#links
  :::u-button
  ---
  size: xl
  to: https://nitro.zhcndoc.com/docs/quick-start
  trailing-icon: i-lucide-arrow-right
  ---
  å¿«é€Ÿå¼€å§‹
  :::

  :::u-button
  ---
  color: neutral
  icon: i-simple-icons-github
  size: xl
  target: _blank
  to: https://github.com/nitrojs/nitro
  variant: outline
  ---
  GitHub
  :::
::

::div{.bg-neutral-50.dark:bg-neutral-950/30.py-10.border-y.border-default}
  :::u-container
    ::::u-page-grid
      :::::u-page-feature
      #title
      å¿«é€Ÿ

      #description
      äº«å—å¸¦æœ‰æœåŠ¡å™¨ç«¯ HMR çš„ Vite å¼€å‘ä½“éªŒï¼Œå¹¶é’ˆå¯¹ç”Ÿäº§ç¯å¢ƒè¿›è¡Œä¼˜åŒ–ã€‚
      :::::

      :::::u-page-feature
      #title
      å¤šæ ·

      #description
      ä½¿ç”¨é›¶é…ç½®å°†ç›¸åŒä»£ç åº“éƒ¨ç½²åˆ°ä»»ä½•éƒ¨ç½²æä¾›å•†ï¼Œæ— ä¾›åº”å•†é”å®šã€‚
      :::::

      :::::u-page-feature
      #title
      æç®€

      #description
      æç®€è®¾è®¡ï¼Œé€‚é…ä»»ä½•è§£å†³æ–¹æ¡ˆï¼Œå¼€é”€æœ€ä½ã€‚
      :::::
    ::::
  :::
::

::u-page-section
---
features:
  - title: routes/
    description: åœ¨ routes/ ç›®å½•ä¸­åˆ›å»ºæœåŠ¡å™¨è·¯ç”±ï¼Œå®ƒä»¬å°†è‡ªåŠ¨æ³¨å†Œã€‚
    icon: i-lucide-folder-tree
  - title: server.ts
    description: å®Œå…¨éµå¾ª Web æ ‡å‡†ï¼Œä½¿ç”¨æ‚¨é€‰æ‹©çš„æ ‡å‡†åº“ï¼Œåœ¨ server.ts æ–‡ä»¶ä¸­åˆ›å»ºæœåŠ¡å™¨è·¯ç”±ã€‚
    icon: i-lucide-file-code
orientation: horizontal
---
  :::div{.min-h-[506px]}
    ::::tabs
      :::::tabs-item{icon="i-lucide-folder" label="æ–‡ä»¶ç³»ç»Ÿè·¯ç”±"}
        ::::::code-tree{expand-all default-value="routes/hello.ts" expand-all=""}
          :::::::prose-pre{filename="vite.config.ts"}
          ```ts
          import { defineConfig } from 'vite'
          import { nitro } from 'nitro/vite'

          export default defineConfig({
            plugins: [
              nitro()
            ],
          });
          ```
          :::::::

          :::::::prose-pre{filename="routes/hello.ts"}
          ```ts
          import { defineHandler } from 'nitro/h3'

          export default defineHandler(({ req }) => {
            return { api: 'works!' }
          })
          ```
          :::::::

          :::::::prose-pre{filename="index.html"}
          ```html
            <html>
            <head>
              <title>Nitro + Vite</title>
            </head>
            <body>
              <h1>Hey, there!</h1>
            </body>
            </html>
          ```
          :::::::
        ::::::
      :::::

      :::::tabs-item{icon="i-lucide-globe" label="Web æ ‡å‡†"}
        ::::::prose-pre{filename="server.ts"}
        ```ts
        export default {
          async fetch(req: Request): Promise<Response> {
            return new Response(`Hello world! (${req.url})`);
          },
        };
        ```
        ::::::
      :::::

      :::::tabs-item{icon="i-undocs-h3" label="H3"}
        ::::::prose-pre{filename="server.ts"}
        ```ts
        import { H3 } from 'h3'

        const app = new H3()

        app.get("/", () => 'âš¡ï¸ Hello from H3!')

        export default app
        ```
        ::::::
      :::::

      :::::tabs-item{icon="i-undocs-hono" label="Hono"}
        ::::::prose-pre{filename="server.ts"}
        ```ts
        import { Hono } from 'hono'

        const app = new Hono()

        app.get("/", (c) => c.text('ğŸ”¥ Hello from Hono!'))

        export default app
        ```
        ::::::
      :::::

      :::::tabs-item{icon="i-undocs-elysia" label="Elysia"}
        ::::::prose-pre{filename="server.ts"}
        ```ts
        import { Elysia } from 'elysia'

        const app = new Elysia()

        app.get("/", (c) => 'ğŸ¦Š Hello from Elysia!')

        export default app
        ```
        ::::::
      :::::
    ::::
  :::

#title
åˆ›å»ºæœåŠ¡å™¨è·¯ç”±

#description
åœ¨ routes/ ç›®å½•ä¸­å¼€å§‹åˆ›å»º API è·¯ç”±ï¼Œæˆ–ä½¿ç”¨æ‚¨å–œæ¬¢çš„åç«¯æ¡†æ¶ï¼Œåœ¨ `server.ts` æ–‡ä»¶ä¸­å¼€å§‹ã€‚
::

:page-sponsors

:page-contributors


# API è·¯ç”±

::code-tree{expand-all default-value="api/hello.ts" expand-all=""}
```html [index.html]
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>API Routes</title>
  </head>
  <body>
    <h2>API Routes:</h2>
    <ul>
      <li><a href="/api/hello">/api/hello</a></li>
      <li><a href="/api/hello/world">/api/hello/world</a></li>
      <li><a href="/api/test">/api/test</a></li>
    </ul>
  </body>
</html>
```

```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({
  serverDir: "./",
});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  "devDependencies": {
    "nitro": "latest"
  }
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```

```ts [api/hello.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler(() => "Nitro is amazing!");
```

```ts [api/test.get.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler(() => "Test get handler");
```

```ts [api/test.post.ts]
import { defineHandler } from "h3";

export default defineHandler(async (event) => {
  const body = await event.req.json();
  return {
    message: "Test post handler",
    body,
  };
});
```

```ts [api/hello/[name\\].ts]
import { defineHandler } from "nitro/h3";

export default defineHandler((event) => `Hello (param: ${event.context.params!.name})!`);
```
::

Nitro æ”¯æŒåœ¨ `api/` æˆ– `routes/` ç›®å½•ä¸­çš„åŸºäºæ–‡ä»¶çš„è·¯ç”±ã€‚æ¯ä¸ªæ–‡ä»¶æ ¹æ®å…¶è·¯å¾„å˜æˆä¸€ä¸ª API ç«¯ç‚¹ã€‚

## åŸºæœ¬è·¯ç”±

åœ¨ `api/` ç›®å½•ä¸­åˆ›å»ºä¸€ä¸ªæ–‡ä»¶æ¥å®šä¹‰è·¯ç”±ã€‚æ–‡ä»¶è·¯å¾„å³ä¸º URL è·¯å¾„ï¼š

```ts [api/hello.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler(() => "Nitro is amazing!");
```

è¿™å°†åˆ›å»ºä¸€ä¸ª `GET /api/hello` ç«¯ç‚¹ã€‚

## åŠ¨æ€è·¯ç”±

ä½¿ç”¨æ–¹æ‹¬å· `[param]` è¡¨ç¤ºåŠ¨æ€ URL æ®µã€‚é€šè¿‡ `event.context.params` è®¿é—®å‚æ•°ï¼š

```ts [api/hello/[name\\].ts]
import { defineHandler } from "nitro/h3";

export default defineHandler((event) => `Hello (param: ${event.context.params!.name})!`);
```

è¿™å°†åˆ›å»ºä¸€ä¸ª `GET /api/hello/:name` ç«¯ç‚¹ï¼ˆä¾‹å¦‚ `/api/hello/world`ï¼‰ã€‚

## HTTP æ–¹æ³•

é€šè¿‡æ–‡ä»¶åç¼€æŒ‡å®š HTTP æ–¹æ³•ï¼ˆ`.get.ts`ã€`.post.ts`ã€`.put.ts`ã€`.delete.ts` ç­‰ï¼‰ï¼š

### GET å¤„ç†å™¨

```ts [api/test.get.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler(() => "Test get handler");
```

### POST å¤„ç†å™¨

```ts [api/test.post.ts]
import { defineHandler } from "h3";

export default defineHandler(async (event) => {
  const body = await event.req.json();
  return {
    message: "Test post handler",
    body,
  };
});
```

## äº†è§£æ›´å¤š

- [è·¯ç”±](https://nitro.zhcndoc.com/docs/routing)


# è‡ªåŠ¨å¯¼å…¥

::code-tree{expand-all default-value="nitro.config.ts" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({
  serverDir: true,
  imports: {},
});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  "devDependencies": {
    "nitro": "latest"
  }
}
```

```ts [server.ts]
import { defineHandler } from "nitro/h3";
import { makeGreeting } from "./server/utils/hello.ts";

export default defineHandler(() => `<h1>${makeGreeting("Nitro")}</h1>`);
```

```json [tsconfig.json]
{
  "include": [".nitro/types/nitro-imports.d.ts", "src"]
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```

```ts [server/utils/hello.ts]
export function makeGreeting(name: string) {
  return `Hello, ${name}!`;
}
```
::

ä» `server/utils/` å¯¼å‡ºçš„å‡½æ•°åœ¨å¯ç”¨è‡ªåŠ¨å¯¼å…¥æ—¶ï¼Œæ— éœ€æ˜¾å¼å¯¼å…¥å³å¯ç›´æ¥ä½¿ç”¨ã€‚åœ¨æœåŠ¡å™¨ä»£ç ä¸­å®šä¹‰ä¸€æ¬¡å®ç”¨å‡½æ•°åï¼Œå°±å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨å®ƒã€‚

## é…ç½®

é€šè¿‡åœ¨é…ç½®ä¸­è®¾ç½® `imports` æ¥å¯ç”¨è‡ªåŠ¨å¯¼å…¥ï¼š

```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({
  serverDir: true,
  imports: {},
});
```

## ä½¿ç”¨è‡ªåŠ¨å¯¼å…¥

1. åœ¨ `server/utils/` ä¸­åˆ›å»ºä¸€ä¸ªå®ç”¨å‡½æ•°æ–‡ä»¶ï¼š

```ts [server/utils/hello.ts]
export function makeGreeting(name: string) {
  return `Hello, ${name}!`;
}
```

2. å‡½æ•°å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€å¯¼å…¥ï¼š

```ts [server.ts]
import { defineHandler } from "nitro/h3";
import { makeGreeting } from "./server/utils/hello.ts";

export default defineHandler(() => `<h1>${makeGreeting("Nitro")}</h1>`);
```

é€šè¿‡æ­¤è®¾ç½®ï¼Œ`server/utils/` ä¸­å¯¼å‡ºçš„ä»»ä½•å‡½æ•°éƒ½ä¼šè‡ªåŠ¨å˜ä¸ºå…¨å±€å¯ç”¨ã€‚Nitro ä¼šæ‰«æè¯¥ç›®å½•å¹¶è‡ªåŠ¨ç”Ÿæˆæ‰€éœ€çš„å¯¼å…¥è¯­å¥ã€‚

## äº†è§£æ›´å¤š

- [é…ç½®](https://nitro.zhcndoc.com/docs/configuration)


# ç¼“å­˜å¤„ç†å™¨

::code-tree{expand-all default-value="server.ts" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  "devDependencies": {
    "nitro": "latest"
  }
}
```

```ts [server.ts]
import { html } from "nitro/h3";
import { defineCachedHandler } from "nitro/cache";

export default defineCachedHandler(
  async () => {
    await new Promise((resolve) => setTimeout(resolve, 500));
    return html`
      Response generated at ${new Date().toISOString()} (took 500ms)
      <br />(<a href="?skipCache=true">skip cache</a>)
    `;
  },
  { shouldBypassCache: ({ req }) => req.url.includes("skipCache=true") }
);
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```
::

è¯¥ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•ç¼“å­˜ä¸€ä¸ªè€—æ—¶æ“ä½œï¼ˆ500 æ¯«ç§’å»¶è¿Ÿï¼‰ï¼Œä»¥åŠå¦‚ä½•é€šè¿‡æŸ¥è¯¢å‚æ•°æœ‰æ¡ä»¶åœ°ç»•è¿‡ç¼“å­˜ã€‚é¦–æ¬¡è¯·æ±‚æ—¶ï¼Œå¤„ç†ç¨‹åºæ‰§è¡Œå¹¶ç¼“å­˜ç»“æœã€‚éšåçš„è¯·æ±‚ä¼šç«‹å³è¿”å›ç¼“å­˜çš„å“åº”ï¼Œç›´åˆ°ç¼“å­˜è¿‡æœŸæˆ–è¢«ç»•è¿‡ã€‚

## å·¥ä½œåŸç†

```ts [server.ts]
import { html } from "nitro/h3";
import { defineCachedHandler } from "nitro/cache";

export default defineCachedHandler(
  async () => {
    await new Promise((resolve) => setTimeout(resolve, 500));
    return html`
      å“åº”ç”Ÿæˆæ—¶é—´ ${new Date().toISOString()}ï¼ˆè€—æ—¶ 500msï¼‰
      <br />(<a href="?skipCache=true">è·³è¿‡ç¼“å­˜</a>)
    `;
  },
  { shouldBypassCache: ({ req }) => req.url.includes("skipCache=true") }
);
```

å¤„ç†ç¨‹åºé€šè¿‡500æ¯«ç§’çš„å»¶è¿Ÿæ¨¡æ‹Ÿäº†ä¸€ä¸ªç¼“æ…¢æ“ä½œã€‚ç”±äºè¢« `defineCachedHandler` åŒ…è£¹ï¼Œé¦–æ¬¡æ‰§è¡Œåå“åº”ä¼šè¢«ç¼“å­˜ã€‚`shouldBypassCache` é€‰é¡¹ä¼šæ£€æŸ¥ URL ä¸­æ˜¯å¦åŒ…å« `?skipCache=true`ï¼Œå­˜åœ¨æ—¶åˆ™è·³è¿‡ç¼“å­˜ï¼Œå¼ºåˆ¶å¤„ç†ç¨‹åºé‡æ–°æ‰§è¡Œã€‚

## äº†è§£æ›´å¤š

- [ç¼“å­˜](https://nitro.zhcndoc.com/docs/cache)
- [å­˜å‚¨](https://nitro.zhcndoc.com/docs/storage)


# è‡ªå®šä¹‰é”™è¯¯å¤„ç†å™¨

::code-tree{expand-all default-value="error.ts" expand-all=""}
```ts [error.ts]
import { defineErrorHandler } from "nitro";

export default defineErrorHandler((error, _event) => {
  return new Response(`Custom Error Handler: ${error.message}`, {
    status: 500,
    headers: { "Content-Type": "text/plain" },
  });
});
```

```ts [nitro.config.ts]
import { defineConfig } from "nitro";
// import errorHandler from "./error";

export default defineConfig({
  errorHandler: "./error.ts",
  // devErrorHandler: errorHandler,
});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  "devDependencies": {
    "nitro": "latest"
  }
}
```

```ts [server.ts]
import { defineHandler, HTTPError } from "nitro/h3";

export default defineHandler(() => {
  throw new HTTPError("Example Error!", { status: 500 });
});
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```
::

è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•æ‹¦æˆªæ‰€æœ‰é”™è¯¯å¹¶è¿”å›è‡ªå®šä¹‰çš„å“åº”æ ¼å¼ã€‚å½“ä»»ä½•è·¯ç”±æŠ›å‡ºé”™è¯¯æ—¶ï¼ŒNitro ä¼šè°ƒç”¨ä½ çš„é”™è¯¯å¤„ç†å™¨ï¼Œè€Œä¸æ˜¯è¿”å›é»˜è®¤çš„é”™è¯¯é¡µé¢ã€‚

## é”™è¯¯å¤„ç†å™¨

åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª `error.ts` æ–‡ä»¶æ¥å®šä¹‰å…¨å±€é”™è¯¯å¤„ç†å™¨ï¼š

```ts [error.ts]
import { defineErrorHandler } from "nitro";

export default defineErrorHandler((error, _event) => {
  return new Response(`è‡ªå®šä¹‰é”™è¯¯å¤„ç†å™¨: ${error.message}`, {
    status: 500,
    headers: { "Content-Type": "text/plain" },
  });
});
```

è¯¥å¤„ç†å™¨æ¥æ”¶æŠ›å‡ºçš„é”™è¯¯å’Œ H3 äº‹ä»¶å¯¹è±¡ã€‚ä½ å¯ä»¥ä½¿ç”¨äº‹ä»¶å¯¹è±¡è®¿é—®è¯·æ±‚è¯¦æƒ…ï¼Œå¦‚è¯·æ±‚å¤´ã€Cookie æˆ– URL è·¯å¾„ï¼Œä»¥é’ˆå¯¹ä¸åŒè·¯ç”±è‡ªå®šä¹‰å“åº”ã€‚

## è§¦å‘é”™è¯¯

ä¸»å¤„ç†å™¨æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œä»¥æ¼”ç¤ºè‡ªå®šä¹‰é”™è¯¯å¤„ç†å™¨ï¼š

```ts [server.ts]
import { defineHandler, HTTPError } from "nitro/h3";

export default defineHandler(() => {
  throw new HTTPError("ç¤ºä¾‹é”™è¯¯ï¼", { status: 500 });
});
```

å½“ä½ è®¿é—®è¯¥é¡µé¢æ—¶ï¼Œä¸ä¼šçœ‹åˆ°é€šç”¨çš„é”™è¯¯é¡µé¢ï¼Œè€Œæ˜¯çœ‹åˆ°â€œè‡ªå®šä¹‰é”™è¯¯å¤„ç†å™¨: ç¤ºä¾‹é”™è¯¯ï¼â€ï¼Œå› ä¸ºé”™è¯¯å¤„ç†å™¨æ‹¦æˆªäº†æŠ›å‡ºçš„é”™è¯¯ã€‚

## äº†è§£æ›´å¤š

- [æœåŠ¡å™¨å…¥å£](https://nitro.zhcndoc.com/docs/server-entry)


# æ•°æ®åº“

::code-tree{expand-all default-value="server.ts" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({
  experimental: {
    database: true,
    tasks: true,
  },
  database: {
    default: { connector: "sqlite" },
  },
});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  "devDependencies": {
    "nitro": "latest"
  }
}
```

```ts [server.ts]
import { defineHandler } from "nitro/h3";
import { useDatabase } from "nitro/database";

export default defineHandler(async () => {
  const db = useDatabase();

  // Create users table
  await db.sql`DROP TABLE IF EXISTS users`;
  await db.sql`CREATE TABLE IF NOT EXISTS users ("id" TEXT PRIMARY KEY, "firstName" TEXT, "lastName" TEXT, "email" TEXT)`;

  // Add a new user
  const userId = String(Math.round(Math.random() * 10_000));
  await db.sql`INSERT INTO users VALUES (${userId}, 'John', 'Doe', '')`;

  // Query for users
  const { rows } = await db.sql`SELECT * FROM users WHERE id = ${userId}`;

  return {
    rows,
  };
});
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```

```ts [tasks/db/migrate.ts]
import { defineTask } from "nitro/task";
import { useDatabase } from "nitro/database";

export default defineTask({
  meta: {
    description: "Run database migrations",
  },
  async run() {
    const db = useDatabase();

    console.log("Running database migrations...");

    // Create users table
    await db.sql`DROP TABLE IF EXISTS users`;
    await db.sql`CREATE TABLE IF NOT EXISTS users ("id" TEXT PRIMARY KEY, "firstName" TEXT, "lastName" TEXT, "email" TEXT)`;

    return {
      result: "Database migrations complete!",
    };
  },
});
```
::

Nitro æä¾›äº†ä¸€ä¸ªå†…ç½®çš„æ•°æ®åº“å±‚ï¼Œä½¿ç”¨ SQL æ¨¡æ¿å­—é¢é‡è¿›è¡Œå®‰å…¨çš„å‚æ•°åŒ–æŸ¥è¯¢ã€‚æ­¤ç¤ºä¾‹åˆ›å»ºäº†ä¸€ä¸ª users è¡¨ï¼Œæ’å…¥ä¸€æ¡è®°å½•ï¼Œå¹¶æŸ¥è¯¢è¯¥è®°å½•ã€‚

## æŸ¥è¯¢æ•°æ®åº“

```ts [server.ts]
import { defineHandler } from "nitro/h3";
import { useDatabase } from "nitro/database";

export default defineHandler(async () => {
  const db = useDatabase();

  // åˆ›å»º users è¡¨
  await db.sql`DROP TABLE IF EXISTS users`;
  await db.sql`CREATE TABLE IF NOT EXISTS users ("id" TEXT PRIMARY KEY, "firstName" TEXT, "lastName" TEXT, "email" TEXT)`;

  // æ·»åŠ ä¸€ä¸ªæ–°ç”¨æˆ·
  const userId = String(Math.round(Math.random() * 10_000));
  await db.sql`INSERT INTO users VALUES (${userId}, 'John', 'Doe', '')`;

  // æŸ¥è¯¢ç”¨æˆ·
  const { rows } = await db.sql`SELECT * FROM users WHERE id = ${userId}`;

  return {
    rows,
  };
});
```

ä½¿ç”¨ `useDatabase()` è·å–æ•°æ®åº“å®ä¾‹ã€‚é€šè¿‡ `db.sql` è¿›è¡Œæ•°æ®åº“æŸ¥è¯¢ï¼Œåƒ `${userId}` è¿™æ ·çš„å˜é‡ä¼šè‡ªåŠ¨è½¬ä¹‰ï¼Œä»¥é˜²æ­¢ SQL æ³¨å…¥ã€‚

## ä½¿ç”¨ä»»åŠ¡è¿è¡Œè¿ç§»

Nitro ä»»åŠ¡å…è®¸ä½ åœ¨è¯·æ±‚å¤„ç†ç¨‹åºä¹‹å¤–è¿è¡Œæ“ä½œã€‚å¯¹äºæ•°æ®åº“è¿ç§»ï¼Œåœ¨ `tasks/` ç›®å½•ä¸‹åˆ›å»ºä»»åŠ¡æ–‡ä»¶ï¼Œç„¶åé€šè¿‡ CLI è¿è¡Œã€‚è¿™æ ·å¯ä»¥å°†æ¨¡å¼å˜æ›´ä¸åº”ç”¨ä»£ç åˆ†ç¦»ã€‚

```ts [tasks/db/migrate.ts]
import { defineTask } from "nitro/task";
import { useDatabase } from "nitro/database";

export default defineTask({
  meta: {
    description: "è¿è¡Œæ•°æ®åº“è¿ç§»",
  },
  async run() {
    const db = useDatabase();

    console.log("æ­£åœ¨è¿è¡Œæ•°æ®åº“è¿ç§»...");

    // åˆ›å»º users è¡¨
    await db.sql`DROP TABLE IF EXISTS users`;
    await db.sql`CREATE TABLE IF NOT EXISTS users ("id" TEXT PRIMARY KEY, "firstName" TEXT, "lastName" TEXT, "email" TEXT)`;

    return {
      result: "æ•°æ®åº“è¿ç§»å®Œæˆï¼",
    };
  },
});
```

## äº†è§£æ›´å¤š

- [æ•°æ®åº“](https://nitro.zhcndoc.com/docs/database)
- [ä»»åŠ¡](https://nitro.zhcndoc.com/docs/tasks)


# Elysia

::code-tree{expand-all default-value="server.ts" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "build": "nitro build",
    "dev": "nitro dev"
  },
  "devDependencies": {
    "elysia": "^1.4.22",
    "nitro": "latest"
  }
}
```

```ts [server.ts]
import { Elysia } from "elysia";

const app = new Elysia();

app.get("/", () => "Hello, Elysia with Nitro!");

export default app.compile();
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```
::

## æœåŠ¡å™¨å…¥å£

```ts [server.ts]
import { Elysia } from "elysia";

const app = new Elysia();

app.get("/", () => "Hello, Elysia with Nitro!");

export default app.compile();
```

Nitro ä¼šè‡ªåŠ¨æ£€æµ‹é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `server.ts` å¹¶å°†å…¶ç”¨ä½œæœåŠ¡å™¨å…¥å£ã€‚Elysia åº”ç”¨ç¨‹åºå¤„ç†æ‰€æœ‰ä¼ å…¥è¯·æ±‚ï¼Œè®©ä½ å¯ä»¥å®Œå…¨æ§åˆ¶è·¯ç”±å’Œä¸­é—´ä»¶ã€‚

åœ¨å¯¼å‡ºä¹‹å‰è°ƒç”¨ `app.compile()` ä»¥ä¼˜åŒ–ç”Ÿäº§ç¯å¢ƒçš„è·¯ç”±å™¨ã€‚

## äº†è§£æ›´å¤š

- [æœåŠ¡ç«¯å…¥å£](https://nitro.zhcndoc.com/docs/server-entry)
- [Elysia æ–‡æ¡£](https://elysiajs.com/){rel="&#x22;nofollow&#x22;"}


# Express

::code-tree{expand-all default-value="server.node.ts" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "build": "nitro build",
    "dev": "nitro dev"
  },
  "devDependencies": {
    "@types/express": "^5.0.6",
    "express": "^5.2.1",
    "nitro": "latest"
  }
}
```

```ts [server.node.ts]
import Express from "express";

const app = Express();

app.use("/", (_req, res) => {
  res.send("Hello from Express with Nitro!");
});

export default app;
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```
::

## æœåŠ¡å™¨å…¥å£

```ts [server.node.ts]
import Express from "express";

const app = Express();

app.use("/", (_req, res) => {
  res.send("Hello from Express with Nitro!");
});

export default app;
```

Nitro ä¼šè‡ªåŠ¨æ£€æµ‹é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `server.node.ts` å¹¶å°†å…¶ä½œä¸ºæœåŠ¡å™¨å…¥å£ã€‚Express åº”ç”¨å¤„ç†æ‰€æœ‰ä¼ å…¥è¯·æ±‚ï¼Œä½¿ä½ èƒ½å¤Ÿå®Œå…¨æ§åˆ¶è·¯ç”±å’Œä¸­é—´ä»¶ã€‚

::note
`.node.ts` åç¼€è¡¨ç¤ºæ­¤å…¥å£ç‰¹å®šäº Node.jsï¼Œæ— æ³•åœ¨ Cloudflare Workers æˆ– Deno ç­‰å…¶ä»–è¿è¡Œç¯å¢ƒä¸­è¿è¡Œã€‚
::

## äº†è§£æ›´å¤š

- [æœåŠ¡å™¨å…¥å£](https://nitro.zhcndoc.com/docs/server-entry)
- [Express æ–‡æ¡£](https://expressjs.com/){rel="&#x22;nofollow&#x22;"}


# Fastify

::code-tree{expand-all default-value="server.node.ts" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "build": "nitro build",
    "dev": "nitro dev"
  },
  "devDependencies": {
    "fastify": "^5.7.4",
    "nitro": "latest"
  }
}
```

```ts [server.node.ts]
import Fastify from "fastify";

const app = Fastify();

app.get("/", () => "Hello, Fastify with Nitro!");

await app.ready();

export default app.routing;
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```
::

## æœåŠ¡å™¨å…¥å£

```ts [server.node.ts]
import Fastify from "fastify";

const app = Fastify();

app.get("/", () => "Hello, Fastify with Nitro!");

await app.ready();

export default app.routing;
```

Nitro ä¼šè‡ªåŠ¨æ£€æµ‹é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `server.node.ts` å¹¶å°†å…¶ç”¨ä½œæœåŠ¡å™¨å…¥å£ã€‚

è°ƒç”¨ `await app.ready()` ä»¥åˆå§‹åŒ–æ‰€æœ‰å·²æ³¨å†Œçš„æ’ä»¶ï¼Œç„¶åå¯¼å‡ºã€‚åœ¨å¯¼å‡ºæ—¶è¯·å¯¼å‡º `app.routing`ï¼ˆè€Œé `app`ï¼‰ï¼Œä»¥ä¾¿ Nitro è·å–è¯·æ±‚å¤„ç†å‡½æ•°ã€‚

::note
`.node.ts` åç¼€è¡¨ç¤ºæ­¤å…¥å£ç‰¹å®šäº Node.jsï¼Œæ— æ³•åœ¨ Cloudflare Workers æˆ– Deno ç­‰å…¶ä»–è¿è¡Œæ—¶ä½¿ç”¨ã€‚
::

## äº†è§£æ›´å¤š

- [æœåŠ¡å™¨å…¥å£](https://nitro.zhcndoc.com/docs/server-entry)
- [Fastify æ–‡æ¡£](https://fastify.dev/){rel="&#x22;nofollow&#x22;"}


# ä½ å¥½ï¼Œä¸–ç•Œ

::code-tree{expand-all default-value="server.ts" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "build": "nitro build",
    "dev": "nitro dev",
    "preview": "node .output/server/index.mjs"
  },
  "devDependencies": {
    "nitro": "latest"
  }
}
```

```ts [server.ts]
export default {
  fetch(req: Request) {
    return new Response("Nitro Works!");
  },
};
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```
::

æœ€ç®€å•çš„ Nitro æœåŠ¡å™¨ã€‚å¯¼å‡ºä¸€ä¸ªå¸¦æœ‰ `fetch` æ–¹æ³•çš„å¯¹è±¡ï¼Œè¯¥æ–¹æ³•æ¥æ”¶ä¸€ä¸ªæ ‡å‡†çš„ `Request` å¹¶è¿”å›ä¸€ä¸ª `Response`ã€‚æ²¡æœ‰æ¡†æ¶ï¼Œæ²¡æœ‰æŠ½è±¡ï¼Œåªæœ‰ Web å¹³å°ã€‚

## æœåŠ¡å™¨å…¥å£

```ts [server.ts]
export default {
  fetch(req: Request) {
    return new Response("Nitro Works!");
  },
};
```

`fetch` æ–¹æ³•éµå¾ªä¸ Service Workers å’Œ Cloudflare Workers ç›¸åŒçš„ç­¾åã€‚ç”±äºå®ƒä½¿ç”¨äº† Web æ ‡å‡†ï¼Œè¿™ç§æ¨¡å¼é€‚ç”¨äºæ‰€æœ‰éƒ¨ç½²ç›®æ ‡ã€‚

å°† Nitro æ’ä»¶æ·»åŠ åˆ° Viteï¼Œå®ƒä¼šå¤„ç†å‰©ä¸‹çš„éƒ¨åˆ†ï¼šå¼€å‘æœåŠ¡å™¨ã€çƒ­é‡è½½å’Œç”Ÿäº§æ„å»ºã€‚

## äº†è§£æ›´å¤š

- [æœåŠ¡å™¨å…¥å£](https://nitro.zhcndoc.com/docs/server-entry)
- [é…ç½®](https://nitro.zhcndoc.com/docs/configuration)


# Hono

::code-tree{expand-all default-value="server.ts" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "build": "nitro build",
    "dev": "nitro dev"
  },
  "devDependencies": {
    "hono": "^4.11.8",
    "nitro": "latest"
  }
}
```

```ts [server.ts]
import { Hono } from "hono";

const app = new Hono();

app.get("/", (c) => {
  return c.text("Hello, Hono with Nitro!");
});

export default app;
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```
::

## æœåŠ¡å™¨å…¥å£

```ts [server.ts]
import { Hono } from "hono";

const app = new Hono();

app.get("/", (c) => {
  return c.text("Hello, Hono with Nitro!");
});

export default app;
```

Nitro ä¼šè‡ªåŠ¨æ£€æµ‹é¡¹ç›®æ ¹ç›®å½•ä¸­çš„ `server.ts` å¹¶å°†å…¶ä½œä¸ºæœåŠ¡å™¨å…¥å£ã€‚Hono åº”ç”¨å¤„ç†æ‰€æœ‰ä¼ å…¥è¯·æ±‚ï¼Œè®©ä½ å¯¹è·¯ç”±å’Œä¸­é—´ä»¶æ‹¥æœ‰å®Œå…¨çš„æ§åˆ¶æƒã€‚

Hono è·¨è¿è¡Œæ—¶å…¼å®¹ï¼Œå› æ­¤è¯¥æœåŠ¡å™¨å…¥å£æ”¯æŒæ‰€æœ‰ Nitro éƒ¨ç½²ç›®æ ‡ï¼ŒåŒ…æ‹¬ Node.jsã€Denoã€Bun å’Œ Cloudflare Workersã€‚

## äº†è§£æ›´å¤š

- [æœåŠ¡å™¨å…¥å£](https://nitro.zhcndoc.com/docs/server-entry)
- [Hono æ–‡æ¡£](https://hono.dev/){rel="&#x22;nofollow&#x22;"}


# å¯¼å…¥åˆ«å

::code-tree{expand-all default-value="server/routes/index.ts" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({
  serverDir: true,
  experimental: {
    tsconfigPaths: true,
  },
});
```

```json [package.json]
{
  "type": "module",
  "imports": {
    "#server/*": "./server/*"
  },
  "scripts": {
    "build": "nitro build",
    "dev": "nitro dev",
    "preview": "node .output/server/index.mjs"
  },
  "devDependencies": {
    "nitro": "latest"
  }
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig",
  "compilerOptions": {
    "paths": {
      "~server/*": ["./server/*"]
    }
  }
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```

```ts [server/routes/index.ts]
import { sum } from "~server/utils/math.ts";

import { rand } from "#server/utils/math.ts";

export default () => {
  const [a, b] = [rand(1, 10), rand(1, 10)];
  const result = sum(a, b);
  return `The sum of ${a} + ${b} = ${result}`;
};
```

```ts [server/utils/math.ts]
export function rand(min: number, max: number): number {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

export function sum(a: number, b: number): number {
  return a + b;
}
```
::

åƒ `~` å’Œ `#` è¿™æ ·çš„å¯¼å…¥åˆ«åè®©ä½ å¯ä»¥ä½¿ç”¨æ›´çŸ­çš„è·¯å¾„æ¥å¼•ç”¨æ¨¡å—ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç›¸å¯¹å¯¼å…¥ã€‚

## ä½¿ç”¨åˆ«åå¯¼å…¥

```ts [server/routes/index.ts]
import { sum } from "~server/utils/math.ts";

import { rand } from "#server/utils/math.ts";

export default () => {
  const [a, b] = [rand(1, 10), rand(1, 10)];
  const result = sum(a, b);
  return `The sum of ${a} + ${b} = ${result}`;
};
```

è¯¥è·¯ç”±é€šè¿‡ `~server/` å¯¼å…¥ `sum` å‡½æ•°ï¼Œé€šè¿‡ `#server/` å¯¼å…¥ `rand` å‡½æ•°ã€‚ä¸¤è€…éƒ½æŒ‡å‘åŒä¸€ä¸ª `server/utils/math.ts` æ–‡ä»¶ã€‚å¤„ç†å‡½æ•°ç”Ÿæˆä¸¤ä¸ªéšæœºæ•°å¹¶è¿”å›å®ƒä»¬çš„å’Œã€‚

## é…ç½®

åˆ«åå¯ä»¥åœ¨ `package.json` çš„ imports å­—æ®µæˆ– `nitro.config.ts` ä¸­é…ç½®ã€‚

## äº†è§£æ›´å¤š

- [é…ç½®](https://nitro.zhcndoc.com/docs/configuration)


# ä¸­é—´ä»¶

::code-tree{expand-all default-value="server/middleware/auth.ts" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({
  serverDir: true,
});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  "devDependencies": {
    "nitro": "latest"
  }
}
```

```ts [server.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler((event) => ({
  auth: event.context.auth,
}));
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```

```ts [server/middleware/auth.ts]
import { defineMiddleware } from "nitro/h3";

export default defineMiddleware((event) => {
  event.context.auth = { name: "User " + Math.round(Math.random() * 100) };
});
```
::

ä¸­é—´ä»¶å‡½æ•°åœ¨æ¯ä¸ªè¯·æ±‚çš„è·¯ç”±å¤„ç†å™¨ä¹‹å‰è¿è¡Œã€‚å®ƒä»¬å¯ä»¥ä¿®æ”¹è¯·æ±‚ã€æ·»åŠ ä¸Šä¸‹æ–‡æˆ–æå‰è¿”å›å“åº”ã€‚

## å®šä¹‰ä¸­é—´ä»¶

åœ¨ `server/middleware/` ç›®å½•ä¸‹åˆ›å»ºæ–‡ä»¶ã€‚å®ƒä»¬æŒ‰å­—æ¯é¡ºåºè¿è¡Œï¼š

```ts [server/middleware/auth.ts]
import { defineMiddleware } from "nitro/h3";

export default defineMiddleware((event) => {
  event.context.auth = { name: "User " + Math.round(Math.random() * 100) };
});
```

ä¸­é—´ä»¶å¯ä»¥ï¼š

- å‘ `event.context` æ·»åŠ æ•°æ®ä»¥ä¾›å¤„ç†å™¨ä½¿ç”¨
- æå‰è¿”å›å“åº”ä»¥çŸ­è·¯è¯·æ±‚
- ä¿®æ”¹è¯·æ±‚å¤´æˆ–å…¶ä»–å±æ€§

## åœ¨å¤„ç†å™¨ä¸­è®¿é—®ä¸Šä¸‹æ–‡

ä¸­é—´ä»¶ä¸­æ·»åŠ åˆ° `event.context` çš„æ•°æ®åœ¨æ‰€æœ‰åç»­å¤„ç†å™¨ä¸­å‡å¯ç”¨ï¼š

```ts [server.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler((event) => ({
  auth: event.context.auth,
}));
```

## äº†è§£æ›´å¤š

- [è·¯ç”±](https://nitro.zhcndoc.com/docs/routing)


# Mono JSX

::code-tree{expand-all default-value="server.tsx" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  "devDependencies": {
    "mono-jsx": "latest",
    "nitro": "latest"
  }
}
```

```tsx [server.tsx]
export default () => (
  <html>
    <h1>Nitro + mongo-jsx works!</h1>
  </html>
);
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig",
  "compilerOptions": {
    "jsx": "react-jsx",
    "jsxImportSource": "mono-jsx"
  }
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```
::

## æœåŠ¡å™¨å…¥å£

```tsx [server.tsx]
export default () => (
  <html>
    <h1>Nitro + mongo-jsx å·¥ä½œæ­£å¸¸ï¼</h1>
  </html>
);
```

Nitro ä¼šè‡ªåŠ¨æ£€æµ‹ `server.tsx` å¹¶ä½¿ç”¨ mono-jsx å°† JSX è½¬æ¢ä¸º HTMLã€‚å¯¼å‡ºä¸€ä¸ªè¿”å› JSX çš„å‡½æ•°ï¼ŒNitro ä¼šå°†æ¸²æŸ“åçš„ HTML ä½œä¸ºå“åº”å‘é€ã€‚

## äº†è§£æ›´å¤š

- [æ¸²æŸ“å™¨](https://nitro.zhcndoc.com/docs/renderer)
- [mono-jsx](https://github.com/aspect-dev/mono-jsx){rel="&#x22;nofollow&#x22;"}


# Nano JSX

::code-tree{expand-all default-value="server.tsx" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  "devDependencies": {
    "nano-jsx": "^0.2.1",
    "nitro": "latest"
  }
}
```

```tsx [server.tsx]
import { defineHandler, html } from "h3";
import { renderSSR } from "nano-jsx";

export default defineHandler(() => {
  return html(renderSSR(() => <h1>Nitro + nano-jsx works!</h1>));
});
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig",
  "compilerOptions": {
    "jsx": "react-jsx",
    "jsxImportSource": "nano-jsx/esm"
  }
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```
::

## æœåŠ¡å™¨å…¥å£

```tsx [server.tsx]
import { defineHandler, html } from "h3";
import { renderSSR } from "nano-jsx";

export default defineHandler(() => {
  return html(renderSSR(() => <h1>Nitro + nano-jsx works!</h1>));
});
```

Nitro ä¼šè‡ªåŠ¨æ£€æµ‹ `server.tsx` å¹¶å°†å…¶ä½œä¸ºæœåŠ¡å™¨å…¥å£ã€‚ä½¿ç”¨ nano-jsx çš„ `renderSSR` å°† JSX è½¬æ¢ä¸º HTML å­—ç¬¦ä¸²ã€‚H3 æä¾›çš„ `html` è¾…åŠ©å‡½æ•°ä¼šè®¾ç½®æ­£ç¡®çš„å†…å®¹ç±»å‹å¤´ã€‚

## äº†è§£æ›´å¤š

- [æ¸²æŸ“å™¨](https://nitro.zhcndoc.com/docs/renderer)
- [nano-jsx](https://nanojsx.io/){rel="&#x22;nofollow&#x22;"}


# æ’ä»¶ï¼ˆPluginsï¼‰

::code-tree{expand-all default-value="server/plugins/test.ts" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({
  serverDir: true,
});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  "devDependencies": {
    "nitro": "latest"
  }
}
```

```ts [server.ts]
import { eventHandler } from "h3";

export default eventHandler(() => "<h1>Hello Nitro!</h1>");
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```

```ts [server/plugins/test.ts]
import { definePlugin } from "nitro";
import { useNitroHooks } from "nitro/app";

export default definePlugin((nitroApp) => {
  const hooks = useNitroHooks();
  hooks.hook("response", (event) => {
    event.headers.set("content-type", "html; charset=utf-8");
  });
});
```
::

æ’ä»¶è®©ä½ å¯ä»¥æŒ‚è½½åˆ° Nitro çš„è¿è¡Œæ—¶ç”Ÿå‘½å‘¨æœŸä¸­ã€‚æ­¤ç¤ºä¾‹å±•ç¤ºäº†ä¸€ä¸ªä¿®æ”¹æ¯ä¸ªå“åº”çš„ `Content-Type` å¤´çš„æ’ä»¶ã€‚åœ¨ `server/plugins/` ä¸­åˆ›å»ºæ–‡ä»¶ï¼Œæ’ä»¶ä¼šåœ¨å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½ã€‚

## å®šä¹‰ä¸€ä¸ªæ’ä»¶

```ts [server/plugins/test.ts]
import { definePlugin } from "nitro";
import { useNitroHooks } from "nitro/app";

export default definePlugin((nitroApp) => {
  const hooks = useNitroHooks();
  hooks.hook("response", (event) => {
    event.headers.set("content-type", "html; charset=utf-8");
  });
});
```

è¯¥æ’ä»¶ä½¿ç”¨ `useNitroHooks()` è®¿é—®é’©å­ç³»ç»Ÿï¼Œç„¶åæ³¨å†Œäº†ä¸€ä¸ª `response` é’©å­ï¼Œä¼šåœ¨æ¯æ¬¡è¯·æ±‚åæ‰§è¡Œã€‚è¿™é‡Œå®ƒå°†å†…å®¹ç±»å‹è®¾ç½®ä¸º HTMLï¼Œä½†ä½ ä¹Ÿå¯ä»¥è®°å½•è¯·æ±‚ã€æ·»åŠ å®‰å…¨å¤´ï¼Œæˆ–ä»¥ä»»ä½•æ–¹å¼ä¿®æ”¹å“åº”ã€‚

## ä¸»å¤„ç†å™¨

```ts [server.ts]
import { eventHandler } from "h3";

export default eventHandler(() => "<h1>Hello Nitro!</h1>");
```

å¤„ç†å™¨è¿”å› HTMLï¼Œä½†æ²¡æœ‰è®¾ç½®å†…å®¹ç±»å‹ã€‚æ’ä»¶ä¼šè‡ªåŠ¨ç»™å“åº”æ·»åŠ æ­£ç¡®çš„ `Content-Type: html; charset=utf-8` å¤´ã€‚

## äº†è§£æ›´å¤š

- [æ’ä»¶](https://nitro.zhcndoc.com/docs/plugins)
- [ç”Ÿå‘½å‘¨æœŸ](https://nitro.zhcndoc.com/docs/lifecycle)


# è‡ªå®šä¹‰æ¸²æŸ“å™¨

::code-tree{expand-all default-value="renderer.ts" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({
  serverDir: "./",
  renderer: { handler: "./renderer" },
});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  "devDependencies": {
    "nitro": "latest"
  }
}
```

```ts [renderer.ts]
import { fetch } from "nitro";

export default async function renderer({ url }: { req: Request; url: URL }) {
  const apiRes = await fetch("/api/hello").then((res) => res.text());
  return new Response(
    /* html */ `<!DOCTYPE html>
    <html>
    <head>
      <title>Custom Renderer</title>
    </head>
    <body>
      <h1>Hello from custom renderer!</h1>
      <p>Current path: ${url.pathname}</p>
      <p>API says: ${apiRes}</p>
    </body>
    </html>`,
    { headers: { "content-type": "text/html; charset=utf-8" } }
  );
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```

```ts [api/hello.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler(() => "Nitro is amazing!");
```
::

åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰æ¸²æŸ“å™¨ï¼Œç”¨äºç”ŸæˆåŒ…å« API è·¯ç”±æ•°æ®çš„ HTML å“åº”ã€‚ä½¿ç”¨ Nitro å†…éƒ¨çš„ `fetch` è°ƒç”¨è·¯ç”±ï¼Œæ— éœ€ç½‘ç»œå¼€é”€ã€‚

## æ¸²æŸ“å™¨

```ts [renderer.ts]
import { fetch } from "nitro";

export default async function renderer({ url }: { req: Request; url: URL }) {
  const apiRes = await fetch("/api/hello").then((res) => res.text());
  return new Response(
    /* html */ `<!DOCTYPE html>
    <html>
    <head>
      <title>Custom Renderer</title>
    </head>
    <body>
      <h1>Hello from custom renderer!</h1>
      <p>å½“å‰è·¯å¾„: ${url.pathname}</p>
      <p>API å“åº”: ${apiRes}</p>
    </body>
    </html>`,
    { headers: { "content-type": "text/html; charset=utf-8" } }
  );
}
```

Nitro ä¼šè‡ªåŠ¨æ£€æµ‹é¡¹ç›®æ ¹ç›®å½•ä¸­çš„ `renderer.ts` å¹¶å°†å…¶ç”¨äºæ‰€æœ‰é API è·¯ç”±ã€‚æ¸²æŸ“å™¨å‡½æ•°æ¥æ”¶è¯·æ±‚ URL å¹¶è¿”å›ä¸€ä¸ª `Response`ã€‚

ä½¿ç”¨æ¥è‡ª `nitro` çš„ `fetch` è°ƒç”¨ API è·¯ç”±ï¼Œæ— éœ€ç½‘ç»œå¼€é”€â€”â€”è¿™äº›è¯·æ±‚åœ¨è¿›ç¨‹å†…å®Œæˆã€‚

## API è·¯ç”±

```ts [api/hello.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler(() => "Nitro éå¸¸æ£’ï¼");
```

åœ¨ `api/` ç›®å½•ä¸­å®šä¹‰ API è·¯ç”±ã€‚å½“æ¸²æŸ“å™¨è°ƒç”¨ `fetch("/api/hello")` æ—¶ï¼Œè¯¥å¤„ç†å™¨æ‰§è¡Œå¹¶è¿”å›å“åº”ã€‚

## äº†è§£æ›´å¤š

- [æ¸²æŸ“å™¨](https://nitro.zhcndoc.com/docs/renderer)


# è¿è¡Œæ—¶é…ç½®

::code-tree{expand-all default-value="nitro.config.ts" expand-all=""}
```text [.env]
# NEVER COMMIT SENSITIVE DATA. THIS IS ONLY FOR DEMO PURPOSES.
NITRO_API_KEY=secret-api-key
```

```text [.gitignore]
# THIS IS ONLY FOR DEMO. DO NOT COMMIT SENSITIVE DATA IN REAL PROJECTS
!.env
```

```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({
  serverDir: "./",
  runtimeConfig: {
    apiKey: "",
  },
});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  "devDependencies": {
    "nitro": "latest"
  }
}
```

```ts [server.ts]
import { defineHandler } from "nitro/h3";
import { useRuntimeConfig } from "nitro/runtime-config";

export default defineHandler((event) => {
  const runtimeConfig = useRuntimeConfig();
  return { runtimeConfig };
});
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```
::

Runtime é…ç½®å…è®¸ä½ å®šä¹‰å¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–çš„é…ç½®å€¼ã€‚

## å®šä¹‰é…ç½® Schema

åœ¨ `nitro.config.ts` ä¸­å£°æ˜ä½ çš„è¿è¡Œæ—¶é…ç½®åŠé»˜è®¤å€¼ï¼š

```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({
  serverDir: "./",
  runtimeConfig: {
    apiKey: "",
  },
});
```

## è¿è¡Œæ—¶è®¿é—®

åœ¨ä½ çš„å¤„ç†å™¨ä¸­ä½¿ç”¨ `useRuntimeConfig` æ¥è®¿é—®é…ç½®å€¼ï¼š

```ts [server.ts]
import { defineHandler } from "nitro/h3";
import { useRuntimeConfig } from "nitro/runtime-config";

export default defineHandler((event) => {
  const runtimeConfig = useRuntimeConfig();
  return { runtimeConfig };
});
```

## ç¯å¢ƒå˜é‡

é€šè¿‡å¸¦æœ‰å‰ç¼€ `NITRO_` çš„ç¯å¢ƒå˜é‡æ¥è¦†ç›–é…ç½®å€¼ï¼š

```sh [.env]
# åˆ‡å‹¿æäº¤æ•æ„Ÿæ•°æ®ã€‚æœ¬ç¤ºä¾‹ä»…ç”¨äºæ¼”ç¤ºã€‚
NITRO_API_KEY=secret-api-key
```

## äº†è§£æ›´å¤š

- [é…ç½®](https://nitro.zhcndoc.com/docs/configuration)


# æœåŠ¡å™¨è¯·æ±‚

::code-tree{expand-all default-value="routes/index.ts" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig, serverFetch } from "nitro";

export default defineConfig({
  serverDir: "./",
  hooks: {
    "dev:start": async () => {
      const res = await serverFetch("/hello");
      const text = await res.text();
      console.log("Fetched /hello in nitro module:", res.status, text);
    },
  },
});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  "devDependencies": {
    "nitro": "latest"
  }
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```

```ts [routes/hello.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler(() => "Hello!");
```

```ts [routes/index.ts]
import { defineHandler } from "nitro/h3";
import { fetch } from "nitro";

export default defineHandler(() => fetch("/hello"));
```
::

å½“ä½ éœ€è¦ä¸€ä¸ªè·¯ç”±è°ƒç”¨å¦ä¸€ä¸ªè·¯ç”±æ—¶ï¼Œä½¿ç”¨ Nitro çš„ `fetch` å‡½æ•°è€Œä¸æ˜¯å…¨å±€çš„ fetchã€‚å®ƒä¼šå‘èµ·å†…éƒ¨è¯·æ±‚ï¼Œä¿æŒè¿›ç¨‹å†…å¤„ç†ï¼Œé¿å…ç½‘ç»œå¾€è¿”ã€‚è¯·æ±‚æ°¸è¿œä¸ä¼šç¦»å¼€æœåŠ¡å™¨ã€‚

## ä¸»è·¯ç”±

```ts [routes/index.ts]
import { defineHandler } from "nitro/h3";
import { fetch } from "nitro";

export default defineHandler(() => fetch("/hello"));
```

ä¸»è·¯ç”±ä» `nitro` å¯¼å…¥äº† `fetch`ï¼ˆè€Œä¸æ˜¯å…¨å±€çš„ fetchï¼‰ï¼Œå¹¶è°ƒç”¨äº† `/hello` è·¯ç”±ã€‚æ­¤è¯·æ±‚åœ¨å†…éƒ¨å¤„ç†ï¼Œä¸ç»è¿‡ç½‘ç»œæ ˆã€‚

## å†…éƒ¨ API è·¯ç”±

```ts [routes/hello.ts]
import { defineHandler } from "nitro/h3";

export default defineHandler(() => "Hello!");
```

ä¸€ä¸ªç®€å•çš„è·¯ç”±ï¼Œè¿”å› "Hello!"ã€‚å½“ä¸»è·¯ç”±è°ƒç”¨ `fetch("/hello")` æ—¶ï¼Œè¿™ä¸ªå¤„ç†å™¨ä¼šè¿è¡Œå¹¶ç›´æ¥è¿”å›å®ƒçš„å“åº”ã€‚

## äº†è§£æ›´å¤š

- [è·¯ç”±](https://nitro.zhcndoc.com/docs/routing)


# Shiki

::code-tree{expand-all default-value="api/highlight.ts" expand-all=""}
```html [index.html]
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Hello World Snippet</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="card" role="region" aria-label="Code snippet">
      <div class="label">JavaScript</div>
      <script server>
        const hl = (code) =>
          serverFetch("/api/highlight", {
            method: "POST",
            body: code,
          });
      </script>
      <pre><code>{{{ hl(`console.log("ğŸ’š Simple is beautiful!");`) }}}</code></pre>
    </div>
  </body>
</html>
```

```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({
  serverDir: "./",
});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "dev": "vite dev",
    "build": "vite build"
  },
  "devDependencies": {
    "nitro": "latest",
    "shiki": "^3.22.0"
  }
}
```

```css [styles.css]
html,
body {
  height: 100%;
  margin: 0;
}
body {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #f6f8fa;
  font-family:
    system-ui,
    -apple-system,
    "Segoe UI",
    Roboto,
    "Helvetica Neue",
    Arial,
    "Noto Sans",
    "Liberation Sans",
    sans-serif;
}
.card {
  text-align: left;
  background: #0b1220;
  color: #e6edf3;
  padding: 1rem;
  border-radius: 8px;
  box-shadow: 0 8px 24px rgba(2, 6, 23, 0.2);
  max-width: 90%;
  width: 520px;
}
.label {
  font-size: 12px;
  color: #9aa7b2;
  margin-bottom: 8px;
}
pre {
  margin: 0;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Courier New", monospace;
  font-size: 14px;
  background: transparent;
  white-space: pre;
  overflow: auto;
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({
  plugins: [nitro()],
});
```

```ts [api/highlight.ts]
import { createHighlighterCore } from "shiki/core";
import { createOnigurumaEngine } from "shiki/engine/oniguruma";

const highlighter = await createHighlighterCore({
  engine: createOnigurumaEngine(import("shiki/wasm")),
  themes: [await import("shiki/themes/vitesse-dark.mjs")],
  langs: [await import("shiki/langs/ts.mjs")],
});

export default async ({ req }: { req: Request }) => {
  const code = await req.text();
  const html = await highlighter.codeToHtml(code, {
    lang: "ts",
    theme: "vitesse-dark",
  });
  return new Response(html, {
    headers: { "Content-Type": "text/html; charset=utf-8" },
  });
};
```
::

ä½¿ç”¨ Shiki å’Œ TextMate è¯­æ³•å®ç°è¯­æ³•é«˜äº®ã€‚æ­¤ç¤ºä¾‹æ¼”ç¤ºå¦‚ä½•åˆ©ç”¨ Nitro çš„æœåŠ¡å™¨è„šæœ¬åŠŸèƒ½ï¼Œåœ¨å‘é€å“åº”ä¹‹å‰ï¼Œäº HTML æ–‡ä»¶å†…è¿è¡Œ JavaScript æ¥åœ¨æœåŠ¡å™¨ç«¯é«˜äº®ä»£ç ã€‚

## API è·¯ç”±

```ts [api/highlight.ts]
import { createHighlighterCore } from "shiki/core";
import { createOnigurumaEngine } from "shiki/engine/oniguruma";

const highlighter = await createHighlighterCore({
  engine: createOnigurumaEngine(import("shiki/wasm")),
  themes: [await import("shiki/themes/vitesse-dark.mjs")],
  langs: [await import("shiki/langs/ts.mjs")],
});

export default async ({ req }: { req: Request }) => {
  const code = await req.text();
  const html = await highlighter.codeToHtml(code, {
    lang: "ts",
    theme: "vitesse-dark",
  });
  return new Response(html, {
    headers: { "Content-Type": "text/html; charset=utf-8" },
  });
};
```

åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ Vitesse Dark ä¸»é¢˜å’Œ TypeScript è¯­è¨€æ”¯æŒçš„ Shiki é«˜äº®å™¨ã€‚å½“ API æ”¶åˆ° POST è¯·æ±‚æ—¶ï¼Œå®ƒä»è¯·æ±‚ä½“è¯»å–ä»£ç ï¼Œå¹¶è¿”å›é«˜äº®åçš„ HTMLã€‚

## æœåŠ¡å™¨ç«¯æ¸²æŸ“

```html [index.html]
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Hello World Snippet</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="card" role="region" aria-label="Code snippet">
      <div class="label">JavaScript</div>
      <script server>
        const hl = (code) =>
          serverFetch("/api/highlight", {
            method: "POST",
            body: code,
          });
      </script>
      <pre><code>{{{ hl(`console.log("ğŸ’š Simple is beautiful!");`) }}}</code></pre>
    </div>
  </body>
</html>
```

`<script server>` æ ‡ç­¾ä¼šåœ¨ HTML å‘é€ä¹‹å‰äºæœåŠ¡å™¨è¿è¡Œã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ªè¾…åŠ©å‡½æ•°ï¼Œä½¿ç”¨ `serverFetch` è°ƒç”¨é«˜äº® APIã€‚ä¸‰é‡å¤§æ‹¬å·è¯­æ³• `{{{ }}}` ä¼šåŸæ ·è¾“å‡ºç»“æœè€Œä¸è¿›è¡Œè½¬ä¹‰ï¼Œå› æ­¤é«˜äº®åçš„ HTML èƒ½æ­£ç¡®æ¸²æŸ“ã€‚

## äº†è§£æ›´å¤š

- [Shiki](https://shiki.style/){rel="&#x22;nofollow&#x22;"}


# è™šæ‹Ÿè·¯ç”±

::code-tree{expand-all default-value="nitro.config.ts" expand-all=""}
```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({
  routes: {
    "/": "#virtual-route",
  },
  virtual: {
    "#virtual-route": () =>
      /* js */ `export default () => new Response("Hello from virtual entry!")`,
  },
});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "build": "nitro build",
    "dev": "nitro dev",
    "preview": "node .output/server/index.mjs"
  },
  "devDependencies": {
    "nitro": "latest"
  }
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```
::

è™šæ‹Ÿè·¯ç”±å…è®¸æ‚¨åœ¨é…ç½®ä¸­å°†å¤„ç†ç¨‹åºå®šä¹‰ä¸ºå­—ç¬¦ä¸²ï¼Œè€Œæ— éœ€åˆ›å»ºå•ç‹¬çš„æ–‡ä»¶ã€‚å½“åŠ¨æ€ç”Ÿæˆè·¯ç”±ã€æ„å»ºæ’ä»¶æˆ–å°†ç®€å•è·¯ç”±ä¿æŒä¸ºå†…è”æ—¶ï¼Œè¿™éå¸¸æœ‰ç”¨ã€‚

## é…ç½®

```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({
  routes: {
    "/": "#virtual-route",
  },
  virtual: {
    "#virtual-route": () =>
      /* js */ `export default () => new Response("Hello from virtual entry!")`,
  },
});
```

`routes` é€‰é¡¹å°† URL è·¯å¾„æ˜ å°„åˆ°è™šæ‹Ÿæ¨¡å—æ ‡è¯†ç¬¦ï¼ˆä»¥ `#` ä¸ºå‰ç¼€ï¼‰ã€‚`virtual` é€‰é¡¹å®šä¹‰æ¨¡å—å†…å®¹ä¸ºå­—ç¬¦ä¸²æˆ–è¿”å›å­—ç¬¦ä¸²çš„å‡½æ•°ã€‚åœ¨æ„å»ºæ—¶ï¼ŒNitro ä¼šå°†è¿™äº›è™šæ‹Ÿæ¨¡å—è§£æä¸ºå®é™…çš„å¤„ç†ç¨‹åºã€‚

è¯¥é¡¹ç›®ä¸­æ²¡æœ‰è·¯ç”±æ–‡ä»¶ã€‚æ•´ä¸ªå¤„ç†ç¨‹åºéƒ½å†…è”å®šä¹‰åœ¨é…ç½®ä¸­ï¼ŒNitro ä¼šåœ¨æ„å»ºæ—¶ç”Ÿæˆè·¯ç”±ã€‚

## äº†è§£æ›´å¤š

- [è·¯ç”±](https://nitro.zhcndoc.com/docs/routing)
- [é…ç½®](https://nitro.zhcndoc.com/docs/configuration)


# Vite Nitro æ’ä»¶

::code-tree{expand-all default-value="vite.config.mjs" expand-all=""}
```json [package.json]
{
  "type": "module",
  "scripts": {
    "build": "vite build",
    "preview": "vite preview",
    "dev": "vite dev"
  },
  "devDependencies": {
    "nitro": "latest",
    "vite": "beta"
  }
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```js [vite.config.mjs]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({
  plugins: [
    nitro(),
    {
      name: "my-nitro-plugin",
      nitro: {
        setup: (nitro) => {
          nitro.options.routes["/"] = "#virtual-by-plugin";
          nitro.options.virtual["#virtual-by-plugin"] =
            `export default () => new Response("Hello from virtual entry!")`;
        },
      },
    },
  ],
});
```
::

ä¸ä½¿ç”¨å•ç‹¬çš„ `nitro.config.ts`ï¼Œæ‚¨å¯ä»¥ç›´æ¥åœ¨ Vite é…ç½®ä¸­é…ç½® Nitroã€‚è¿™ä½¿æ‚¨å¯ä»¥è®¿é—® Nitro çš„ setup é’©å­ï¼Œä»è€Œä»¥ç¼–ç¨‹æ–¹å¼æ³¨å†Œè·¯ç”±å’Œè™šæ‹Ÿæ¨¡å—ã€‚

## Vite é…ç½®

```js [vite.config.mjs]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({
  plugins: [
    nitro(),
    {
      name: "my-nitro-plugin",
      nitro: {
        setup: (nitro) => {
          nitro.options.routes["/"] = "#virtual-by-plugin";
          nitro.options.virtual["#virtual-by-plugin"] =
            `export default () => new Response("Hello from virtual entry!")`;
        },
      },
    },
  ],
});
```

è¯¥é…ç½®æ·»åŠ äº†ä¸¤ä¸ªæ’ä»¶ï¼š`nitro()` æ’ä»¶å’Œä¸€ä¸ªä½¿ç”¨äº† `nitro.setup` é’©å­çš„è‡ªå®šä¹‰æ’ä»¶ã€‚åœ¨ setup å‡½æ•°ä¸­ï¼Œæ‚¨å¯ä»¥è®¿é—® Nitro çš„ options å¯¹è±¡ã€‚æ­¤ç¤ºä¾‹åœ¨ `/` è·¯ç”±æ³¨å†Œäº†ä¸€ä¸ªè™šæ‹Ÿè·¯ç”±ï¼Œæ˜ å°„åˆ°è™šæ‹Ÿæ¨¡å— `#virtual-by-plugin`ï¼Œå¹¶ä¸”åœ¨å†…è”æ–¹å¼å®šä¹‰äº†è¯¥æ¨¡å—ã€‚

## äº†è§£æ›´å¤š

- [é…ç½®](https://nitro.zhcndoc.com/docs/configuration)


# Vite RSC

::code-tree{expand-all default-value="app/root.tsx" expand-all=""}
```text [.gitignore]
node_modules
dist
```

```json [package.json]
{
  "name": "@vitejs/plugin-rsc-examples-starter",
  "version": "0.0.0",
  "private": true,
  "license": "MIT",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^19.2.4",
    "react-dom": "^19.2.4"
  },
  "devDependencies": {
    "@types/react": "^19.2.13",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.3",
    "@vitejs/plugin-rsc": "^0.5.19",
    "nitro": "latest",
    "rsc-html-stream": "^0.0.7",
    "vite": "beta"
  }
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig",
  "compilerOptions": {
    "lib": ["ESNext", "DOM", "DOM.Iterable"],
    "types": ["vite/client", "@vitejs/plugin-rsc/types"],
    "jsx": "react-jsx"
  }
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

import rsc from "@vitejs/plugin-rsc";
import react from "@vitejs/plugin-react";

export default defineConfig({
  plugins: [
    nitro(),
    rsc({
      serverHandler: false,
      entries: {
        ssr: "./app/framework/entry.ssr.tsx",
        rsc: "./app/framework/entry.rsc.tsx",
      },
    }),
    react(),
  ],

  environments: {
    client: {
      build: {
        rollupOptions: {
          input: { index: "./app/framework/entry.browser.tsx" },
        },
      },
    },
  },
});
```

```tsx [app/action.tsx]
"use server";

let serverCounter = 0;

export async function getServerCounter() {
  return serverCounter;
}

export async function updateServerCounter(change: number) {
  serverCounter += change;
}
```

```tsx [app/client.tsx]
"use client";

import React from "react";

export function ClientCounter() {
  const [count, setCount] = React.useState(0);

  return <button onClick={() => setCount((count) => count + 1)}>Client Counter: {count}</button>;
}
```

```css [app/index.css]
:root {
  font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;

  color-scheme: light dark;
  color: rgba(255, 255, 255, 0.87);
  background-color: #242424;

  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

a {
  font-weight: 500;
  color: #646cff;
  text-decoration: inherit;
}
a:hover {
  color: #535bf2;
}

body {
  margin: 0;
  display: flex;
  place-items: center;
  min-width: 320px;
  min-height: 100vh;
}

h1 {
  font-size: 3.2em;
  line-height: 1.1;
}

button {
  border-radius: 8px;
  border: 1px solid transparent;
  padding: 0.6em 1.2em;
  font-size: 1em;
  font-weight: 500;
  font-family: inherit;
  background-color: #1a1a1a;
  cursor: pointer;
  transition: border-color 0.25s;
}
button:hover {
  border-color: #646cff;
}
button:focus,
button:focus-visible {
  outline: 4px auto -webkit-focus-ring-color;
}

@media (prefers-color-scheme: light) {
  :root {
    color: #213547;
    background-color: #ffffff;
  }
  a:hover {
    color: #747bff;
  }
  button {
    background-color: #f9f9f9;
  }
}

#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 1rem;
}

.read-the-docs {
  color: #888;
  text-align: left;
}
```

```tsx [app/root.tsx]
import "./index.css"; // css import is automatically injected in exported server components
import viteLogo from "./assets/vite.svg";
import { getServerCounter, updateServerCounter } from "./action.tsx";
import reactLogo from "./assets/react.svg";
import nitroLogo from "./assets/nitro.svg";
import { ClientCounter } from "./client.tsx";

export function Root(props: { url: URL }) {
  return (
    <html lang="en">
      <head>
        {/* eslint-disable-next-line unicorn/text-encoding-identifier-case */}
        <meta charSet="UTF-8" />
        <link rel="icon" type="image/svg+xml" href="/vite.svg" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Nitro + Vite + RSC</title>
      </head>
      <body>
        <App {...props} />
      </body>
    </html>
  );
}

function App(props: { url: URL }) {
  return (
    <div id="root">
      <div>
        <a href="https://vite.dev" target="_blank">
          <img src={viteLogo} className="logo" alt="Vite logo" />
        </a>
        <a href="https://react.dev/reference/rsc/server-components" target="_blank">
          <img src={reactLogo} className="logo react" alt="React logo" />
        </a>

        <a href="https://v3.nitro.build" target="_blank">
          <img src={nitroLogo} className="logo" alt="Nitro logo" />
        </a>
      </div>
      <h1>Vite + RSC + Nitro</h1>
      <div className="card">
        <ClientCounter />
      </div>
      <div className="card">
        <form action={updateServerCounter.bind(null, 1)}>
          <button>Server Counter: {getServerCounter()}</button>
        </form>
      </div>
      <div className="card">Request URL: {props.url?.href}</div>
      <ul className="read-the-docs">
        <li>
          Edit <code>src/client.tsx</code> to test client HMR.
        </li>
        <li>
          Edit <code>src/root.tsx</code> to test server HMR.
        </li>
        <li>
          Visit{" "}
          <a href="./_.rsc" target="_blank">
            <code>_.rsc</code>
          </a>{" "}
          to view RSC stream payload.
        </li>
        <li>
          Visit{" "}
          <a href="?__nojs" target="_blank">
            <code>?__nojs</code>
          </a>{" "}
          to test server action without js enabled.
        </li>
      </ul>
    </div>
  );
}
```

```text [app/assets/nitro.svg]
<!-- nitro logo -->
<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
  <g clip-path="url(#clip0_115_108)">
    <path fill-rule="evenodd" clip-rule="evenodd"
      d="M35.2166 7.02016C28.0478 -1.38317 15.4241 -2.38397 7.02077 4.78481C-1.38256 11.9536 -2.38336 24.5773 4.78542 32.9806C11.9542 41.3839 24.5779 42.3847 32.9812 35.216C41.3846 28.0472 42.3854 15.4235 35.2166 7.02016ZM25.2525 17.5175C26.0233 17.5175 26.5155 18.3527 26.1287 19.0194L26.0175 19.2111L18.4696 31.6294C18.3293 31.8602 18.0788 32.001 17.8088 32.001H17.0883C16.5946 32.001 16.2336 31.5349 16.3573 31.0569L18.4054 23.1384C18.5691 22.5053 18.0912 21.888 17.4373 21.888H14.2914C13.6375 21.888 13.1596 21.2708 13.3232 20.6377L16.4137 8.68289C16.5261 8.28056 16.8904 7.99734 17.3081 8.00208C17.3587 8.00266 17.4046 8.0035 17.4427 8.0047L20.6109 8.00465C21.217 8.00436 21.684 8.53896 21.6023 9.13949L21.5828 9.28246L20.3746 16.349C20.2702 16.9598 20.7406 17.5175 21.3603 17.5175H25.2525Z"
      fill="url(#paint0_diamond_115_108)" />
    <mask id="mask0_115_108" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0"
      width="40" height="41">
      <circle cx="20" cy="20.001" r="20" fill="url(#paint1_diamond_115_108)" />
    </mask>
    <g mask="url(#mask0_115_108)">
      <g filter="url(#filter0_f_115_108)">
        <path
          d="M1.11145 13.4267C0.0703174 16.4179 -0.245523 19.6136 0.189923 22.7507C0.62537 25.8879 1.79965 28.8768 3.61611 31.4713C5.43256 34.0659 7.83925 36.192 10.6381 37.6746C13.4369 39.1572 16.5478 39.9538 19.7147 39.999C22.8816 40.0442 26.0139 39.3366 28.8539 37.9345C31.6939 36.5324 34.1602 34.4758 36.05 31.9341C37.9397 29.3924 39.1988 26.4383 39.7236 23.3148C40.2483 20.1914 40.0238 16.9879 39.0684 13.9682L33.2532 15.808C33.9172 17.9068 34.0732 20.1333 33.7085 22.3042C33.3438 24.4751 32.4687 26.5283 31.1552 28.2949C29.8418 30.0615 28.1276 31.4908 26.1537 32.4653C24.1799 33.4399 22.0028 33.9316 19.8017 33.9002C17.6006 33.8688 15.4384 33.3151 13.4932 32.2847C11.5479 31.2543 9.87518 29.7766 8.61269 27.9733C7.35019 26.1699 6.53403 24.0926 6.23138 21.9122C5.92873 19.7317 6.14825 17.5106 6.87187 15.4316L1.11145 13.4267Z"
          fill="white" />
      </g>
    </g>
  </g>
  <defs>
    <filter id="filter0_f_115_108" x="-10" y="3.42667" width="60" height="46.5744"
      filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
      <feFlood flood-opacity="0" result="BackgroundImageFix" />
      <feBlend mode="normal" in="SourceGraphic" in2="BackgroundImageFix" result="shape" />
      <feGaussianBlur stdDeviation="5" result="effect1_foregroundBlur_115_108" />
    </filter>
    <radialGradient id="paint0_diamond_115_108" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse"
      gradientTransform="translate(4.00069 20.0004) scale(39.0007 397.71)">
      <stop stop-color="#31B2F3" />
      <stop offset="0.473958" stop-color="#F27CEC" />
      <stop offset="1" stop-color="#FD6641" />
    </radialGradient>
    <radialGradient id="paint1_diamond_115_108" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse"
      gradientTransform="translate(4 20.0011) scale(39 397.703)">
      <stop stop-color="#F27CEC" />
      <stop offset="0.484375" stop-color="#31B2F3" />
      <stop offset="1" stop-color="#7D7573" />
    </radialGradient>
    <clipPath id="clip0_115_108">
      <rect width="146" height="40.001" fill="white" />
    </clipPath>
  </defs>
</svg>
```

```text [app/assets/react.svg]
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
```

```text [app/assets/vite.svg]
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
```

```tsx [app/framework/entry.browser.tsx]
import {
  createFromReadableStream,
  createFromFetch,
  setServerCallback,
  createTemporaryReferenceSet,
  encodeReply,
} from "@vitejs/plugin-rsc/browser";
import React from "react";
import { createRoot, hydrateRoot } from "react-dom/client";
import { rscStream } from "rsc-html-stream/client";
import { GlobalErrorBoundary } from "./error-boundary";
import type { RscPayload } from "./entry.rsc";
import { createRscRenderRequest } from "./request";

async function main() {
  // Stash `setPayload` function to trigger re-rendering
  // from outside of `BrowserRoot` component (e.g. server function call, navigation, hmr)
  let setPayload: (v: RscPayload) => void;

  // Deserialize RSC stream back to React VDOM for CSR
  const initialPayload = await createFromReadableStream<RscPayload>(
    // Initial RSC stream is injected in SSR stream as <script>...FLIGHT_DATA...</script>
    rscStream
  );

  // Browser root component to (re-)render RSC payload as state
  function BrowserRoot() {
    const [payload, setPayload_] = React.useState(initialPayload);

    React.useEffect(() => {
      setPayload = (v) => React.startTransition(() => setPayload_(v));
    }, [setPayload_]);

    // Re-fetch/render on client side navigation
    React.useEffect(() => {
      return listenNavigation(() => fetchRscPayload());
    }, []);

    return payload.root;
  }

  // Re-fetch RSC and trigger re-rendering
  async function fetchRscPayload() {
    const renderRequest = createRscRenderRequest(globalThis.location.href);
    const payload = await createFromFetch<RscPayload>(fetch(renderRequest));
    setPayload(payload);
  }

  // Register a handler which will be internally called by React
  // on server function request after hydration.
  setServerCallback(async (id, args) => {
    const temporaryReferences = createTemporaryReferenceSet();
    const renderRequest = createRscRenderRequest(globalThis.location.href, {
      id,
      body: await encodeReply(args, { temporaryReferences }),
    });
    const payload = await createFromFetch<RscPayload>(fetch(renderRequest), {
      temporaryReferences,
    });
    setPayload(payload);
    const { ok, data } = payload.returnValue!;
    if (!ok) throw data;
    return data;
  });

  // Hydration
  const browserRoot = (
    <React.StrictMode>
      <GlobalErrorBoundary>
        <BrowserRoot />
      </GlobalErrorBoundary>
    </React.StrictMode>
  );
  if ("__NO_HYDRATE" in globalThis) {
    createRoot(document).render(browserRoot);
  } else {
    hydrateRoot(document, browserRoot, {
      formState: initialPayload.formState,
    });
  }

  // Implement server HMR by triggering re-fetch/render of RSC upon server code change
  if (import.meta.hot) {
    import.meta.hot.on("rsc:update", () => {
      fetchRscPayload();
    });
  }
}

// A little helper to setup events interception for client side navigation
function listenNavigation(onNavigation: () => void) {
  globalThis.addEventListener("popstate", onNavigation);

  const oldPushState = globalThis.history.pushState;
  globalThis.history.pushState = function (...args) {
    const res = oldPushState.apply(this, args);
    onNavigation();
    return res;
  };

  const oldReplaceState = globalThis.history.replaceState;
  globalThis.history.replaceState = function (...args) {
    const res = oldReplaceState.apply(this, args);
    onNavigation();
    return res;
  };

  function onClick(e: MouseEvent) {
    const link = (e.target as Element).closest("a");
    if (
      link &&
      link instanceof HTMLAnchorElement &&
      link.href &&
      (!link.target || link.target === "_self") &&
      link.origin === location.origin &&
      !link.hasAttribute("download") &&
      e.button === 0 && // left clicks only
      !e.metaKey && // open in new tab (mac)
      !e.ctrlKey && // open in new tab (windows)
      !e.altKey && // download
      !e.shiftKey &&
      !e.defaultPrevented
    ) {
      e.preventDefault();
      history.pushState(null, "", link.href);
    }
  }
  document.addEventListener("click", onClick);

  return () => {
    document.removeEventListener("click", onClick);
    globalThis.removeEventListener("popstate", onNavigation);
    globalThis.history.pushState = oldPushState;
    globalThis.history.replaceState = oldReplaceState;
  };
}

// eslint-disable-next-line unicorn/prefer-top-level-await
main();
```

```tsx [app/framework/entry.rsc.tsx]
import {
  renderToReadableStream,
  createTemporaryReferenceSet,
  decodeReply,
  loadServerAction,
  decodeAction,
  decodeFormState,
} from "@vitejs/plugin-rsc/rsc";
import type { ReactFormState } from "react-dom/client";
import { Root } from "../root.tsx";
import { parseRenderRequest } from "./request.tsx";

// The schema of payload which is serialized into RSC stream on rsc environment
// and deserialized on ssr/client environments.
export type RscPayload = {
  // this demo renders/serializes/deserializes entire root html element
  // but this mechanism can be changed to render/fetch different parts of components
  // based on your own route conventions.
  root: React.ReactNode;

  // Server action return value of non-progressive enhancement case
  returnValue?: { ok: boolean; data: unknown };

  // Server action form state (e.g. useActionState) of progressive enhancement case
  formState?: ReactFormState;
};

// The plugin by default assumes `rsc` entry having default export of request handler.
// however, how server entries are executed can be customized by registering own server handler.
export default async function handler(request: Request): Promise<Response> {
  // Differentiate RSC, SSR, action, etc.
  const renderRequest = parseRenderRequest(request);
  request = renderRequest.request;

  // Handle server function request
  let returnValue: RscPayload["returnValue"] | undefined;
  let formState: ReactFormState | undefined;
  let temporaryReferences: unknown | undefined;
  let actionStatus: number | undefined;

  if (renderRequest.isAction === true) {
    if (renderRequest.actionId) {
      // Action is called via `ReactClient.setServerCallback`.
      const contentType = request.headers.get("content-type");
      const body = contentType?.startsWith("multipart/form-data")
        ? await request.formData()
        : await request.text();
      temporaryReferences = createTemporaryReferenceSet();
      const args = await decodeReply(body, { temporaryReferences });
      const action = await loadServerAction(renderRequest.actionId);
      try {
        // eslint-disable-next-line prefer-spread
        const data = await action.apply(null, args);
        returnValue = { ok: true, data };
      } catch (error_) {
        returnValue = { ok: false, data: error_ };
        actionStatus = 500;
      }
    } else {
      // Otherwise server function is called via `<form action={...}>`
      // before hydration (e.g. when JavaScript is disabled).
      // aka progressive enhancement.
      const formData = await request.formData();
      const decodedAction = await decodeAction(formData);
      try {
        const result = await decodedAction();
        formState = await decodeFormState(result, formData);
      } catch {
        // there's no single general obvious way to surface this error,
        // so explicitly return classic 500 response.
        return new Response("Internal Server Error: server action failed", {
          status: 500,
        });
      }
    }
  }

  // Serialization from React VDOM tree to RSC stream.
  // We render RSC stream after handling server function request
  // so that new render reflects updated state from server function call
  // to achieve single round trip to mutate and fetch from server.
  const rscPayload: RscPayload = {
    root: <Root url={renderRequest.url} />,
    formState,
    returnValue,
  };

  const rscOptions = { temporaryReferences };
  const rscStream = renderToReadableStream<RscPayload>(rscPayload, rscOptions);

  // Respond RSC stream without HTML rendering as decided by `RenderRequest`
  if (renderRequest.isRsc) {
    return new Response(rscStream, {
      status: actionStatus,
      headers: {
        "content-type": "text/x-component;charset=utf-8",
      },
    });
  }

  // Delegate to SSR environment for HTML rendering.
  // The plugin provides `loadModule` helper to allow loading SSR environment entry module
  // in RSC environment. however this can be customized by implementing own runtime communication
  // e.g. `@cloudflare/vite-plugin`'s service binding.
  const ssrEntryModule = await import.meta.viteRsc.loadModule<typeof import("./entry.ssr.tsx")>(
    "ssr",
    "index"
  );

  const ssrResult = await ssrEntryModule.renderHTML(rscStream, {
    formState,
    // Allow quick simulation of JavaScript disabled browser
    debugNoJS: renderRequest.url.searchParams.has("__nojs"),
  });

  // Respond HTML
  return new Response(ssrResult.stream, {
    status: ssrResult.status,
    headers: {
      "Content-Type": "text/html",
    },
  });
}

if (import.meta.hot) {
  import.meta.hot.accept();
}
```

```tsx [app/framework/entry.ssr.tsx]
import { createFromReadableStream } from "@vitejs/plugin-rsc/ssr";
import React from "react";
import type { ReactFormState } from "react-dom/client";
import { renderToReadableStream } from "react-dom/server.edge";
import { injectRSCPayload } from "rsc-html-stream/server";
import type { RscPayload } from "./entry.rsc";

export default {
  fetch: async (request: Request) => {
    const rscEntryModule = await import.meta.viteRsc.loadModule<typeof import("./entry.rsc")>(
      "rsc",
      "index"
    );
    return rscEntryModule.default(request);
  },
};

export async function renderHTML(
  rscStream: ReadableStream<Uint8Array>,
  options: {
    formState?: ReactFormState;
    nonce?: string;
    debugNoJS?: boolean;
  }
): Promise<{ stream: ReadableStream<Uint8Array>; status?: number }> {
  // Duplicate one RSC stream into two.
  // - one for SSR (ReactClient.createFromReadableStream below)
  // - another for browser hydration payload by injecting <script>...FLIGHT_DATA...</script>.
  const [rscStream1, rscStream2] = rscStream.tee();

  // Deserialize RSC stream back to React VDOM
  let payload: Promise<RscPayload> | undefined;
  function SsrRoot() {
    // Deserialization needs to be kicked off inside ReactDOMServer context
    // for ReactDOMServer preinit/preloading to work
    payload ??= createFromReadableStream<RscPayload>(rscStream1);
    return React.use(payload).root;
  }

  // Render HTML (traditional SSR)
  const bootstrapScriptContent = await import.meta.viteRsc.loadBootstrapScriptContent("index");

  let htmlStream: ReadableStream<Uint8Array>;
  let status: number | undefined;

  try {
    htmlStream = await renderToReadableStream(<SsrRoot />, {
      bootstrapScriptContent: options?.debugNoJS ? undefined : bootstrapScriptContent,
      nonce: options?.nonce,
      formState: options?.formState,
    });
  } catch {
    // fallback to render an empty shell and run pure CSR on browser,
    // which can replay server component error and trigger error boundary.
    status = 500;
    htmlStream = await renderToReadableStream(
      <html>
        <body>
          <noscript>Internal Server Error: SSR failed</noscript>
        </body>
      </html>,
      {
        bootstrapScriptContent:
          `self.__NO_HYDRATE=1;` + (options?.debugNoJS ? "" : bootstrapScriptContent),
        nonce: options?.nonce,
      }
    );
  }

  let responseStream: ReadableStream<Uint8Array> = htmlStream;
  if (!options?.debugNoJS) {
    // Initial RSC stream is injected in HTML stream as <script>...FLIGHT_DATA...</script>
    // using utility made by devongovett https://github.com/devongovett/rsc-html-stream
    responseStream = responseStream.pipeThrough(
      injectRSCPayload(rscStream2, {
        nonce: options?.nonce,
      })
    );
  }

  return { stream: responseStream, status };
}
```

```tsx [app/framework/error-boundary.tsx]
"use client";

import React from "react";

// Minimal ErrorBoundary example to handle errors globally on browser
export function GlobalErrorBoundary(props: { children?: React.ReactNode }) {
  return <ErrorBoundary errorComponent={DefaultGlobalErrorPage}>{props.children}</ErrorBoundary>;
}

// https://github.com/vercel/next.js/blob/33f8428f7066bf8b2ec61f025427ceb2a54c4bdf/packages/next/src/client/components/error-boundary.tsx
// https://react.dev/reference/react/Component#catching-rendering-errors-with-an-error-boundary
class ErrorBoundary extends React.Component<{
  children?: React.ReactNode;
  errorComponent: React.FC<{
    error: Error;
    reset: () => void;
  }>;
}> {
  override state: { error?: Error } = {};

  static getDerivedStateFromError(error: Error) {
    return { error };
  }

  reset = () => {
    this.setState({ error: null });
  };

  override render() {
    const error = this.state.error;
    if (error) {
      return <this.props.errorComponent error={error} reset={this.reset} />;
    }
    return this.props.children;
  }
}

// https://github.com/vercel/next.js/blob/677c9b372faef680d17e9ba224743f44e1107661/packages/next/src/build/webpack/loaders/next-app-loader.ts#L73
// https://github.com/vercel/next.js/blob/677c9b372faef680d17e9ba224743f44e1107661/packages/next/src/client/components/error-boundary.tsx#L145
function DefaultGlobalErrorPage(props: { error: Error; reset: () => void }) {
  return (
    <html>
      <head>
        <title>Unexpected Error</title>
      </head>
      <body
        style={{
          height: "100vh",
          display: "flex",
          flexDirection: "column",
          placeContent: "center",
          placeItems: "center",
          fontSize: "16px",
          fontWeight: 400,
          lineHeight: "24px",
        }}
      >
        <p>Caught an unexpected error</p>
        <pre>
          Error:{" "}
          {import.meta.env.DEV && "message" in props.error ? props.error.message : "(Unknown)"}
        </pre>
        <button
          onClick={() => {
            React.startTransition(() => {
              props.reset();
            });
          }}
        >
          Reset
        </button>
      </body>
    </html>
  );
}
```

```tsx [app/framework/request.tsx]
// Framework conventions (arbitrary choices for this demo):
// - Use `_.rsc` URL suffix to differentiate RSC requests from SSR requests
// - Use `x-rsc-action` header to pass server action ID
const URL_POSTFIX = "_.rsc";
const HEADER_ACTION_ID = "x-rsc-action";

// Parsed request information used to route between RSC/SSR rendering and action handling.
// Created by parseRenderRequest() from incoming HTTP requests.
type RenderRequest = {
  isRsc: boolean; // true if request should return RSC payload (via _.rsc suffix)
  isAction: boolean; // true if this is a server action call (POST request)
  actionId?: string; // server action ID from x-rsc-action header
  request: Request; // normalized Request with _.rsc suffix removed from URL
  url: URL; // normalized URL with _.rsc suffix removed
};

export function createRscRenderRequest(
  urlString: string,
  action?: { id: string; body: BodyInit }
): Request {
  const url = new URL(urlString);
  url.pathname += URL_POSTFIX;
  const headers = new Headers();
  if (action) {
    headers.set(HEADER_ACTION_ID, action.id);
  }
  return new Request(url.toString(), {
    method: action ? "POST" : "GET",
    headers,
    body: action?.body,
  });
}

export function parseRenderRequest(request: Request): RenderRequest {
  const url = new URL(request.url);
  const isAction = request.method === "POST";
  if (url.pathname.endsWith(URL_POSTFIX)) {
    url.pathname = url.pathname.slice(0, -URL_POSTFIX.length);
    const actionId = request.headers.get(HEADER_ACTION_ID) || undefined;
    if (request.method === "POST" && !actionId) {
      throw new Error("Missing action id header for RSC action request");
    }
    return {
      isRsc: true,
      isAction,
      actionId,
      request: new Request(url, request),
      url,
    };
  } else {
    return {
      isRsc: false,
      isAction,
      request,
      url,
    };
  }
}
```
::

è¯¥ç¤ºä¾‹æ¼”ç¤ºäº†ä½¿ç”¨ Vite çš„å®éªŒæ€§ RSC æ’ä»¶å’Œ Nitro çš„ React æœåŠ¡å™¨ç»„ä»¶ï¼ˆRSCï¼‰ã€‚å®ƒåŒ…æ‹¬æœåŠ¡å™¨ç»„ä»¶ã€å®¢æˆ·ç«¯ç»„ä»¶ã€æœåŠ¡å™¨åŠ¨ä½œå’Œæµå¼ SSRã€‚

## æ¦‚è¿°

::steps{level="4"}
#### **SSR å…¥å£** å¤„ç†ä¼ å…¥è¯·æ±‚å¹¶å°† React ç»„ä»¶æ¸²æŸ“ä¸º HTML

#### **æ ¹ç»„ä»¶** ä½œä¸ºæœåŠ¡å™¨ç»„ä»¶å®šä¹‰é¡µé¢ç»“æ„

#### **å®¢æˆ·ç«¯ç»„ä»¶** ä½¿ç”¨ `"use client"` æŒ‡ä»¤å®ç°äº¤äº’éƒ¨åˆ†
::

## 1. SSR å…¥å£

```tsx [app/framework/entry.ssr.tsx]
import { createFromReadableStream } from "@vitejs/plugin-rsc/ssr";
import React from "react";
import type { ReactFormState } from "react-dom/client";
import { renderToReadableStream } from "react-dom/server.edge";
import { injectRSCPayload } from "rsc-html-stream/server";
import type { RscPayload } from "./entry.rsc";

export default {
  fetch: async (request: Request) => {
    const rscEntryModule = await import.meta.viteRsc.loadModule<typeof import("./entry.rsc")>(
      "rsc",
      "index"
    );
    return rscEntryModule.default(request);
  },
};

export async function renderHTML(
  rscStream: ReadableStream<Uint8Array>,
  options: {
    formState?: ReactFormState;
    nonce?: string;
    debugNoJS?: boolean;
  }
): Promise<{ stream: ReadableStream<Uint8Array>; status?: number }> {
  // å°†ä¸€ä¸ª RSC æµå¤åˆ¶æˆä¸¤ä¸ªæµã€‚
  // - ä¸€ä¸ªç”¨äº SSRï¼ˆä¸‹æ–¹çš„ ReactClient.createFromReadableStreamï¼‰
  // - å¦ä¸€ä¸ªç”¨äºé€šè¿‡æ³¨å…¥ <script>...FLIGHT_DATA...</script> å®ç°æµè§ˆå™¨æ°´åˆ
  const [rscStream1, rscStream2] = rscStream.tee();

  // å°† RSC æµååºåˆ—åŒ–ä¸º React è™šæ‹Ÿ DOM
  let payload: Promise<RscPayload> | undefined;
  function SsrRoot() {
    // ååºåˆ—åŒ–éœ€è¦åœ¨ ReactDOMServer ä¸Šä¸‹æ–‡ä¸­å¯åŠ¨ï¼Œ
    // ä»¥ä¾¿ ReactDOMServer çš„é¢„åˆå§‹åŒ–/é¢„åŠ è½½ç”Ÿæ•ˆ
    payload ??= createFromReadableStream<RscPayload>(rscStream1);
    return React.use(payload).root;
  }

  // æ¸²æŸ“ HTMLï¼ˆä¼ ç»Ÿ SSRï¼‰
  const bootstrapScriptContent = await import.meta.viteRsc.loadBootstrapScriptContent("index");

  let htmlStream: ReadableStream<Uint8Array>;
  let status: number | undefined;

  try {
    htmlStream = await renderToReadableStream(<SsrRoot />, {
      bootstrapScriptContent: options?.debugNoJS ? undefined : bootstrapScriptContent,
      nonce: options?.nonce,
      formState: options?.formState,
    });
  } catch {
    // å›é€€æ¸²æŸ“ä¸€ä¸ªç©ºå£³ï¼Œåœ¨æµè§ˆå™¨çº¯ CSR è¿è¡Œï¼Œ
    // è¯¥è¿‡ç¨‹èƒ½é‡æ”¾æœåŠ¡å™¨ç»„ä»¶é”™è¯¯å¹¶è§¦å‘é”™è¯¯è¾¹ç•Œã€‚
    status = 500;
    htmlStream = await renderToReadableStream(
      <html>
        <body>
          <noscript>æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼šSSR å¤±è´¥</noscript>
        </body>
      </html>,
      {
        bootstrapScriptContent:
          `self.__NO_HYDRATE=1;` + (options?.debugNoJS ? "" : bootstrapScriptContent),
        nonce: options?.nonce,
      }
    );
  }

  let responseStream: ReadableStream<Uint8Array> = htmlStream;
  if (!options?.debugNoJS) {
    // åˆå§‹ RSC æµä½œä¸º <script>...FLIGHT_DATA...</script> æ³¨å…¥åˆ° HTML æµä¸­ï¼Œ
    // ä½¿ç”¨ devongovett å¼€å‘çš„å·¥å…· https://github.com/devongovett/rsc-html-stream
    responseStream = responseStream.pipeThrough(
      injectRSCPayload(rscStream2, {
        nonce: options?.nonce,
      })
    );
  }

  return { stream: responseStream, status };
}
```

SSR å…¥å£å¤„ç†æ¸²æŸ“æµç¨‹ã€‚å®ƒåŠ è½½ RSC å…¥å£æ¨¡å—ï¼Œå¤åˆ¶ RSC æµï¼ˆä¸€ä»½ç”¨äº SSRï¼Œä¸€ä»½ç”¨äºæ°´åˆï¼‰ï¼Œå°†æµååºåˆ—åŒ–å› React è™šæ‹Ÿ DOM å¹¶æ¸²æŸ“ä¸º HTMLã€‚RSC è´Ÿè½½é€šè¿‡æ³¨å…¥åˆ° HTML ä¸­å®ç°å®¢æˆ·ç«¯æ°´åˆã€‚

## 2. æ ¹æœåŠ¡å™¨ç»„ä»¶

```tsx [app/root.tsx]
import "./index.css"; // css å¯¼å…¥ä¼šè‡ªåŠ¨æ³¨å…¥å¯¼å‡ºçš„æœåŠ¡å™¨ç»„ä»¶ä¸­
import viteLogo from "./assets/vite.svg";
import { getServerCounter, updateServerCounter } from "./action.tsx";
import reactLogo from "./assets/react.svg";
import nitroLogo from "./assets/nitro.svg";
import { ClientCounter } from "./client.tsx";

export function Root(props: { url: URL }) {
  return (
    <html lang="en">
      <head>
        {/* eslint-disable-next-line unicorn/text-encoding-identifier-case */}
        <meta charSet="UTF-8" />
        <link rel="icon" type="image/svg+xml" href="/vite.svg" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Nitro + Vite + RSC</title>
      </head>
      <body>
        <App {...props} />
      </body>
    </html>
  );
}

function App(props: { url: URL }) {
  return (
    <div id="root">
      <div>
        <a href="https://vite.dev" target="_blank">
          <img src={viteLogo} className="logo" alt="Vite logo" />
        </a>
        <a href="https://react.dev/reference/rsc/server-components" target="_blank">
          <img src={reactLogo} className="logo react" alt="React logo" />
        </a>

        <a href="https://v3.nitro.build" target="_blank">
          <img src={nitroLogo} className="logo" alt="Nitro logo" />
        </a>
      </div>
      <h1>Vite + RSC + Nitro</h1>
      <div className="card">
        <ClientCounter />
      </div>
      <div className="card">
        <form action={updateServerCounter.bind(null, 1)}>
          <button>æœåŠ¡å™¨è®¡æ•°å™¨ï¼š{getServerCounter()}</button>
        </form>
      </div>
      <div className="card">è¯·æ±‚ URL: {props.url?.href}</div>
      <ul className="read-the-docs">
        <li>
          ç¼–è¾‘ <code>src/client.tsx</code> æ¥æµ‹è¯•å®¢æˆ·ç«¯ HMRã€‚
        </li>
        <li>
          ç¼–è¾‘ <code>src/root.tsx</code> æ¥æµ‹è¯•æœåŠ¡å™¨ç«¯ HMRã€‚
        </li>
        <li>
          è®¿é—®{" "}
          <a href="./_.rsc" target="_blank">
            <code>_.rsc</code>
          </a>{" "}
          æŸ¥çœ‹ RSC æµè´Ÿè½½ã€‚
        </li>
        <li>
          è®¿é—®{" "}
          <a href="?__nojs" target="_blank">
            <code>?__nojs</code>
          </a>{" "}
          æµ‹è¯•åœ¨ä¸å¯ç”¨ JS çš„æƒ…å†µä¸‹çš„æœåŠ¡å™¨åŠ¨ä½œã€‚
        </li>
      </ul>
    </div>
  );
}
```

æœåŠ¡å™¨ç»„ä»¶ä»…åœ¨æœåŠ¡å™¨ç«¯è¿è¡Œã€‚å®ƒä»¬å¯ä»¥ç›´æ¥å¯¼å…¥ CSSï¼Œä½¿ç”¨æœåŠ¡å™¨ç«¯æ•°æ®å¹¶è°ƒç”¨æœåŠ¡å™¨åŠ¨ä½œã€‚`ClientCounter` ç»„ä»¶è¢«å¯¼å…¥ä½†è¿è¡Œåœ¨å®¢æˆ·ç«¯ï¼Œå› ä¸ºå®ƒå¸¦æœ‰ `"use client"` æŒ‡ä»¤ã€‚

## 3. å®¢æˆ·ç«¯ç»„ä»¶

```tsx [app/client.tsx]
"use client";

import React from "react";

export function ClientCounter() {
  const [count, setCount] = React.useState(0);

  return <button onClick={() => setCount((count) => count + 1)}>å®¢æˆ·ç«¯è®¡æ•°å™¨ï¼š{count}</button>;
}
```

`"use client"` æŒ‡ä»¤å°†å…¶æ ‡è®°ä¸ºå®¢æˆ·ç«¯ç»„ä»¶ã€‚å®ƒåœ¨æµè§ˆå™¨ä¸­æ°´åˆå¹¶å¤„ç†äº¤äº’çŠ¶æ€ã€‚æœåŠ¡å™¨ç»„ä»¶å¯ä»¥å¯¼å…¥å’Œæ¸²æŸ“å®¢æˆ·ç«¯ç»„ä»¶ï¼Œä½†å®¢æˆ·ç«¯ç»„ä»¶ä¸èƒ½å¯¼å…¥æœåŠ¡å™¨ç»„ä»¶ã€‚

## äº†è§£æ›´å¤š

- [React æœåŠ¡å™¨ç»„ä»¶](https://react.dev/reference/rsc/server-components){rel="&#x22;nofollow&#x22;"}


# Vite SSR HTML

::code-tree{expand-all default-value="app/entry-server.ts" expand-all=""}
```html [index.html]
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nitro Quotes</title>
    <style>
      @import "tailwindcss";
    </style>
  </head>
  <body
    class="min-h-screen flex items-center justify-center p-5 bg-gradient-to-br from-indigo-500 to-purple-600 font-sans"
  >
    <div class="max-w-xl w-full text-center text-white">
      <div class="bg-white/10 backdrop-blur-md rounded-2xl p-10 shadow-xl border border-white/20">
        <div
          id="quote"
          class="text-[clamp(1.2rem,4vw,1.8rem)] leading-relaxed mb-5 font-light opacity-70 transition-opacity duration-500"
        >
          <!--ssr-outlet-->
        </div>
        <div
          id="author"
          class="text-[clamp(1rem,3vw,1.2rem)] opacity-0 font-normal transition-opacity duration-500"
        ></div>
        <button
          id="refresh-btn"
          class="mt-5 bg-white/20 border border-white/30 text-white px-6 py-3 rounded-full cursor-pointer text-sm transition hover:bg-white/30 hover:-translate-y-0.5"
          onclick="fetchQuote()"
        >
          New Quote
        </button>
      </div>
      <div class="mt-8 text-sm opacity-60">
        Powered by
        <a
          class="text-white no-underline border-b border-white/30 hover:border-white transition-colors"
          href="https://vitejs.dev/"
          >Vite</a
        >
        and
        <a
          class="text-white no-underline border-b border-white/30 hover:border-white transition-colors"
          href="https://github.com/nitrojs/nitro"
          >Nitro v3</a
        >.
      </div>
    </div>

    <script>
      const quoteElement = document.getElementById("quote");
      const authorElement = document.getElementById("author");
      const refreshBtn = document.getElementById("refresh-btn");

      const baseQuoteClasses =
        "text-[clamp(1.2rem,4vw,1.8rem)] leading-relaxed mb-5 font-light transition-opacity duration-500";
      const loadingQuoteClasses = baseQuoteClasses + " opacity-70";
      const normalQuoteClasses = baseQuoteClasses + " opacity-100";
      const errorQuoteClasses = baseQuoteClasses + " text-red-400 opacity-100 text-sm";

      const baseAuthorClasses =
        "text-[clamp(1rem,3vw,1.2rem)] font-normal transition-opacity duration-500";
      const hiddenAuthorClasses = baseAuthorClasses + " opacity-0";
      const visibleAuthorClasses = baseAuthorClasses + " opacity-80";

      async function fetchQuote() {
        try {
          quoteElement.textContent = "Loading...";
          quoteElement.className = loadingQuoteClasses;
          authorElement.textContent = "";
          authorElement.className = hiddenAuthorClasses;
          refreshBtn.style.display = "none";
          const response = await fetch("/quote");
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const { text, author } = await response.json();
          quoteElement.textContent = `"${text}"`;
          quoteElement.className = normalQuoteClasses;
          authorElement.textContent = `â€” ${author}`;
          authorElement.className = visibleAuthorClasses;
        } catch (error) {
          console.error("Error fetching quote:", error);
          quoteElement.textContent = "Failed to load quote. Please try again.";
          quoteElement.className = errorQuoteClasses;
          authorElement.textContent = "";
          authorElement.className = hiddenAuthorClasses;
        } finally {
          refreshBtn.style.display = "inline-block";
        }
      }
    </script>
  </body>
</html>
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "build": "vite build",
    "dev": "vite dev",
    "preview": "vite preview"
  },
  "devDependencies": {
    "@tailwindcss/vite": "^4.1.18",
    "nitro": "latest",
    "tailwindcss": "^4.1.18",
    "vite": "beta"
  }
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

import tailwindcss from "@tailwindcss/vite";

export default defineConfig({
  plugins: [
    nitro({
      serverDir: "./",
    }),
    tailwindcss(),
  ],
});
```

```ts [app/entry-server.ts]
import { fetch } from "nitro";

export default {
  async fetch() {
    const quote = (await fetch("/quote").then((res) => res.json())) as {
      text: string;
    };
    return tokenizedStream(quote.text, 50);
  },
};

function tokenizedStream(text: string, delay: number): ReadableStream<Uint8Array> {
  const tokens = text.split(" ");
  return new ReadableStream({
    start(controller) {
      let index = 0;
      function push() {
        if (index < tokens.length) {
          const word = tokens[index++] + (index < tokens.length ? " " : "");
          controller.enqueue(new TextEncoder().encode(word));
          setTimeout(push, delay);
        } else {
          controller.close();
        }
      }
      push();
    },
  });
}
```

```ts [routes/quote.ts]
const QUOTES_URL =
  "https://github.com/JamesFT/Database-Quotes-JSON/raw/refs/heads/master/quotes.json";

let _quotes: Promise<unknown> | undefined;

function getQuotes() {
  return (_quotes ??= fetch(QUOTES_URL).then((res) => res.json())) as Promise<
    { quoteText: string; quoteAuthor: string }[]
  >;
}

export default async function quotesHandler() {
  const quotes = await getQuotes();
  const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
  return Response.json({
    text: randomQuote.quoteText,
    author: randomQuote.quoteAuthor,
  });
}
```
::

è¯¥ç¤ºä¾‹æ¼”ç¤ºäº†å¦‚ä½•æ¸²æŸ“å¸¦æœ‰æœåŠ¡å™¨ç«¯æ•°æ®çš„ HTML æ¨¡æ¿ï¼Œå¹¶é€å­—æµå¼ä¼ è¾“å“åº”å†…å®¹ã€‚å®ƒå±•ç¤ºäº†å¦‚ä½•åœ¨ä¸ä½¿ç”¨æ¡†æ¶çš„æƒ…å†µä¸‹ï¼Œåˆ©ç”¨ Nitro çš„ Vite SSR é›†æˆã€‚

## æ¦‚è§ˆ

::steps{level="4"}
#### **æ·»åŠ  Nitro Vite æ’ä»¶** ä»¥å¯ç”¨ SSR

#### **åˆ›å»ºä¸€ä¸ª HTML æ¨¡æ¿**ï¼Œåœ¨æœåŠ¡å™¨å†…å®¹æ’å…¥å¤„æ·»åŠ  `<!--ssr-outlet-->` æ³¨é‡Š

#### **åˆ›å»ºä¸€ä¸ªæœåŠ¡å™¨å…¥å£**ï¼Œè·å–æ•°æ®å¹¶è¿”å›ä¸€ä¸ªæµ

#### **æ·»åŠ ç”¨äºæœåŠ¡å™¨ç«¯æ•°æ®çš„ API è·¯ç”±**
::

## å·¥ä½œåŸç†

`index.html` æ–‡ä»¶åŒ…å«ä¸€ä¸ª `<!--ssr-outlet-->` æ³¨é‡Šï¼Œæ ‡è®°æœåŠ¡å™¨æ¸²æŸ“å†…å®¹å°†è¢«æ’å…¥çš„ä½ç½®ã€‚Nitro ä¼šç”¨ä½ çš„æœåŠ¡å™¨å…¥å£è¾“å‡ºæ›¿æ¢è¯¥æ³¨é‡Šã€‚

æœåŠ¡å™¨å…¥å£å¯¼å‡ºä¸€ä¸ªå¸¦æœ‰ `fetch` æ–¹æ³•çš„å¯¹è±¡ã€‚å®ƒä½¿ç”¨ Nitro çš„å†…éƒ¨ fetch è°ƒç”¨ `/quote` API è·¯ç”±ï¼Œç„¶åè¿”å›ä¸€ä¸ª `ReadableStream`ï¼Œè¯¥æµä»¥æ¯ä¸ªå•è¯é—´éš” 50ms çš„é€Ÿåº¦é€å­—å‘é€å¼•ç”¨æ–‡æœ¬ã€‚

å¼•ç”¨è·¯ç”±ä» GitHub è·å–åŒ…å«å¤šä¸ªå¼•ç”¨çš„ JSON æ–‡ä»¶ï¼Œç¼“å­˜ç»“æœï¼Œå¹¶è¿”å›ä¸€ä¸ªéšæœºå¼•ç”¨ã€‚æœåŠ¡å™¨å…¥å£è°ƒç”¨æ­¤è·¯ç”±ä»¥è·å–é¡µé¢å†…å®¹ã€‚

## äº†è§£æ›´å¤š

- [Renderer](https://nitro.zhcndoc.com/docs/renderer)
- [Server Entry](https://nitro.zhcndoc.com/docs/server-entry)


# ä½¿ç”¨ Preact è¿›è¡Œ SSR

::code-tree{expand-all default-value="src/entry-server.tsx" expand-all=""}
```json [package.json]
{
  "type": "module",
  "scripts": {
    "build": "vite build",
    "preview": "vite preview",
    "dev": "vite dev"
  },
  "devDependencies": {
    "@preact/preset-vite": "^2.10.3",
    "@tailwindcss/vite": "^4.1.18",
    "nitro": "latest",
    "preact": "^10.28.3",
    "preact-render-to-string": "^6.6.5",
    "tailwindcss": "^4.1.18",
    "vite": "beta"
  }
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig",
  "compilerOptions": {
    "jsx": "react-jsx",
    "jsxImportSource": "preact"
  }
}
```

```js [vite.config.mjs]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";
import preact from "@preact/preset-vite";

export default defineConfig({
  plugins: [nitro(), preact()],
  environments: {
    client: {
      build: {
        rollupOptions: {
          input: "./src/entry-client.tsx",
        },
      },
    },
  },
});
```

```tsx [src/app.tsx]
import { useState } from "preact/hooks";

export function App() {
  const [count, setCount] = useState(0);
  return <button onClick={() => setCount((c) => c + 1)}>Count is {count}</button>;
}
```

```tsx [src/entry-client.tsx]
import { hydrate } from "preact";
import { App } from "./app.tsx";

function main() {
  hydrate(<App />, document.querySelector("#app")!);
}

main();
```

```tsx [src/entry-server.tsx]
import "./styles.css";
import { renderToReadableStream } from "preact-render-to-string/stream";
import { App } from "./app.jsx";

import clientAssets from "./entry-client?assets=client";
import serverAssets from "./entry-server?assets=ssr";

export default {
  async fetch(request: Request) {
    const url = new URL(request.url);
    const htmlStream = renderToReadableStream(<Root url={url} />);
    return new Response(htmlStream, {
      headers: { "Content-Type": "text/html;charset=utf-8" },
    });
  },
};

function Root(props: { url: URL }) {
  const assets = clientAssets.merge(serverAssets);
  return (
    <html lang="en">
      <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        {assets.css.map((attr: any) => (
          <link key={attr.href} rel="stylesheet" {...attr} />
        ))}
        {assets.js.map((attr: any) => (
          <link key={attr.href} type="modulepreload" {...attr} />
        ))}
        <script type="module" src={assets.entry} />
      </head>
      <body>
        <h1 className="hero">Nitro + Vite + Preact</h1>
        <p>URL: {props.url.href}</p>
        <div id="app">
          <App />
        </div>
      </body>
    </html>
  );
}
```

```css [src/styles.css]
.hero {
  color: orange;
}

button {
  background-color: lightskyblue;
}
```
::

ä½¿ç”¨ Preactã€Vite å’Œ Nitro è®¾ç½®æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰ã€‚æ­¤é…ç½®æ”¯æŒæµå¼ HTML å“åº”ã€è‡ªåŠ¨èµ„äº§ç®¡ç†å’Œå®¢æˆ·ç«¯æ°´åˆã€‚

## æ¦‚è¿°

::steps{level="4"}
#### åœ¨ Vite é…ç½®ä¸­æ·»åŠ  Nitro Vite æ’ä»¶

#### é…ç½®å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å…¥å£æ–‡ä»¶

#### åˆ›å»ºæ¸²æŸ“åº”ç”¨ä¸º HTML çš„æœåŠ¡å™¨å…¥å£

#### åˆ›å»ºå°†æœåŠ¡å™¨æ¸²æŸ“çš„ HTML æ°´åˆçš„å®¢æˆ·ç«¯å…¥å£
::

## 1. é…ç½® Vite

åœ¨ Vite é…ç½®ä¸­æ·»åŠ  Nitro å’Œ Preact æ’ä»¶ã€‚å®šä¹‰ `client` ç¯å¢ƒï¼ŒæŒ‡å®šå®¢æˆ·ç«¯å…¥å£ç‚¹ï¼š

```js [vite.config.mjs]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";
import preact from "@preact/preset-vite";

export default defineConfig({
  plugins: [nitro(), preact()],
  environments: {
    client: {
      build: {
        rollupOptions: {
          input: "./src/entry-client.tsx",
        },
      },
    },
  },
});
```

`environments.client` é…ç½®å‘Šè¯‰ Vite ä½¿ç”¨å“ªä¸ªæ–‡ä»¶ä½œä¸ºæµè§ˆå™¨å…¥å£ã€‚Nitro ä¼šè‡ªåŠ¨ä»å¸¸è§ç›®å½•ä¸­ï¼Œåä¸º `entry-server` æˆ– `server` çš„æ–‡ä»¶ä¸­æ£€æµ‹æœåŠ¡å™¨å…¥å£ã€‚

## 2. åˆ›å»º App ç»„ä»¶

åˆ›å»ºä¸€ä¸ªåœ¨æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å…±ç”¨çš„ Preact ç»„ä»¶ï¼š

```tsx [src/app.tsx]
import { useState } from "preact/hooks";

export function App() {
  const [count, setCount] = useState(0);
  return <button onClick={() => setCount((c) => c + 1)}>Count is {count}</button>;
}
```

## 3. åˆ›å»ºæœåŠ¡å™¨å…¥å£

æœåŠ¡å™¨å…¥å£ä½¿ç”¨ `preact-render-to-string/stream` å°†ä½ çš„ Preact åº”ç”¨æ¸²æŸ“ä¸ºæµå¼ HTML å“åº”ï¼š

```tsx [src/entry-server.tsx]
import "./styles.css";
import { renderToReadableStream } from "preact-render-to-string/stream";
import { App } from "./app.jsx";

import clientAssets from "./entry-client?assets=client";
import serverAssets from "./entry-server?assets=ssr";

export default {
  async fetch(request: Request) {
    const url = new URL(request.url);
    const htmlStream = renderToReadableStream(<Root url={url} />);
    return new Response(htmlStream, {
      headers: { "Content-Type": "text/html;charset=utf-8" },
    });
  },
};

function Root(props: { url: URL }) {
  const assets = clientAssets.merge(serverAssets);
  return (
    <html lang="en">
      <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        {assets.css.map((attr: any) => (
          <link key={attr.href} rel="stylesheet" {...attr} />
        ))}
        {assets.js.map((attr: any) => (
          <link key={attr.href} type="modulepreload" {...attr} />
        ))}
        <script type="module" src={assets.entry} />
      </head>
      <body>
        <h1 className="hero">Nitro + Vite + Preact</h1>
        <p>URL: {props.url.href}</p>
        <div id="app">
          <App />
        </div>
      </body>
    </html>
  );
}
```

é€šè¿‡æ·»åŠ  `?assets=client` å’Œ `?assets=ssr` æŸ¥è¯¢å‚æ•°å¯¼å…¥èµ„æºã€‚Nitro ä¼šæ”¶é›†å„ä¸ªå…¥å£çš„ CSS å’Œ JS èµ„æºï¼Œ`merge()` æ–¹æ³•ä¼šå°†å®ƒä»¬åˆå¹¶ä¸ºä¸€ä¸ªæ¸…å•ã€‚`assets` å¯¹è±¡æä¾›æ ·å¼è¡¨å’Œè„šæœ¬å±æ€§æ•°ç»„ï¼Œä»¥åŠå®¢æˆ·ç«¯å…¥å£ URLã€‚ä½¿ç”¨ `renderToReadableStream` è®© Preact æ¸²æŸ“è¿‡ç¨‹ä¸­ä»¥æµå½¢å¼å‘é€ HTMLï¼Œä»è€Œæå‡é¦–å­—èŠ‚æ—¶é—´ã€‚

## 4. åˆ›å»ºå®¢æˆ·ç«¯å…¥å£

å®¢æˆ·ç«¯å…¥å£ç”¨äºæ°´åˆæœåŠ¡å™¨æ¸²æŸ“çš„ HTMLï¼Œç»‘å®š Preact çš„äº‹ä»¶å¤„ç†ç¨‹åºï¼š

```tsx [src/entry-client.tsx]
import { hydrate } from "preact";
import { App } from "./app.tsx";

function main() {
  hydrate(<App />, document.querySelector("#app")!);
}

main();
```

`hydrate` å‡½æ•°ä¼šæŠŠ Preact é™„åŠ åˆ°ç°æœ‰çš„ã€æœåŠ¡ç«¯æ¸²æŸ“çš„ `#app` DOM å†…ï¼Œè€Œä¸ä¼šé‡æ–°æ¸²æŸ“ã€‚

## äº†è§£æ›´å¤š

- [Renderer](https://nitro.zhcndoc.com/docs/renderer)
- [Server Entry](https://nitro.zhcndoc.com/docs/server-entry)


# ä½¿ç”¨ React å®ç° SSR

::code-tree{expand-all default-value="src/entry-server.tsx" expand-all=""}
```json [package.json]
{
  "type": "module",
  "scripts": {
    "build": "vite build",
    "preview": "vite preview",
    "dev": "vite dev"
  },
  "devDependencies": {
    "@types/react": "^19.2.13",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.3",
    "nitro": "latest",
    "react": "^19.2.4",
    "react-dom": "^19.2.4",
    "react-refresh": "^0.18.0",
    "vite": "beta"
  }
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig",
  "compilerOptions": {
    "jsx": "react-jsx",
    "jsxImportSource": "react"
  }
}
```

```js [vite.config.mjs]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";
import react from "@vitejs/plugin-react";

export default defineConfig({
  plugins: [nitro(), react()],
  environments: {
    client: {
      build: { rollupOptions: { input: "./src/entry-client.tsx" } },
    },
  },
});
```

```tsx [src/app.tsx]
import { useState } from "react";

export function App() {
  const [count, setCount] = useState(0);
  return (
    <>
      <h1 className="hero">Nitro + Vite + React</h1>
      <button onClick={() => setCount((c) => c + 1)}>Count is {count}</button>
    </>
  );
}
```

```tsx [src/entry-client.tsx]
import "@vitejs/plugin-react/preamble";
import { hydrateRoot } from "react-dom/client";
import { App } from "./app.tsx";

hydrateRoot(document.querySelector("#app")!, <App />);
```

```tsx [src/entry-server.tsx]
import "./styles.css";
import { renderToReadableStream } from "react-dom/server.edge";
import { App } from "./app.tsx";

import clientAssets from "./entry-client?assets=client";
import serverAssets from "./entry-server?assets=ssr";

export default {
  async fetch(_req: Request) {
    const assets = clientAssets.merge(serverAssets);
    return new Response(
      await renderToReadableStream(
        <html lang="en">
          <head>
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            {assets.css.map((attr: any) => (
              <link key={attr.href} rel="stylesheet" {...attr} />
            ))}
            {assets.js.map((attr: any) => (
              <link key={attr.href} type="modulepreload" {...attr} />
            ))}
            <script type="module" src={assets.entry} />
          </head>
          <body id="app">
            <App />
          </body>
        </html>
      ),
      { headers: { "Content-Type": "text/html;charset=utf-8" } }
    );
  },
};
```

```css [src/styles.css]
.hero {
  color: orange;
}

button {
  background-color: lightskyblue;
}
```
::

ä½¿ç”¨ Reactã€Vite å’Œ Nitro è®¾ç½®æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰ã€‚æ­¤é…ç½®æ”¯æŒæµå¼ HTML å“åº”ã€è‡ªåŠ¨èµ„æºç®¡ç†ä»¥åŠå®¢æˆ·ç«¯æ°´åˆã€‚

## æ¦‚è§ˆ

::steps{level="4"}
#### åœ¨ Vite é…ç½®ä¸­æ·»åŠ  Nitro Vite æ’ä»¶

#### é…ç½®å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å…¥å£æ–‡ä»¶

#### åˆ›å»ºæœåŠ¡ç«¯å…¥å£æ–‡ä»¶ï¼Œå°†åº”ç”¨æ¸²æŸ“ä¸º HTML

#### åˆ›å»ºå®¢æˆ·ç«¯å…¥å£æ–‡ä»¶ï¼Œå¯¹æœåŠ¡ç«¯æ¸²æŸ“çš„ HTML è¿›è¡Œæ°´åˆ
::

## 1. é…ç½® Vite

åœ¨ Vite é…ç½®ä¸­æ·»åŠ  Nitro å’Œ React æ’ä»¶ï¼Œå®šä¹‰å…·æœ‰å®¢æˆ·ç«¯å…¥å£çš„ `client` ç¯å¢ƒï¼š

```js [vite.config.mjs]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";
import react from "@vitejs/plugin-react";

export default defineConfig({
  plugins: [nitro(), react()],
  environments: {
    client: {
      build: { rollupOptions: { input: "./src/entry-client.tsx" } },
    },
  },
});
```

`environments.client` é…ç½®å‘ŠçŸ¥ Vite ä½¿ç”¨å“ªä¸ªæ–‡ä»¶ä½œä¸ºæµè§ˆå™¨å…¥å£ã€‚Nitro ä¼šæ ¹æ®å¸¸è§ç›®å½•ä¸­åä¸º `entry-server` æˆ– `server` çš„æ–‡ä»¶è‡ªåŠ¨æ£€æµ‹æœåŠ¡ç«¯å…¥å£ã€‚

## 2. åˆ›å»ºåº”ç”¨ç»„ä»¶

åˆ›å»ºä¸€ä¸ªå¯åœ¨æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å…±äº«è¿è¡Œçš„ React ç»„ä»¶ï¼š

```tsx [src/app.tsx]
import { useState } from "react";

export function App() {
  const [count, setCount] = useState(0);
  return (
    <>
      <h1 className="hero">Nitro + Vite + React</h1>
      <button onClick={() => setCount((c) => c + 1)}>Count is {count}</button>
    </>
  );
}
```

## 3. åˆ›å»ºæœåŠ¡ç«¯å…¥å£

æœåŠ¡ç«¯å…¥å£å°† React åº”ç”¨æ¸²æŸ“æˆæµå¼ HTML å“åº”ï¼Œä½¿ç”¨é€‚é…è¾¹ç¼˜ç¯å¢ƒçš„ `react-dom/server.edge`ï¼š

```tsx [src/entry-server.tsx]
import "./styles.css";
import { renderToReadableStream } from "react-dom/server.edge";
import { App } from "./app.tsx";

import clientAssets from "./entry-client?assets=client";
import serverAssets from "./entry-server?assets=ssr";

export default {
  async fetch(_req: Request) {
    const assets = clientAssets.merge(serverAssets);
    return new Response(
      await renderToReadableStream(
        <html lang="en">
          <head>
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            {assets.css.map((attr: any) => (
              <link key={attr.href} rel="stylesheet" {...attr} />
            ))}
            {assets.js.map((attr: any) => (
              <link key={attr.href} type="modulepreload" {...attr} />
            ))}
            <script type="module" src={assets.entry} />
          </head>
          <body id="app">
            <App />
          </body>
        </html>
      ),
      { headers: { "Content-Type": "text/html;charset=utf-8" } }
    );
  },
};
```

ä½¿ç”¨ `?assets=client` å’Œ `?assets=ssr` æŸ¥è¯¢å‚æ•°å¯¼å…¥èµ„æºã€‚Nitro ä¼šæ”¶é›†æ¯ä¸ªå…¥å£ç‚¹çš„ CSS å’Œ JS èµ„æºï¼Œ`merge()` å°†å®ƒä»¬åˆå¹¶æˆä¸€ä¸ªæ¸…å•ã€‚`assets` å¯¹è±¡æä¾›æ ·å¼è¡¨å’Œè„šæœ¬çš„å±æ€§æ•°ç»„ï¼Œä»¥åŠå®¢æˆ·ç«¯å…¥å£ URLã€‚ä½¿ç”¨ `renderToReadableStream` ä»¥æµå¼æ–¹å¼è¾“å‡º HTMLï¼Œé…åˆ React æ¸²æŸ“ï¼Œæå‡é¦–å­—èŠ‚æ—¶é—´ã€‚

## 4. åˆ›å»ºå®¢æˆ·ç«¯å…¥å£

å®¢æˆ·ç«¯å…¥å£å¯¹æœåŠ¡ç«¯æ¸²æŸ“çš„ HTML è¿›è¡Œæ°´åˆï¼Œç»‘å®š React äº‹ä»¶å¤„ç†å™¨ï¼š

```tsx [src/entry-client.tsx]
import "@vitejs/plugin-react/preamble";
import { hydrateRoot } from "react-dom/client";
import { App } from "./app.tsx";

hydrateRoot(document.querySelector("#app")!, <App />);
```

`@vitejs/plugin-react/preamble` å¯¼å…¥ç”¨äºå¼€å‘æ—¶çš„ React å¿«é€Ÿåˆ·æ–°ï¼ˆFast Refreshï¼‰ã€‚`hydrateRoot` å‡½æ•°å°† React é™„åŠ åˆ°å·²å­˜åœ¨çš„æœåŠ¡ç«¯æ¸²æŸ“ DOMï¼Œè€Œéé‡æ–°æ¸²æŸ“ã€‚

## äº†è§£æ›´å¤š

- [Renderer](https://nitro.zhcndoc.com/docs/renderer)
- [Server Entry](https://nitro.zhcndoc.com/docs/server-entry)


# ä½¿ç”¨ SolidJS è¿›è¡Œ SSR

::code-tree{expand-all default-value="src/entry-server.tsx" expand-all=""}
```json [package.json]
{
  "type": "module",
  "scripts": {
    "build": "vite build",
    "dev": "vite dev"
  },
  "devDependencies": {
    "nitro": "latest",
    "solid-js": "^1.9.11",
    "vite": "beta",
    "vite-plugin-solid": "^2.11.10"
  }
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig",
  "compilerOptions": {
    "jsx": "preserve",
    "jsxImportSource": "solid-js"
  }
}
```

```js [vite.config.mjs]
import solid from "vite-plugin-solid";
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({
  plugins: [solid({ ssr: true }), nitro()],
  esbuild: { jsx: "preserve", jsxImportSource: "solid-js" },
  environments: {
    ssr: {
      build: { rollupOptions: { input: "./src/entry-server.tsx" } },
    },
    client: {
      build: { rollupOptions: { input: "./src/entry-client.tsx" } },
    },
  },
});
```

```tsx [src/app.tsx]
import { createSignal } from "solid-js";

export function App() {
  const [count, setCount] = createSignal(0);

  return (
    <div>
      <h1>Hello, Solid!</h1>
      <button onClick={() => setCount((count) => count + 1)}>Count: {count()}</button>
    </div>
  );
}
```

```tsx [src/entry-client.tsx]
import { hydrate } from "solid-js/web";
import "./styles.css";
import { App } from "./app.jsx";

hydrate(() => <App />, document.querySelector("#app")!);
```

```tsx [src/entry-server.tsx]
import { renderToStringAsync, HydrationScript } from "solid-js/web";
import { App } from "./app.jsx";

import clientAssets from "./entry-client?assets=client";
import serverAssets from "./entry-server?assets=ssr";

export default {
  async fetch(req: Request): Promise<Response> {
    const appHTML = await renderToStringAsync(() => <App />);
    const rootHTML = await renderToStringAsync(() => <Root appHTML={appHTML} />);
    return new Response(rootHTML, {
      headers: { "Content-Type": "text/html" },
    });
  },
};

function Root(props: { appHTML?: string }) {
  const assets = clientAssets.merge(serverAssets);
  return (
    <html lang="en">
      <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        {assets.css.map((attr: any) => (
          <link key={attr.href} rel="stylesheet" {...attr} />
        ))}
        {assets.js.map((attr: any) => (
          <link key={attr.href} type="modulepreload" {...attr} />
        ))}
      </head>
      <body>
        <div id="app" innerHTML={props.appHTML || ""} />
        <HydrationScript />
        <script type="module" src={assets.entry} />
      </body>
    </html>
  );
}
```

```css [src/styles.css]
div {
  font-family: system-ui, Arial, sans-serif;
  font-size: 20px;
  margin-bottom: 10px;
}

button {
  background-color: rgb(147 197 253);
  color: rgb(15 23 42);
  border: none;
  padding: 10px 20px;
  font-size: 16px;
  cursor: pointer;
  border-radius: 5px;
}

button:hover {
  background-color: rgb(191 219 254);
}
```
::

ä½¿ç”¨ SolidJSã€Vite å’Œ Nitro è®¾ç½®æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰ã€‚è¯¥è®¾ç½®ä½¿ç”¨ `renderToStringAsync` è¿›è¡Œ HTML ç”Ÿæˆï¼Œå¹¶æ”¯æŒå®¢æˆ·ç«¯æ°´åˆã€‚

## æ¦‚è¿°

::steps{level="4"}
#### åœ¨ Vite é…ç½®ä¸­æ·»åŠ  Nitro æ’ä»¶

#### é…ç½®å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å…¥å£

#### åˆ›å»ºæœåŠ¡ç«¯å…¥å£ï¼Œå°†åº”ç”¨æ¸²æŸ“æˆ HTML

#### åˆ›å»ºå®¢æˆ·ç«¯å…¥å£ï¼Œå¯¹æœåŠ¡ç«¯æ¸²æŸ“çš„ HTML è¿›è¡Œæ°´åˆ
::

## 1. é…ç½® Vite

åœ¨ Vite é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  Nitro å’Œ SolidJS æ’ä»¶ã€‚SolidJS éœ€è¦æ˜¾å¼é…ç½® JSX ä»¥åŠåŒæ—¶é…ç½® `ssr` å’Œ `client` ç¯å¢ƒï¼š

```js [vite.config.mjs]
import solid from "vite-plugin-solid";
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({
  plugins: [solid({ ssr: true }), nitro()],
  esbuild: { jsx: "preserve", jsxImportSource: "solid-js" },
  environments: {
    ssr: {
      build: { rollupOptions: { input: "./src/entry-server.tsx" } },
    },
    client: {
      build: { rollupOptions: { input: "./src/entry-client.tsx" } },
    },
  },
});
```

é€šè¿‡ `solid({ ssr: true })` å¯ç”¨ Solid æ’ä»¶çš„ SSR æ¨¡å¼ã€‚é…ç½® esbuild ä¿ç•™ JSX ä»¥ä¾¿ Solid ç¼–è¯‘å™¨å¤„ç†ï¼Œå¹¶ä½¿ç”¨ Solid çš„ JSX è¿è¡Œæ—¶ã€‚SolidJS éœ€è¦åœ¨ Vite ä¸­æ˜¾å¼é…ç½® `ssr` å’Œ `client` ç¯å¢ƒã€‚

## 2. åˆ›å»º App ç»„ä»¶

ä½¿ç”¨å“åº”å¼ä¿¡å·åˆ›å»ºä¸€ä¸ªå…±äº«çš„ SolidJS ç»„ä»¶ï¼š

```tsx [src/app.tsx]
import { createSignal } from "solid-js";

export function App() {
  const [count, setCount] = createSignal(0);

  return (
    <div>
      <h1>Hello, Solid!</h1>
      <button onClick={() => setCount((count) => count + 1)}>Count: {count()}</button>
    </div>
  );
}
```

SolidJS ä½¿ç”¨ä¿¡å·ï¼ˆ`createSignal`ï¼‰æ¥ç®¡ç†çŠ¶æ€ã€‚ä¸ React çš„ `useState` ä¸åŒï¼Œä¿¡å·æ˜¯è°ƒç”¨å³å¯è¯»å–å€¼çš„ getter å‡½æ•°ã€‚

## 3. åˆ›å»ºæœåŠ¡ç«¯å…¥å£

æœåŠ¡ç«¯å…¥å£ä½¿ç”¨ `renderToStringAsync` å°† SolidJS åº”ç”¨æ¸²æŸ“æˆ HTMLï¼Œå¹¶åŒ…å«ç”¨äºå®¢æˆ·ç«¯æ°´åˆçš„ `HydrationScript`ï¼š

```tsx [src/entry-server.tsx]
import { renderToStringAsync, HydrationScript } from "solid-js/web";
import { App } from "./app.jsx";

import clientAssets from "./entry-client?assets=client";
import serverAssets from "./entry-server?assets=ssr";

export default {
  async fetch(req: Request): Promise<Response> {
    const appHTML = await renderToStringAsync(() => <App />);
    const rootHTML = await renderToStringAsync(() => <Root appHTML={appHTML} />);
    return new Response(rootHTML, {
      headers: { "Content-Type": "text/html" },
    });
  },
};

function Root(props: { appHTML?: string }) {
  const assets = clientAssets.merge(serverAssets);
  return (
    <html lang="en">
      <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        {assets.css.map((attr: any) => (
          <link key={attr.href} rel="stylesheet" {...attr} />
        ))}
        {assets.js.map((attr: any) => (
          <link key={attr.href} type="modulepreload" {...attr} />
        ))}
      </head>
      <body>
        <div id="app" innerHTML={props.appHTML || ""} />
        <HydrationScript />
        <script type="module" src={assets.entry} />
      </body>
    </html>
  );
}
```

SolidJS éœ€è¦å°†åº”ç”¨å’Œæ¡†æ¶åˆ†å¼€æ¸²æŸ“ï¼ˆä¸¤é˜¶æ®µæ¸²æŸ“ï¼‰ã€‚é€šè¿‡ `innerHTML` æ³¨å…¥åº”ç”¨ HTML ä»¥ä¿ç•™æ°´åˆæ ‡è®°ã€‚åŒ…å« `HydrationScript` ç»„ä»¶ä»¥æ³¨å…¥ Solid å®¢æˆ·ç«¯æ°´åˆæ‰€éœ€çš„è„šæœ¬ã€‚é€šè¿‡ `?assets=client` å’Œ `?assets=ssr` æŸ¥è¯¢å‚æ•°å¯¼å…¥èµ„æºï¼Œæ”¶é›†æ¯ä¸ªå…¥å£ç‚¹çš„ CSS å’Œ JSã€‚

## 4. åˆ›å»ºå®¢æˆ·ç«¯å…¥å£

å®¢æˆ·ç«¯å…¥å£å¯¹æœåŠ¡ç«¯æ¸²æŸ“çš„ HTML è¿›è¡Œæ°´åˆï¼Œæ¢å¤ Solid çš„å“åº”å¼ï¼š

```tsx [src/entry-client.tsx]
import { hydrate } from "solid-js/web";
import "./styles.css";
import { App } from "./app.jsx";

hydrate(() => <App />, document.querySelector("#app")!);
```

`hydrate` å‡½æ•°å°† Solid çš„å“åº”ç³»ç»Ÿé™„åŠ åˆ°å·²å­˜åœ¨çš„ `#app` æœåŠ¡ç«¯æ¸²æŸ“ DOM ä¸Šã€‚ç»„ä»¶éœ€ç”¨å‡½æ•° `() => <App />` åŒ…è£¹ï¼Œè¿™æ˜¯ Solid çš„ API è¦æ±‚ã€‚

## äº†è§£æ›´å¤š

- [SolidJS æ–‡æ¡£](https://docs.solidjs.com/){rel="&#x22;nofollow&#x22;"}
- [æ¸²æŸ“å™¨](https://nitro.zhcndoc.com/docs/renderer)
- [æœåŠ¡ç«¯å…¥å£](https://nitro.zhcndoc.com/docs/server-entry)


# ä½¿ç”¨ TanStack Router å®ç° SSR

::code-tree{expand-all default-value="src/main.tsx" expand-all=""}
```html [index.html]
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nitro + TanStack Router + React</title>
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "build": "vite build",
    "dev": "vite dev",
    "preview": "vite preview"
  },
  "devDependencies": {
    "@tanstack/react-router": "^1.158.1",
    "@tanstack/react-router-devtools": "^1.158.1",
    "@tanstack/router-plugin": "^1.158.1",
    "@types/react": "^19.2.13",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.3",
    "nitro": "latest",
    "react": "^19.2.4",
    "react-dom": "^19.2.4",
    "vite": "beta"
  }
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig",
  "compilerOptions": {
    "baseUrl": ".",
    "jsx": "react-jsx",
    "paths": {
      "@/*": ["sec/*"]
    }
  }
}
```

```js [vite.config.mjs]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";
import react from "@vitejs/plugin-react";
import { tanstackRouter } from "@tanstack/router-plugin/vite";

export default defineConfig({
  plugins: [tanstackRouter({ target: "react", autoCodeSplitting: true }), react(), nitro()],
});
```

```tsx [src/main.tsx]
import { StrictMode } from "react";
import ReactDOM from "react-dom/client";
import { RouterProvider, createRouter } from "@tanstack/react-router";

// Import the generated route tree
import { routeTree } from "./routeTree.gen.ts";

// Create a new router instance
const router = createRouter({ routeTree });

// Register the router instance for type safety
declare module "@tanstack/react-router" {
  interface Register {
    router: typeof router;
  }
}

// Render the app
const rootElement = document.querySelector("#root")!;
if (!rootElement.innerHTML) {
  const root = ReactDOM.createRoot(rootElement);
  root.render(
    <StrictMode>
      <RouterProvider router={router} />
    </StrictMode>
  );
}
```

```ts [src/routeTree.gen.ts]
/* eslint-disable */

// @ts-nocheck

// noinspection JSUnusedGlobalSymbols

// This file was automatically generated by TanStack Router.
// You should NOT make any changes in this file as it will be overwritten.
// Additionally, you should also exclude this file from your linter and/or formatter to prevent it from being checked or modified.

import { Route as rootRouteImport } from './routes/__root'
import { Route as IndexRouteImport } from './routes/index'

const IndexRoute = IndexRouteImport.update({
  id: '/',
  path: '/',
  getParentRoute: () => rootRouteImport,
} as any)

export interface FileRoutesByFullPath {
  '/': typeof IndexRoute
}
export interface FileRoutesByTo {
  '/': typeof IndexRoute
}
export interface FileRoutesById {
  __root__: typeof rootRouteImport
  '/': typeof IndexRoute
}
export interface FileRouteTypes {
  fileRoutesByFullPath: FileRoutesByFullPath
  fullPaths: '/'
  fileRoutesByTo: FileRoutesByTo
  to: '/'
  id: '__root__' | '/'
  fileRoutesById: FileRoutesById
}
export interface RootRouteChildren {
  IndexRoute: typeof IndexRoute
}

declare module '@tanstack/react-router' {
  interface FileRoutesByPath {
    '/': {
      id: '/'
      path: '/'
      fullPath: '/'
      preLoaderRoute: typeof IndexRouteImport
      parentRoute: typeof rootRouteImport
    }
  }
}

const rootRouteChildren: RootRouteChildren = {
  IndexRoute: IndexRoute,
}
export const routeTree = rootRouteImport
  ._addFileChildren(rootRouteChildren)
  ._addFileTypes<FileRouteTypes>()
```

```css [src/assets/main.css]
:root {
  font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;

  color-scheme: light dark;
  color: rgba(255, 255, 255, 0.87);
  background-color: #242424;

  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

a {
  font-weight: 500;
  color: #ff2056;
  text-decoration: inherit;
}
a:hover {
  color: #ff637e;
}

body {
  margin: 0;
  display: flex;
  flex-direction: column;
  place-items: center;
  justify-content: center;
  min-width: 320px;
  min-height: 100vh;
}

h1 {
  font-size: 3.2em;
  line-height: 1.1;
}

#app {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
  transition: transform 300ms;
}
.logo:hover {
  transform: scale(1.1);
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}

button {
  border-radius: 8px;
  border: 1px solid transparent;
  padding: 0.6em 1.2em;
  font-size: 1em;
  font-weight: 500;
  font-family: inherit;
  background-color: #1a1a1a;
  cursor: pointer;
  transition: border-color 0.25s;
}
button:hover {
  border-color: #646cff;
}
button:focus,
button:focus-visible {
  outline: 4px auto -webkit-focus-ring-color;
}

@media (prefers-color-scheme: light) {
  :root {
    color: #213547;
    background-color: #ffffff;
  }
  a:hover {
    color: #747bff;
  }
  button {
    background-color: #f9f9f9;
  }
}
```

```tsx [src/routes/__root.tsx]
import { createRootRoute, Link, Outlet } from "@tanstack/react-router";
import { TanStackRouterDevtools } from "@tanstack/react-router-devtools";

const RootLayout = () => (
  <>
    <div className="p-2 flex gap-2">
      <Link to="/" className="[&.active]:font-bold">
        Home
      </Link>
    </div>
    <hr />
    <Outlet />
    <TanStackRouterDevtools />
  </>
);

export const Route = createRootRoute({ component: RootLayout });
```

```tsx [src/routes/index.tsx]
import { createFileRoute } from "@tanstack/react-router";

export const Route = createFileRoute("/")({
  loader: async () => {
    const r = await fetch("/api/hello");
    return r.json();
  },
  component: Index,
});

function Index() {
  const r = Route.useLoaderData();

  return (
    <div className="p-2">
      <h3>{JSON.stringify(r)}</h3>
    </div>
  );
}
```
::

è®¾ç½® TanStack Router ä¸ Reactã€Vite å’Œ Nitroã€‚è¯¥è®¾ç½®æä¾›åŸºäºæ–‡ä»¶çš„è·¯ç”±ï¼Œå…·æœ‰ç±»å‹å®‰å…¨çš„å¯¼èˆªå’Œè‡ªåŠ¨ä»£ç æ‹†åˆ†ã€‚

## æ¦‚è§ˆ

::steps{level="4"}
#### åœ¨ Vite é…ç½®ä¸­æ·»åŠ  Nitro Vite æ’ä»¶

#### åˆ›å»ºåŒ…å«åº”ç”¨å…¥å£çš„ HTML æ¨¡æ¿

#### åˆ›å»ºåˆå§‹åŒ–è·¯ç”±çš„ä¸»å…¥å£æ–‡ä»¶

#### ä½¿ç”¨åŸºäºæ–‡ä»¶çš„è·¯ç”±å®šä¹‰è·¯ç”±
::

## 1. é…ç½® Vite

åœ¨ Vite é…ç½®ä¸­æ·»åŠ  Nitroã€React å’Œ TanStack Router æ’ä»¶ï¼š

```js [vite.config.mjs]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";
import react from "@vitejs/plugin-react";
import { tanstackRouter } from "@tanstack/router-plugin/vite";

export default defineConfig({
  plugins: [tanstackRouter({ target: "react", autoCodeSplitting: true }), react(), nitro()],
});
```

`tanstackRouter` æ’ä»¶æ ¹æ®ä½ çš„ `routes/` ç›®å½•ç»“æ„ç”Ÿæˆè·¯ç”±æ ‘ã€‚å¯ç”¨ `autoCodeSplitting` ä»¥è‡ªåŠ¨å°†è·¯ç”±æ‹†åˆ†æˆç‹¬ç«‹ä»£ç å—ã€‚è¯·å°† TanStack Router æ’ä»¶æ”¾åœ¨ React æ’ä»¶ä¹‹å‰ã€‚

## 2. åˆ›å»º HTML æ¨¡æ¿

åˆ›å»ºä¸€ä¸ªä½œä¸ºåº”ç”¨å¤–å£³çš„ HTML æ–‡ä»¶ï¼š

```html [index.html]
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nitro + TanStack Router + React</title>
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

## 3. åˆ›å»ºåº”ç”¨å…¥å£

åˆ›å»ºåˆå§‹åŒ– TanStack Router çš„ä¸»å…¥å£æ–‡ä»¶ï¼š

```tsx [src/main.tsx]
import { StrictMode } from "react";
import ReactDOM from "react-dom/client";
import { RouterProvider, createRouter } from "@tanstack/react-router";

// å¯¼å…¥è‡ªåŠ¨ç”Ÿæˆçš„è·¯ç”±æ ‘
import { routeTree } from "./routeTree.gen.ts";

// åˆ›å»ºæ–°çš„è·¯ç”±å®ä¾‹
const router = createRouter({ routeTree });

// æ³¨å†Œè·¯ç”±å®ä¾‹ä»¥æ”¯æŒç±»å‹å®‰å…¨
declare module "@tanstack/react-router" {
  interface Register {
    router: typeof router;
  }
}

// æ¸²æŸ“åº”ç”¨
const rootElement = document.querySelector("#root")!;
if (!rootElement.innerHTML) {
  const root = ReactDOM.createRoot(rootElement);
  root.render(
    <StrictMode>
      <RouterProvider router={router} />
    </StrictMode>
  );
}
```

`routeTree.gen.ts` æ–‡ä»¶æ ¹æ® `routes/` ç›®å½•ç»“æ„è‡ªåŠ¨ç”Ÿæˆã€‚`Register` æ¥å£å£°æ˜æä¾›äº†å…³äºè·¯ç”±è·¯å¾„å’Œå‚æ•°çš„å®Œæ•´ç±»å‹æ¨æ–­ã€‚`!rootElement.innerHTML` æ£€æŸ¥é˜²æ­¢çƒ­æ¨¡å—æ›¿æ¢æ—¶çš„é‡å¤æ¸²æŸ“ã€‚

## 4. åˆ›å»ºæ ¹è·¯ç”±

æ ¹è·¯ç”±ï¼ˆ`__root.tsx`ï¼‰å®šä¹‰åº”ç”¨çš„å¸ƒå±€ï¼š

```tsx [src/routes/__root.tsx]
import { createRootRoute, Link, Outlet } from "@tanstack/react-router";
import { TanStackRouterDevtools } from "@tanstack/react-router-devtools";

const RootLayout = () => (
  <>
    <div className="p-2 flex gap-2">
      <Link to="/" className="[&.active]:font-bold">
        é¦–é¡µ
      </Link>
    </div>
    <hr />
    <Outlet />
    <TanStackRouterDevtools />
  </>
);

export const Route = createRootRoute({ component: RootLayout });
```

ä½¿ç”¨ `Link` å®ç°ç±»å‹å®‰å…¨çš„å¯¼èˆªï¼Œå¹¶å¸¦æœ‰æ¿€æ´»çŠ¶æ€æ ·å¼ã€‚`Outlet` ç»„ä»¶æ¸²æŸ“å­è·¯ç”±ã€‚åŒ…å« `TanStackRouterDevtools` ç”¨äºå¼€å‘è°ƒè¯•ï¼ˆç”Ÿäº§ç¯å¢ƒä¼šè‡ªåŠ¨ç§»é™¤ï¼‰ã€‚

## 5. åˆ›å»ºé¡µé¢è·¯ç”±

é¡µé¢è·¯ç”±ä½¿ç”¨ `createFileRoute`ï¼Œå¯ä»¥åŒ…å«åŠ è½½å™¨ï¼š

```tsx [src/routes/index.tsx]
import { createFileRoute } from "@tanstack/react-router";

export const Route = createFileRoute("/")({
  loader: async () => {
    const r = await fetch("/api/hello");
    return r.json();
  },
  component: Index,
});

function Index() {
  const r = Route.useLoaderData();

  return (
    <div className="p-2">
      <h3>{JSON.stringify(r)}</h3>
    </div>
  );
}
```

ä½¿ç”¨ `loader` å‡½æ•°åœ¨æ¸²æŸ“å‰è·å–æ•°æ®â€”â€”æ•°æ®é€šè¿‡ `Route.useLoaderData()` å¯ç”¨ã€‚æ–‡ä»¶è·¯å¾„å¯¹åº” URL è·¯å¾„ï¼š`routes/index.tsx` æ˜ å°„ä¸º `/`ï¼Œ`routes/about.tsx` æ˜ å°„ä¸º `/about`ï¼Œ`routes/users/$id.tsx` æ˜ å°„ä¸º `/users/:id`ã€‚

## æ›´å¤šå­¦ä¹ èµ„æº

- [TanStack Router æ–‡æ¡£](https://tanstack.com/router){rel="&#x22;nofollow&#x22;"}
- [Renderer](https://nitro.zhcndoc.com/docs/renderer)


# ä½¿ç”¨ TanStack Start è¿›è¡Œ SSR

::code-tree{expand-all default-value="server.ts" expand-all=""}
```text [.gitignore]
node_modules
package-lock.json
yarn.lock

.DS_Store
.cache
.env
.vercel
.output
.nitro
/build/
/api/
/server/build
/public/build# Sentry Config File
.env.sentry-build-plugin
/test-results/
/playwright-report/
/blob-report/
/playwright/.cache/
.tanstack
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "build": "vite build",
    "dev": "vite dev",
    "start": "node .output/server/index.mjs"
  },
  "dependencies": {
    "@tanstack/react-router": "^1.158.1",
    "@tanstack/react-router-devtools": "^1.158.1",
    "@tanstack/react-start": "^1.158.3",
    "nitro": "latest",
    "react": "^19.2.4",
    "react-dom": "^19.2.4",
    "tailwind-merge": "^3.4.0",
    "zod": "^4.3.6"
  },
  "devDependencies": {
    "@tailwindcss/vite": "^4.1.18",
    "@types/node": "latest",
    "@types/react": "^19.2.13",
    "@types/react-dom": "^19.2.3",
    "@vitejs/plugin-react": "^5.1.3",
    "tailwindcss": "^4.1.18",
    "typescript": "^5.9.3",
    "vite": "beta",
    "vite-tsconfig-paths": "^6.0.5"
  }
}
```

```ts [server.ts]
import handler, { createServerEntry } from "@tanstack/react-start/server-entry";

export default createServerEntry({
  fetch(request) {
    return handler.fetch(request);
  },
});
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig",
  "compilerOptions": {
    "baseUrl": ".",
    "jsx": "react-jsx",
    "paths": {
      "~/*": ["./src/*"]
    }
  }
}
```

```js [vite.config.mjs]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";
import { tanstackStart } from "@tanstack/react-start/plugin/vite";
import viteReact from "@vitejs/plugin-react";
import viteTsConfigPaths from "vite-tsconfig-paths";
import tailwindcss from "@tailwindcss/vite";

export default defineConfig({
  plugins: [
    viteTsConfigPaths({ projects: ["./tsconfig.json"] }),
    tanstackStart(),
    viteReact(),
    tailwindcss(),
    nitro(),
  ],
  environments: {
    ssr: { build: { rollupOptions: { input: "./server.ts" } } },
  },
});
```

```tsx [src/router.tsx]
import { createRouter } from "@tanstack/react-router";
import { routeTree } from "./routeTree.gen.ts";

export function getRouter() {
  const router = createRouter({
    routeTree,
    defaultPreload: "intent",
    defaultErrorComponent: () => <div>Internal Server Error</div>,
    defaultNotFoundComponent: () => <div>Not Found</div>,
    scrollRestoration: true,
  });
  return router;
}
```

```ts [src/routeTree.gen.ts]
/* eslint-disable */

// @ts-nocheck

// noinspection JSUnusedGlobalSymbols

// This file was automatically generated by TanStack Router.
// You should NOT make any changes in this file as it will be overwritten.
// Additionally, you should also exclude this file from your linter and/or formatter to prevent it from being checked or modified.

import { Route as rootRouteImport } from './routes/__root'
import { Route as IndexRouteImport } from './routes/index'
import { Route as ApiTestRouteImport } from './routes/api/test'

const IndexRoute = IndexRouteImport.update({
  id: '/',
  path: '/',
  getParentRoute: () => rootRouteImport,
} as any)
const ApiTestRoute = ApiTestRouteImport.update({
  id: '/api/test',
  path: '/api/test',
  getParentRoute: () => rootRouteImport,
} as any)

export interface FileRoutesByFullPath {
  '/': typeof IndexRoute
  '/api/test': typeof ApiTestRoute
}
export interface FileRoutesByTo {
  '/': typeof IndexRoute
  '/api/test': typeof ApiTestRoute
}
export interface FileRoutesById {
  __root__: typeof rootRouteImport
  '/': typeof IndexRoute
  '/api/test': typeof ApiTestRoute
}
export interface FileRouteTypes {
  fileRoutesByFullPath: FileRoutesByFullPath
  fullPaths: '/' | '/api/test'
  fileRoutesByTo: FileRoutesByTo
  to: '/' | '/api/test'
  id: '__root__' | '/' | '/api/test'
  fileRoutesById: FileRoutesById
}
export interface RootRouteChildren {
  IndexRoute: typeof IndexRoute
  ApiTestRoute: typeof ApiTestRoute
}

declare module '@tanstack/react-router' {
  interface FileRoutesByPath {
    '/': {
      id: '/'
      path: '/'
      fullPath: '/'
      preLoaderRoute: typeof IndexRouteImport
      parentRoute: typeof rootRouteImport
    }
    '/api/test': {
      id: '/api/test'
      path: '/api/test'
      fullPath: '/api/test'
      preLoaderRoute: typeof ApiTestRouteImport
      parentRoute: typeof rootRouteImport
    }
  }
}

const rootRouteChildren: RootRouteChildren = {
  IndexRoute: IndexRoute,
  ApiTestRoute: ApiTestRoute,
}
export const routeTree = rootRouteImport
  ._addFileChildren(rootRouteChildren)
  ._addFileTypes<FileRouteTypes>()

import type { getRouter } from './router.tsx'
import type { createStart } from '@tanstack/react-start'
declare module '@tanstack/react-start' {
  interface Register {
    ssr: true
    router: Awaited<ReturnType<typeof getRouter>>
  }
}
```

```tsx [src/routes/__root.tsx]
/// <reference types="vite/client" />
import { HeadContent, Link, Scripts, createRootRoute } from "@tanstack/react-router";
import { TanStackRouterDevtools } from "@tanstack/react-router-devtools";
import * as React from "react";
import appCss from "~/styles/app.css?url";

export const Route = createRootRoute({
  head: () => ({
    meta: [
      { charSet: "utf8" },
      { name: "viewport", content: "width=device-width, initial-scale=1" },
    ],
    links: [{ rel: "stylesheet", href: appCss }],
    scripts: [{ src: "/customScript.js", type: "text/javascript" }],
  }),
  errorComponent: () => <h1>500: Internal Server Error</h1>,
  notFoundComponent: () => <h1>404: Page Not Found</h1>,
  shellComponent: RootDocument,
});

function RootDocument({ children }: { children: React.ReactNode }) {
  return (
    <html>
      <head>
        <HeadContent />
      </head>
      <body>
        <div className="p-2 flex gap-2 text-lg">
          <Link to="/" activeProps={{ className: "font-bold" }} activeOptions={{ exact: true }}>
            Home
          </Link>{" "}
          <Link
            // @ts-ignore
            to="/this-route-does-not-exist"
            activeProps={{ className: "font-bold" }}
          >
            404
          </Link>
        </div>
        <hr />
        {children}
        <TanStackRouterDevtools position="bottom-right" />
        <Scripts />
      </body>
    </html>
  );
}
```

```tsx [src/routes/index.tsx]
import { createFileRoute } from "@tanstack/react-router";

export const Route = createFileRoute("/")({ component: Home });

function Home() {
  return (
    <div className="p-2">
      <h3>Welcome Home!</h3>
      <a href="/api/test">/api/test</a>
    </div>
  );
}
```

```css [src/styles/app.css]
@import "tailwindcss";

@layer base {
  *,
  ::after,
  ::before,
  ::backdrop,
  ::file-selector-button {
    border-color: var(--color-gray-200, currentcolor);
  }
}

@layer base {
  html {
    color-scheme: light dark;
  }

  * {
    @apply border-gray-200 dark:border-gray-800;
  }

  html,
  body {
    @apply text-gray-900 bg-gray-50 dark:bg-gray-950 dark:text-gray-200;
  }

  .using-mouse * {
    outline: none !important;
  }
}
```
::

é€šè¿‡ TanStack Start é…åˆ Nitro æ­å»ºä¸€ä¸ªå…¨æ ˆ React æ¡†æ¶ä½“éªŒï¼Œæ”¯æŒæœåŠ¡ç«¯æ¸²æŸ“ã€åŸºäºæ–‡ä»¶çš„è·¯ç”±ä»¥åŠé›†æˆçš„ API è·¯ç”±ã€‚

## æ¦‚è§ˆ

::steps{level="4"}
#### åœ¨ Vite é…ç½®ä¸­æ·»åŠ  Nitro æ’ä»¶

#### ä½¿ç”¨ TanStack Start çš„æœåŠ¡ handler åˆ›å»ºæœåŠ¡å™¨å…¥å£

#### é…ç½®é»˜è®¤ç»„ä»¶çš„è·¯ç”±å™¨

#### ä½¿ç”¨åŸºäºæ–‡ä»¶çš„è·¯ç”±å®šä¹‰é¡µé¢å’Œ API è·¯ç”±
::

## 1. é…ç½® Vite

åœ¨ä½ çš„ Vite é…ç½®ä¸­æ·»åŠ  Nitroã€Reactã€TanStack Start å’Œ Tailwind æ’ä»¶ï¼š

```js [vite.config.mjs]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";
import { tanstackStart } from "@tanstack/react-start/plugin/vite";
import viteReact from "@vitejs/plugin-react";
import viteTsConfigPaths from "vite-tsconfig-paths";
import tailwindcss from "@tailwindcss/vite";

export default defineConfig({
  plugins: [
    viteTsConfigPaths({ projects: ["./tsconfig.json"] }),
    tanstackStart(),
    viteReact(),
    tailwindcss(),
    nitro(),
  ],
  environments: {
    ssr: { build: { rollupOptions: { input: "./server.ts" } } },
  },
});
```

`tanstackStart()` æ’ä»¶æä¾›å®Œæ•´çš„ SSR é›†æˆå’Œè‡ªåŠ¨çš„å®¢æˆ·ç«¯å…¥å£å¤„ç†ã€‚ä½¿ç”¨ `viteTsConfigPaths()` å¯ä»¥å¯ç”¨ tsconfig ä¸­çš„è·¯å¾„åˆ«åå¦‚ `~/`ã€‚`environments.ssr` æŒ‡å®šäº†æœåŠ¡å™¨å…¥å£æ–‡ä»¶ã€‚

## 2. åˆ›å»ºæœåŠ¡å™¨å…¥å£

åˆ›å»ºä¸€ä¸ªä½¿ç”¨ TanStack Start handler çš„æœåŠ¡å™¨å…¥å£ï¼š

```ts [server.ts]
import handler, { createServerEntry } from "@tanstack/react-start/server-entry";

export default createServerEntry({
  fetch(request) {
    return handler.fetch(request);
  },
});
```

TanStack Start ä¼šè‡ªåŠ¨å¤„ç† SSRã€‚`createServerEntry` ç”¨äºé€‚é… Nitro çš„æœåŠ¡å™¨å…¥å£æ ¼å¼ï¼Œ`handler.fetch` å¤„ç†æ‰€æœ‰ä¼ å…¥è¯·æ±‚ã€‚

## 3. é…ç½®è·¯ç”±å™¨

åˆ›å»ºä¸€ä¸ªå¸¦æœ‰é»˜è®¤é”™è¯¯å’Œæœªæ‰¾åˆ°ç»„ä»¶çš„è·¯ç”±å™¨å·¥å‚å‡½æ•°ï¼š

```tsx [src/router.tsx]
import { createRouter } from "@tanstack/react-router";
import { routeTree } from "./routeTree.gen.ts";

export function getRouter() {
  const router = createRouter({
    routeTree,
    defaultPreload: "intent",
    defaultErrorComponent: () => <div>å†…éƒ¨æœåŠ¡å™¨é”™è¯¯</div>,
    defaultNotFoundComponent: () => <div>æœªæ‰¾åˆ°é¡µé¢</div>,
    scrollRestoration: true,
  });
  return router;
}
```

è·¯ç”±å™¨å·¥å‚å‡½æ•°é…ç½®äº†é¢„åŠ è½½è¡Œä¸ºã€æ»šåŠ¨æ¢å¤åŠé»˜è®¤é”™è¯¯/æœªæ‰¾åˆ°ç»„ä»¶ã€‚

## 4. åˆ›å»ºæ ¹è·¯ç”±

æ ¹è·¯ç”±å®šä¹‰ HTML å¤–å£³ï¼ŒåŒ…å« head ç®¡ç†å’Œè„šæœ¬ï¼š

```tsx [src/routes/__root.tsx]
/// <reference types="vite/client" />
import { HeadContent, Link, Scripts, createRootRoute } from "@tanstack/react-router";
import { TanStackRouterDevtools } from "@tanstack/react-router-devtools";
import * as React from "react";
import appCss from "~/styles/app.css?url";

export const Route = createRootRoute({
  head: () => ({
    meta: [
      { charSet: "utf8" },
      { name: "viewport", content: "width=device-width, initial-scale=1" },
    ],
    links: [{ rel: "stylesheet", href: appCss }],
    scripts: [{ src: "/customScript.js", type: "text/javascript" }],
  }),
  errorComponent: () => <h1>500ï¼šå†…éƒ¨æœåŠ¡å™¨é”™è¯¯</h1>,
  notFoundComponent: () => <h1>404ï¼šæœªæ‰¾åˆ°é¡µé¢</h1>,
  shellComponent: RootDocument,
});

function RootDocument({ children }: { children: React.ReactNode }) {
  return (
    <html>
      <head>
        <HeadContent />
      </head>
      <body>
        <div className="p-2 flex gap-2 text-lg">
          <Link to="/" activeProps={{ className: "font-bold" }} activeOptions={{ exact: true }}>
            é¦–é¡µ
          </Link>{" "}
          <Link
            // @ts-ignore
            to="/this-route-does-not-exist"
            activeProps={{ className: "font-bold" }}
          >
            404
          </Link>
        </div>
        <hr />
        {children}
        <TanStackRouterDevtools position="bottom-right" />
        <Scripts />
      </body>
    </html>
  );
}
```

åœ¨ `head()` å‡½æ•°ä¸­å®šä¹‰ meta æ ‡ç­¾ã€æ ·å¼è¡¨å’Œè„šæœ¬ã€‚`shellComponent` æ˜¯åŒ…è£¹æ‰€æœ‰é¡µé¢çš„ HTML æ–‡æ¡£å¤–å£³ã€‚ä½¿ç”¨ `HeadContent` æ¸²æŸ“ head é…ç½®ï¼Œ`Scripts` æ³¨å…¥å®¢æˆ·ç«¯ JavaScript ä»¥è¿›è¡Œ hydrationã€‚

## 5. åˆ›å»ºé¡µé¢è·¯ç”±

é¡µé¢è·¯ç”±å®šä¹‰åº”ç”¨é¡µé¢ï¼š

```tsx [src/routes/index.tsx]
import { createFileRoute } from "@tanstack/react-router";

export const Route = createFileRoute("/")({ component: Home });

function Home() {
  return (
    <div className="p-2">
      <h3>æ¬¢è¿å›å®¶ï¼</h3>
      <a href="/api/test">/api/test</a>
    </div>
  );
}
```

## API è·¯ç”±

TanStack Start æ”¯æŒä¸é¡µé¢è·¯ç”±å¹¶è¡Œçš„ API è·¯ç”±ã€‚åœ¨ `src/routes/api/` ä¸‹åˆ›å»ºæ–‡ä»¶æ¥å®šä¹‰æœåŠ¡ç«¯æ¥å£ï¼ŒNitro ä¼šè‡ªåŠ¨å¤„ç†è¿™äº›æ¥å£ã€‚

## äº†è§£æ›´å¤š

- [TanStack Start æ–‡æ¡£](https://tanstack.com/start){rel="&#x22;nofollow&#x22;"}
- [æœåŠ¡å™¨å…¥å£](https://nitro.zhcndoc.com/docs/server-entry)


# ä½¿ç”¨ Vue Router çš„ SSR

::code-tree{expand-all default-value="app/entry-server.ts" expand-all=""}
```json [package.json]
{
  "type": "module",
  "scripts": {
    "build": "vite build",
    "dev": "vite dev",
    "preview": "vite preview"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^6.0.4",
    "nitro": "latest",
    "unhead": "^2.1.3",
    "vite": "beta",
    "vite-plugin-devtools-json": "^1.0.0",
    "vue": "^3.5.27",
    "vue-router": "^4.6.4"
  }
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```js [vite.config.mjs]
import vue from "@vitejs/plugin-vue";
import { defineConfig } from "vite";
import devtoolsJson from "vite-plugin-devtools-json";
import { nitro } from "nitro/vite";

export default defineConfig((_env) => ({
  plugins: [patchVueExclude(vue(), /\?assets/), devtoolsJson(), nitro()],
  environments: {
    client: { build: { rollupOptions: { input: "./app/entry-client.ts" } } },
    ssr: { build: { rollupOptions: { input: "./app/entry-server.ts" } } },
  },
}));

// Workaround https://github.com/vitejs/vite-plugin-vue/issues/677
function patchVueExclude(plugin, exclude) {
  const original = plugin.transform.handler;
  plugin.transform.handler = function (...args) {
    if (exclude.test(args[1])) return;
    return original.call(this, ...args);
  };
  return plugin;
}
```

```vue [app/app.vue]
<script setup lang="ts">
import { RouterLink, RouterView } from "vue-router";
import "./styles.css";
</script>

<template>
  <nav>
    <ul>
      <li>
        <RouterLink to="/" exact-active-class="active">Home</RouterLink>
      </li>
      <li>
        <RouterLink to="/about" active-class="active">About</RouterLink>
      </li>
    </ul>
  </nav>
  <RouterView />
</template>

<style scoped>
nav {
  background: white;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  padding: 1rem;
}

nav ul {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  gap: 2rem;
  max-width: 800px;
  margin: 0 auto;
}

nav a {
  color: #666;
  text-decoration: none;
}

nav a:hover {
  color: #333;
}

nav a.active {
  color: #646cff;
}
</style>
```

```ts [app/entry-client.ts]
import { createSSRApp } from "vue";
import { RouterView, createRouter, createWebHistory } from "vue-router";
import { routes } from "./routes.ts";

async function main() {
  const app = createSSRApp(RouterView);
  const router = createRouter({ history: createWebHistory(), routes });
  app.use(router);

  await router.isReady();
  app.mount("#root");
}

// eslint-disable-next-line unicorn/prefer-top-level-await
main();
```

```ts [app/entry-server.ts]
import { createSSRApp } from "vue";
import { renderToString } from "vue/server-renderer";
import { RouterView, createMemoryHistory, createRouter } from "vue-router";
import { createHead, transformHtmlTemplate } from "unhead/server";

import { routes } from "./routes.ts";

import clientAssets from "./entry-client.ts?assets=client";

async function handler(request: Request): Promise<Response> {
  const app = createSSRApp(RouterView);
  const router = createRouter({ history: createMemoryHistory(), routes });
  app.use(router);

  const url = new URL(request.url);
  const href = url.href.slice(url.origin.length);

  await router.push(href);
  await router.isReady();

  const assets = clientAssets.merge(
    ...(await Promise.all(
      router.currentRoute.value.matched
        .map((to) => to.meta.assets)
        .filter(Boolean)
        .map((fn) => (fn as any)().then((m: any) => m.default))
    ))
  );

  const head = createHead();

  head.push({
    link: [
      ...assets.css.map((attrs: any) => ({ rel: "stylesheet", ...attrs })),
      ...assets.js.map((attrs: any) => ({ rel: "modulepreload", ...attrs })),
    ],
    script: [{ type: "module", src: clientAssets.entry }],
  });

  const renderedApp = await renderToString(app);

  const html = await transformHtmlTemplate(head, htmlTemplate(renderedApp));

  return new Response(html, {
    headers: { "Content-Type": "text/html;charset=utf-8" },
  });
}

function htmlTemplate(body: string): string {
  return /* html */ `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vue Router Custom Framework</title>
</head>
<body>
  <div id="root">${body}</div>
</body>
</html>`;
}

export default {
  fetch: handler,
};
```

```ts [app/routes.ts]
import type { RouteRecordRaw } from "vue-router";

export const routes: RouteRecordRaw[] = [
  {
    path: "/",
    name: "app",
    component: () => import("./app.vue"),
    meta: {
      assets: () => import("./app.vue?assets"),
    },
    children: [
      {
        path: "/",
        name: "home",
        component: () => import("./pages/index.vue"),
        meta: {
          assets: () => import("./pages/index.vue?assets"),
        },
      },
      {
        path: "/about",
        name: "about",
        component: () => import("./pages/about.vue"),
        meta: {
          assets: () => import("./pages/about.vue?assets"),
        },
      },
      {
        path: "/:catchAll(.*)",
        name: "not-found",
        component: () => import("./pages/not-found.vue"),
        meta: {
          assets: () => import("./pages/not-found.vue?assets"),
        },
      },
    ],
  },
];
```

```ts [app/shims.d.ts]
declare module "*.vue" {
  import type { DefineComponent } from "vue";
  const component: DefineComponent<{}, {}, any>;
  export default component;
}
```

```css [app/styles.css]
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #f5f5f5;
  color: #333;
}

main {
  max-width: 800px;
  margin: 0 auto;
  padding: 2rem;
}

h1 {
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
}

.card {
  background: white;
  border-radius: 8px;
  padding: 2rem;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  margin: 2rem 0;
}

button {
  background: rgb(83, 91, 242);
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  font-size: 1rem;
  cursor: pointer;
}

button:hover {
  background: #535bf2;
}

.subtitle {
  color: #666;
  font-size: 1.1rem;
  margin-bottom: 2rem;
}
```

```vue [app/pages/about.vue]
<template>
  <main>
    <h1>About</h1>
    <div class="card">
      <p>This is a simple Vue Router demo app built with Vite Plugin Fullstack.</p>
      <p>It demonstrates basic routing and server-side rendering.</p>
    </div>
  </main>
</template>
```

```vue [app/pages/index.vue]
<script setup lang="ts">
import { ref } from "vue";

const count = ref(0);

function increment() {
  count.value++;
}
</script>

<template>
  <main>
    <div class="hero">
      <h1>Vue Router Custom Framework</h1>
      <p class="subtitle">A simple demo app with Vite</p>
    </div>

    <div class="card counter-card">
      <p>Count: {{ count }}</p>
      <button @click="increment">Increment</button>
    </div>
  </main>
</template>

<style scoped>
.hero {
  text-align: center;
  margin-bottom: 2rem;
}

.hero h1 {
  color: rgb(100, 108, 255);
}

.counter-card {
  text-align: center;
}

.counter-card h2 {
  color: #646cff;
  margin-bottom: 1rem;
}

.counter-card p {
  font-size: 1.5rem;
  font-weight: bold;
  margin: 1rem 0;
}
</style>
```

```vue [app/pages/not-found.vue]
<template>
  <main>
    <h1>Not Found 404</h1>
  </main>
</template>
```
::

è®¾ç½®ä½¿ç”¨ Vueã€Vue Routerã€Vite å’Œ Nitro è¿›è¡ŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰ã€‚æ­¤é…ç½®æ”¯æŒæŒ‰è·¯ç”±æ‹†åˆ†ä»£ç ã€ä½¿ç”¨ unhead è¿›è¡Œ head ç®¡ç†ä»¥åŠå®¢æˆ·ç«¯æ°´åˆï¼ˆhydrationï¼‰ã€‚

## æ¦‚è§ˆ

::steps{level="4"}
#### åœ¨ Vite é…ç½®ä¸­æ·»åŠ  Nitro Vite æ’ä»¶

#### å®šä¹‰å¸¦æœ‰æ‡’åŠ è½½ç»„ä»¶çš„è·¯ç”±

#### åˆ›å»ºæ”¯æŒè·¯ç”±çš„æœåŠ¡å™¨å…¥å£æ¸²æŸ“åº”ç”¨

#### åˆ›å»ºå®¢æˆ·ç«¯å…¥å£è¿›è¡Œæ°´åˆå¹¶æ¥ç®¡è·¯ç”±

#### åˆ›å»ºé¡µé¢ç»„ä»¶
::

## 1. é…ç½® Vite

åœ¨ Vite é…ç½®ä¸­æ·»åŠ  Nitro å’Œ Vue æ’ä»¶ã€‚å®šä¹‰ `client` å’Œ `ssr` ä¸¤ä¸ªç¯å¢ƒï¼š

```js [vite.config.mjs]
import vue from "@vitejs/plugin-vue";
import { defineConfig } from "vite";
import devtoolsJson from "vite-plugin-devtools-json";
import { nitro } from "nitro/vite";

export default defineConfig((_env) => ({
  plugins: [patchVueExclude(vue(), /\?assets/), devtoolsJson(), nitro()],
  environments: {
    client: { build: { rollupOptions: { input: "./app/entry-client.ts" } } },
    ssr: { build: { rollupOptions: { input: "./app/entry-server.ts" } } },
  },
}));

// è§£å†³ https://github.com/vitejs/vite-plugin-vue/issues/677
function patchVueExclude(plugin, exclude) {
  const original = plugin.transform.handler;
  plugin.transform.handler = function (...args) {
    if (exclude.test(args[1])) return;
    return original.call(this, ...args);
  };
  return plugin;
}
```

`patchVueExclude` è¾…åŠ©å‡½æ•°é˜²æ­¢ Vue æ’ä»¶å¤„ç†å¸¦æœ‰ `?assets` æŸ¥è¯¢å‚æ•°çš„èµ„æºå¯¼å…¥ï¼ˆasset importsï¼‰ã€‚

## 2. å®šä¹‰è·¯ç”±

åˆ›å»ºè·¯ç”±å®šä¹‰ï¼Œä½¿ç”¨æ‡’åŠ è½½ç»„ä»¶å’Œèµ„æºå…ƒæ•°æ®ï¼š

```ts [app/routes.ts]
import type { RouteRecordRaw } from "vue-router";

export const routes: RouteRecordRaw[] = [
  {
    path: "/",
    name: "app",
    component: () => import("./app.vue"),
    meta: {
      assets: () => import("./app.vue?assets"),
    },
    children: [
      {
        path: "/",
        name: "home",
        component: () => import("./pages/index.vue"),
        meta: {
          assets: () => import("./pages/index.vue?assets"),
        },
      },
      {
        path: "/about",
        name: "about",
        component: () => import("./pages/about.vue"),
        meta: {
          assets: () => import("./pages/about.vue?assets"),
        },
      },
      {
        path: "/:catchAll(.*)",
        name: "not-found",
        component: () => import("./pages/not-found.vue"),
        meta: {
          assets: () => import("./pages/not-found.vue?assets"),
        },
      },
    ],
  },
];
```

ä½¿ç”¨åŠ¨æ€å¯¼å…¥å®ç°ç»„ä»¶æ‡’åŠ è½½ï¼Œæ”¯æŒä»£ç æ‹†åˆ†ã€‚`meta.assets` å‡½æ•°ç”¨äºåŠ è½½ä¸è·¯ç”±ç›¸å…³çš„ CSS å’Œ JS ä»£ç å—ã€‚åœ¨æ ¹å¸ƒå±€ç»„ä»¶ä¸‹å®šä¹‰å­è·¯ç”±ï¼Œå®ç°åµŒå¥—è·¯ç”±ã€‚

## 3. åˆ›å»ºæœåŠ¡å™¨å…¥å£

æœåŠ¡å™¨å…¥å£æ¸²æŸ“ Vue åº”ç”¨ï¼Œæ”¯æŒè·¯ç”±å’Œ head ç®¡ç†ï¼š

```ts [app/entry-server.ts]
import { createSSRApp } from "vue";
import { renderToString } from "vue/server-renderer";
import { RouterView, createMemoryHistory, createRouter } from "vue-router";
import { createHead, transformHtmlTemplate } from "unhead/server";

import { routes } from "./routes.ts";

import clientAssets from "./entry-client.ts?assets=client";

async function handler(request: Request): Promise<Response> {
  const app = createSSRApp(RouterView);
  const router = createRouter({ history: createMemoryHistory(), routes });
  app.use(router);

  const url = new URL(request.url);
  const href = url.href.slice(url.origin.length);

  await router.push(href);
  await router.isReady();

  const assets = clientAssets.merge(
    ...(await Promise.all(
      router.currentRoute.value.matched
        .map((to) => to.meta.assets)
        .filter(Boolean)
        .map((fn) => (fn as any)().then((m: any) => m.default))
    ))
  );

  const head = createHead();

  head.push({
    link: [
      ...assets.css.map((attrs: any) => ({ rel: "stylesheet", ...attrs })),
      ...assets.js.map((attrs: any) => ({ rel: "modulepreload", ...attrs })),
    ],
    script: [{ type: "module", src: clientAssets.entry }],
  });

  const renderedApp = await renderToString(app);

  const html = await transformHtmlTemplate(head, htmlTemplate(renderedApp));

  return new Response(html, {
    headers: { "Content-Type": "text/html;charset=utf-8" },
  });
}

function htmlTemplate(body: string): string {
  return /* html */ `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vue Router Custom Framework</title>
</head>
<body>
  <div id="root">${body}</div>
</body>
</html>`;
}

export default {
  fetch: handler,
};
```

æœåŠ¡å™¨ç«¯ä½¿ç”¨ `createMemoryHistory()`ï¼Œå› ä¸ºæ²¡æœ‰æµè§ˆå™¨åœ°å€æ â€”â€”è·¯ç”±å™¨ä¼šå…ˆå¯¼èˆªè‡³è¯·æ±‚çš„ URL å†è¿›è¡Œæ¸²æŸ“ã€‚æ ¹æ®åŒ¹é…çš„è·¯ç”±åŠ¨æ€åŠ è½½å¯¹åº”èµ„æºï¼Œç¡®ä¿åªåŒ…å«å½“å‰é¡µé¢æ‰€éœ€çš„ CSS å’Œ JSã€‚`unhead` åº“ç®¡ç† `<head>` å…ƒç´ ï¼Œé€šè¿‡ `transformHtmlTemplate` æ³¨å…¥æ ·å¼ä¸è„šæœ¬ã€‚

## 4. åˆ›å»ºå®¢æˆ·ç«¯å…¥å£

å®¢æˆ·ç«¯å…¥å£è´Ÿè´£æ°´åˆæœåŠ¡å™¨æ¸²æŸ“åçš„ HTML å¹¶æ¥ç®¡è·¯ç”±ï¼š

```ts [app/entry-client.ts]
import { createSSRApp } from "vue";
import { RouterView, createRouter, createWebHistory } from "vue-router";
import { routes } from "./routes.ts";

async function main() {
  const app = createSSRApp(RouterView);
  const router = createRouter({ history: createWebHistory(), routes });
  app.use(router);

  await router.isReady();
  app.mount("#root");
}

// eslint-disable-next-line unicorn/prefer-top-level-await
main();
```

å®¢æˆ·ç«¯å…¥å£ä½¿ç”¨ `createWebHistory()` åˆ›å»º Vue åº”ç”¨ä»¥æ”¯æŒæµè§ˆå™¨è·¯ç”±ã€‚è·¯ç”±å™¨å‡†å¤‡å®Œæ¯•åï¼ŒæŒ‚è½½åˆ° `#root` å…ƒç´ ï¼Œå¹¶å®Œæˆ HTML æ°´åˆã€‚

## 5. åˆ›å»ºæ ¹ç»„ä»¶

æ ¹ç»„ä»¶æä¾›å¯¼èˆªåŠŸèƒ½å¹¶æ¸²æŸ“å­è·¯ç”±ï¼š

```vue [app/app.vue]
<script setup lang="ts">
import { RouterLink, RouterView } from "vue-router";
import "./styles.css";
</script>

<template>
  <nav>
    <ul>
      <li>
        <RouterLink to="/" exact-active-class="active">é¦–é¡µ</RouterLink>
      </li>
      <li>
        <RouterLink to="/about" active-class="active">å…³äº</RouterLink>
      </li>
    </ul>
  </nav>
  <RouterView />
</template>

<style scoped>
nav {
  background: white;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  padding: 1rem;
}

nav ul {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  gap: 2rem;
  max-width: 800px;
  margin: 0 auto;
}

nav a {
  color: #666;
  text-decoration: none;
}

nav a:hover {
  color: #333;
}

nav a.active {
  color: #646cff;
}
</style>
```

## äº†è§£æ›´å¤š

- [Vue Router æ–‡æ¡£](https://router.vuejs.org/){rel="&#x22;nofollow&#x22;"}
- [Unhead æ–‡æ¡£](https://unhead.unjs.io/){rel="&#x22;nofollow&#x22;"}
- [Renderer](https://nitro.zhcndoc.com/docs/renderer)
- [Server Entry](https://nitro.zhcndoc.com/docs/server-entry)


# Vite + tRPC

::code-tree{expand-all default-value="server/trpc.ts" expand-all=""}
```text [.gitignore]
node_modules
dist
```

```html [index.html]
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>tRPC Counter</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        background: #0f1115;
        color: #e5e7eb;
        display: grid;
        place-items: center;
        height: 100vh;
        margin: 0;
      }

      .box {
        background: #181b22;
        padding: 24px 32px;
        border-radius: 10px;
        text-align: center;
        min-width: 200px;
      }

      button {
        background: #2563eb;
        border: none;
        color: white;
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 12px;
        font-size: 14px;
      }

      button:hover {
        background: #1d4ed8;
      }

      .value {
        font-size: 36px;
        margin: 12px 0;
      }
    </style>
  </head>
  <body>
    <div class="box">
      <div>Counter</div>
      <div class="value" id="value">
        <script server>
          // Server-side Rendering
          const { result } = await serverFetch("/trpc/get").then(r => r.json())
          echo(result?.data?.value)
        </script>
      </div>
      <button id="inc">Increment</button>
    </div>

    <script setup>
      const valueEl = document.getElementById("value");
      const incBtn = document.getElementById("inc");

      async function call(path, body) {
        const res = await fetch(`/trpc/${path}`, {
          method: body ? "POST" : "GET",
          headers: { "content-type": "application/json" },
          body: body ? JSON.stringify(body) : undefined,
        });

        const json = await res.json();
        return json.result.data;
      }

      async function refresh() {
        const data = await call("get");
        valueEl.textContent = data.value;
      }

      incBtn.onclick = async () => {
        const data = await call("inc", {});
        valueEl.textContent = data.value;
      };

      refresh();
    </script>
  </body>
</html>
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "devDependencies": {
    "@trpc/client": "^11.9.0",
    "@trpc/server": "^11.9.0",
    "nitro": "latest",
    "vite": "beta",
    "zod": "^4.3.6"
  }
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig",
  "compilerOptions": {}
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({
  plugins: [
    nitro({
      routes: {
        "/trpc/**": "./server/trpc.ts",
      },
    }),
  ],
});
```

```ts [server/trpc.ts]
import { initTRPC } from "@trpc/server";
import { fetchRequestHandler } from "@trpc/server/adapters/fetch";

let counter = 0;

const t = initTRPC.create();

export const appRouter = t.router({
  get: t.procedure.query(() => {
    return { value: counter };
  }),

  inc: t.procedure.mutation(() => {
    counter++;
    return { value: counter };
  }),
});

export type AppRouter = typeof appRouter;

export default {
  async fetch(request: Request): Promise<Response> {
    return fetchRequestHandler({
      endpoint: "/trpc",
      req: request,
      router: appRouter,
    });
  },
};
```
::

ä½¿ç”¨ Vite å’Œ Nitro è®¾ç½® tRPCï¼Œå®ç°ç«¯åˆ°ç«¯çš„ç±»å‹å®‰å…¨ APIï¼Œæ— éœ€ä»£ç ç”Ÿæˆã€‚æ­¤ç¤ºä¾‹æ„å»ºäº†ä¸€ä¸ªè®¡æ•°å™¨ï¼Œåˆå§‹å€¼é€šè¿‡æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼Œå®¢æˆ·ç«¯è¿›è¡Œæ›´æ–°ã€‚

## æ¦‚è§ˆ

::steps{level="4"}
#### é…ç½® Viteï¼Œæ·»åŠ  Nitro æ’ä»¶å¹¶è·¯ç”± tRPC è¯·æ±‚

#### åˆ›å»ºå¸¦æœ‰è¿‡ç¨‹çš„ tRPC è·¯ç”±å™¨

#### åˆ›å»ºå¸¦æœåŠ¡å™¨ç«¯æ¸²æŸ“åŠå®¢æˆ·ç«¯äº¤äº’çš„ HTML é¡µé¢
::

## 1. é…ç½® Vite

æ·»åŠ  Nitro æ’ä»¶å¹¶é…ç½® `/trpc/**` è·¯ç”±æŒ‡å‘ä½ çš„ tRPC å¤„ç†ç¨‹åºï¼š

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({
  plugins: [
    nitro({
      routes: {
        "/trpc/**": "./server/trpc.ts",
      },
    }),
  ],
});
```

`routes` é€‰é¡¹å°† URL æ¨¡å¼æ˜ å°„åˆ°å¤„ç†ç¨‹åºæ–‡ä»¶ã€‚æ‰€æœ‰å¯¹ `/trpc/*` çš„è¯·æ±‚å‡ç”± tRPC è·¯ç”±å™¨å¤„ç†ã€‚

## 2. åˆ›å»º tRPC è·¯ç”±å™¨

å®šä¹‰å¸¦è¿‡ç¨‹çš„ tRPC è·¯ç”±å™¨å¹¶å°†å…¶å¯¼å‡ºä¸º fetch å¤„ç†å‡½æ•°ï¼š

```ts [server/trpc.ts]
import { initTRPC } from "@trpc/server";
import { fetchRequestHandler } from "@trpc/server/adapters/fetch";

let counter = 0;

const t = initTRPC.create();

export const appRouter = t.router({
  get: t.procedure.query(() => {
    return { value: counter };
  }),

  inc: t.procedure.mutation(() => {
    counter++;
    return { value: counter };
  }),
});

export type AppRouter = typeof appRouter;

export default {
  async fetch(request: Request): Promise<Response> {
    return fetchRequestHandler({
      endpoint: "/trpc",
      req: request,
      router: appRouter,
    });
  },
};
```

ä½¿ç”¨ `t.procedure.query()` å®šä¹‰è¯»å–æ“ä½œï¼Œä½¿ç”¨ `t.procedure.mutation()` å®šä¹‰å†™å…¥æ“ä½œã€‚å¯¼å‡º `AppRouter` ç±»å‹ï¼Œå®¢æˆ·ç«¯å¯è·å¾—å®Œæ•´çš„ç±»å‹æ¨æ–­ã€‚é»˜è®¤å¯¼å‡ºä½¿ç”¨ tRPC çš„ fetch é€‚é…å™¨æ¥å¤„ç†ä¼ å…¥è¯·æ±‚ã€‚

## 3. åˆ›å»º HTML é¡µé¢

åˆ›å»ºå…·æœ‰æœåŠ¡å™¨ç«¯æ¸²æŸ“å’Œå®¢æˆ·ç«¯äº¤äº’åŠŸèƒ½çš„ HTML é¡µé¢ï¼š

```html [index.html]
<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>tRPC Counter</title>
    <style>
      body {
        font-family: system-ui, sans-serif;
        background: #0f1115;
        color: #e5e7eb;
        display: grid;
        place-items: center;
        height: 100vh;
        margin: 0;
      }

      .box {
        background: #181b22;
        padding: 24px 32px;
        border-radius: 10px;
        text-align: center;
        min-width: 200px;
      }

      button {
        background: #2563eb;
        border: none;
        color: white;
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 12px;
        font-size: 14px;
      }

      button:hover {
        background: #1d4ed8;
      }

      .value {
        font-size: 36px;
        margin: 12px 0;
      }
    </style>
  </head>
  <body>
    <div class="box">
      <div>è®¡æ•°å™¨</div>
      <div class="value" id="value">
        <script server>
          // æœåŠ¡å™¨ç«¯æ¸²æŸ“
          const { result } = await serverFetch("/trpc/get").then(r => r.json())
          echo(result?.data?.value)
        </script>
      </div>
      <button id="inc">é€’å¢</button>
    </div>

    <script setup>
      const valueEl = document.getElementById("value");
      const incBtn = document.getElementById("inc");

      async function call(path, body) {
        const res = await fetch(`/trpc/${path}`, {
          method: body ? "POST" : "GET",
          headers: { "content-type": "application/json" },
          body: body ? JSON.stringify(body) : undefined,
        });

        const json = await res.json();
        return json.result.data;
      }

      async function refresh() {
        const data = await call("get");
        valueEl.textContent = data.value;
      }

      incBtn.onclick = async () => {
        const data = await call("inc", {});
        valueEl.textContent = data.value;
      };

      refresh();
    </script>
  </body>
</html>
```

`<script server>` å—åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œåœ¨å“åº”å‘é€å‰é€šè¿‡ `serverFetch` è·å–åˆå§‹è®¡æ•°å€¼ã€‚`<script setup>` å—åœ¨æµè§ˆå™¨ä¸­æ‰§è¡Œï¼Œå¤„ç†é€’å¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶ã€‚

## äº†è§£æ›´å¤š

- [tRPC](https://trpc.io/){rel="&#x22;nofollow&#x22;"}
- [è·¯ç”±](https://nitro.zhcndoc.com/docs/routing)


# WebSocket

::code-tree{expand-all default-value="routes/_ws.ts" expand-all=""}
```html [index.html]
<html lang="en" data-theme="dark">
  <head>
    <title>CrossWS Test Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background-color: #1a1a1a;
      }
    </style>
    <script type="module">
      import { createApp, reactive, nextTick } from "https://esm.sh/petite-vue@0.4.1";

      let ws;

      const store = reactive({
        message: "",
        messages: [],
      });

      const scroll = () => {
        nextTick(() => {
          const el = document.querySelector("#messages");
          el.scrollTop = el.scrollHeight;
          el.scrollTo({
            top: el.scrollHeight,
            behavior: "smooth",
          });
        });
      };

      const format = async () => {
        for (const message of store.messages) {
          if (!message._fmt && message.text.startsWith("{")) {
            message._fmt = true;
            const { codeToHtml } = await import("https://esm.sh/shiki@1.0.0");
            const str = JSON.stringify(JSON.parse(message.text), null, 2);
            message.formattedText = await codeToHtml(str, {
              lang: "json",
              theme: "dark-plus",
            });
          }
        }
      };

      const log = (user, ...args) => {
        console.log("[ws]", user, ...args);
        store.messages.push({
          text: args.join(" "),
          formattedText: "",
          user: user,
          date: new Date().toLocaleString(),
        });
        scroll();
        format();
      };

      const connect = async () => {
        const isSecure = location.protocol === "https:";
        const url = (isSecure ? "wss://" : "ws://") + location.host + "/_ws";
        if (ws) {
          log("ws", "Closing previous connection before reconnecting...");
          ws.close();
          clear();
        }

        log("ws", "Connecting to", url, "...");
        ws = new WebSocket(url);

        ws.addEventListener("message", async (event) => {
          let data = typeof event.data === "string" ? event.data : await event.data.text();
          const { user = "system", message = "" } = data.startsWith("{")
            ? JSON.parse(data)
            : { message: data };
          log(user, typeof message === "string" ? message : JSON.stringify(message));
        });

        await new Promise((resolve) => ws.addEventListener("open", resolve));
        log("ws", "Connected!");
      };

      const clear = () => {
        store.messages.splice(0, store.messages.length);
        log("system", "previous messages cleared");
      };

      const send = () => {
        console.log("sending message...");
        if (store.message) {
          ws.send(store.message);
        }
        store.message = "";
      };

      const ping = () => {
        log("ws", "Sending ping");
        ws.send("ping");
      };

      createApp({
        store,
        send,
        ping,
        clear,
        connect,
        rand: Math.random(),
      }).mount();

      await connect();
    </script>
  </head>
  <body class="h-screen flex flex-col justify-between">
    <main v-scope="{}">
      <!-- Messages -->
      <div id="messages" class="flex-grow flex flex-col justify-end px-4 py-8">
        <div class="flex items-center mb-4" v-for="message in store.messages">
          <div class="flex flex-col">
            <p class="text-gray-500 mb-1 text-xs ml-10">{{ message.user }}</p>
            <div class="flex items-center">
              <img
                :src="'https://www.gravatar.com/avatar/' + encodeURIComponent(message.user + rand) + '?s=512&d=monsterid'"
                alt="Avatar"
                class="w-8 h-8 rounded-full"
              />
              <div class="ml-2 bg-gray-800 rounded-lg p-2">
                <p
                  v-if="message.formattedText"
                  class="overflow-x-scroll"
                  v-html="message.formattedText"
                ></p>
                <p v-else class="text-white">{{ message.text }}</p>
              </div>
            </div>
            <p class="text-gray-500 mt-1 text-xs ml-10">{{ message.date }}</p>
          </div>
        </div>
      </div>

      <!-- Chatbox -->
      <div class="bg-gray-800 px-4 py-2 flex items-center justify-between fixed bottom-0 w-full">
        <div class="w-full min-w-6">
          <input
            type="text"
            placeholder="Type your message..."
            class="w-full rounded-l-lg px-4 py-2 bg-gray-700 text-white focus:outline-none focus:ring focus:border-blue-300"
            @keydown.enter="send"
            v-model="store.message"
          />
        </div>
        <div class="flex">
          <button class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4" @click="send">
            Send
          </button>
          <button class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4" @click="ping">
            Ping
          </button>
          <button class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4" @click="connect">
            Reconnect
          </button>
          <button
            class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-r-lg"
            @click="clear"
          >
            Clear
          </button>
        </div>
      </div>
    </main>
  </body>
</html>
`
```

```ts [nitro.config.ts]
import { defineConfig } from "nitro";

export default defineConfig({
  serverDir: "./",
  renderer: { static: true },
  features: { websocket: true },
});
```

```json [package.json]
{
  "type": "module",
  "scripts": {
    "dev": "nitro dev",
    "build": "nitro build"
  },
  "devDependencies": {
    "nitro": "latest"
  }
}
```

```json [tsconfig.json]
{
  "extends": "nitro/tsconfig"
}
```

```ts [vite.config.ts]
import { defineConfig } from "vite";
import { nitro } from "nitro/vite";

export default defineConfig({ plugins: [nitro()] });
```

```ts [routes/_ws.ts]
import { defineWebSocketHandler } from "nitro/h3";

export default defineWebSocketHandler({
  open(peer) {
    peer.send({ user: "server", message: `Welcome ${peer}!` });
    peer.publish("chat", { user: "server", message: `${peer} joined!` });
    peer.subscribe("chat");
  },
  message(peer, message) {
    if (message.text().includes("ping")) {
      peer.send({ user: "server", message: "pong" });
    } else {
      const msg = {
        user: peer.toString(),
        message: message.toString(),
      };
      peer.send(msg); // echo
      peer.publish("chat", msg);
    }
  },
  close(peer) {
    peer.publish("chat", { user: "server", message: `${peer} left!` });
  },
});
```
::

æ­¤ç¤ºä¾‹ä½¿ç”¨ WebSockets å®ç°äº†ä¸€ä¸ªç®€å•çš„èŠå¤©å®¤ã€‚å®¢æˆ·ç«¯è¿æ¥åï¼Œå¯ä»¥å‘é€æ¶ˆæ¯ï¼Œå¹¶å®æ—¶æ¥æ”¶å…¶ä»–ç”¨æˆ·çš„æ¶ˆæ¯ã€‚æœåŠ¡å™¨ä½¿ç”¨å‘å¸ƒ/è®¢é˜…é€šé“å‘æ‰€æœ‰å·²è¿æ¥çš„å®¢æˆ·ç«¯å¹¿æ’­æ¶ˆæ¯ã€‚

## WebSocket å¤„ç†å™¨

ä½¿ç”¨ `defineWebSocketHandler` åˆ›å»ºä¸€ä¸ª WebSocket è·¯ç”±ã€‚

```ts [routes/_ws.ts]
import { defineWebSocketHandler } from "nitro/h3";

export default defineWebSocketHandler({
  open(peer) {
    peer.send({ user: "server", message: `Welcome ${peer}!` });
    peer.publish("chat", { user: "server", message: `${peer} joined!` });
    peer.subscribe("chat");
  },
  message(peer, message) {
    if (message.text().includes("ping")) {
      peer.send({ user: "server", message: "pong" });
    } else {
      const msg = {
        user: peer.toString(),
        message: message.toString(),
      };
      peer.send(msg); // å›æ˜¾
      peer.publish("chat", msg);
    }
  },
  close(peer) {
    peer.publish("chat", { user: "server", message: `${peer} left!` });
  },
});
```

`defineWebSocketHandler()` æš´éœ²äº†ä¸åŒçš„é’©å­ï¼Œç”¨äºé›†æˆ WebSocket ç”Ÿå‘½å‘¨æœŸçš„ä¸åŒéƒ¨åˆ†ã€‚

## äº†è§£æ›´å¤š

- [è·¯ç”±](https://nitro.zhcndoc.com/docs/routing)
- [crossws æ–‡æ¡£](https://crossws.h3.dev/guide/hooks){rel="&#x22;nofollow&#x22;"}
